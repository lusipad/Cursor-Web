<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cursor 多实例测试</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .panel { padding: 16px; background:#111; border:1px solid #333; border-radius:8px; margin:12px 0; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .col { display:flex; flex-direction:column; gap:6px; }
    input, select { background:#181a1b; color:#fff; border:1px solid #333; border-radius:6px; padding:8px; }
    button { padding:8px 12px; border:none; border-radius:6px; background:#4f8cff; color:#fff; cursor:pointer; }
    button.secondary { background:#444c56; }
    pre { white-space:pre-wrap; background:#0d0d0d; color:#bbb; padding:10px; border-radius:6px; border:1px solid #333; max-height:280px; overflow:auto; }
  </style>
</head>
<body>
  <div class="container" style="padding:16px;">
    <h2>Cursor 多实例测试</h2>

    <div class="panel">
      <div class="col">
        <div class="row">
          <label style="min-width:120px;">实例 ID</label>
          <input id="instanceId" placeholder="cursor-1" value="cursor-1" />
          <label style="min-width:120px;">Cursor 路径</label>
          <input id="cursorPath" style="min-width:380px;" placeholder="留空=自动查找（推荐）" />
          <button id="launchBtn">启动并注入</button>
          <button id="listBtn" class="secondary">查看已启动</button>
          <button id="scanInjectBtn" class="secondary">仅注入现有端口(扫)</button>
          <button id="restartBtn" class="secondary">强制重启并注入</button>
          <button id="killAllBtn" class="secondary">关闭所有 Cursor</button>
        </div>
        <div class="row">
          <label style="min-width:120px;">历史根目录</label>
          <input id="historyRoot" style="min-width:380px;" placeholder="D:\\test" />
          <button id="setRootBtn" class="secondary">设置历史根</button>
          <button id="chatsBtn" class="secondary">获取会话</button>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="row"><strong>发送对话</strong></div>
      <div class="row">
        <input id="message" style="flex:1" placeholder="输入要发送给 Cursor 的消息" />
        <button id="sendBtn">发送</button>
      </div>
    </div>

    <div class="panel">
      <div class="row" style="justify-content:space-between;">
        <strong>最新历史（助手回复）</strong>
        <button id="pullReplyBtn" class="secondary">拉取最新回复</button>
      </div>
      <pre id="log"></pre>
    </div>

      <div class="panel">
        <div class="row" style="justify-content:space-between;">
          <strong>客户端连接列表</strong>
          <button id="refreshClientsBtn" class="secondary">刷新连接列表</button>
        </div>
        <pre id="clients"></pre>
      </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const log = (msg) => { const el = $('log'); el.textContent = [msg, '', el.textContent].join('\n').trim(); };

    async function api(path, method='GET', body=null){
      const res = await fetch(path, { method, headers: body?{ 'Content-Type':'application/json' }:undefined, body: body?JSON.stringify(body):undefined });
      const txt = await res.text();
      try{ return JSON.parse(txt) }catch{ return txt }
    }

    // 简易 WebSocket 客户端（用于直接发送）
    let ws = null;
    function wsUrl(){
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      const host = location.hostname + (location.port ? ':'+location.port : '');
      return protocol + '//' + host;
    }
    function connectWs(instanceId){
      return new Promise((resolve,reject)=>{
        try{
          if (ws && ws.readyState === WebSocket.OPEN){ resolve(ws); return; }
          ws = new WebSocket(wsUrl());
          ws.onopen = () => {
            try{ ws.send(JSON.stringify({ type:'register', role:'web', instanceId })); }catch{}
            resolve(ws);
          };
          ws.onerror = (e) => { reject(new Error('WS错误')); };
          ws.onclose = () => {};
          ws.onmessage = (ev) => { try { const m = JSON.parse(ev.data); if(m.type==='register_ack'){ log('已注册：'+JSON.stringify(m)); } } catch{} };
        }catch(e){ reject(e); }
      });
    }

    $('launchBtn').onclick = async () => {
      const instanceId = $('instanceId').value.trim() || 'cursor-1';
      const cursorPath = $('cursorPath').value.trim();
      // 通过接口启动并注入（后台）
      const body = { detach: true, exitAfterReady: false };
      if (cursorPath) body.cursorPath = cursorPath; // 留空=服务器自动查找
      const r = await api('/api/inject/launch', 'POST', body);
      log('启动注入：' + JSON.stringify(r));
      // 打开绑定实例的页面窗口（新标签页）
      window.open('/?instance=' + encodeURIComponent(instanceId), '_blank');
    };

    $('listBtn').onclick = async () => {
      const r = await api('/api/inject/processes');
      log('已启动进程：' + JSON.stringify(r));
    };

    $('scanInjectBtn').onclick = async () => {
      const instanceId = $('instanceId').value.trim() || 'cursor-1';
      const r = await api('/api/inject/scan-inject', 'POST', { startPort: 9222, endPort: 9250, instanceId });
      log('扫描并注入：' + JSON.stringify(r));
    };

    $('killAllBtn').onclick = async () => {
      const r = await api('/api/inject/kill-all', 'POST', {});
      log('关闭结果：' + JSON.stringify(r));
    };

    $('restartBtn').onclick = async () => {
      const instanceId = $('instanceId').value.trim() || 'cursor-1';
      const cursorPath = $('cursorPath').value.trim();
      const body = { instanceId };
      if (cursorPath) body.cursorPath = cursorPath;
      const r = await api('/api/inject/restart', 'POST', body);
      log('重启并注入：' + JSON.stringify(r));
      if (r && r.success) {
        window.open('/?instance=' + encodeURIComponent(instanceId), '_blank');
      }
    };

    $('setRootBtn').onclick = async () => {
      const root = $('historyRoot').value.trim();
      const r = await api('/api/history/cursor-path', 'POST', { path: root });
      log('设置历史根：' + JSON.stringify(r));
    };

    $('chatsBtn').onclick = async () => {
      const r = await api('/api/chats');
      log('会话：' + JSON.stringify(r).slice(0, 800));
    };

    $('sendBtn').onclick = async () => {
      const msg = $('message').value.trim();
      if(!msg) return;
      const instanceId = $('instanceId').value.trim() || 'cursor-1';
      try{
        await connectWs(instanceId);
        ws.send(JSON.stringify({ type:'user_message', data: msg, targetInstanceId: instanceId }));
        log('已发送到实例 '+instanceId+'：'+msg);
      }catch(e){
        log('发送失败：'+e.message);
      }
    };

    $('pullReplyBtn').onclick = async () => {
      const r = await api('/api/chats');
      try{
        const chats = Array.isArray(r) ? r : (r.data || r.value || []);
        // 简易：选择最近会话的末尾助手
        let assi = null; let sid='';
        for(const s of chats){
          const msgs = Array.isArray(s.messages) ? s.messages : [];
          for(let i=msgs.length-1;i>=0;i--){ const m=msgs[i]; if(m.role==='assistant'){ assi=m; sid=s.sessionId||s.session_id||''; break; } }
          if(assi) break;
        }
        log('最新助手：session=' + sid + '\n' + JSON.stringify(assi||{}));
      }catch(e){ log('解析失败：' + e.message); }
    };

    $('refreshClientsBtn').onclick = async () => {
      const r = await api('/api/inject/clients');
      const data = r && r.data ? r.data : [];
      const lines = [
        '总数: ' + data.length,
        ...data.map((c,i)=>{
          const online = c.online ? '在线' : '离线';
          const inj = c.injected ? '已注入' : '未注入';
          const role = c.role || 'unknown';
          const inst = c.instanceId || '-';
          const state = c.readyState;
          return `${i+1}. [${online}/${inj}] role=${role} inst=${inst} state=${state} ip=${c.ip||''} url=${c.url||''}`;
        })
      ];
      document.getElementById('clients').textContent = lines.join('\n');
    };
  </script>
</body>
</html>


