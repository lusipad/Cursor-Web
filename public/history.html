<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>历史记录 - Claude Web</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .history-panel {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .history-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }
        
        .history-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-box {
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px 12px;
            min-width: 300px;
        }
        
        .search-box input {
            border: none;
            outline: none;
            flex: 1;
            font-size: 14px;
        }
        
        .search-box button {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 4px;
        }
        
        .filter-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-controls select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #1e7e34;
        }
        
        .history-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }
        
        .stat-card .value {
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }
        
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .history-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
            transition: all 0.3s ease;
        }
        
        .history-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .history-item.type-chat {
            border-left-color: #007bff;
        }
        
        .history-item.type-system {
            border-left-color: #28a745;
        }
        
        .history-item.type-error {
            border-left-color: #dc3545;
        }
        
        .history-item.type-git {
            border-left-color: #ffc107;
        }
        
        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .history-item-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .type-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            color: white;
        }
        
        .type-badge.type-chat {
            background: #007bff;
        }
        
        .type-badge.type-system {
            background: #28a745;
        }
        
        .type-badge.type-error {
            background: #dc3545;
        }
        
        .type-badge.type-git {
            background: #ffc107;
            color: #333;
        }
        
        .timestamp {
            color: #666;
            font-size: 12px;
        }
        
        .history-item-actions {
            display: flex;
            gap: 5px;
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }
        
        .history-item-content {
            color: #333;
            line-height: 1.5;
            margin-bottom: 10px;
        }
        
        .history-item-summary {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .history-item-details {
            background: #f8f9fa;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            color: #666;
            display: none;
        }
        
        .history-item-details.show {
            display: block;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            margin: 0;
        }
        
        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #333;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        @media (max-width: 768px) {
            .history-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .history-controls {
                flex-direction: column;
            }
            
            .search-box {
                min-width: auto;
            }
            
            .filter-controls {
                justify-content: center;
            }
            
            .history-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="history-panel">
        <div class="history-header">
            <h1 class="history-title">历史记录</h1>
            <div class="history-controls">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="搜索历史记录...">
                    <button type="button" onclick="clearSearch()">✕</button>
                </div>
                <div class="filter-controls">
                    <select id="typeFilter">
                        <option value="">所有类型</option>
                        <option value="chat">聊天</option>
                        <option value="system">系统</option>
                        <option value="error">错误</option>
                        <option value="git">Git</option>
                    </select>
                    <select id="sortBy">
                        <option value="timestamp">时间</option>
                        <option value="type">类型</option>
                    </select>
                    <select id="sortOrder">
                        <option value="desc">降序</option>
                        <option value="asc">升序</option>
                    </select>
                </div>
                <div class="filter-controls">
                    <button class="btn btn-primary" onclick="loadHistory()">刷新</button>
                    <button class="btn btn-secondary" onclick="exportHistory()">导出</button>
                    <button class="btn btn-danger" onclick="showClearModal()">清除</button>
                </div>
            </div>
        </div>

        <div class="history-stats" id="historyStats">
            <div class="stat-card">
                <h3>总记录数</h3>
                <div class="value" id="totalRecords">0</div>
            </div>
            <div class="stat-card">
                <h3>聊天记录</h3>
                <div class="value" id="chatRecords">0</div>
            </div>
            <div class="stat-card">
                <h3>系统记录</h3>
                <div class="value" id="systemRecords">0</div>
            </div>
            <div class="stat-card">
                <h3>错误记录</h3>
                <div class="value" id="errorRecords">0</div>
            </div>
        </div>

        <div class="history-list" id="historyList">
            <div class="loading">加载中...</div>
        </div>

        <div class="pagination" id="pagination">
            <!-- 分页控件将在这里动态生成 -->
        </div>
    </div>

    <!-- 清除确认模态框 -->
    <div id="clearModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>确认清除</h2>
                <span class="close" onclick="hideClearModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>您确定要清除历史记录吗？此操作不可恢复。</p>
                <select id="clearType" style="width: 100%; padding: 8px; margin-top: 10px;">
                    <option value="">清除所有记录</option>
                    <option value="chat">仅清除聊天记录</option>
                    <option value="system">仅清除系统记录</option>
                    <option value="error">仅清除错误记录</option>
                    <option value="git">仅清除Git记录</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideClearModal()">取消</button>
                <button class="btn btn-danger" onclick="clearHistory()">确认清除</button>
            </div>
        </div>
    </div>

    <!-- 导出模态框 -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>导出历史记录</h2>
                <span class="close" onclick="hideExportModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="exportFormat">导出格式：</label>
                    <select id="exportFormat" style="width: 100%; padding: 8px; margin-top: 5px;">
                        <option value="json">JSON</option>
                        <option value="csv">CSV</option>
                        <option value="html">HTML</option>
                    </select>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label for="exportType">记录类型：</label>
                    <select id="exportType" style="width: 100%; padding: 8px; margin-top: 5px;">
                        <option value="">所有类型</option>
                        <option value="chat">仅聊天记录</option>
                        <option value="system">仅系统记录</option>
                        <option value="error">仅错误记录</option>
                        <option value="git">仅Git记录</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideExportModal()">取消</button>
                <button class="btn btn-primary" onclick="doExport()">导出</button>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 0;
        const pageSize = 20;
        let currentHistory = [];

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadHistory();
            loadStats();
            
            // 添加事件监听器
            document.getElementById('searchInput').addEventListener('input', debounce(loadHistory, 500));
            document.getElementById('typeFilter').addEventListener('change', loadHistory);
            document.getElementById('sortBy').addEventListener('change', loadHistory);
            document.getElementById('sortOrder').addEventListener('change', loadHistory);
        });

        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 加载历史记录
        async function loadHistory() {
            const searchQuery = document.getElementById('searchInput').value;
            const type = document.getElementById('typeFilter').value;
            const sortBy = document.getElementById('sortBy').value;
            const sortOrder = document.getElementById('sortOrder').value;

            const params = new URLSearchParams({
                limit: pageSize,
                offset: currentPage * pageSize,
                sortBy: sortBy,
                sortOrder: sortOrder
            });

            if (searchQuery) params.append('search', searchQuery);
            if (type) params.append('type', type);

            try {
                const response = await fetch(`/api/history?${params}`);
                const result = await response.json();

                if (result.success) {
                    currentHistory = result.data;
                    renderHistory(result.data.items);
                    renderPagination(result.data);
                } else {
                    showError('加载历史记录失败: ' + result.error);
                }
            } catch (error) {
                showError('加载历史记录失败: ' + error.message);
            }
        }

        // 渲染历史记录
        function renderHistory(items) {
            const container = document.getElementById('historyList');
            
            if (items.length === 0) {
                container.innerHTML = '<div class="no-data">暂无历史记录</div>';
                return;
            }

            container.innerHTML = items.map(item => `
                <div class="history-item type-${item.type}">
                    <div class="history-item-header">
                        <div class="history-item-meta">
                            <span class="type-badge type-${item.type}">${getTypeLabel(item.type)}</span>
                            <span class="timestamp">${formatTimestamp(item.timestamp)}</span>
                        </div>
                        <div class="history-item-actions">
                            <button class="btn btn-sm btn-primary" onclick="viewDetails('${item.id}')">查看</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteHistory('${item.id}')">删除</button>
                        </div>
                    </div>
                    <div class="history-item-summary">${item.summary}</div>
                    <div class="history-item-content">${formatContent(item.content)}</div>
                    <div class="history-item-details" id="details-${item.id}">
                        <strong>详细信息:</strong><br>
                        ID: ${item.id}<br>
                        时间戳: ${new Date(item.timestamp).toISOString()}<br>
                        元数据: ${JSON.stringify(item.metadata, null, 2)}
                    </div>
                </div>
            `).join('');
        }

        // 渲染分页
        function renderPagination(data) {
            const container = document.getElementById('pagination');
            const totalPages = Math.ceil(data.total / pageSize);
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            
            // 上一页
            if (currentPage > 0) {
                html += `<button class="btn btn-secondary" onclick="goToPage(${currentPage - 1})">上一页</button>`;
            }
            
            // 页码
            for (let i = 0; i < totalPages; i++) {
                if (i === currentPage) {
                    html += `<button class="btn btn-primary">${i + 1}</button>`;
                } else {
                    html += `<button class="btn btn-secondary" onclick="goToPage(${i})">${i + 1}</button>`;
                }
            }
            
            // 下一页
            if (currentPage < totalPages - 1) {
                html += `<button class="btn btn-secondary" onclick="goToPage(${currentPage + 1})">下一页</button>`;
            }
            
            container.innerHTML = html;
        }

        // 加载统计信息
        async function loadStats() {
            try {
                const response = await fetch('/api/history/stats');
                const result = await response.json();

                if (result.success) {
                    const stats = result.data;
                    document.getElementById('totalRecords').textContent = stats.total;
                    document.getElementById('chatRecords').textContent = stats.byType.chat || 0;
                    document.getElementById('systemRecords').textContent = stats.byType.system || 0;
                    document.getElementById('errorRecords').textContent = stats.byType.error || 0;
                } else {
                    console.error('加载统计信息失败:', result.error);
                }
            } catch (error) {
                console.error('加载统计信息失败:', error.message);
            }
        }

        // 跳转到指定页面
        function goToPage(page) {
            currentPage = page;
            loadHistory();
        }

        // 查看详情
        function viewDetails(id) {
            const details = document.getElementById(`details-${id}`);
            details.classList.toggle('show');
        }

        // 删除历史记录
        async function deleteHistory(id) {
            if (!confirm('确定要删除这条记录吗？')) {
                return;
            }

            try {
                const response = await fetch(`/api/history/${id}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (result.success) {
                    loadHistory();
                    loadStats();
                    showSuccess('删除成功');
                } else {
                    showError('删除失败: ' + result.error);
                }
            } catch (error) {
                showError('删除失败: ' + error.message);
            }
        }

        // 清除搜索
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            loadHistory();
        }

        // 显示清除模态框
        function showClearModal() {
            document.getElementById('clearModal').style.display = 'block';
        }

        // 隐藏清除模态框
        function hideClearModal() {
            document.getElementById('clearModal').style.display = 'none';
        }

        // 清除历史记录
        async function clearHistory() {
            const type = document.getElementById('clearType').value;
            
            try {
                const params = new URLSearchParams();
                if (type) params.append('type', type);
                
                const response = await fetch(`/api/history?${params}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (result.success) {
                    hideClearModal();
                    loadHistory();
                    loadStats();
                    showSuccess('清除成功');
                } else {
                    showError('清除失败: ' + result.error);
                }
            } catch (error) {
                showError('清除失败: ' + error.message);
            }
        }

        // 显示导出模态框
        function showExportModal() {
            document.getElementById('exportModal').style.display = 'block';
        }

        // 隐藏导出模态框
        function hideExportModal() {
            document.getElementById('exportModal').style.display = 'none';
        }

        // 导出历史记录
        function exportHistory() {
            showExportModal();
        }

        // 执行导出
        async function doExport() {
            const format = document.getElementById('exportFormat').value;
            const type = document.getElementById('exportType').value;
            
            const params = new URLSearchParams({ format });
            if (type) params.append('type', type);
            
            window.open(`/api/history/export?${params}`);
            hideExportModal();
        }

        // 格式化时间戳
        function formatTimestamp(timestamp) {
            return new Date(timestamp).toLocaleString();
        }

        // 获取类型标签
        function getTypeLabel(type) {
            const labels = {
                'chat': '聊天',
                'system': '系统',
                'error': '错误',
                'git': 'Git'
            };
            return labels[type] || type;
        }

        // 格式化内容
        function formatContent(content) {
            if (content.length > 200) {
                return content.substring(0, 200) + '...';
            }
            return content;
        }

        // 显示成功消息
        function showSuccess(message) {
            alert(message);
        }

        // 显示错误消息
        function showError(message) {
            alert(message);
        }

        // 点击模态框外部关闭
        window.onclick = function(event) {
            const clearModal = document.getElementById('clearModal');
            const exportModal = document.getElementById('exportModal');
            if (event.target === clearModal) {
                hideClearModal();
            }
            if (event.target === exportModal) {
                hideExportModal();
            }
        }
    </script>
</body>
</html>