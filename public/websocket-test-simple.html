<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket ç®€å•æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .container { max-width: 800px; margin: 0 auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #2d5a2d; }
        .error { background: #5a2d2d; }
        .warning { background: #5a5a2d; }
        .info { background: #2d2d5a; }
        button { padding: 10px 20px; margin: 5px; background: #007acc; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #005a99; }
        #log { background: #2a2a2a; padding: 10px; border-radius: 5px; height: 300px; overflow-y: auto; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”Œ WebSocket ç®€å•è¿æ¥æµ‹è¯•</h1>
        
        <div id="status" class="status info">å‡†å¤‡æµ‹è¯•...</div>
        
        <div>
            <button onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
            <button onclick="sendTestMessage()">å‘é€æµ‹è¯•æ¶ˆæ¯</button>
            <button onclick="closeConnection()">å…³é—­è¿æ¥</button>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <h3>è¿æ¥æ—¥å¿—:</h3>
        <div id="log"></div>
    </div>

    <script>
        let ws = null;
        let logElement = document.getElementById('log');
        let statusElement = document.getElementById('status');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message, type = 'info') {
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }
        
        function testConnection() {
            if (ws) {
                log('å…³é—­ç°æœ‰è¿æ¥...');
                ws.close();
                ws = null;
            }
            
            log('å¼€å§‹æµ‹è¯• WebSocket è¿æ¥...');
            updateStatus('æ­£åœ¨è¿æ¥...', 'warning');
            
            try {
                // æµ‹è¯•å¤šä¸ªåœ°å€
                const urls = [
                    'ws://localhost:3000',
                    'ws://127.0.0.1:3000',
                    `ws://${window.location.hostname}:3000`
                ];
                
                let currentIndex = 0;
                
                function tryConnect() {
                    if (currentIndex >= urls.length) {
                        log('âŒ æ‰€æœ‰è¿æ¥åœ°å€éƒ½å¤±è´¥äº†');
                        updateStatus('è¿æ¥å¤±è´¥', 'error');
                        return;
                    }
                    
                    const url = urls[currentIndex];
                    log(`ğŸ”— å°è¯•è¿æ¥: ${url}`);
                    
                    ws = new WebSocket(url);
                    
                    const timeout = setTimeout(() => {
                        if (ws.readyState === WebSocket.CONNECTING) {
                            log(`â° è¿æ¥è¶…æ—¶: ${url}`);
                            ws.close();
                            currentIndex++;
                            setTimeout(tryConnect, 500);
                        }
                    }, 5000);
                    
                    ws.onopen = function() {
                        clearTimeout(timeout);
                        log(`âœ… WebSocket è¿æ¥æˆåŠŸ: ${url}`);
                        updateStatus('è¿æ¥æˆåŠŸ', 'success');
                        
                        // å‘é€æ³¨å†Œæ¶ˆæ¯
                        const registerMsg = {
                            type: 'register',
                            role: 'web',
                            instanceId: 'websocket-test'
                        };
                        ws.send(JSON.stringify(registerMsg));
                        log('ğŸ“ å·²å‘é€æ³¨å†Œæ¶ˆæ¯');
                    };
                    
                    ws.onmessage = function(event) {
                        try {
                            const data = JSON.parse(event.data);
                            log(`ğŸ“¥ æ”¶åˆ°æ¶ˆæ¯: ${data.type} - ${JSON.stringify(data)}`);
                        } catch (e) {
                            log(`ğŸ“¥ æ”¶åˆ°åŸå§‹æ¶ˆæ¯: ${event.data}`);
                        }
                    };
                    
                    ws.onclose = function(event) {
                        clearTimeout(timeout);
                        log(`âŒ WebSocket è¿æ¥å…³é—­: code=${event.code}, reason=${event.reason}`);
                        if (event.code !== 1000 && currentIndex < urls.length - 1) {
                            currentIndex++;
                            setTimeout(tryConnect, 500);
                        } else {
                            updateStatus('è¿æ¥å·²å…³é—­', 'warning');
                        }
                    };
                    
                    ws.onerror = function(error) {
                        clearTimeout(timeout);
                        log(`âš ï¸ WebSocket é”™è¯¯: ${error}`);
                        log(`ğŸ” é”™è¯¯è¯¦æƒ…: readyState=${ws.readyState}, url=${url}`);
                        if (currentIndex < urls.length - 1) {
                            currentIndex++;
                            setTimeout(tryConnect, 500);
                        } else {
                            updateStatus('è¿æ¥é”™è¯¯', 'error');
                        }
                    };
                }
                
                tryConnect();
                
            } catch (error) {
                log(`âŒ åˆ›å»º WebSocket å¤±è´¥: ${error.message}`);
                updateStatus('åˆ›å»ºå¤±è´¥', 'error');
            }
        }
        
        function sendTestMessage() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('âŒ WebSocket æœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯');
                updateStatus('æœªè¿æ¥', 'error');
                return;
            }
            
            const testMessage = {
                type: 'user_message',
                targetInstanceId: 'default',
                msgId: 'test-' + Date.now(),
                data: 'WebSocket è¿æ¥æµ‹è¯•æ¶ˆæ¯',
                timestamp: Date.now()
            };
            
            try {
                ws.send(JSON.stringify(testMessage));
                log(`ğŸ“¤ å‘é€æµ‹è¯•æ¶ˆæ¯: ${JSON.stringify(testMessage)}`);
                updateStatus('æ¶ˆæ¯å·²å‘é€', 'success');
            } catch (error) {
                log(`âŒ å‘é€æ¶ˆæ¯å¤±è´¥: ${error.message}`);
                updateStatus('å‘é€å¤±è´¥', 'error');
            }
        }
        
        function closeConnection() {
            if (ws) {
                ws.close();
                ws = null;
                log('ğŸ”Œ æ‰‹åŠ¨å…³é—­è¿æ¥');
                updateStatus('è¿æ¥å·²å…³é—­', 'warning');
            } else {
                log('âŒ æ²¡æœ‰æ´»åŠ¨çš„è¿æ¥');
            }
        }
        
        function clearLog() {
            logElement.textContent = '';
            log('æ—¥å¿—å·²æ¸…ç©º');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æµ‹è¯•
        window.addEventListener('load', function() {
            log('WebSocket æµ‹è¯•é¡µé¢å·²åŠ è½½');
            updateStatus('å‡†å¤‡å°±ç»ª', 'info');
        });
    </script>
</body>
</html>