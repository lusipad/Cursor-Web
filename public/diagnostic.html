<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠŸèƒ½æ¨¡å—è¯Šæ–­</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 15px;
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            min-height: 100vh;
            color: #e2e8f0;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }
        .diagnostic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        .module-card {
            background: #2d3748;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border-left: 4px solid #718096;
            border: 1px solid #4a5568;
            transition: all 0.3s ease;
        }
        .module-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        .module-card.success {
            border-left-color: #48bb78;
            border-color: #48bb78;
        }
        .module-card.error {
            border-left-color: #f56565;
            border-color: #f56565;
        }
        .module-card.warning {
            border-left-color: #ed8936;
            border-color: #ed8936;
        }
        .module-card.info {
            border-left-color: #4299e1;
            border-color: #4299e1;
        }

        .module-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #e2e8f0;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 3px rgba(0,0,0,0.3);
        }
        .status-success { background-color: #48bb78; }
        .status-error { background-color: #f56565; }
        .status-warning { background-color: #ed8936; }
        .status-info { background-color: #4299e1; }

        .module-details {
            font-size: 11px;
            color: #a0aec0;
            margin-bottom: 10px;
            line-height: 1.3;
        }
        .module-actions {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }
        .module-actions .btn {
            flex: 0 0 auto;
        }
        .btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.2s ease;
            min-width: 50px;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .btn-primary { background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%); color: white; }
        .btn-warning { background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); color: white; }
        .btn-info { background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); color: white; }
        .btn-secondary { background: linear-gradient(135deg, #718096 0%, #4a5568 100%); color: white; }

        .log-section {
            background: #2d3748;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 1px solid #4a5568;
        }
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .log-header h3 {
            color: #e2e8f0;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        #log {
            background-color: #1e1e1e;
            border: 1px solid #333;
            padding: 12px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            border-radius: 4px;
            color: #e0e0e0;
            line-height: 1.3;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .log-entry {
            margin-bottom: 2px;
            padding: 2px 0;
        }
        .log-entry.info { color: #87ceeb; }
        .log-entry.success { color: #90ee90; }
        .log-entry.warning { color: #ffd700; }
        .log-entry.error { color: #ff6b6b; }
        .summary {
            background: #2d3748;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin-bottom: 15px;
            border: 1px solid #4a5568;
        }
        .summary h3 {
            color: #e2e8f0;
            margin-bottom: 12px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        .summary-item {
            text-align: center;
            padding: 10px;
            border-radius: 6px;
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            border: 1px solid #718096;
            transition: all 0.3s ease;
        }
        .summary-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            border-color: #90cdf4;
        }
        .summary-number {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 3px;
            color: #f7fafc;
        }
        .summary-label {
            font-size: 10px;
            color: #a0aec0;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 style="font-size: 18px; margin-bottom: 6px;">ğŸ” åŠŸèƒ½æ¨¡å—è¯Šæ–­</h1>
        <p style="font-size: 11px; margin-bottom: 0;">å…¨é¢æ£€æŸ¥ç³»ç»Ÿå„ä¸ªåŠŸèƒ½æ¨¡å—çš„çŠ¶æ€å’Œè¿æ¥æƒ…å†µ</p>
    </div>

    <div class="summary">
        <h3>ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ</h3>
        <div class="summary-grid">
            <div class="summary-item">
                <div class="summary-number" id="total-modules">0</div>
                <div class="summary-label">æ€»æ¨¡å—æ•°</div>
            </div>
            <div class="summary-item">
                <div class="summary-number" id="loaded-modules">0</div>
                <div class="summary-label">å·²åŠ è½½æ¨¡å—</div>
            </div>
            <div class="summary-item">
                <div class="summary-number" id="ws-status">ğŸ”´</div>
                <div class="summary-label">WebSocketçŠ¶æ€</div>
            </div>
            <div class="summary-item">
                <div class="summary-number" id="client-status">ğŸ”´</div>
                <div class="summary-label">å®¢æˆ·ç«¯çŠ¶æ€</div>
            </div>
        </div>
    </div>

    <div class="diagnostic-grid">
        <!-- æ¨¡å—åŠ è½½å™¨ -->
        <div class="module-card" id="module-loader-card">
            <div class="module-title">
                <span class="status-indicator" id="module-loader-status"></span>
                æ¨¡å—åŠ è½½å™¨
            </div>
            <div class="module-details" id="module-loader-details">æ£€æŸ¥ä¸­...</div>
            <div class="module-actions">
                <button class="btn btn-primary" onclick="checkModuleLoader()">æ£€æŸ¥åŠ è½½å™¨</button>
                <button class="btn btn-success" onclick="loadAllModules()">åŠ è½½æ‰€æœ‰æ¨¡å—</button>
            </div>
        </div>

        <!-- WebSocket å›æ˜¾æ§åˆ¶ï¼ˆhtml_content å¹¿æ’­å¼€å…³ï¼‰ -->
        <div class="module-card" id="ws-broadcast-card">
            <div class="module-title">
                <span class="status-indicator" id="ws-broadcast-status"></span>
                WebSocket å›æ˜¾æ§åˆ¶
            </div>
            <div class="module-details" id="ws-broadcast-details">ç”¨äºå¼€å¯/å…³é—­æœåŠ¡ç«¯ html_content å¹¿æ’­ï¼ˆé»˜è®¤å…³é—­ï¼Œä»…è°ƒè¯•ä½¿ç”¨ï¼‰ã€‚</div>
            <div class="module-actions">
                <button class="btn btn-info" onclick="refreshWsBroadcast()">è¯»å–çŠ¶æ€</button>
                <button class="btn btn-success" onclick="enableWsBroadcast()">å¼€å¯å¹¿æ’­</button>
                <button class="btn btn-danger" onclick="disableWsBroadcast()">å…³é—­å¹¿æ’­</button>
            </div>
        </div>

        <!-- é”™è¯¯å¤„ç†å™¨ -->
        <div class="module-card" id="error-handler-card">
            <div class="module-title">
                <span class="status-indicator" id="error-handler-status"></span>
                é”™è¯¯å¤„ç†å™¨
            </div>
            <div class="module-details" id="error-handler-details">æ£€æŸ¥ä¸­...</div>
            <div class="module-actions">
                <button class="btn btn-info" onclick="testErrorHandler()">æµ‹è¯•</button>
            </div>
        </div>

        <!-- WebSocketç®¡ç†å™¨ -->
        <div class="module-card" id="websocket-card">
            <div class="module-title">
                <span class="status-indicator" id="websocket-status"></span>
                WebSocketç®¡ç†å™¨
            </div>
            <div class="module-details" id="websocket-details">æ£€æŸ¥ä¸­...</div>
            <div class="module-actions">
                <button class="btn btn-success" onclick="testWebSocket()">æµ‹è¯•</button>
                <button class="btn btn-warning" onclick="reconnectWebSocket()">é‡è¿</button>
                <button class="btn btn-info" onclick="openWebSocketTest()">æµ‹è¯•é¡µé¢</button>
            </div>
        </div>

        <!-- å†…å®¹ç®¡ç†å™¨ -->
        <div class="module-card" id="content-manager-card">
            <div class="module-title">
                <span class="status-indicator" id="content-manager-status"></span>
                å†…å®¹ç®¡ç†å™¨
            </div>
            <div class="module-details" id="content-manager-details">æ£€æŸ¥ä¸­...</div>
            <div class="module-actions">
                <button class="btn btn-info" onclick="checkContent()">æ£€æŸ¥</button>
            </div>
        </div>

        <!-- çŠ¶æ€ç®¡ç†å™¨ -->
        <div class="module-card" id="status-manager-card">
            <div class="module-title">
                <span class="status-indicator" id="status-manager-status"></span>
                çŠ¶æ€ç®¡ç†å™¨
            </div>
            <div class="module-details" id="status-manager-details">æ£€æŸ¥ä¸­...</div>
            <div class="module-actions">
                <button class="btn btn-info" onclick="checkStatus()">æ£€æŸ¥</button>
            </div>
        </div>

        <!-- UIç®¡ç†å™¨ -->
        <div class="module-card" id="ui-manager-card">
            <div class="module-title">
                <span class="status-indicator" id="ui-manager-status"></span>
                UIç®¡ç†å™¨
            </div>
            <div class="module-details" id="ui-manager-details">æ£€æŸ¥ä¸­...</div>
            <div class="module-actions">
                <button class="btn btn-info" onclick="testUI()">æµ‹è¯•</button>
            </div>
        </div>

        <!-- äº‹ä»¶ç®¡ç†å™¨ -->
        <div class="module-card" id="event-manager-card">
            <div class="module-title">
                <span class="status-indicator" id="event-manager-status"></span>
                äº‹ä»¶ç®¡ç†å™¨
            </div>
            <div class="module-details" id="event-manager-details">æ£€æŸ¥ä¸­...</div>
            <div class="module-actions">
                <button class="btn btn-info" onclick="checkEvents()">æ£€æŸ¥</button>
            </div>
        </div>

        <!-- è°ƒè¯•ç®¡ç†å™¨ -->
        <div class="module-card" id="debug-manager-card">
            <div class="module-title">
                <span class="status-indicator" id="debug-manager-status"></span>
                è°ƒè¯•ç®¡ç†å™¨
            </div>
            <div class="module-details" id="debug-manager-details">æ£€æŸ¥ä¸­...</div>
            <div class="module-actions">
                <button class="btn btn-info" onclick="getDebugInfo()">è°ƒè¯•</button>
            </div>
        </div>

        <!-- ä¸»å®¢æˆ·ç«¯ -->
        <div class="module-card" id="simple-client-card">
            <div class="module-title">
                <span class="status-indicator" id="simple-client-status"></span>
                ä¸»å®¢æˆ·ç«¯
            </div>
            <div class="module-details" id="simple-client-details">æ£€æŸ¥ä¸­...</div>
            <div class="module-actions">
                <button class="btn btn-success" onclick="initClient()">åˆå§‹åŒ–</button>
                <button class="btn btn-info" onclick="checkClient()">æ£€æŸ¥</button>
            </div>
        </div>

        <!-- CursorçŠ¶æ€ç®¡ç†å™¨ -->
        <div class="module-card" id="cursor-status-card">
            <div class="module-title">
                <span class="status-indicator" id="cursor-status-status"></span>
                CursorçŠ¶æ€ç®¡ç†å™¨
            </div>
            <div class="module-details" id="cursor-status-details">æ£€æŸ¥ä¸­...</div>
            <div class="module-actions">
                <button class="btn btn-info" onclick="checkCursorStatus()">æ£€æŸ¥</button>
                <button class="btn btn-warning" onclick="simulateCursorActivity()">æ¨¡æ‹Ÿæ´»åŠ¨</button>
                <button class="btn btn-danger" onclick="simulateCursorClose()">æ¨¡æ‹Ÿå…³é—­</button>
            </div>
        </div>

        <!-- é¦–é¡µçŠ¶æ€ç®¡ç†å™¨ -->
        <div class="module-card" id="home-page-status-card">
            <div class="module-title">
                <span class="status-indicator" id="home-page-status-status"></span>
                é¦–é¡µçŠ¶æ€ç®¡ç†å™¨
            </div>
            <div class="module-details" id="home-page-status-details">æ£€æŸ¥ä¸­...</div>
            <div class="module-actions">
                <button class="btn btn-info" onclick="checkHomePageStatus()">æ£€æŸ¥</button>
                <button class="btn btn-success" onclick="forceUpdateHomeStatus()">å¼ºåˆ¶æ›´æ–°</button>
            </div>
        </div>

        <!-- çŠ¶æ€åŒæ­¥æµ‹è¯• -->
        <div class="module-card" id="status-sync-card">
            <div class="module-title">
                <span class="status-indicator" id="status-sync-status"></span>
                çŠ¶æ€åŒæ­¥æµ‹è¯•
            </div>
            <div class="module-details" id="status-sync-details">æ£€æŸ¥ä¸­...</div>
            <div class="module-actions">
                <button class="btn btn-info" onclick="testStatusSync()">æµ‹è¯•åŒæ­¥</button>
                <button class="btn btn-success" onclick="openStatusSyncTest()">æµ‹è¯•é¡µé¢</button>
            </div>
        </div>

        <!-- WebSocketè¿æ¥æµ‹è¯• -->
        <div class="module-card" id="websocket-test-card">
            <div class="module-title">
                <span class="status-indicator" id="websocket-test-status"></span>
                WebSocketè¿æ¥æµ‹è¯•
            </div>
            <div class="module-details" id="websocket-test-details">æ£€æŸ¥ä¸­...</div>
            <div class="module-actions">
                <button class="btn btn-info" onclick="testWebSocketConnection()">è¿æ¥æµ‹è¯•</button>
                <button class="btn btn-warning" onclick="testDisconnect()">æ–­å¼€æµ‹è¯•</button>
                <button class="btn btn-success" onclick="openWebSocketTest()">æµ‹è¯•é¡µé¢</button>
            </div>
        </div>

        <!-- æ¶ˆæ¯å‘é€æµ‹è¯• -->
        <div class="module-card" id="message-test-card">
            <div class="module-title">
                <span class="status-indicator" id="message-test-status"></span>
                æ¶ˆæ¯å‘é€æµ‹è¯•
            </div>
            <div class="module-details" id="message-test-details">æ£€æŸ¥ä¸­...</div>
            <div class="module-actions">
                <button class="btn btn-info" onclick="sendTestMessage()">å‘é€æµ‹è¯•</button>
                <button class="btn btn-warning" onclick="testMessageInput()">è¾“å…¥æµ‹è¯•</button>
            </div>
        </div>
    </div>

    <div class="log-section">
        <div class="log-header">
            <h3>ğŸ“ è¯Šæ–­æ—¥å¿—</h3>
            <div style="display: flex; gap: 6px;">
                <button class="btn btn-success" onclick="startDiagnostic()">ğŸš€ å¼€å§‹è¯Šæ–­</button>
                <button class="btn btn-secondary" onclick="clearLog()">ğŸ§¹ æ¸…é™¤æ—¥å¿—</button>
                <button class="btn btn-info" onclick="exportLog()">ğŸ“¤ å¯¼å‡ºæ—¥å¿—</button>
            </div>
        </div>
        <div id="log"></div>
        </div>

    <script src="js/modules/module-loader.js"></script>
    <script>
        // ---- WS å›æ˜¾æ§åˆ¶ï¼ˆè°ƒç”¨ä¸´æ—¶ç«¯ç‚¹ /api/debug/html-broadcastï¼‰----
        async function fetchJson(url, options){ const r = await fetch(url, options); const t = await r.text(); try{return JSON.parse(t)}catch{return { raw:t }} }
        async function refreshWsBroadcast(){
            try{
                const j = await fetchJson('/api/debug/html-broadcast');
                const on = !!(j && (j.enabled === true || j.data === true));
                const cardId = 'ws-broadcast';
                updateModuleCard(cardId, on ? 'success' : 'warning', on ? 'å·²å¼€å¯ï¼ˆå»ºè®®ä»…è°ƒè¯•ä½¿ç”¨ï¼‰' : 'å·²å…³é—­ï¼ˆæ¨èï¼‰', on ? 'success' : 'warning');
                log(`WS å¹¿æ’­çŠ¶æ€ï¼š${on?'å¼€å¯':'å…³é—­'}`, on?'success':'info');
            }catch(e){ updateModuleCard('ws-broadcast','error','è¯»å–å¤±è´¥','error'); log('âŒ è¯»å– WS å¹¿æ’­çŠ¶æ€å¤±è´¥: '+e.message,'error'); }
        }
        async function enableWsBroadcast(){
            try{
                const j = await fetchJson('/api/debug/html-broadcast?enable=1');
                log('âœ… å·²å¼€å¯ WS å¹¿æ’­', 'success');
                refreshWsBroadcast();
            }catch(e){ log('âŒ å¼€å¯å¤±è´¥: '+e.message, 'error'); }
        }
        async function disableWsBroadcast(){
            try{
                const j = await fetchJson('/api/debug/html-broadcast?enable=0');
                log('âœ… å·²å…³é—­ WS å¹¿æ’­', 'success');
                refreshWsBroadcast();
            }catch(e){ log('âŒ å…³é—­å¤±è´¥: '+e.message, 'error'); }
        }
        // æ—¥å¿—åŠŸèƒ½
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = {
                'info': 'â„¹ï¸',
                'success': 'âœ…',
                'warning': 'âš ï¸',
                'error': 'âŒ'
            };

            // å¤„ç†æ¢è¡Œç¬¦
            const lines = message.split('\n');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;

            lines.forEach((line, index) => {
                if (index === 0) {
                    logEntry.innerHTML = `[${timestamp}] ${typeIcon[type]} ${line}`;
                } else {
                    logEntry.innerHTML += `<br>${' '.repeat(timestamp.length + 3)}${line}`;
                }
            });

            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        // ç­‰å¾…æ¨¡å—åŠ è½½å™¨åˆå§‹åŒ–
        function waitForModuleLoader() {
            return new Promise((resolve) => {
                const checkLoader = () => {
                    if (window.ModuleLoader) {
                        log('âœ… æ¨¡å—åŠ è½½å™¨å·²å°±ç»ª', 'success');
                        resolve();
                    } else {
                        log('â³ ç­‰å¾…æ¨¡å—åŠ è½½å™¨...', 'info');
                        setTimeout(checkLoader, 100);
                    }
                };
                checkLoader();
            });
        }

        // æ›´æ–°æ¨¡å—å¡ç‰‡çŠ¶æ€
        function updateModuleCard(moduleId, status, details, className = 'info') {
            const card = document.getElementById(`${moduleId}-card`);
            const statusIndicator = document.getElementById(`${moduleId}-status`);
            const detailsElement = document.getElementById(`${moduleId}-details`);

            card.className = `module-card ${className}`;
            statusIndicator.className = `status-indicator status-${className}`;
            detailsElement.textContent = details;
        }

        // æ›´æ–°æ¦‚è§ˆ
        function updateSummary() {
            const modules = ['ErrorHandler', 'WebSocketManager', 'ContentManager', 'StatusManager', 'CursorStatusManager', 'HomePageStatusManager', 'UIManager', 'EventManager', 'DebugManager'];
            const loadedModules = modules.filter(m => window[m]).length;

            document.getElementById('total-modules').textContent = modules.length;
            document.getElementById('loaded-modules').textContent = loadedModules;

            if (window.simpleClient && window.simpleClient.wsManager && window.simpleClient.wsManager.isConnected()) {
                document.getElementById('ws-status').textContent = 'ğŸŸ¢';
            } else {
                document.getElementById('ws-status').textContent = 'ğŸ”´';
            }

            if (window.simpleClient) {
                document.getElementById('client-status').textContent = 'ğŸŸ¢';
            } else {
                document.getElementById('client-status').textContent = 'ğŸ”´';
            }
        }

        // æ£€æŸ¥æ¨¡å—åŠ è½½å™¨
        function checkModuleLoader() {
            log('ğŸ” æ£€æŸ¥æ¨¡å—åŠ è½½å™¨...');
            if (window.ModuleLoader) {
                const status = window.ModuleLoader.getLoadStatus();
                updateModuleCard('module-loader', 'success',
                    `å·²åŠ è½½: ${status.loadedModules.length}/${status.totalModules}`, 'success');
                log('âœ… æ¨¡å—åŠ è½½å™¨æ­£å¸¸', 'success');
                log(`ğŸ“Š åŠ è½½çŠ¶æ€: ${status.loadedModules.join(', ')}`, 'info');
            } else {
                updateModuleCard('module-loader', 'error', 'æ¨¡å—åŠ è½½å™¨æœªåŠ è½½', 'error');
                log('âŒ æ¨¡å—åŠ è½½å™¨æœªæ‰¾åˆ°', 'error');
            }
        }

        // åŠ è½½æ‰€æœ‰æ¨¡å—
        async function loadAllModules() {
            log('ğŸ“¦ å¼€å§‹åŠ è½½æ‰€æœ‰æ¨¡å—...');
            if (window.ModuleLoader) {
                try {
                    await window.ModuleLoader.loadAllModules();
                    log('âœ… æ‰€æœ‰æ¨¡å—åŠ è½½å®Œæˆ', 'success');

                    // æ£€æŸ¥æ¨¡å—å¯ç”¨æ€§
                    if (window.ModuleLoader.checkModulesAvailability()) {
                        log('âœ… æ‰€æœ‰æ¨¡å—å¯ç”¨', 'success');

                        // åŠ è½½ä¸»å®¢æˆ·ç«¯
                        if (!window.SimpleWebClient) {
                            log('ğŸ“¦ åŠ è½½ä¸»å®¢æˆ·ç«¯...', 'info');
                            try {
                                await window.ModuleLoader.loadModule('SimpleWebClient');
                                log('âœ… SimpleWebClient åŠ è½½å®Œæˆ', 'success');
                            } catch (error) {
                                log(`âŒ SimpleWebClient åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                                return;
                            }
                        }

                        // åˆå§‹åŒ–å®¢æˆ·ç«¯
                        if (window.SimpleWebClient && !window.simpleClient) {
                            log('ğŸš€ åˆå§‹åŒ–å®¢æˆ·ç«¯...', 'info');
                            try {
                                window.simpleClient = new window.SimpleWebClient();
                                log('âœ… å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ', 'success');
                            } catch (error) {
                                log(`âŒ å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                                return;
                            }
                        }

                        setTimeout(runFullDiagnostic, 1000);
                    } else {
                        log('âŒ éƒ¨åˆ†æ¨¡å—ä¸å¯ç”¨', 'error');
                    }
                } catch (error) {
                    log(`âŒ æ¨¡å—åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                }
            } else {
                log('âŒ æ¨¡å—åŠ è½½å™¨ä¸å¯ç”¨', 'error');
            }
        }

        // æµ‹è¯•WebSocket
        function testWebSocket() {
            log('ğŸ”Œ æµ‹è¯•WebSocketè¿æ¥...');
            if (window.simpleClient && window.simpleClient.wsManager) {
                const state = window.simpleClient.wsManager.getConnectionState();
                const connected = window.simpleClient.wsManager.isConnected();

                if (connected) {
                    updateModuleCard('websocket', 'success', 'WebSocketå·²è¿æ¥', 'success');
                    log('âœ… WebSocketè¿æ¥æ­£å¸¸', 'success');
                } else {
                    updateModuleCard('websocket', 'warning', `WebSocketçŠ¶æ€: ${state}`, 'warning');
                    log(`âš ï¸ WebSocketæœªè¿æ¥ï¼ŒçŠ¶æ€: ${state}`, 'warning');
                }
            } else {
                updateModuleCard('websocket', 'error', 'WebSocketç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                log('âŒ WebSocketç®¡ç†å™¨ä¸å¯ç”¨', 'error');
            }
        }

        // é‡æ–°è¿æ¥WebSocket
        function reconnectWebSocket() {
            log('ğŸ”„ é‡æ–°è¿æ¥WebSocket...');
            if (window.simpleClient && window.simpleClient.wsManager) {
                window.simpleClient.wsManager.manualReconnect();
                log('ğŸ”„ WebSocketé‡è¿å·²è§¦å‘', 'info');
                setTimeout(testWebSocket, 2000);
            } else {
                log('âŒ WebSocketç®¡ç†å™¨ä¸å¯ç”¨', 'error');
            }
        }

        // æ‰“å¼€WebSocketæµ‹è¯•é¡µé¢
        function openWebSocketTest() {
            log('ğŸ”— æ‰“å¼€WebSocketæµ‹è¯•é¡µé¢...');
            try {
                const testUrl = 'test-websocket.html';
                window.open(testUrl, '_blank');
                log('âœ… WebSocketæµ‹è¯•é¡µé¢å·²åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€', 'success');
            } catch (error) {
                log(`âŒ æ‰“å¼€æµ‹è¯•é¡µé¢å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å‘é€æµ‹è¯•æ¶ˆæ¯
        function sendTestMessage() {
            log('ğŸ“¤ å‘é€æµ‹è¯•æ¶ˆæ¯...');
            if (window.simpleClient) {
                const success = window.simpleClient.testSendMessage('è¯Šæ–­æµ‹è¯•æ¶ˆæ¯');
                if (success) {
                    log('âœ… æµ‹è¯•æ¶ˆæ¯å‘é€æˆåŠŸ', 'success');
                } else {
                    log('âŒ æµ‹è¯•æ¶ˆæ¯å‘é€å¤±è´¥', 'error');
                }
            } else {
                log('âŒ å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
            }
        }

        // æ£€æŸ¥å†…å®¹ç®¡ç†å™¨
        function checkContent() {
            log('ğŸ“„ æ£€æŸ¥å†…å®¹ç®¡ç†å™¨...');
            if (window.simpleClient) {
                log(`ğŸ” simpleClientå­˜åœ¨: ${typeof window.simpleClient}`, 'info');
                log(`ğŸ” contentManagerå­˜åœ¨: ${!!window.simpleClient.contentManager}`, 'info');

                if (window.simpleClient.contentManager) {
                    log(`ğŸ” contentManagerç±»å‹: ${typeof window.simpleClient.contentManager}`, 'info');
                    log(`ğŸ” hasReceivedContentæ–¹æ³•å­˜åœ¨: ${typeof window.simpleClient.contentManager.hasReceivedContent}`, 'info');

                    try {
                        const hasContent = window.simpleClient.contentManager.hasReceivedContent();
                        const currentContent = window.simpleClient.contentManager.getCurrentContent();

                        updateModuleCard('content-manager', 'success',
                            `å†…å®¹çŠ¶æ€: ${hasContent ? 'æœ‰å†…å®¹' : 'æ— å†…å®¹'}`, 'success');
                        log(`âœ… å†…å®¹ç®¡ç†å™¨æ­£å¸¸ï¼Œå†…å®¹é•¿åº¦: ${currentContent ? currentContent.length : 0}`, 'success');
                    } catch (error) {
                        updateModuleCard('content-manager', 'error', `å†…å®¹ç®¡ç†å™¨é”™è¯¯: ${error.message}`, 'error');
                        log(`âŒ å†…å®¹ç®¡ç†å™¨è°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
                    }
                } else {
                    updateModuleCard('content-manager', 'error', 'å†…å®¹ç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                    log('âŒ å†…å®¹ç®¡ç†å™¨ä¸å¯ç”¨', 'error');
                }
            } else {
                updateModuleCard('content-manager', 'error', 'å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
                log('âŒ å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
            }
        }

        // æ¸…é™¤å†…å®¹
        function clearContent() {
            log('ğŸ§¹ æ¸…é™¤å†…å®¹...');
            if (window.simpleClient) {
                window.simpleClient.forceClear();
                log('âœ… å†…å®¹å·²æ¸…é™¤', 'success');
                setTimeout(checkContent, 1000);
            } else {
                log('âŒ å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
            }
        }

        // æ£€æŸ¥çŠ¶æ€ç®¡ç†å™¨
        function checkStatus() {
            log('ğŸ“Š æ£€æŸ¥çŠ¶æ€ç®¡ç†å™¨...');
            if (window.simpleClient) {
                log(`ğŸ” statusManagerå­˜åœ¨: ${!!window.simpleClient.statusManager}`, 'info');

                if (window.simpleClient.statusManager) {
                    try {
                        updateModuleCard('status-manager', 'success', 'çŠ¶æ€ç®¡ç†å™¨æ­£å¸¸', 'success');
                        log('âœ… çŠ¶æ€ç®¡ç†å™¨æ­£å¸¸', 'success');
                    } catch (error) {
                        updateModuleCard('status-manager', 'error', `çŠ¶æ€ç®¡ç†å™¨é”™è¯¯: ${error.message}`, 'error');
                        log(`âŒ çŠ¶æ€ç®¡ç†å™¨è°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
                    }
                } else {
                    updateModuleCard('status-manager', 'error', 'çŠ¶æ€ç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                    log('âŒ çŠ¶æ€ç®¡ç†å™¨ä¸å¯ç”¨', 'error');
                }
            } else {
                updateModuleCard('status-manager', 'error', 'å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
                log('âŒ å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
            }
        }

        // å¼€å§‹çŠ¶æ€æ£€æŸ¥
        function startStatusCheck() {
            log('ğŸ”„ å¼€å§‹çŠ¶æ€æ£€æŸ¥...');
            if (window.simpleClient && window.simpleClient.statusManager) {
                window.simpleClient.statusManager.startStatusCheck();
                log('âœ… çŠ¶æ€æ£€æŸ¥å·²å¯åŠ¨', 'success');
            } else {
                log('âŒ çŠ¶æ€ç®¡ç†å™¨ä¸å¯ç”¨', 'error');
            }
        }

        // æµ‹è¯•UIç®¡ç†å™¨
        function testUI() {
            log('ğŸ¨ æµ‹è¯•UIç®¡ç†å™¨...');
            if (window.simpleClient) {
                log(`ğŸ” uiManagerå­˜åœ¨: ${!!window.simpleClient.uiManager}`, 'info');

                if (window.simpleClient.uiManager) {
                    try {
                        window.simpleClient.uiManager.updateStatus('UIæµ‹è¯• - æ­£å¸¸', 'info');
                        updateModuleCard('ui-manager', 'success', 'UIç®¡ç†å™¨æ­£å¸¸', 'success');
                        log('âœ… UIç®¡ç†å™¨æ­£å¸¸', 'success');
                    } catch (error) {
                        updateModuleCard('ui-manager', 'error', `UIç®¡ç†å™¨é”™è¯¯: ${error.message}`, 'error');
                        log(`âŒ UIç®¡ç†å™¨è°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
                    }
                } else {
                    updateModuleCard('ui-manager', 'error', 'UIç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                    log('âŒ UIç®¡ç†å™¨ä¸å¯ç”¨', 'error');
                }
            } else {
                updateModuleCard('ui-manager', 'error', 'å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
                log('âŒ å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification() {
            log('ğŸ”” æ˜¾ç¤ºé€šçŸ¥...');
            if (window.simpleClient && window.simpleClient.uiManager) {
                window.simpleClient.uiManager.showNotification('è¯Šæ–­é€šçŸ¥', 'info');
                log('âœ… é€šçŸ¥å·²æ˜¾ç¤º', 'success');
            } else {
                log('âŒ UIç®¡ç†å™¨ä¸å¯ç”¨', 'error');
            }
        }

        // æ£€æŸ¥äº‹ä»¶ç®¡ç†å™¨
        function checkEvents() {
            log('ğŸ¯ æ£€æŸ¥äº‹ä»¶ç®¡ç†å™¨...');
            if (window.simpleClient) {
                log(`ğŸ” eventManagerå­˜åœ¨: ${!!window.simpleClient.eventManager}`, 'info');

                if (window.simpleClient.eventManager) {
                    try {
                        const events = window.simpleClient.eventManager.getBoundEvents();
                        updateModuleCard('event-manager', 'success',
                            `å·²ç»‘å®šäº‹ä»¶: ${events.length}ä¸ª`, 'success');
                        log(`âœ… äº‹ä»¶ç®¡ç†å™¨æ­£å¸¸ï¼Œå·²ç»‘å®š${events.length}ä¸ªäº‹ä»¶`, 'success');
                    } catch (error) {
                        updateModuleCard('event-manager', 'error', `äº‹ä»¶ç®¡ç†å™¨é”™è¯¯: ${error.message}`, 'error');
                        log(`âŒ äº‹ä»¶ç®¡ç†å™¨è°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
                    }
                } else {
                    updateModuleCard('event-manager', 'error', 'äº‹ä»¶ç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                    log('âŒ äº‹ä»¶ç®¡ç†å™¨ä¸å¯ç”¨', 'error');
                }
            } else {
                updateModuleCard('event-manager', 'error', 'å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
                log('âŒ å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
            }
        }

        // æµ‹è¯•äº‹ä»¶
        function testEvents() {
            log('ğŸ§ª æµ‹è¯•äº‹ä»¶...');
            if (window.simpleClient && window.simpleClient.eventManager) {
                window.simpleClient.eventManager.triggerEvent('diagnostic-test', { timestamp: Date.now() });
                log('âœ… æµ‹è¯•äº‹ä»¶å·²è§¦å‘', 'success');
            } else {
                log('âŒ äº‹ä»¶ç®¡ç†å™¨ä¸å¯ç”¨', 'error');
            }
        }

        // è·å–è°ƒè¯•ä¿¡æ¯
        function getDebugInfo() {
            log('ğŸ” è·å–è°ƒè¯•ä¿¡æ¯...');
            if (window.simpleClient) {
                log(`ğŸ” debugManagerå­˜åœ¨: ${!!window.simpleClient.debugManager}`, 'info');

                if (window.simpleClient.debugManager) {
                    try {
                        const status = window.simpleClient.debugManager.getClientStatus();
                        updateModuleCard('debug-manager', 'success', 'è°ƒè¯•ç®¡ç†å™¨æ­£å¸¸', 'success');
                        log('âœ… è°ƒè¯•ä¿¡æ¯å·²è·å–', 'success');
                        console.log('è°ƒè¯•çŠ¶æ€:', status);
                    } catch (error) {
                        updateModuleCard('debug-manager', 'error', `è°ƒè¯•ç®¡ç†å™¨é”™è¯¯: ${error.message}`, 'error');
                        log(`âŒ è°ƒè¯•ç®¡ç†å™¨è°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
                    }
                } else {
                    updateModuleCard('debug-manager', 'error', 'è°ƒè¯•ç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                    log('âŒ è°ƒè¯•ç®¡ç†å™¨ä¸å¯ç”¨', 'error');
                }
            } else {
                updateModuleCard('debug-manager', 'error', 'å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
                log('âŒ å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
            }
        }

        // å¯¼å‡ºè°ƒè¯•æ•°æ®
        function exportDebugData() {
            log('ğŸ“¤ å¯¼å‡ºè°ƒè¯•æ•°æ®...');
            if (window.simpleClient && window.simpleClient.debugManager) {
                const status = window.simpleClient.debugManager.getClientStatus();
                const dataStr = JSON.stringify(status, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `debug-data-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                log('âœ… è°ƒè¯•æ•°æ®å·²å¯¼å‡º', 'success');
            } else {
                log('âŒ è°ƒè¯•ç®¡ç†å™¨ä¸å¯ç”¨', 'error');
            }
        }

        // åˆå§‹åŒ–å®¢æˆ·ç«¯
        function initClient() {
            log('ğŸš€ åˆå§‹åŒ–å®¢æˆ·ç«¯...');
            if (window.SimpleWebClient) {
                try {
                    log('ğŸ” åˆ›å»ºSimpleWebClientå®ä¾‹...', 'info');
                    window.simpleClient = new window.SimpleWebClient();

                    // éªŒè¯å®¢æˆ·ç«¯æ˜¯å¦æ­£ç¡®åˆå§‹åŒ–
                    log('ğŸ” éªŒè¯å®¢æˆ·ç«¯åˆå§‹åŒ–...', 'info');
                    log(`ğŸ” simpleClientç±»å‹: ${typeof window.simpleClient}`, 'info');
                    log(`ğŸ” contentManagerå­˜åœ¨: ${!!window.simpleClient.contentManager}`, 'info');
                    log(`ğŸ” wsManagerå­˜åœ¨: ${!!window.simpleClient.wsManager}`, 'info');
                    log(`ğŸ” statusManagerå­˜åœ¨: ${!!window.simpleClient.statusManager}`, 'info');
                    log(`ğŸ” uiManagerå­˜åœ¨: ${!!window.simpleClient.uiManager}`, 'info');
                    log(`ğŸ” eventManagerå­˜åœ¨: ${!!window.simpleClient.eventManager}`, 'info');
                    log(`ğŸ” debugManagerå­˜åœ¨: ${!!window.simpleClient.debugManager}`, 'info');

                    updateModuleCard('simple-client', 'success', 'å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ', 'success');
                    log('âœ… å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ', 'success');
                    setTimeout(runFullDiagnostic, 1000);
                } catch (error) {
                    updateModuleCard('simple-client', 'error', `å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                    log(`âŒ å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                    log(`ğŸ” é”™è¯¯å †æ ˆ: ${error.stack}`, 'error');
                }
            } else {
                updateModuleCard('simple-client', 'error', 'SimpleWebClientç±»ä¸å¯ç”¨', 'error');
                log('âŒ SimpleWebClientç±»ä¸å¯ç”¨', 'error');
            }
        }

        // æ£€æŸ¥å®¢æˆ·ç«¯
        function checkClient() {
            log('ğŸ” æ£€æŸ¥å®¢æˆ·ç«¯...');
            if (window.simpleClient) {
                const wsConnected = window.simpleClient.isConnected();
                const wsState = window.simpleClient.getConnectionState();

                updateModuleCard('simple-client', 'success',
                    `å®¢æˆ·ç«¯æ­£å¸¸ï¼ŒWebSocket: ${wsConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}`, 'success');
                log(`âœ… å®¢æˆ·ç«¯æ­£å¸¸ï¼ŒWebSocketçŠ¶æ€: ${wsState}`, 'success');
            } else {
                updateModuleCard('simple-client', 'error', 'å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
                log('âŒ å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
            }
        }

        // æ¸…ç†å®¢æˆ·ç«¯
        function cleanupClient() {
            log('ğŸ§¹ æ¸…ç†å®¢æˆ·ç«¯...');
            if (window.simpleClient) {
                window.simpleClient.cleanup();
                log('âœ… å®¢æˆ·ç«¯å·²æ¸…ç†', 'success');
            } else {
                log('âŒ å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
            }
        }

        // æµ‹è¯•é”™è¯¯å¤„ç†å™¨
        function testErrorHandler() {
            log('ğŸ§ª æµ‹è¯•é”™è¯¯å¤„ç†å™¨...');
            if (window.ErrorHandler && typeof window.ErrorHandler.handleError === 'function') {
                try {
                    throw new Error('æµ‹è¯•é”™è¯¯');
                } catch (error) {
                    window.ErrorHandler.handleError(error, 'è¯Šæ–­æµ‹è¯•');
                }
                updateModuleCard('error-handler', 'success', 'é”™è¯¯å¤„ç†å™¨æ­£å¸¸', 'success');
                log('âœ… é”™è¯¯å¤„ç†å™¨æµ‹è¯•å®Œæˆ', 'success');
            } else {
                updateModuleCard('error-handler', 'error', 'é”™è¯¯å¤„ç†å™¨æœªæ­£ç¡®åŠ è½½', 'error');
                log('âŒ é”™è¯¯å¤„ç†å™¨ä¸å¯ç”¨æˆ–æ–¹æ³•ç¼ºå¤±', 'error');
                if (window.ErrorHandler) {
                    log(`ğŸ” ErrorHandlerå¯¹è±¡: ${typeof window.ErrorHandler}`, 'info');
                    log(`ğŸ” handleErroræ–¹æ³•: ${typeof window.ErrorHandler.handleError}`, 'info');
                }
            }
        }

        // æ¸…é™¤é”™è¯¯æ—¥å¿—
        function clearErrorLog() {
            log('ğŸ§¹ æ¸…é™¤é”™è¯¯æ—¥å¿—...');
            if (window.ErrorHandler) {
                window.ErrorHandler.clearErrorLog();
                log('âœ… é”™è¯¯æ—¥å¿—å·²æ¸…é™¤', 'success');
            } else {
                log('âŒ é”™è¯¯å¤„ç†å™¨ä¸å¯ç”¨', 'error');
            }
        }

        // æ¸…é™¤æ—¥å¿—
        function clearLog() {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML = '';
            log('ğŸ§¹ è¯Šæ–­æ—¥å¿—å·²æ¸…é™¤', 'info');
        }

        // å¯¼å‡ºæ—¥å¿—
        function exportLog() {
            const logContent = document.getElementById('log').innerText;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `diagnostic-log-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            log('âœ… æ—¥å¿—å·²å¯¼å‡º', 'success');
        }

        // æ£€æŸ¥CursorçŠ¶æ€ç®¡ç†å™¨
        function checkCursorStatus() {
            log('ğŸ” æ£€æŸ¥CursorçŠ¶æ€ç®¡ç†å™¨...');
            if (window.simpleClient && window.simpleClient.cursorStatusManager) {
                try {
                    const status = window.simpleClient.cursorStatusManager.getCursorStatus();
                    const description = window.simpleClient.cursorStatusManager.getStatusDescription();

                    updateModuleCard('cursor-status', 'success',
                        `çŠ¶æ€: ${status.status} - ${description}`, 'success');
                    log(`âœ… CursorçŠ¶æ€ç®¡ç†å™¨æ­£å¸¸ï¼ŒçŠ¶æ€: ${status.status}`, 'success');
                    log(`ğŸ“Š çŠ¶æ€è¯¦æƒ…: ${description}`, 'info');
                } catch (error) {
                    updateModuleCard('cursor-status', 'error', `CursorçŠ¶æ€ç®¡ç†å™¨é”™è¯¯: ${error.message}`, 'error');
                    log(`âŒ CursorçŠ¶æ€ç®¡ç†å™¨è°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
                }
            } else {
                updateModuleCard('cursor-status', 'error', 'CursorçŠ¶æ€ç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                log('âŒ CursorçŠ¶æ€ç®¡ç†å™¨ä¸å¯ç”¨', 'error');
            }
        }

        // æ¨¡æ‹ŸCursoræ´»åŠ¨
        function simulateCursorActivity() {
            log('ğŸ¯ æ¨¡æ‹ŸCursoræ´»åŠ¨...');
            if (window.simpleClient && window.simpleClient.cursorStatusManager) {
                window.simpleClient.cursorStatusManager.simulateCursorActivity();
                updateModuleCard('cursor-status', 'success', 'Cursoræ´»åŠ¨å·²æ¨¡æ‹Ÿ', 'success');
                log('âœ… Cursoræ´»åŠ¨æ¨¡æ‹Ÿå®Œæˆ', 'success');
                setTimeout(checkCursorStatus, 1000);
            } else {
                log('âŒ CursorçŠ¶æ€ç®¡ç†å™¨ä¸å¯ç”¨', 'error');
            }
        }

        // æ¨¡æ‹ŸCursorå…³é—­
        function simulateCursorClose() {
            log('ğŸšª æ¨¡æ‹ŸCursorå…³é—­...');
            if (window.simpleClient && window.simpleClient.cursorStatusManager) {
                window.simpleClient.cursorStatusManager.simulateCursorClose();
                updateModuleCard('cursor-status', 'warning', 'Cursorå…³é—­å·²æ¨¡æ‹Ÿ', 'warning');
                log('âœ… Cursorå…³é—­æ¨¡æ‹Ÿå®Œæˆ', 'success');
                setTimeout(checkCursorStatus, 1000);
            } else {
                log('âŒ CursorçŠ¶æ€ç®¡ç†å™¨ä¸å¯ç”¨', 'error');
            }
        }

        // æ£€æŸ¥é¦–é¡µçŠ¶æ€ç®¡ç†å™¨
        function checkHomePageStatus() {
            log('ğŸ  æ£€æŸ¥é¦–é¡µçŠ¶æ€ç®¡ç†å™¨...');
            if (window.simpleClient && window.simpleClient.homePageStatusManager) {
                try {
                    const status = window.simpleClient.homePageStatusManager.getCurrentStatus();

                    updateModuleCard('home-page-status', 'success',
                        `æ˜¾ç¤º: ${status.displayMessage}`, 'success');
                    log(`âœ… é¦–é¡µçŠ¶æ€ç®¡ç†å™¨æ­£å¸¸ï¼Œæ˜¾ç¤º: ${status.displayMessage}`, 'success');
                    log(`ğŸ“Š WebSocketè¿æ¥: ${status.websocketConnected}`, 'info');
                    log(`ğŸ“Š CursorçŠ¶æ€: ${status.cursorStatus}`, 'info');
                } catch (error) {
                    updateModuleCard('home-page-status', 'error', `é¦–é¡µçŠ¶æ€ç®¡ç†å™¨é”™è¯¯: ${error.message}`, 'error');
                    log(`âŒ é¦–é¡µçŠ¶æ€ç®¡ç†å™¨è°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
                }
            } else {
                updateModuleCard('home-page-status', 'error', 'é¦–é¡µçŠ¶æ€ç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                log('âŒ é¦–é¡µçŠ¶æ€ç®¡ç†å™¨ä¸å¯ç”¨', 'error');
            }
        }

        // å¼ºåˆ¶æ›´æ–°é¦–é¡µçŠ¶æ€
        function forceUpdateHomeStatus() {
            log('ğŸ”„ å¼ºåˆ¶æ›´æ–°é¦–é¡µçŠ¶æ€...');
            if (window.simpleClient && window.simpleClient.homePageStatusManager) {
                window.simpleClient.homePageStatusManager.forceUpdate();
                updateModuleCard('home-page-status', 'success', 'é¦–é¡µçŠ¶æ€å·²å¼ºåˆ¶æ›´æ–°', 'success');
                log('âœ… é¦–é¡µçŠ¶æ€å¼ºåˆ¶æ›´æ–°å®Œæˆ', 'success');
                setTimeout(checkHomePageStatus, 1000);
            } else {
                log('âŒ é¦–é¡µçŠ¶æ€ç®¡ç†å™¨ä¸å¯ç”¨', 'error');
            }
        }

        // æµ‹è¯•çŠ¶æ€åŒæ­¥
        function testStatusSync() {
            log('ğŸ”„ æµ‹è¯•çŠ¶æ€åŒæ­¥...');
            if (window.simpleClient) {
                try {
                    // æ¨¡æ‹ŸçŠ¶æ€å˜åŒ–
                    window.simpleClient.cursorStatusManager.simulateCursorActivity();
                    log('âœ… çŠ¶æ€åŒæ­¥æµ‹è¯•å®Œæˆ', 'success');
                    setTimeout(() => {
                        checkHomePageStatus();
                        checkCursorStatus();
                    }, 1000);
                } catch (error) {
                    log(`âŒ çŠ¶æ€åŒæ­¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                }
            } else {
                log('âŒ å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
            }
        }

        // æ‰“å¼€çŠ¶æ€åŒæ­¥æµ‹è¯•é¡µé¢
        function openStatusSyncTest() {
            log('ğŸ”— æ‰“å¼€çŠ¶æ€åŒæ­¥æµ‹è¯•é¡µé¢...');
            try {
                const testUrl = 'status-sync-test.html';
                window.open(testUrl, '_blank');
                log('âœ… çŠ¶æ€åŒæ­¥æµ‹è¯•é¡µé¢å·²åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€', 'success');
            } catch (error) {
                log(`âŒ æ‰“å¼€æµ‹è¯•é¡µé¢å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•WebSocketè¿æ¥
        function testWebSocketConnection() {
            log('ğŸ”Œ æµ‹è¯•WebSocketè¿æ¥...');
            if (window.simpleClient && window.simpleClient.wsManager) {
                const connected = window.simpleClient.wsManager.isConnected();
                const state = window.simpleClient.wsManager.getConnectionState();

                if (connected) {
                    updateModuleCard('websocket-test', 'success', 'WebSocketå·²è¿æ¥', 'success');
                    log('âœ… WebSocketè¿æ¥æ­£å¸¸', 'success');
                } else {
                    updateModuleCard('websocket-test', 'warning', `WebSocketæœªè¿æ¥ï¼ŒçŠ¶æ€: ${state}`, 'warning');
                    log(`âš ï¸ WebSocketæœªè¿æ¥ï¼ŒçŠ¶æ€: ${state}`, 'warning');
                }
            } else {
                updateModuleCard('websocket-test', 'error', 'WebSocketç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                log('âŒ WebSocketç®¡ç†å™¨ä¸å¯ç”¨', 'error');
            }
        }

        // æµ‹è¯•æ–­å¼€è¿æ¥
        function testDisconnect() {
            log('ğŸ”Œ æµ‹è¯•æ–­å¼€è¿æ¥...');
            if (window.simpleClient && window.simpleClient.wsManager) {
                window.simpleClient.wsManager.manualDisconnect();
                updateModuleCard('websocket-test', 'warning', 'WebSocketå·²æ‰‹åŠ¨æ–­å¼€', 'warning');
                log('âœ… WebSocketæ‰‹åŠ¨æ–­å¼€å®Œæˆ', 'success');
                setTimeout(testWebSocketConnection, 2000);
            } else {
                log('âŒ WebSocketç®¡ç†å™¨ä¸å¯ç”¨', 'error');
            }
        }

        // æµ‹è¯•æ¶ˆæ¯è¾“å…¥
        function testMessageInput() {
            log('ğŸ“ æµ‹è¯•æ¶ˆæ¯è¾“å…¥...');
            if (window.simpleClient) {
                const testMessage = 'è¯Šæ–­æµ‹è¯•æ¶ˆæ¯ - ' + new Date().toLocaleTimeString();
                const success = window.simpleClient.testSendMessage(testMessage);

                if (success) {
                    updateModuleCard('message-test', 'success', 'æµ‹è¯•æ¶ˆæ¯å‘é€æˆåŠŸ', 'success');
                    log('âœ… æµ‹è¯•æ¶ˆæ¯å‘é€æˆåŠŸ', 'success');
                } else {
                    updateModuleCard('message-test', 'warning', 'æµ‹è¯•æ¶ˆæ¯å‘é€å¤±è´¥', 'warning');
                    log('âš ï¸ æµ‹è¯•æ¶ˆæ¯å‘é€å¤±è´¥', 'warning');
                }
            } else {
                updateModuleCard('message-test', 'error', 'å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
                log('âŒ å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
            }
        }

        // è¿è¡Œå®Œæ•´è¯Šæ–­
        function runFullDiagnostic() {
            log('ğŸ” å¼€å§‹å®Œæ•´è¯Šæ–­...', 'info');

            // æ£€æŸ¥å„ä¸ªæ¨¡å—
            checkModuleLoader();
            testErrorHandler();
            testWebSocket();
            checkContent();
            checkStatus();
            testUI();
            checkEvents();
            getDebugInfo();
            checkClient();
            checkCursorStatus();
            checkHomePageStatus();

            // æ›´æ–°æ¦‚è§ˆ
            updateSummary();

            log('âœ… å®Œæ•´è¯Šæ–­å®Œæˆ', 'success');
        }

        // å¼€å§‹è¯Šæ–­
        async function startDiagnostic() {
            log('ğŸš€ å¼€å§‹ç³»ç»Ÿè¯Šæ–­...', 'info');
            clearLog();

            // å…ˆæ£€æŸ¥æ¨¡å—åŠ è½½å™¨
            checkModuleLoader();

            // å¦‚æœæ¨¡å—åŠ è½½å™¨å¯ç”¨ï¼Œå°è¯•åŠ è½½æ¨¡å—
            if (window.ModuleLoader) {
                log('ğŸ“¦ å¼€å§‹åŠ è½½æ¨¡å—...', 'info');
                await loadAllModules();
            } else {
                log('âŒ æ¨¡å—åŠ è½½å™¨ä¸å¯ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
            }
        }

                // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨å¼€å§‹è¯Šæ–­
        window.addEventListener('load', async () => {
            log('ğŸ“„ è¯Šæ–­é¡µé¢åŠ è½½å®Œæˆ', 'info');

            // ç­‰å¾…æ¨¡å—åŠ è½½å™¨å°±ç»ª
            await waitForModuleLoader();

            // å¼€å§‹è¯Šæ–­
            await startDiagnostic();
        });

        // ç›‘å¬å…¨å±€é”™è¯¯
        window.addEventListener('error', (event) => {
            log(`ğŸ”¥ å…¨å±€é”™è¯¯: ${event.error.message}`, 'error');
        });

        window.addEventListener('unhandledrejection', (event) => {
            log(`ğŸ”¥ æœªå¤„ç†çš„Promiseæ‹’ç»: ${event.reason}`, 'error');
        });
    </script>
</body>
</html>
