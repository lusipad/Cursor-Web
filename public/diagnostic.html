<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠŸèƒ½æ¨¡å—è¯Šæ–­</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .diagnostic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .module-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #ddd;
        }
        .module-card.success { border-left-color: #28a745; }
        .module-card.error { border-left-color: #dc3545; }
        .module-card.warning { border-left-color: #ffc107; }
        .module-card.info { border-left-color: #17a2b8; }

        .module-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        .status-info { background-color: #17a2b8; }

        .module-details {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }
        .module-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-info { background-color: #17a2b8; color: white; }

        .log-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        #log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            border-radius: 5px;
        }
        .summary {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .summary-item {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        .summary-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .summary-label {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ” åŠŸèƒ½æ¨¡å—è¯Šæ–­</h1>
        <p>å…¨é¢æ£€æŸ¥ç³»ç»Ÿå„ä¸ªåŠŸèƒ½æ¨¡å—çš„çŠ¶æ€å’Œè¿æ¥æƒ…å†µ</p>
    </div>

    <div class="summary">
        <h3>ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ</h3>
        <div class="summary-grid">
            <div class="summary-item">
                <div class="summary-number" id="total-modules">0</div>
                <div class="summary-label">æ€»æ¨¡å—æ•°</div>
            </div>
            <div class="summary-item">
                <div class="summary-number" id="loaded-modules">0</div>
                <div class="summary-label">å·²åŠ è½½æ¨¡å—</div>
            </div>
            <div class="summary-item">
                <div class="summary-number" id="ws-status">âŒ</div>
                <div class="summary-label">WebSocketçŠ¶æ€</div>
            </div>
            <div class="summary-item">
                <div class="summary-number" id="client-status">âŒ</div>
                <div class="summary-label">å®¢æˆ·ç«¯çŠ¶æ€</div>
            </div>
        </div>
    </div>

    <div class="diagnostic-grid">
        <!-- æ¨¡å—åŠ è½½å™¨ -->
        <div class="module-card" id="module-loader-card">
            <div class="module-title">
                <span class="status-indicator" id="module-loader-status"></span>
                æ¨¡å—åŠ è½½å™¨
            </div>
            <div class="module-details" id="module-loader-details">æ£€æŸ¥ä¸­...</div>
            <div class="module-actions">
                <button class="btn btn-primary" onclick="checkModuleLoader()">æ£€æŸ¥åŠ è½½å™¨</button>
                <button class="btn btn-success" onclick="loadAllModules()">åŠ è½½æ‰€æœ‰æ¨¡å—</button>
            </div>
        </div>

        <!-- é”™è¯¯å¤„ç†å™¨ -->
        <div class="module-card" id="error-handler-card">
            <div class="module-title">
                <span class="status-indicator" id="error-handler-status"></span>
                é”™è¯¯å¤„ç†å™¨
            </div>
            <div class="module-details" id="error-handler-details">æ£€æŸ¥ä¸­...</div>
            <div class="module-actions">
                <button class="btn btn-info" onclick="testErrorHandler()">æµ‹è¯•é”™è¯¯å¤„ç†</button>
                <button class="btn btn-warning" onclick="clearErrorLog()">æ¸…é™¤é”™è¯¯æ—¥å¿—</button>
            </div>
        </div>

        <!-- WebSocketç®¡ç†å™¨ -->
        <div class="module-card" id="websocket-card">
            <div class="module-title">
                <span class="status-indicator" id="websocket-status"></span>
                WebSocketç®¡ç†å™¨
            </div>
            <div class="module-details" id="websocket-details">æ£€æŸ¥ä¸­...</div>
            <div class="module-actions">
                <button class="btn btn-success" onclick="testWebSocket()">æµ‹è¯•è¿æ¥</button>
                <button class="btn btn-warning" onclick="reconnectWebSocket()">é‡æ–°è¿æ¥</button>
                <button class="btn btn-info" onclick="sendTestMessage()">å‘é€æµ‹è¯•æ¶ˆæ¯</button>
            </div>
        </div>

        <!-- å†…å®¹ç®¡ç†å™¨ -->
        <div class="module-card" id="content-manager-card">
            <div class="module-title">
                <span class="status-indicator" id="content-manager-status"></span>
                å†…å®¹ç®¡ç†å™¨
            </div>
            <div class="module-details" id="content-manager-details">æ£€æŸ¥ä¸­...</div>
            <div class="module-actions">
                <button class="btn btn-info" onclick="checkContent()">æ£€æŸ¥å†…å®¹</button>
                <button class="btn btn-warning" onclick="clearContent()">æ¸…é™¤å†…å®¹</button>
            </div>
        </div>

        <!-- çŠ¶æ€ç®¡ç†å™¨ -->
        <div class="module-card" id="status-manager-card">
            <div class="module-title">
                <span class="status-indicator" id="status-manager-status"></span>
                çŠ¶æ€ç®¡ç†å™¨
            </div>
            <div class="module-details" id="status-manager-details">æ£€æŸ¥ä¸­...</div>
            <div class="module-actions">
                <button class="btn btn-info" onclick="checkStatus()">æ£€æŸ¥çŠ¶æ€</button>
                <button class="btn btn-warning" onclick="startStatusCheck()">å¼€å§‹çŠ¶æ€æ£€æŸ¥</button>
            </div>
        </div>

        <!-- UIç®¡ç†å™¨ -->
        <div class="module-card" id="ui-manager-card">
            <div class="module-title">
                <span class="status-indicator" id="ui-manager-status"></span>
                UIç®¡ç†å™¨
            </div>
            <div class="module-details" id="ui-manager-details">æ£€æŸ¥ä¸­...</div>
            <div class="module-actions">
                <button class="btn btn-info" onclick="testUI()">æµ‹è¯•UIæ›´æ–°</button>
                <button class="btn btn-warning" onclick="showNotification()">æ˜¾ç¤ºé€šçŸ¥</button>
            </div>
        </div>

        <!-- äº‹ä»¶ç®¡ç†å™¨ -->
        <div class="module-card" id="event-manager-card">
            <div class="module-title">
                <span class="status-indicator" id="event-manager-status"></span>
                äº‹ä»¶ç®¡ç†å™¨
            </div>
            <div class="module-details" id="event-manager-details">æ£€æŸ¥ä¸­...</div>
            <div class="module-actions">
                <button class="btn btn-info" onclick="checkEvents()">æ£€æŸ¥äº‹ä»¶</button>
                <button class="btn btn-warning" onclick="testEvents()">æµ‹è¯•äº‹ä»¶</button>
            </div>
        </div>

        <!-- è°ƒè¯•ç®¡ç†å™¨ -->
        <div class="module-card" id="debug-manager-card">
            <div class="module-title">
                <span class="status-indicator" id="debug-manager-status"></span>
                è°ƒè¯•ç®¡ç†å™¨
            </div>
            <div class="module-details" id="debug-manager-details">æ£€æŸ¥ä¸­...</div>
            <div class="module-actions">
                <button class="btn btn-info" onclick="getDebugInfo()">è·å–è°ƒè¯•ä¿¡æ¯</button>
                <button class="btn btn-warning" onclick="exportDebugData()">å¯¼å‡ºè°ƒè¯•æ•°æ®</button>
            </div>
        </div>

        <!-- ä¸»å®¢æˆ·ç«¯ -->
        <div class="module-card" id="simple-client-card">
            <div class="module-title">
                <span class="status-indicator" id="simple-client-status"></span>
                ä¸»å®¢æˆ·ç«¯
            </div>
            <div class="module-details" id="simple-client-details">æ£€æŸ¥ä¸­...</div>
            <div class="module-actions">
                <button class="btn btn-success" onclick="initClient()">åˆå§‹åŒ–å®¢æˆ·ç«¯</button>
                <button class="btn btn-info" onclick="checkClient()">æ£€æŸ¥å®¢æˆ·ç«¯</button>
                <button class="btn btn-warning" onclick="cleanupClient()">æ¸…ç†å®¢æˆ·ç«¯</button>
            </div>
        </div>
    </div>

    <div class="log-section">
        <div class="log-header">
            <h3>ğŸ“ è¯Šæ–­æ—¥å¿—</h3>
            <div>
                <button class="btn btn-primary" onclick="startDiagnostic()">å¼€å§‹è¯Šæ–­</button>
                <button class="btn btn-warning" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
                <button class="btn btn-info" onclick="exportLog()">å¯¼å‡ºæ—¥å¿—</button>
            </div>
        </div>
        <div id="log"></div>
        </div>

    <script src="js/modules/module-loader.js"></script>
    <script>
        // æ—¥å¿—åŠŸèƒ½
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = {
                'info': 'â„¹ï¸',
                'success': 'âœ…',
                'warning': 'âš ï¸',
                'error': 'âŒ'
            };
            logDiv.innerHTML += `[${timestamp}] ${typeIcon[type]} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        // æ›´æ–°æ¨¡å—å¡ç‰‡çŠ¶æ€
        function updateModuleCard(moduleId, status, details, className = 'info') {
            const card = document.getElementById(`${moduleId}-card`);
            const statusIndicator = document.getElementById(`${moduleId}-status`);
            const detailsElement = document.getElementById(`${moduleId}-details`);

            card.className = `module-card ${className}`;
            statusIndicator.className = `status-indicator status-${className}`;
            detailsElement.textContent = details;
        }

        // æ›´æ–°æ¦‚è§ˆ
        function updateSummary() {
            const modules = ['ErrorHandler', 'WebSocketManager', 'ContentManager', 'StatusManager', 'UIManager', 'EventManager', 'DebugManager'];
            const loadedModules = modules.filter(m => window[m]).length;

            document.getElementById('total-modules').textContent = modules.length;
            document.getElementById('loaded-modules').textContent = loadedModules;

            if (window.simpleClient && window.simpleClient.wsManager && window.simpleClient.wsManager.isConnected()) {
                document.getElementById('ws-status').textContent = 'âœ…';
            } else {
                document.getElementById('ws-status').textContent = 'âŒ';
            }

            if (window.simpleClient) {
                document.getElementById('client-status').textContent = 'âœ…';
            } else {
                document.getElementById('client-status').textContent = 'âŒ';
            }
        }

        // æ£€æŸ¥æ¨¡å—åŠ è½½å™¨
        function checkModuleLoader() {
            log('ğŸ” æ£€æŸ¥æ¨¡å—åŠ è½½å™¨...');
            if (window.ModuleLoader) {
                const status = window.ModuleLoader.getLoadStatus();
                updateModuleCard('module-loader', 'success',
                    `å·²åŠ è½½: ${status.loadedModules.length}/${status.totalModules}`, 'success');
                log('âœ… æ¨¡å—åŠ è½½å™¨æ­£å¸¸', 'success');
                log(`ğŸ“Š åŠ è½½çŠ¶æ€: ${status.loadedModules.join(', ')}`, 'info');
            } else {
                updateModuleCard('module-loader', 'error', 'æ¨¡å—åŠ è½½å™¨æœªåŠ è½½', 'error');
                log('âŒ æ¨¡å—åŠ è½½å™¨æœªæ‰¾åˆ°', 'error');
            }
        }

        // åŠ è½½æ‰€æœ‰æ¨¡å—
        async function loadAllModules() {
            log('ğŸ“¦ å¼€å§‹åŠ è½½æ‰€æœ‰æ¨¡å—...');
            if (window.ModuleLoader) {
                try {
                    await window.ModuleLoader.loadAllModules();
                    log('âœ… æ‰€æœ‰æ¨¡å—åŠ è½½å®Œæˆ', 'success');

                    // æ£€æŸ¥æ¨¡å—å¯ç”¨æ€§
                    if (window.ModuleLoader.checkModulesAvailability()) {
                        log('âœ… æ‰€æœ‰æ¨¡å—å¯ç”¨', 'success');

                        // åŠ è½½ä¸»å®¢æˆ·ç«¯
                        if (!window.SimpleWebClient) {
                            log('ğŸ“¦ åŠ è½½ä¸»å®¢æˆ·ç«¯...', 'info');
                            window.ModuleLoader.loadModule('SimpleWebClient').then(() => {
                                log('âœ… SimpleWebClient åŠ è½½å®Œæˆ', 'success');
                                if (window.SimpleWebClient && !window.simpleClient) {
                                    log('ğŸš€ åˆå§‹åŒ–å®¢æˆ·ç«¯...', 'info');
                                    window.simpleClient = new window.SimpleWebClient();
                                }
                                setTimeout(runFullDiagnostic, 1000);
                            }).catch(error => {
                                log(`âŒ SimpleWebClient åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                            });
                        } else {
                            setTimeout(runFullDiagnostic, 1000);
                        }
                    } else {
                        log('âŒ éƒ¨åˆ†æ¨¡å—ä¸å¯ç”¨', 'error');
                    }
                } catch (error) {
                    log(`âŒ æ¨¡å—åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                }
            } else {
                log('âŒ æ¨¡å—åŠ è½½å™¨ä¸å¯ç”¨', 'error');
            }
        }

        // æµ‹è¯•WebSocket
        function testWebSocket() {
            log('ğŸ”Œ æµ‹è¯•WebSocketè¿æ¥...');
            if (window.simpleClient && window.simpleClient.wsManager) {
                const state = window.simpleClient.wsManager.getConnectionState();
                const connected = window.simpleClient.wsManager.isConnected();

                if (connected) {
                    updateModuleCard('websocket', 'success', 'WebSocketå·²è¿æ¥', 'success');
                    log('âœ… WebSocketè¿æ¥æ­£å¸¸', 'success');
                } else {
                    updateModuleCard('websocket', 'warning', `WebSocketçŠ¶æ€: ${state}`, 'warning');
                    log(`âš ï¸ WebSocketæœªè¿æ¥ï¼ŒçŠ¶æ€: ${state}`, 'warning');
                }
            } else {
                updateModuleCard('websocket', 'error', 'WebSocketç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                log('âŒ WebSocketç®¡ç†å™¨ä¸å¯ç”¨', 'error');
            }
        }

        // é‡æ–°è¿æ¥WebSocket
        function reconnectWebSocket() {
            log('ğŸ”„ é‡æ–°è¿æ¥WebSocket...');
            if (window.simpleClient && window.simpleClient.wsManager) {
                window.simpleClient.wsManager.manualReconnect();
                log('ğŸ”„ WebSocketé‡è¿å·²è§¦å‘', 'info');
                setTimeout(testWebSocket, 2000);
            } else {
                log('âŒ WebSocketç®¡ç†å™¨ä¸å¯ç”¨', 'error');
            }
        }

        // å‘é€æµ‹è¯•æ¶ˆæ¯
        function sendTestMessage() {
            log('ğŸ“¤ å‘é€æµ‹è¯•æ¶ˆæ¯...');
            if (window.simpleClient) {
                const success = window.simpleClient.testSendMessage('è¯Šæ–­æµ‹è¯•æ¶ˆæ¯');
                if (success) {
                    log('âœ… æµ‹è¯•æ¶ˆæ¯å‘é€æˆåŠŸ', 'success');
                } else {
                    log('âŒ æµ‹è¯•æ¶ˆæ¯å‘é€å¤±è´¥', 'error');
                }
            } else {
                log('âŒ å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
            }
        }

        // æ£€æŸ¥å†…å®¹ç®¡ç†å™¨
        function checkContent() {
            log('ğŸ“„ æ£€æŸ¥å†…å®¹ç®¡ç†å™¨...');
            if (window.simpleClient && window.simpleClient.contentManager) {
                const hasContent = window.simpleClient.contentManager.hasReceivedContent();
                const currentContent = window.simpleClient.contentManager.getCurrentContent();

                updateModuleCard('content-manager', 'success',
                    `å†…å®¹çŠ¶æ€: ${hasContent ? 'æœ‰å†…å®¹' : 'æ— å†…å®¹'}`, 'success');
                log(`âœ… å†…å®¹ç®¡ç†å™¨æ­£å¸¸ï¼Œå†…å®¹é•¿åº¦: ${currentContent ? currentContent.length : 0}`, 'success');
            } else {
                updateModuleCard('content-manager', 'error', 'å†…å®¹ç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                log('âŒ å†…å®¹ç®¡ç†å™¨ä¸å¯ç”¨', 'error');
            }
        }

        // æ¸…é™¤å†…å®¹
        function clearContent() {
            log('ğŸ§¹ æ¸…é™¤å†…å®¹...');
            if (window.simpleClient) {
                window.simpleClient.forceClear();
                log('âœ… å†…å®¹å·²æ¸…é™¤', 'success');
                setTimeout(checkContent, 1000);
            } else {
                log('âŒ å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
            }
        }

        // æ£€æŸ¥çŠ¶æ€ç®¡ç†å™¨
        function checkStatus() {
            log('ğŸ“Š æ£€æŸ¥çŠ¶æ€ç®¡ç†å™¨...');
            if (window.simpleClient && window.simpleClient.statusManager) {
                updateModuleCard('status-manager', 'success', 'çŠ¶æ€ç®¡ç†å™¨æ­£å¸¸', 'success');
                log('âœ… çŠ¶æ€ç®¡ç†å™¨æ­£å¸¸', 'success');
            } else {
                updateModuleCard('status-manager', 'error', 'çŠ¶æ€ç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                log('âŒ çŠ¶æ€ç®¡ç†å™¨ä¸å¯ç”¨', 'error');
            }
        }

        // å¼€å§‹çŠ¶æ€æ£€æŸ¥
        function startStatusCheck() {
            log('ğŸ”„ å¼€å§‹çŠ¶æ€æ£€æŸ¥...');
            if (window.simpleClient && window.simpleClient.statusManager) {
                window.simpleClient.statusManager.startStatusCheck();
                log('âœ… çŠ¶æ€æ£€æŸ¥å·²å¯åŠ¨', 'success');
            } else {
                log('âŒ çŠ¶æ€ç®¡ç†å™¨ä¸å¯ç”¨', 'error');
            }
        }

        // æµ‹è¯•UIç®¡ç†å™¨
        function testUI() {
            log('ğŸ¨ æµ‹è¯•UIç®¡ç†å™¨...');
            if (window.simpleClient && window.simpleClient.uiManager) {
                window.simpleClient.uiManager.updateStatus('UIæµ‹è¯• - æ­£å¸¸', 'info');
                updateModuleCard('ui-manager', 'success', 'UIç®¡ç†å™¨æ­£å¸¸', 'success');
                log('âœ… UIç®¡ç†å™¨æ­£å¸¸', 'success');
            } else {
                updateModuleCard('ui-manager', 'error', 'UIç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                log('âŒ UIç®¡ç†å™¨ä¸å¯ç”¨', 'error');
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification() {
            log('ğŸ”” æ˜¾ç¤ºé€šçŸ¥...');
            if (window.simpleClient && window.simpleClient.uiManager) {
                window.simpleClient.uiManager.showNotification('è¯Šæ–­é€šçŸ¥', 'info');
                log('âœ… é€šçŸ¥å·²æ˜¾ç¤º', 'success');
            } else {
                log('âŒ UIç®¡ç†å™¨ä¸å¯ç”¨', 'error');
            }
        }

        // æ£€æŸ¥äº‹ä»¶ç®¡ç†å™¨
        function checkEvents() {
            log('ğŸ¯ æ£€æŸ¥äº‹ä»¶ç®¡ç†å™¨...');
            if (window.simpleClient && window.simpleClient.eventManager) {
                const events = window.simpleClient.eventManager.getBoundEvents();
                updateModuleCard('event-manager', 'success',
                    `å·²ç»‘å®šäº‹ä»¶: ${events.length}ä¸ª`, 'success');
                log(`âœ… äº‹ä»¶ç®¡ç†å™¨æ­£å¸¸ï¼Œå·²ç»‘å®š${events.length}ä¸ªäº‹ä»¶`, 'success');
            } else {
                updateModuleCard('event-manager', 'error', 'äº‹ä»¶ç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                log('âŒ äº‹ä»¶ç®¡ç†å™¨ä¸å¯ç”¨', 'error');
            }
        }

        // æµ‹è¯•äº‹ä»¶
        function testEvents() {
            log('ğŸ§ª æµ‹è¯•äº‹ä»¶...');
            if (window.simpleClient && window.simpleClient.eventManager) {
                window.simpleClient.eventManager.triggerEvent('diagnostic-test', { timestamp: Date.now() });
                log('âœ… æµ‹è¯•äº‹ä»¶å·²è§¦å‘', 'success');
            } else {
                log('âŒ äº‹ä»¶ç®¡ç†å™¨ä¸å¯ç”¨', 'error');
            }
        }

        // è·å–è°ƒè¯•ä¿¡æ¯
        function getDebugInfo() {
            log('ğŸ” è·å–è°ƒè¯•ä¿¡æ¯...');
            if (window.simpleClient && window.simpleClient.debugManager) {
                const status = window.simpleClient.debugManager.getClientStatus();
                updateModuleCard('debug-manager', 'success', 'è°ƒè¯•ç®¡ç†å™¨æ­£å¸¸', 'success');
                log('âœ… è°ƒè¯•ä¿¡æ¯å·²è·å–', 'success');
                console.log('è°ƒè¯•çŠ¶æ€:', status);
            } else {
                updateModuleCard('debug-manager', 'error', 'è°ƒè¯•ç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                log('âŒ è°ƒè¯•ç®¡ç†å™¨ä¸å¯ç”¨', 'error');
            }
        }

        // å¯¼å‡ºè°ƒè¯•æ•°æ®
        function exportDebugData() {
            log('ğŸ“¤ å¯¼å‡ºè°ƒè¯•æ•°æ®...');
            if (window.simpleClient && window.simpleClient.debugManager) {
                const status = window.simpleClient.debugManager.getClientStatus();
                const dataStr = JSON.stringify(status, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `debug-data-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                log('âœ… è°ƒè¯•æ•°æ®å·²å¯¼å‡º', 'success');
            } else {
                log('âŒ è°ƒè¯•ç®¡ç†å™¨ä¸å¯ç”¨', 'error');
            }
        }

        // åˆå§‹åŒ–å®¢æˆ·ç«¯
        function initClient() {
            log('ğŸš€ åˆå§‹åŒ–å®¢æˆ·ç«¯...');
            if (window.SimpleWebClient) {
                window.simpleClient = new window.SimpleWebClient();
                log('âœ… å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ', 'success');
                setTimeout(runFullDiagnostic, 1000);
            } else {
                log('âŒ SimpleWebClientç±»ä¸å¯ç”¨', 'error');
            }
        }

        // æ£€æŸ¥å®¢æˆ·ç«¯
        function checkClient() {
            log('ğŸ” æ£€æŸ¥å®¢æˆ·ç«¯...');
            if (window.simpleClient) {
                const wsConnected = window.simpleClient.isConnected();
                const wsState = window.simpleClient.getConnectionState();

                updateModuleCard('simple-client', 'success',
                    `å®¢æˆ·ç«¯æ­£å¸¸ï¼ŒWebSocket: ${wsConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}`, 'success');
                log(`âœ… å®¢æˆ·ç«¯æ­£å¸¸ï¼ŒWebSocketçŠ¶æ€: ${wsState}`, 'success');
            } else {
                updateModuleCard('simple-client', 'error', 'å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
                log('âŒ å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
            }
        }

        // æ¸…ç†å®¢æˆ·ç«¯
        function cleanupClient() {
            log('ğŸ§¹ æ¸…ç†å®¢æˆ·ç«¯...');
            if (window.simpleClient) {
                window.simpleClient.cleanup();
                log('âœ… å®¢æˆ·ç«¯å·²æ¸…ç†', 'success');
            } else {
                log('âŒ å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
            }
        }

        // æµ‹è¯•é”™è¯¯å¤„ç†å™¨
        function testErrorHandler() {
            log('ğŸ§ª æµ‹è¯•é”™è¯¯å¤„ç†å™¨...');
            if (window.ErrorHandler && typeof window.ErrorHandler.handleError === 'function') {
                try {
                    throw new Error('æµ‹è¯•é”™è¯¯');
                } catch (error) {
                    window.ErrorHandler.handleError(error, 'è¯Šæ–­æµ‹è¯•');
                }
                updateModuleCard('error-handler', 'success', 'é”™è¯¯å¤„ç†å™¨æ­£å¸¸', 'success');
                log('âœ… é”™è¯¯å¤„ç†å™¨æµ‹è¯•å®Œæˆ', 'success');
            } else {
                updateModuleCard('error-handler', 'error', 'é”™è¯¯å¤„ç†å™¨æœªæ­£ç¡®åŠ è½½', 'error');
                log('âŒ é”™è¯¯å¤„ç†å™¨ä¸å¯ç”¨æˆ–æ–¹æ³•ç¼ºå¤±', 'error');
                if (window.ErrorHandler) {
                    log(`ğŸ” ErrorHandlerå¯¹è±¡: ${typeof window.ErrorHandler}`, 'info');
                    log(`ğŸ” handleErroræ–¹æ³•: ${typeof window.ErrorHandler.handleError}`, 'info');
                }
            }
        }

        // æ¸…é™¤é”™è¯¯æ—¥å¿—
        function clearErrorLog() {
            log('ğŸ§¹ æ¸…é™¤é”™è¯¯æ—¥å¿—...');
            if (window.ErrorHandler) {
                window.ErrorHandler.clearErrorLog();
                log('âœ… é”™è¯¯æ—¥å¿—å·²æ¸…é™¤', 'success');
            } else {
                log('âŒ é”™è¯¯å¤„ç†å™¨ä¸å¯ç”¨', 'error');
            }
        }

        // æ¸…é™¤æ—¥å¿—
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('ğŸ§¹ è¯Šæ–­æ—¥å¿—å·²æ¸…é™¤', 'info');
        }

        // å¯¼å‡ºæ—¥å¿—
        function exportLog() {
            const logContent = document.getElementById('log').innerText;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `diagnostic-log-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            log('âœ… æ—¥å¿—å·²å¯¼å‡º', 'success');
        }

        // è¿è¡Œå®Œæ•´è¯Šæ–­
        function runFullDiagnostic() {
            log('ğŸ” å¼€å§‹å®Œæ•´è¯Šæ–­...', 'info');

            // æ£€æŸ¥å„ä¸ªæ¨¡å—
            checkModuleLoader();
            testErrorHandler();
            testWebSocket();
            checkContent();
            checkStatus();
            testUI();
            checkEvents();
            getDebugInfo();
            checkClient();

            // æ›´æ–°æ¦‚è§ˆ
            updateSummary();

            log('âœ… å®Œæ•´è¯Šæ–­å®Œæˆ', 'success');
        }

        // å¼€å§‹è¯Šæ–­
        function startDiagnostic() {
            log('ğŸš€ å¼€å§‹ç³»ç»Ÿè¯Šæ–­...', 'info');
            clearLog();

            // å…ˆæ£€æŸ¥æ¨¡å—åŠ è½½å™¨
            checkModuleLoader();

            // å¦‚æœæ¨¡å—åŠ è½½å™¨å¯ç”¨ï¼Œå°è¯•åŠ è½½æ¨¡å—
            if (window.ModuleLoader) {
                setTimeout(loadAllModules, 500);
            } else {
                log('âŒ æ¨¡å—åŠ è½½å™¨ä¸å¯ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨å¼€å§‹è¯Šæ–­
        window.addEventListener('load', () => {
            log('ğŸ“„ è¯Šæ–­é¡µé¢åŠ è½½å®Œæˆ', 'info');
            setTimeout(startDiagnostic, 1000);
        });

        // ç›‘å¬å…¨å±€é”™è¯¯
        window.addEventListener('error', (event) => {
            log(`ğŸ”¥ å…¨å±€é”™è¯¯: ${event.error.message}`, 'error');
        });

        window.addEventListener('unhandledrejection', (event) => {
            log(`ğŸ”¥ æœªå¤„ç†çš„Promiseæ‹’ç»: ${event.reason}`, 'error');
        });
    </script>
</body>
</html>
