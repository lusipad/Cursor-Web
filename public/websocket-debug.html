<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket è¿æ¥è°ƒè¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        .success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.connected { background: #d4edda; color: #155724; }
        .status.connecting { background: #fff3cd; color: #856404; }
        .status.disconnected { background: #f8d7da; color: #721c24; }
        .status.error { background: #f5c6cb; color: #721c24; }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>ğŸ”Œ WebSocket è¿æ¥è°ƒè¯•å·¥å…·</h1>
        
        <div class="section">
            <h3>1. è¿æ¥ä¿¡æ¯</h3>
            <div id="connection-info"></div>
            <button onclick="updateConnectionInfo()">åˆ·æ–°è¿æ¥ä¿¡æ¯</button>
        </div>
        
        <div class="section">
            <h3>2. ç›´æ¥ WebSocket æµ‹è¯•</h3>
            <button onclick="testDirectWebSocket()">æµ‹è¯•ç›´æ¥è¿æ¥</button>
            <button onclick="closeDirectWebSocket()">å…³é—­è¿æ¥</button>
            <div id="direct-ws-result" class="result" style="display:none;"></div>
        </div>
        
        <div class="section">
            <h3>3. SimpleWebClient WebSocket æµ‹è¯•</h3>
            <button onclick="testSimpleClientWebSocket()">æµ‹è¯• SimpleClient è¿æ¥</button>
            <button onclick="reconnectSimpleClient()">é‡æ–°è¿æ¥</button>
            <div id="simple-client-result" class="result" style="display:none;"></div>
        </div>
        
        <div class="section">
            <h3>4. å‘é€æ¶ˆæ¯æµ‹è¯•</h3>
            <input type="text" id="test-message" placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯" value="WebSocket è¿æ¥æµ‹è¯•" style="width: 300px; padding: 8px; margin-right: 10px;">
            <button onclick="sendTestMessage()">å‘é€æµ‹è¯•æ¶ˆæ¯</button>
            <div id="send-message-result" class="result" style="display:none;"></div>
        </div>
        
        <div class="section">
            <h3>5. å®æ—¶æ—¥å¿—</h3>
            <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
            <button onclick="toggleAutoScroll()">åˆ‡æ¢è‡ªåŠ¨æ»šåŠ¨</button>
            <div id="logs" class="result"></div>
        </div>
    </div>

    <!-- åŠ è½½å¿…è¦çš„è„šæœ¬ -->
    <script src="js/modules/module-loader.js"></script>
    
    <script>
        let directWs = null;
        let autoScroll = true;
        let logCount = 0;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('logs');
            const logEntry = `[${timestamp}] ${message}\n`;
            logElement.textContent += logEntry;
            
            if (autoScroll) {
                logElement.scrollTop = logElement.scrollHeight;
            }
            
            logCount++;
            if (logCount > 1000) {
                const lines = logElement.textContent.split('\n');
                logElement.textContent = lines.slice(-500).join('\n');
                logCount = 500;
            }
            
            console.log(`[WebSocket Debug] ${message}`);
        }
        
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `result ${type}`;
            element.textContent = message;
        }
        
        function updateConnectionInfo() {
            const info = {
                'URL': window.location.href,
                'åè®®': window.location.protocol,
                'ä¸»æœº': window.location.hostname,
                'ç«¯å£': window.location.port || 'é»˜è®¤',
                'WebSocket URL': getWebSocketUrl()
            };
            
            let html = '';
            for (const [key, value] of Object.entries(info)) {
                html += `<strong>${key}:</strong> ${value}<br>`;
            }
            
            document.getElementById('connection-info').innerHTML = html;
            log('è¿æ¥ä¿¡æ¯å·²æ›´æ–°');
        }
        
        function getWebSocketUrl() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.hostname;
            const port = window.location.port || '3000';
            return `${protocol}//${host}:${port}`;
        }
        
        function testDirectWebSocket() {
            log('å¼€å§‹ç›´æ¥ WebSocket è¿æ¥æµ‹è¯•...');
            
            if (directWs) {
                directWs.close();
                directWs = null;
            }
            
            const wsUrl = getWebSocketUrl();
            log(`å°è¯•è¿æ¥åˆ°: ${wsUrl}`);
            
            try {
                directWs = new WebSocket(wsUrl);
                
                directWs.onopen = () => {
                    log('âœ… ç›´æ¥ WebSocket è¿æ¥æˆåŠŸ');
                    showResult('direct-ws-result', 'âœ… WebSocket è¿æ¥æˆåŠŸ', 'success');
                    
                    // å‘é€æ³¨å†Œæ¶ˆæ¯
                    const registerMsg = {
                        type: 'register',
                        role: 'web',
                        instanceId: 'debug-test'
                    };
                    directWs.send(JSON.stringify(registerMsg));
                    log('å·²å‘é€æ³¨å†Œæ¶ˆæ¯');
                };
                
                directWs.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        log(`ğŸ“¥ æ”¶åˆ°æ¶ˆæ¯: ${data.type} - ${JSON.stringify(data)}`);
                    } catch (e) {
                        log(`ğŸ“¥ æ”¶åˆ°åŸå§‹æ¶ˆæ¯: ${event.data}`);
                    }
                };
                
                directWs.onclose = (event) => {
                    log(`âŒ WebSocket è¿æ¥å…³é—­: code=${event.code}, reason=${event.reason}`);
                    showResult('direct-ws-result', `âŒ è¿æ¥å…³é—­: ${event.code} - ${event.reason}`, 'error');
                };
                
                directWs.onerror = (error) => {
                    log(`âš ï¸ WebSocket é”™è¯¯: ${error}`);
                    showResult('direct-ws-result', `âš ï¸ è¿æ¥é”™è¯¯: ${error}`, 'error');
                };
                
                // è¿æ¥è¶…æ—¶æ£€æµ‹
                setTimeout(() => {
                    if (directWs && directWs.readyState === WebSocket.CONNECTING) {
                        log('â° è¿æ¥è¶…æ—¶');
                        directWs.close();
                        showResult('direct-ws-result', 'â° è¿æ¥è¶…æ—¶', 'error');
                    }
                }, 10000);
                
            } catch (error) {
                log(`âŒ åˆ›å»º WebSocket å¤±è´¥: ${error.message}`);
                showResult('direct-ws-result', `âŒ åˆ›å»ºå¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function closeDirectWebSocket() {
            if (directWs) {
                directWs.close();
                directWs = null;
                log('ç›´æ¥ WebSocket è¿æ¥å·²å…³é—­');
                showResult('direct-ws-result', 'è¿æ¥å·²æ‰‹åŠ¨å…³é—­', 'warning');
            } else {
                log('æ²¡æœ‰æ´»åŠ¨çš„ç›´æ¥ WebSocket è¿æ¥');
            }
        }
        
        function testSimpleClientWebSocket() {
            log('æµ‹è¯• SimpleWebClient WebSocket è¿æ¥...');
            
            if (!window.simpleClient) {
                log('âŒ SimpleWebClient æœªåˆå§‹åŒ–');
                showResult('simple-client-result', 'âŒ SimpleWebClient æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            if (!window.simpleClient.wsManager) {
                log('âŒ WebSocketManager æœªåˆå§‹åŒ–');
                showResult('simple-client-result', 'âŒ WebSocketManager æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            const wsManager = window.simpleClient.wsManager;
            const connectionState = wsManager.getConnectionState ? wsManager.getConnectionState() : 'æœªçŸ¥';
            const isConnected = wsManager.isConnected ? wsManager.isConnected() : false;
            
            log(`WebSocket çŠ¶æ€: ${connectionState}`);
            log(`æ˜¯å¦å·²è¿æ¥: ${isConnected}`);
            
            const result = `çŠ¶æ€: ${connectionState}\nå·²è¿æ¥: ${isConnected}\né‡è¿æ¬¡æ•°: ${wsManager.reconnectAttempts || 0}`;
            
            if (isConnected) {
                showResult('simple-client-result', `âœ… ${result}`, 'success');
            } else {
                showResult('simple-client-result', `âš ï¸ ${result}`, 'warning');
            }
        }
        
        function reconnectSimpleClient() {
            log('å°è¯•é‡æ–°è¿æ¥ SimpleWebClient WebSocket...');
            
            if (!window.simpleClient || !window.simpleClient.wsManager) {
                log('âŒ SimpleWebClient æˆ– WebSocketManager æœªåˆå§‹åŒ–');
                showResult('simple-client-result', 'âŒ å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            try {
                if (window.simpleClient.wsManager.manualReconnect) {
                    window.simpleClient.wsManager.manualReconnect();
                    log('âœ… é‡è¿è¯·æ±‚å·²å‘é€');
                    showResult('simple-client-result', 'ğŸ”„ é‡è¿ä¸­...', 'warning');
                    
                    // 2ç§’åæ£€æŸ¥è¿æ¥çŠ¶æ€
                    setTimeout(() => {
                        testSimpleClientWebSocket();
                    }, 2000);
                } else if (window.simpleClient.wsManager.connect) {
                    window.simpleClient.wsManager.connect();
                    log('âœ… è¿æ¥è¯·æ±‚å·²å‘é€');
                    showResult('simple-client-result', 'ğŸ”„ è¿æ¥ä¸­...', 'warning');
                    
                    setTimeout(() => {
                        testSimpleClientWebSocket();
                    }, 2000);
                } else {
                    log('âŒ æ‰¾ä¸åˆ°é‡è¿æ–¹æ³•');
                    showResult('simple-client-result', 'âŒ æ‰¾ä¸åˆ°é‡è¿æ–¹æ³•', 'error');
                }
            } catch (error) {
                log(`âŒ é‡è¿å¤±è´¥: ${error.message}`);
                showResult('simple-client-result', `âŒ é‡è¿å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function sendTestMessage() {
            const message = document.getElementById('test-message').value.trim();
            if (!message) {
                log('âŒ è¯·è¾“å…¥æµ‹è¯•æ¶ˆæ¯');
                showResult('send-message-result', 'âŒ è¯·è¾“å…¥æµ‹è¯•æ¶ˆæ¯', 'error');
                return;
            }
            
            log(`å°è¯•å‘é€æµ‹è¯•æ¶ˆæ¯: ${message}`);
            
            // ä¼˜å…ˆä½¿ç”¨ SimpleWebClient
            if (window.simpleClient && window.simpleClient.sendAndPoll) {
                log('ä½¿ç”¨ SimpleWebClient å‘é€æ¶ˆæ¯...');
                
                window.simpleClient.sendAndPoll(message)
                    .then(result => {
                        log(`âœ… SimpleWebClient å‘é€æˆåŠŸ: ${JSON.stringify(result)}`);
                        showResult('send-message-result', `âœ… å‘é€æˆåŠŸ: ${JSON.stringify(result)}`, 'success');
                    })
                    .catch(error => {
                        log(`âŒ SimpleWebClient å‘é€å¤±è´¥: ${error.message}`);
                        showResult('send-message-result', `âŒ å‘é€å¤±è´¥: ${error.message}`, 'error');
                    });
            } else if (directWs && directWs.readyState === WebSocket.OPEN) {
                log('ä½¿ç”¨ç›´æ¥ WebSocket å‘é€æ¶ˆæ¯...');
                
                try {
                    const msgData = {
                        type: 'user_message',
                        message: message,
                        timestamp: Date.now(),
                        instanceId: 'debug-test'
                    };
                    
                    directWs.send(JSON.stringify(msgData));
                    log('âœ… ç›´æ¥ WebSocket å‘é€æˆåŠŸ');
                    showResult('send-message-result', 'âœ… æ¶ˆæ¯å·²é€šè¿‡ç›´æ¥ WebSocket å‘é€', 'success');
                } catch (error) {
                    log(`âŒ ç›´æ¥ WebSocket å‘é€å¤±è´¥: ${error.message}`);
                    showResult('send-message-result', `âŒ å‘é€å¤±è´¥: ${error.message}`, 'error');
                }
            } else {
                log('âŒ æ²¡æœ‰å¯ç”¨çš„ WebSocket è¿æ¥');
                showResult('send-message-result', 'âŒ æ²¡æœ‰å¯ç”¨çš„ WebSocket è¿æ¥', 'error');
            }
        }
        
        function clearLogs() {
            document.getElementById('logs').textContent = '';
            logCount = 0;
            log('æ—¥å¿—å·²æ¸…ç©º');
        }
        
        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            log(`è‡ªåŠ¨æ»šåŠ¨å·²${autoScroll ? 'å¼€å¯' : 'å…³é—­'}`);
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', function() {
            log('WebSocket è°ƒè¯•å·¥å…·å·²åŠ è½½');
            updateConnectionInfo();
            
            // ç­‰å¾…æ¨¡å—åŠ è½½
            setTimeout(() => {
                if (window.simpleClient) {
                    log('âœ… SimpleWebClient å·²åŠ è½½');
                    testSimpleClientWebSocket();
                } else {
                    log('âš ï¸ SimpleWebClient æœªåŠ è½½ï¼Œç­‰å¾…ä¸­...');
                    
                    // ç»§ç»­ç­‰å¾…
                    let waitCount = 0;
                    const waitInterval = setInterval(() => {
                        waitCount++;
                        if (window.simpleClient) {
                            log('âœ… SimpleWebClient å·²åŠ è½½ï¼ˆå»¶è¿Ÿï¼‰');
                            testSimpleClientWebSocket();
                            clearInterval(waitInterval);
                        } else if (waitCount >= 20) {
                            log('âŒ SimpleWebClient åŠ è½½è¶…æ—¶');
                            clearInterval(waitInterval);
                        }
                    }, 500);
                }
            }, 2000);
        });
    </script>
</body>
</html>