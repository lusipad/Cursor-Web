<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cursor 聊天历史记录</title>
    <style>
        :root {
            --primary-color: #00bbff;
            --primary-light: #66d6ff;
            --primary-dark: #005e80;
            --secondary-color: #FF6B35;
            --tertiary-color: #3EBD64;
            --bg-color: #121212;
            --surface-color: #1E1E1E;
            --surface-hover: #2A2A2A;
            --text-primary: #FFFFFF;
            --text-secondary: #B3B3B3;
            --border-color: #333333;
            --shadow-color: rgba(12, 188, 255, 0.3);
            --gradient: linear-gradient(135deg, #6E2CF4 0%, #FF6B35 50%, #3EBD64 100%);
        }

        body { margin: 0; background: var(--bg-color); color: var(--text-primary); font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; min-height: 100vh; }

        .header { background: var(--gradient); padding: 14px 18px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 2px 12px var(--shadow-color); }
        .header h1 { font-size: 1.4rem; font-weight: 700; margin: 0 0 6px; }
        .header-subtitle { color: var(--text-secondary); font-size: 1rem; }

        .controls { background-color: var(--surface-color); padding: 12px 14px; border-radius: 12px; margin-bottom: 14px; box-shadow: 0 2px 10px var(--shadow-color); }
        /* 让搜索框与按钮稳定排列，避免相互覆盖（改为 Flex，更稳） */
        .search-section { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
        @media (max-width: 640px){ .search-section { flex-direction: column; align-items: stretch; } }
        .search-box { position: relative; min-width: 0; flex: 1 1 0; overflow: hidden; }
        .search-input { display: block; width: 100%; max-width: 100%; padding: 12px 45px 12px 15px; border: 2px solid var(--border-color); border-radius: 10px; background-color: var(--bg-color); color: var(--text-primary); font-size: 1rem; }
        .search-clear { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.2rem; padding: 5px; border-radius: 5px; z-index: 1; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all .3s ease; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary-color); color: #fff; }
        .btn-secondary { background: var(--secondary-color); color: #fff; }
        .btn-sm { padding: 6px 12px; font-size: .8rem; }

        .view-toggle { display: flex; gap: 10px; margin-bottom: 20px; }
        .view-btn { padding: 8px 16px; border: 2px solid var(--border-color); background: transparent; color: var(--text-secondary); border-radius: 8px; cursor: pointer; }
        .view-btn.active { border-color: var(--primary-color); background: var(--primary-color); color: #fff; }

        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; }
        .stat-card { background: var(--surface-color); padding: 8px 10px; border-radius: 10px; text-align: center; }
        .stat-card h3 { color: var(--text-secondary); font-size: .75rem; margin: 0 0 4px; }
        .stat-value { font-size: 1.2rem; font-weight: 700; color: var(--primary-color); }

        .sessions-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 12px; }
        .chat-card { background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; transition: all .3s ease; cursor: pointer; }
        .chat-card:hover { transform: translateY(-3px); box-shadow: 0 6px 20px var(--shadow-color); border-color: var(--primary-color); }
        .chat-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: grid; grid-template-columns: 1fr auto; row-gap: 6px; }
        .chat-title { font-size: 1rem; font-weight: 600; color: var(--primary-color); }
        .chat-date { font-size: .8rem; color: var(--text-secondary); }
        .chat-meta { grid-column: 1 / -1; font-size: .8rem; color: var(--text-secondary); }
        .chat-preview { padding: 15px 20px; max-height: 100px; overflow: hidden; position: relative; }
        .chat-actions { padding: 10px 20px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; justify-content: flex-end; }

        .loading { text-align: center; padding: 40px; color: var(--text-secondary); }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border-color); border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }

        .no-data { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .no-data-icon { font-size: 4rem; margin-bottom: 20px; opacity: .5; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 Cursor 聊天历史记录</h1>
            <div class="header-subtitle">查看、搜索和导出您的 AI 聊天记录</div>
            <div id="instanceBadge" style="margin-top:6px;font-size:12px;opacity:.9"></div>
        </div>

        <div class="controls">
            <div class="search-section">
                <div class="search-box">
                    <input type="text" id="searchInput" class="search-input" placeholder="搜索聊天内容、项目名称..." />
                    <button class="search-clear" onclick="clearSearch()">✕</button>
                </div>
                <button class="btn btn-primary" onclick="loadHistory()">🔄 刷新</button>
                <button class="btn btn-secondary" onclick="showExportModal()">📥 导出</button>
            </div>

            <div class="view-toggle">
                <button class="view-btn" data-mode="list" onclick="setViewMode('list')">全部会话</button>
                <button class="view-btn" data-mode="grouped" onclick="setViewMode('grouped')">按项目聚合</button>
                <button class="view-btn" data-mode="active" onclick="setViewMode('active')">当前活动目录</button>
            </div>
        </div>

        <div class="stats" id="statsContainer">
            <div class="stat-card"><h3>总记录数</h3><div class="stat-value" id="totalRecords">-</div></div>
            <div class="stat-card"><h3>聊天会话</h3><div class="stat-value" id="chatRecords">-</div></div>
            <div class="stat-card"><h3>项目数量</h3><div class="stat-value" id="projectCount">-</div></div>
            <div class="stat-card"><h3>消息总数</h3><div class="stat-value" id="messageCount">-</div></div>
        </div>

        <div id="historyContent">
            <div class="loading">
                <div class="spinner"></div>
                <div>正在加载聊天记录...</div>
            </div>
        </div>
    </div>

    <script src="/js/instance-utils.js"></script>
    <script src="/js/instance-banner.js"></script>
    <script>
    let currentViewMode = 'list';
    let currentHistory = [];
    let allProjects = [];
    let selectedProjectKey = '';
    let selectedProjectName = '';
    let activeWorkspacePath = '';
    let activeWorkspaceCvPath = '';
    let activeWorkspaceLoaded = false;

    // 分页/滚动加载状态
    let pageSize = 30;
    let nextOffset = 0;
    let hasMore = true;
    let isLoading = false;
    let io = null; // IntersectionObserver
    let lastQuery = '';
    // 防止初始阶段一次性把所有页拉完
    const MAX_INITIAL_AUTO_LOADS = 0;
    let initialAutoLoads = 0;
    let userScrolled = false;
    let lastLoadTime = 0;

    document.addEventListener('DOMContentLoaded', async () => {
        try{ InstanceUtils && InstanceUtils.renderBadge(document.getElementById('instanceBadge')); }catch{}
        // 先读取实例 openPath，再加载历史
        try { await ensureInstanceOpenPathLoaded(); } catch {}
        // 若带 instance，默认使用“当前活动目录”；否则默认“全部会话”
        setViewMode(detectInstanceId() ? 'active' : 'list');
        // 监听滚动，用于控制仅在用户滚动后继续加载
        window.addEventListener('scroll', () => { userScrolled = true; }, { passive: true });
        // 首次加载按分页进行
        resetAndLoad();
        document.getElementById('searchInput').addEventListener('input', debounce(()=>loadHistory(true), 500));
    });

    function debounce(fn, wait){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); }; }

    function setViewMode(mode){
        currentViewMode = mode;
        document.querySelectorAll('.view-btn').forEach(b=>{ b.classList.toggle('active', b.dataset.mode===mode); });
        const stats = document.getElementById('statsContainer');
        stats.style.display = (mode === 'active') ? 'none' : 'grid';
        // 视图变更后重置并按分页加载
        resetAndLoad();
    }

    // 对外刷新函数（按钮/搜索共用）
    function loadHistory(reset = true){
        if (reset) return resetAndLoad();
        return loadMoreHistory();
    }

    // 重置并启动首次分页加载
    async function resetAndLoad(){
        resetPagination();
        currentHistory = [];
        lastQuery = document.getElementById('searchInput').value || '';
        // 基础布局：标题（可选）、列表容器、触底加载区
        const container = document.getElementById('historyContent');
        container.innerHTML = `
            <div id="listHeading"></div>
            <div id="listContainer" style="display:grid;gap:20px;"></div>
            <div id="loadMoreArea" class="loading"><div class="spinner"></div><div>正在加载...</div></div>
        `;
        if (currentViewMode !== 'active') { try { loadStats(); } catch {} }
        if (currentViewMode === 'active') { try { await ensureActiveWorkspaceLoaded(); } catch {} ; updateActiveHeading(0); }
        setupInfiniteScroll();
        await loadMoreHistory();
        if (currentViewMode !== 'list') { try { await autoLoadAllPages(); } catch {} }
    }

    function resetPagination(){
        nextOffset = 0;
        hasMore = true;
        isLoading = false;
        if (io){ try{ io.disconnect(); }catch{} io = null; }
    }

    function setupInfiniteScroll(){
        const target = document.getElementById('loadMoreArea');
        if (!target) return;
        if (currentViewMode !== 'list') return;
        io = new IntersectionObserver((entries)=>{
            const entry = entries[0];
            if (!entry || !entry.isIntersecting) return;
            // 简单冷却，避免在同一渲染周期内连发多次
            const now = Date.now();
            if (now - lastLoadTime < 400) return;
            // 初始阶段仅允许少量自动加载，避免页面未溢出时把全部数据拉完
            if (initialAutoLoads < MAX_INITIAL_AUTO_LOADS) {
                initialAutoLoads++;
                loadMoreHistory();
                return;
            }
            // 非初始阶段：需要用户滚动后才触发
            if (userScrolled) {
                userScrolled = false;
                loadMoreHistory();
            }
        }, { root: null, rootMargin: '200px', threshold: 0 });
        io.observe(target);
    }

    async function loadMoreHistory(){
        if (isLoading || !hasMore) return;
        isLoading = true;
        const q = document.getElementById('searchInput').value || '';
        const inst = detectInstanceId();
        const params = new URLSearchParams({ limit: String(pageSize), offset: String(nextOffset), includeUnmapped: 'false', summary: '1', maxAgeMs: '8000', mode: 'cv' });
        if (q) params.append('search', q);
        try{
            const res = await fetch(`/api/history?${params}`);
            const result = await res.json();
            if (!result || !result.success){
                updateLoadMoreText('加载失败');
                isLoading = false; return;
            }
            const payload = result.data || {};
            const items = Array.isArray(payload.items) ? payload.items : (Array.isArray(payload) ? payload : []);
            // 累计数据
            if (items.length > 0){
                currentHistory.push(...items.map(ensurePrimaryTimestamp));
                nextOffset += items.length;
            }
            hasMore = typeof payload.hasMore === 'boolean' ? payload.hasMore : ((payload.total && nextOffset < payload.total) ? true : (items.length === pageSize));
            renderAccordingToMode(items);
            updateLoadMoreText(hasMore ? '向下滚动加载更多...' : '已全部加载');
            // 更新统计（基于已加载数据）
            try { updateStatsFromLoaded(); } catch {}
        }catch(e){
            updateLoadMoreText('加载失败：' + e.message);
        }finally{
            isLoading = false;
            lastLoadTime = Date.now();
        }
    }

    async function autoLoadAllPages(){
        while (hasMore && !isLoading) {
            await loadMoreHistory();
            await new Promise(r => setTimeout(r, 0));
        }
    }

    function updateLoadMoreText(text){
        const el = document.getElementById('loadMoreArea');
        if (!el) return;
        el.innerHTML = hasMore
            ? `<div class="spinner"></div><div>${text}</div>`
            : `<div style="color: var(--text-secondary); padding: 8px 0;">${text}</div>`;
    }

    function renderAccordingToMode(newItems){
        if (currentViewMode === 'list'){
            appendListItems(newItems);
        } else if (currentViewMode === 'grouped'){
            renderProjectsUnique(currentHistory);
        } else if (currentViewMode === 'active'){
            renderActiveView();
        }
    }

    function appendListItems(items){
        const list = document.getElementById('listContainer');
        if (!list) return;
        if (!items || items.length === 0) return;
        const html = items.map(chat => renderChatCard(ensurePrimaryTimestamp(chat))).join('');
        list.insertAdjacentHTML('beforeend', html);
    }

    function renderHistory(items){
        // 非 active 模式：填充到 listContainer
        if (currentViewMode==='active') return renderActiveView();
        const list = document.getElementById('listContainer');
        if (!list){ showLoading(); return; }
        if (!items || items.length===0){
            list.innerHTML = `<div class="no-data"><div class="no-data-icon">💬</div><h3>暂无聊天记录</h3><p>当前筛选条件下没有找到聊天记录</p></div>`; return;
        }
        if (currentViewMode==='list') return renderListView(items);
        return renderProjectsUnique(items);
    }

    // ===== 当前活动目录视图 =====
    function normalizeCvPathLower(p){
        if (!p) return '';
        const s = String(p).replace(/\\/g,'/');
        const replaced = s.replace(/^([A-Za-z]):/, (m,d)=>`${d}%3A`);
        const cv = replaced.startsWith('/') ? replaced : '/' + replaced;
        return cv.replace(/^\/([A-Za-z])%3A/, (_, d) => '/' + String(d).toLowerCase() + '%3A');
    }

    function normalizeProjectCvPathLower(p){
        if (!p) return '';
        let s = String(p).replace(/\\/g,'/');
        s = s.replace(/^file:\/\//, '');
        try { s = decodeURIComponent(s); } catch {}
        if (/^\/[A-Za-z]%3A\//.test(s)){
            return s.replace(/^\/[A-Za-z]%3A\//, (m) => m.toLowerCase());
        }
        if (/^\/[A-Za-z]:\//.test(s)){
            const d = s.charAt(1).toLowerCase();
            return `/${d}%3a/` + s.slice(3);
        }
        if (/^[A-Za-z]:\//.test(s)){
            const d = s.charAt(0).toLowerCase();
            return `/${d}%3a/` + s.slice(3);
        }
        return normalizeCvPathLower(s);
    }

    async function ensureActiveWorkspaceLoaded(){
        if (activeWorkspaceLoaded && activeWorkspacePath && activeWorkspaceCvPath) return;
        try{
            const inst = detectInstanceId();
            if (inst && !instanceOpenPath) { try { await ensureInstanceOpenPathLoaded(); } catch {} }
            if (inst && instanceOpenPath){
                activeWorkspacePath = instanceOpenPath;
                activeWorkspaceCvPath = normalizeCvPathLower(activeWorkspacePath);
                activeWorkspaceLoaded = true;
                return;
            }
            const res = await fetch('/api/health');
            const json = await res.json();
            let ws = json && (json.workspace || (json.data && json.data.workspace)) || '';
            // 回退：若健康接口未提供工作目录，则使用当前页面推断或服务器工作目录作为默认活动目录
            if (!ws) {
                try { ws = (window.location && window.location.pathname) ? (window.location.pathname) : ''; } catch {}
            }
            if (!ws) {
                try { ws = '/'; } catch {}
            }
            activeWorkspacePath = ws || '';
            activeWorkspaceCvPath = normalizeCvPathLower(activeWorkspacePath);
            activeWorkspaceLoaded = true;
        }catch(err){
            activeWorkspacePath = '';
            activeWorkspaceCvPath = '';
            activeWorkspaceLoaded = true;
        }
    }

    // ========== 实例 openPath 支持 ==========
    let instanceOpenPath = '';
    function detectInstanceId(){ try{ return window.InstanceUtils ? (InstanceUtils.get()||'') : ''; }catch{ return ''; } }
    async function ensureInstanceOpenPathLoaded(){
        const inst = detectInstanceId();
        if (!inst) { instanceOpenPath=''; return; }
        try{
            const r = await fetch(`/api/instances/${encodeURIComponent(inst)}`);
            const j = await r.json();
            const it = j && j.success && j.data ? j.data : null;
            instanceOpenPath = (it && typeof it.openPath === 'string') ? it.openPath : '';
        }catch{ instanceOpenPath=''; }
    }

    function matchActiveDirectory(projectRoot){
        if (!activeWorkspaceCvPath) return false;
        if (!projectRoot || projectRoot === '(unknown)') return true; // 未映射的也先显示，避免误伤
        const pr = normalizeProjectCvPathLower(projectRoot);
        const ar = normalizeProjectCvPathLower(activeWorkspaceCvPath);
        return pr === ar || pr.startsWith(ar + '/') || ar.startsWith(pr + '/');
    }

    async function renderActiveView(){
        const headingEl = document.getElementById('listHeading');
        const list = document.getElementById('listContainer');
        if (!headingEl || !list) return;
        await ensureActiveWorkspaceLoaded();
        if (!activeWorkspaceCvPath){
            headingEl.innerHTML = '';
            list.innerHTML = `
                <div class="no-data">
                    <div class="no-data-icon">⚠️</div>
                    <h3>需要选择实例</h3>
                    <p><a href="/instances.html" style="color:#0aa6ff;">点击选择实例</a>，或在地址栏添加 ?instance= 实例ID。</p>
                </div>`;
            return;
        }
        let filtered = (currentHistory||[]).filter(item => matchActiveDirectory(item?.project?.rootPath || item?.project?.root || ''));
        if (filtered.length === 0 && currentHistory.length > 0) {
            // 回退：尝试使用会话的 workspaceId/dbPath 作为信号，宽松匹配一次
            try {
                const ar = normalizeProjectCvPathLower(activeWorkspaceCvPath);
                filtered = (currentHistory||[]).filter(it => {
                    const ws = String(it?.workspaceId||'').toLowerCase();
                    const db = String(it?.dbPath||'').replace(/\\/g,'/').toLowerCase();
                    return ws.includes('global') || db.includes('user/globalstorage');
                });
            } catch {}
        }
        updateActiveHeading(filtered.length);
        if (filtered.length === 0){
            const hasInst = !!detectInstanceId();
            list.innerHTML = `
                <div class="no-data">
                    <div class="no-data-icon">💬</div>
                    <h3>暂无聊天记录</h3>
                    <p>${hasInst ? '当前活动目录下没有匹配的会话' : '未指定实例参数，当前活动目录取的是服务器工作目录，可能与 Cursor 的活动目录不一致。请在 URL 添加 ?instance=你的实例ID，或切换到“全部会话/按项目聚合”。'}</p>
                </div>`;
            return;
        }
        const extra = (currentHistory||[]).filter(item => !item?.project || !item?.project?.rootPath || item?.project?.rootPath === '(unknown)');
        const merged = filtered.length ? filtered : extra;
        list.innerHTML = merged.map(chat => renderChatCard(chat)).join('');
    }

    function updateActiveHeading(count){
        const headingEl = document.getElementById('listHeading');
        if (!headingEl) return;
        const instanceId = detectInstanceId();
        headingEl.innerHTML = `
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                <div style="font-weight:600;">当前活动目录：
                    <span style="opacity:.8">${escapeHtml(toPrettyDisplayPath(activeWorkspacePath || activeWorkspaceCvPath))}</span>（${count||0}）
                    ${instanceId ? `<span style=\"margin-left:8px;color:#aaa;\">实例：${escapeHtml(instanceId)}</span>` : ''}
                </div>
            </div>`;
    }

    function renderProjectsUnique(items){
        const byProject = new Map();
        for (const chat of items){
            const normalized = ensurePrimaryTimestamp(chat);
            const p = normalized.project || {}; const root=(p.rootPath||'').trim(); const name=(p.name||'Unknown Project').trim();
            const key = (root && root!=='(unknown)') ? root : `unknown:${name}`;
            if (!byProject.has(key)) byProject.set(key, { project: normalized.project, chats: [], latest: null });
            const g = byProject.get(key); g.chats.push(normalized);
            const cd = new Date(normalized.timestamp || normalized.date || 0).getTime();
            const ld = g.latest ? new Date(g.latest.timestamp || g.latest.date || 0).getTime() : -1;
            if (!g.latest || cd>ld) g.latest = normalized;
        }
        const groups = Array.from(byProject.values()).sort((a,b)=> new Date(b.latest?.timestamp||b.latest?.date||0) - new Date(a.latest?.timestamp||a.latest?.date||0));
        const html = groups.map(g => renderProjectCard(g.project, g.latest, g.chats.length)).join('');
        const list = document.getElementById('listContainer');
        if (list) list.innerHTML = `<div class="sessions-grid">${html}</div>`;
    }

    function renderListView(items){
        const list = document.getElementById('listContainer');
        if (!list) return;
        const html = items.map(chat => renderChatCard(ensurePrimaryTimestamp(chat))).join('');
        list.innerHTML = html;
    }

    function renderProjectCard(project, latestChat, chatCount){
        const id = latestChat?.session_id || latestChat?.id || latestChat?.sessionId || 'unknown';
        const projectName = project?.name || 'Unknown Project';
        // 与 chat-detail 一致：仅读取会话上直带的时间（timestamp 优先）
        const baseTimestamp = latestChat?.timestamp ?? latestChat?.date ?? null;
        const previewMessages = (latestChat?.messages || []).slice(0,3);
        const projectPath = project?.rootPath || '';
        const pathDisplay = projectPath ? toPrettyDisplayPath(projectPath) : '';
        const dateDisplay = formatTimestamp(baseTimestamp);
        const countInfo = chatCount ? `（${chatCount} 会话）` : '';
        const projectKey = (projectPath && projectPath !== '(unknown)') ? projectPath : `unknown:${projectName}`;
        return `
            <div class="chat-card" onclick="showProjectSessions('${encodeURIComponent(projectKey)}','${encodeURIComponent(projectName)}')">
                <div class="chat-header">
                    <div class="chat-title">📁 ${projectName} ${countInfo} · ${dateDisplay}</div>
                    <div class="chat-meta">${pathDisplay ? pathDisplay : ''}</div>
                </div>
                <div class="chat-preview">
                    ${previewMessages.length>0 ? previewMessages.map(m=>`<div>${escapeHtml(m.content)}</div>`).join('') : `<div class="message-preview assistant-message">暂无会话</div>`}
                </div>
                <div class="chat-actions" onclick="event.stopPropagation()">
                    <button class="btn btn-sm btn-primary" onclick="showChatDetail('${id}')">👁️ 查看详情</button>
                </div>
            </div>`;
    }

    function showProjectSessions(k,n){ try{selectedProjectKey=decodeURIComponent(k||'');selectedProjectName=decodeURIComponent(n||'');}catch{selectedProjectKey=k||'';selectedProjectName=n||'';}
        const items=(currentHistory||[]).filter(it=>{ const p=it.project||{}; const root=(p.rootPath||'').trim(); const name=(p.name||'Unknown Project').trim(); const key=(root&&root!=='(unknown)')?root:`unknown:${name}`; return key===selectedProjectKey; });
        currentViewMode='list';
        const heading = `<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;"><div style="font-weight:600;">${escapeHtml(selectedProjectName||selectedProjectKey)} 的会话列表（${items.length}）</div><button class="btn btn-sm" onclick="setViewMode('grouped')">← 返回项目</button></div>`;
        document.getElementById('historyContent').innerHTML = heading + `<div style="display:grid;gap:20px;">${items.map(chat=>renderChatCard(chat)).join('')}</div>`;
    }

    function renderChatCard(chat){
        const id = chat?.session_id || chat?.id || chat?.sessionId || 'unknown';
        const projectName = chat?.project?.name || 'Unknown Project';
        // 与 chat-detail 保持一致：仅使用 chat.timestamp 或 chat.date（timestamp 优先）
        const baseTimestamp = (chat?.timestamp ?? chat?.date ?? null);
        const projectPath = chat?.project?.rootPath || '';
        const pathDisplay = projectPath ? toPrettyDisplayPath(projectPath) : '';
        const dateDisplay = formatTimestamp(baseTimestamp);
        const previewMessages = (chat?.messages || []).slice(-3); // 取最近 3 条
        return `
        <div class="chat-card" onclick="showChatDetail('${id}')">
            <div class="chat-header">
                <div class="chat-title">💬 ${projectName} · ${dateDisplay}</div>
                <div class="chat-meta">${pathDisplay ? pathDisplay : ''}</div>
            </div>
            <div class="chat-preview">
                ${previewMessages.length > 0 ? previewMessages.map(msg => `
                    <div class="message-preview ${msg.role === 'user' ? 'user-message' : 'assistant-message'}">
                        <strong>${msg.role === 'user' ? '👤 用户' : '🤖 助手'}:</strong>
                        ${escapeHtml(String(msg.content || '').slice(0, 120))}
                    </div>
                `).join('') : `<div class="message-preview assistant-message">暂无会话</div>`}
            </div>
            <div class="chat-actions" onclick="event.stopPropagation()">
                <button class="btn btn-sm btn-primary" onclick="showChatDetail('${id}')">👁️ 查看详情</button>
            </div>
        </div>`;
    }

    // 提取会话最佳时间戳（尽量保证卡片显示日期）
    function getChatTimestamp(chat){
        if (!chat) return null;
        let ts = chat.timestamp ?? chat.date ?? chat.lastUpdatedAt ?? chat.updatedAt
            ?? (chat.session ? (chat.session.lastUpdatedAt ?? chat.session.createdAt) : null);
        if (!ts && Array.isArray(chat.messages) && chat.messages.length){
            let maxTs = 0; for (const m of chat.messages){ const mt = Number(m.timestamp || 0); if (mt > maxTs) maxTs = mt; }
            ts = maxTs || null;
        }
        return ts || null;
    }

    function toCursorViewPath(p){ if (!p) return ''; const s=String(p).replace(/\\/g,'/'); const replaced=s.replace(/^([A-Za-z]):/, (m,d)=>`${d}%3A`); return replaced.startsWith('/')?replaced:'/'+replaced; }
    // 将 Windows 风格/光标视图风格路径转为可读形式，例如：/d%3A/Repos/X -> D:\\Repos\\X
    function toPrettyDisplayPath(p){
        if (!p) return '';
        let s = String(p);
        // 处理 /d%3A/xxx -> D:\\xxx
        if (/^\/[A-Za-z]%3A\//.test(s)){
            s = s.replace(/^\/([A-Za-z])%3A\//, (_, d) => `${String(d).toUpperCase()}:\\`);
            s = s.replace(/\//g, '\\');
            return s;
        }
        // 处理 D:/xxx -> D\\xxx
        if (/^[A-Za-z]:\//.test(s)){
            s = s.replace(/^([A-Za-z]):\//, (_, d) => `${String(d).toUpperCase()}:\\`);
            s = s.replace(/\//g, '\\');
            return s;
        }
        // 处理 d:\\xxx -> D:\\xxx
        if (/^[A-Za-z]:\\/.test(s)){
            s = s.replace(/^([A-Za-z]):\\/, (_, d) => `${String(d).toUpperCase()}:\\`);
            return s;
        }
        return s;
    }
    function showChatDetail(id){
        let url = `/chat-detail.html?sessionId=${encodeURIComponent(id)}&mode=cv`;
        try{ const u=new URL(window.location.href); const inst=u.searchParams.get('instance'); if(inst){ url += `&instance=${encodeURIComponent(inst)}`; } }catch{}
        window.open(url, '_blank');
    }

    // 保障每条记录具备 primary 时间戳字段（timestamp 或 date），方便统一展示
    function ensurePrimaryTimestamp(item){
        const copy = { ...(item||{}) };
        if (copy.timestamp == null && copy.date != null) {
            copy.timestamp = copy.date;
        }
        return copy;
    }

    async function loadStats(){ if (currentViewMode==='active') return; try{ updateStatsFromLoaded(); }catch(e){} }
    function updateStatsFromLoaded(){ try{ const messageCount=currentHistory.reduce((sum,it)=>sum+(it.messages?.length||0),0); const total=currentHistory.length; const chats=total; const proj=new Set(currentHistory.map(it=>it?.project?.rootPath||it?.project?.name||'(unknown)')).size; const setText=(id,txt)=>{ const el=document.getElementById(id); if(el) el.textContent=String(txt); }; setText('totalRecords', total); setText('chatRecords', chats); setText('projectCount', proj); setText('messageCount', messageCount); }catch{} }

    function showLoading(){
        const c = document.getElementById('historyContent');
        if (c) c.innerHTML = `<div class="loading"><div class="spinner"></div><div>正在加载聊天记录...</div></div>`;
    }
    function showError(msg){
        const c = document.getElementById('historyContent');
        if (c) c.innerHTML = `<div class="no-data"><div class="no-data-icon">⚠️</div><h3>加载失败</h3><p>${msg}</p></div>`;
    }
    function clearSearch(){ document.getElementById('searchInput').value=''; loadHistory(true); }
    // 与 chat-detail.html 完全一致：简单直取并展示
    function formatTimestamp(timestamp){
        if (!timestamp) return 'N/A';
        const date = new Date(timestamp);
        return date.toLocaleString('zh-CN');
    }
    function escapeHtml(t){ const div=document.createElement('div'); div.textContent=t; return div.innerHTML; }
    </script>
</body>
</html>

