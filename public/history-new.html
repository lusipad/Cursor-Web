<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cursor 聊天历史记录</title>
    <style>
        :root {
            --primary-color: #00bbff;
            --primary-light: #66d6ff;
            --primary-dark: #005e80;
            --secondary-color: #FF6B35;
            --tertiary-color: #3EBD64;
            --bg-color: #121212;
            --surface-color: #1E1E1E;
            --surface-hover: #2A2A2A;
            --text-primary: #FFFFFF;
            --text-secondary: #B3B3B3;
            --border-color: #333333;
            --shadow-color: rgba(12, 188, 255, 0.3);
            --gradient: linear-gradient(135deg, #6E2CF4 0%, #FF6B35 50%, #3EBD64 100%);
        }

        body { margin: 0; background: var(--bg-color); color: var(--text-primary); font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; min-height: 100vh; }

        .header { background: var(--gradient); padding: 14px 18px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 2px 12px var(--shadow-color); }
        .header h1 { font-size: 1.4rem; font-weight: 700; margin: 0 0 6px; }
        .header-subtitle { color: var(--text-secondary); font-size: 1rem; }

        .controls { background-color: var(--surface-color); padding: 12px 14px; border-radius: 12px; margin-bottom: 14px; box-shadow: 0 2px 10px var(--shadow-color); }
        /* 让搜索框与按钮稳定排列，避免相互覆盖（改为 Flex，更稳） */
        .search-section { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
        @media (max-width: 640px){ .search-section { flex-direction: column; align-items: stretch; } }
        .search-box { position: relative; min-width: 0; flex: 1 1 0; overflow: hidden; }
        .search-input { display: block; width: 100%; max-width: 100%; padding: 12px 45px 12px 15px; border: 2px solid var(--border-color); border-radius: 10px; background-color: var(--bg-color); color: var(--text-primary); font-size: 1rem; }
        .search-clear { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.2rem; padding: 5px; border-radius: 5px; z-index: 1; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all .3s ease; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary-color); color: #fff; }
        .btn-secondary { background: var(--secondary-color); color: #fff; }
        .btn-sm { padding: 6px 12px; font-size: .8rem; }

        .view-toggle { display: flex; gap: 10px; margin-bottom: 20px; }
        .view-btn { padding: 8px 16px; border: 2px solid var(--border-color); background: transparent; color: var(--text-secondary); border-radius: 8px; cursor: pointer; }
        .view-btn.active { border-color: var(--primary-color); background: var(--primary-color); color: #fff; }

        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; }
        .stat-card { background: var(--surface-color); padding: 8px 10px; border-radius: 10px; text-align: center; }
        .stat-card h3 { color: var(--text-secondary); font-size: .75rem; margin: 0 0 4px; }
        .stat-value { font-size: 1.2rem; font-weight: 700; color: var(--primary-color); }

        .sessions-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 12px; }
        .chat-card { background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; transition: all .3s ease; cursor: pointer; }
        .chat-card:hover { transform: translateY(-3px); box-shadow: 0 6px 20px var(--shadow-color); border-color: var(--primary-color); }
        .chat-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: grid; grid-template-columns: 1fr auto; row-gap: 6px; }
        .chat-title { font-size: 1rem; font-weight: 600; color: var(--primary-color); }
        .chat-date { font-size: .8rem; color: var(--text-secondary); }
        .chat-meta { grid-column: 1 / -1; font-size: .8rem; color: var(--text-secondary); }
        .chat-preview { padding: 15px 20px; max-height: 100px; overflow: hidden; position: relative; }
        .chat-actions { padding: 10px 20px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; justify-content: flex-end; }

        .loading { text-align: center; padding: 40px; color: var(--text-secondary); }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border-color); border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }

        .no-data { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .no-data-icon { font-size: 4rem; margin-bottom: 20px; opacity: .5; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 Cursor 聊天历史记录</h1>
            <div class="header-subtitle">查看、搜索和导出您的 AI 聊天记录</div>
        </div>

        <div class="controls">
            <div class="search-section">
                <div class="search-box">
                    <input type="text" id="searchInput" class="search-input" placeholder="搜索聊天内容、项目名称..." />
                    <button class="search-clear" onclick="clearSearch()">✕</button>
                </div>
                <button class="btn btn-primary" onclick="loadHistory()">🔄 刷新</button>
                <button class="btn btn-secondary" onclick="showExportModal()">📥 导出</button>
            </div>

            <div class="view-toggle">
                <button class="view-btn" data-mode="list" onclick="setViewMode('list')">全部会话</button>
                <button class="view-btn" data-mode="grouped" onclick="setViewMode('grouped')">按项目聚合</button>
                <button class="view-btn" data-mode="active" onclick="setViewMode('active')">当前活动目录</button>
            </div>
        </div>

        <div class="stats" id="statsContainer">
            <div class="stat-card"><h3>总记录数</h3><div class="stat-value" id="totalRecords">-</div></div>
            <div class="stat-card"><h3>聊天会话</h3><div class="stat-value" id="chatRecords">-</div></div>
            <div class="stat-card"><h3>项目数量</h3><div class="stat-value" id="projectCount">-</div></div>
            <div class="stat-card"><h3>消息总数</h3><div class="stat-value" id="messageCount">-</div></div>
        </div>

        <div id="historyContent">
            <div class="loading">
                <div class="spinner"></div>
                <div>正在加载聊天记录...</div>
            </div>
        </div>
    </div>

    <script>
    let currentViewMode = 'list';
    let currentHistory = [];
    let allProjects = [];
    let selectedProjectKey = '';
    let selectedProjectName = '';
    let activeWorkspacePath = '';
    let activeWorkspaceCvPath = '';
    let activeWorkspaceLoaded = false;

    document.addEventListener('DOMContentLoaded', async () => {
        // 先读取实例 openPath，再加载历史，避免首次渲染使用了 /api/health 的工作区
        try { await ensureInstanceOpenPathLoaded(); } catch {}
        setViewMode('active');
        loadHistory();
        document.getElementById('searchInput').addEventListener('input', debounce(loadHistory, 500));
    });

    function debounce(fn, wait){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); }; }

    function setViewMode(mode){
        currentViewMode = mode;
        document.querySelectorAll('.view-btn').forEach(b=>{ b.classList.toggle('active', b.dataset.mode===mode); });
        const stats = document.getElementById('statsContainer');
        if (mode === 'active') { stats.style.display='none'; renderActiveView(); } else { stats.style.display='grid'; loadStats(); renderHistory(currentHistory); }
    }

    async function loadHistory(){
        const q = document.getElementById('searchInput').value;
        const params = new URLSearchParams({ limit: 20000, includeUnmapped: 'true', mode: 'cv' });
        const inst = detectInstanceId();
        if (inst) params.append('instance', inst);
        if (q) params.append('search', q);
        showLoading();
        try{
            const [hRes, pRes] = await Promise.all([
                fetch(`/api/history?${params}`),
                fetch(`/api/history/projects${inst?`?instance=${encodeURIComponent(inst)}`:''}`)
            ]);
            const result = await hRes.json();
            const projects = await pRes.json();
            if (result.success){
                const raw = result.data.items || result.data || [];
                currentHistory = (Array.isArray(raw) ? raw : []).map(ensurePrimaryTimestamp);
                allProjects = projects && projects.success ? (Array.isArray(projects.data)?projects.data:[]) : [];
                if (currentViewMode==='active') renderActiveView(); else renderHistory(currentHistory);
            } else { showError('加载历史记录失败：' + result.error); }
        } catch(e){ showError('加载历史记录失败：' + e.message); }
    }

    function renderHistory(items){
        if (currentViewMode==='active') return renderActiveView();
        const container=document.getElementById('historyContent');
        if (!items || items.length===0){
            container.innerHTML = `<div class="no-data"><div class="no-data-icon">💬</div><h3>暂无聊天记录</h3><p>当前筛选条件下没有找到聊天记录</p></div>`; return;
        }
        if (currentViewMode==='list') return renderListView(items);
        return renderProjectsUnique(items);
    }

    // ===== 当前活动目录视图 =====
    function normalizeCvPathLower(p){
        if (!p) return '';
        const s = String(p).replace(/\\/g,'/');
        const replaced = s.replace(/^([A-Za-z]):/, (m,d)=>`${d}%3A`);
        const cv = replaced.startsWith('/') ? replaced : '/' + replaced;
        return cv.replace(/^\/([A-Za-z])%3A/, (_, d) => '/' + String(d).toLowerCase() + '%3A');
    }

    function normalizeProjectCvPathLower(p){
        if (!p) return '';
        const s = String(p).replace(/\\/g,'/');
        if (/^\/[A-Za-z]%3A\//.test(s)){
            return s.replace(/^\/([A-Za-z])%3A/, (_, d) => '/' + String(d).toLowerCase() + '%3A');
        }
        return normalizeCvPathLower(s);
    }

    async function ensureActiveWorkspaceLoaded(){
        if (activeWorkspaceLoaded && activeWorkspacePath && activeWorkspaceCvPath) return;
        try{
            const inst = detectInstanceId();
            if (inst && !instanceOpenPath) { try { await ensureInstanceOpenPathLoaded(); } catch {} }
            if (inst && instanceOpenPath){
                activeWorkspacePath = instanceOpenPath;
                activeWorkspaceCvPath = normalizeCvPathLower(activeWorkspacePath);
                activeWorkspaceLoaded = true;
                return;
            }
            const res = await fetch('/api/health');
            const json = await res.json();
            const ws = json && (json.workspace || (json.data && json.data.workspace)) || '';
            activeWorkspacePath = ws || '';
            activeWorkspaceCvPath = normalizeCvPathLower(activeWorkspacePath);
            activeWorkspaceLoaded = true;
        }catch(err){
            activeWorkspacePath = '';
            activeWorkspaceCvPath = '';
            activeWorkspaceLoaded = true;
        }
    }

    // ========== 实例 openPath 支持 ==========
    let instanceOpenPath = '';
    function detectInstanceId(){ try{ const u=new URL(window.location.href); return u.searchParams.get('instance')||''; }catch{ return ''; } }
    async function ensureInstanceOpenPathLoaded(){
        const inst = detectInstanceId();
        if (!inst) { instanceOpenPath=''; return; }
        try{
            const r = await fetch(`/api/instances/${encodeURIComponent(inst)}`);
            const j = await r.json();
            const it = j && j.success && j.data ? j.data : null;
            instanceOpenPath = (it && typeof it.openPath === 'string') ? it.openPath : '';
        }catch{ instanceOpenPath=''; }
    }

    function matchActiveDirectory(projectRoot){
        if (!projectRoot || !activeWorkspaceCvPath) return false;
        const pr = normalizeProjectCvPathLower(projectRoot);
        const ar = activeWorkspaceCvPath;
        return pr === ar || pr.startsWith(ar + '/') || ar.startsWith(pr + '/');
    }

    async function renderActiveView(){
        const container = document.getElementById('historyContent');
        showLoading();
        await ensureActiveWorkspaceLoaded();
        if (!activeWorkspaceCvPath){
            container.innerHTML = `
                <div class="no-data">
                    <div class="no-data-icon">⚠️</div>
                    <h3>无法获取当前活动目录</h3>
                    <p>请稍后重试，或检查服务器是否正常运行。</p>
                </div>`;
            return;
        }
        const filtered = (currentHistory||[]).filter(item => matchActiveDirectory(item?.project?.rootPath || ''));
        const heading = `<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
            <div style="font-weight:600;">当前活动目录：
                <span style="opacity:.8">${escapeHtml(toPrettyDisplayPath(activeWorkspacePath || activeWorkspaceCvPath))}</span>（${filtered.length}）
            </div>
        </div>`;
        if (filtered.length === 0){
            container.innerHTML = `${heading}
                <div class="no-data">
                    <div class="no-data-icon">💬</div>
                    <h3>暂无聊天记录</h3>
                    <p>当前活动目录下没有匹配的会话</p>
                </div>`;
            return;
        }
        const html = filtered.map(chat => renderChatCard(chat)).join('');
        container.innerHTML = `${heading}<div style="display:grid;gap:20px;">${html}</div>`;
    }

    function renderProjectsUnique(items){
        const byProject = new Map();
        for (const chat of items){
            const normalized = ensurePrimaryTimestamp(chat);
            const p = normalized.project || {}; const root=(p.rootPath||'').trim(); const name=(p.name||'Unknown Project').trim();
            const key = (root && root!=='(unknown)') ? root : `unknown:${name}`;
            if (!byProject.has(key)) byProject.set(key, { project: normalized.project, chats: [], latest: null });
            const g = byProject.get(key); g.chats.push(normalized);
            const cd = new Date(normalized.timestamp || normalized.date || 0).getTime();
            const ld = g.latest ? new Date(g.latest.timestamp || g.latest.date || 0).getTime() : -1;
            if (!g.latest || cd>ld) g.latest = normalized;
        }
        const groups = Array.from(byProject.values()).sort((a,b)=> new Date(b.latest?.timestamp||b.latest?.date||0) - new Date(a.latest?.timestamp||a.latest?.date||0));
        const html = groups.map(g => renderProjectCard(g.project, g.latest, g.chats.length)).join('');
        document.getElementById('historyContent').innerHTML = `<div class="sessions-grid">${html}</div>`;
    }

    function renderListView(items){
        const html = items.map(chat => renderChatCard(ensurePrimaryTimestamp(chat))).join('');
        document.getElementById('historyContent').innerHTML = `<div style="display:grid;gap:20px;">${html}</div>`;
    }

    function renderProjectCard(project, latestChat, chatCount){
        const id = latestChat?.session_id || latestChat?.id || latestChat?.sessionId || 'unknown';
        const projectName = project?.name || 'Unknown Project';
        // 与 chat-detail 一致：仅读取会话上直带的时间（timestamp 优先）
        const baseTimestamp = latestChat?.timestamp ?? latestChat?.date ?? null;
        const previewMessages = (latestChat?.messages || []).slice(0,3);
        const projectPath = project?.rootPath || '';
        const pathDisplay = projectPath ? toPrettyDisplayPath(projectPath) : '';
        const dateDisplay = formatTimestamp(baseTimestamp);
        const countInfo = chatCount ? `（${chatCount} 会话）` : '';
        const projectKey = (projectPath && projectPath !== '(unknown)') ? projectPath : `unknown:${projectName}`;
        return `
            <div class="chat-card" onclick="showProjectSessions('${encodeURIComponent(projectKey)}','${encodeURIComponent(projectName)}')">
                <div class="chat-header">
                    <div class="chat-title">📁 ${projectName} ${countInfo} · ${dateDisplay}</div>
                    <div class="chat-meta">${pathDisplay ? pathDisplay : ''}</div>
                </div>
                <div class="chat-preview">
                    ${previewMessages.length>0 ? previewMessages.map(m=>`<div>${escapeHtml(m.content)}</div>`).join('') : `<div class="message-preview assistant-message">暂无会话</div>`}
                </div>
                <div class="chat-actions" onclick="event.stopPropagation()">
                    <button class="btn btn-sm btn-primary" onclick="showChatDetail('${id}')">👁️ 查看详情</button>
                </div>
            </div>`;
    }

    function showProjectSessions(k,n){ try{selectedProjectKey=decodeURIComponent(k||'');selectedProjectName=decodeURIComponent(n||'');}catch{selectedProjectKey=k||'';selectedProjectName=n||'';}
        const items=(currentHistory||[]).filter(it=>{ const p=it.project||{}; const root=(p.rootPath||'').trim(); const name=(p.name||'Unknown Project').trim(); const key=(root&&root!=='(unknown)')?root:`unknown:${name}`; return key===selectedProjectKey; });
        currentViewMode='list';
        const heading = `<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;"><div style="font-weight:600;">${escapeHtml(selectedProjectName||selectedProjectKey)} 的会话列表（${items.length}）</div><button class="btn btn-sm" onclick="setViewMode('grouped')">← 返回项目</button></div>`;
        document.getElementById('historyContent').innerHTML = heading + `<div style="display:grid;gap:20px;">${items.map(chat=>renderChatCard(chat)).join('')}</div>`;
    }

    function renderChatCard(chat){
        const id = chat?.session_id || chat?.id || chat?.sessionId || 'unknown';
        const projectName = chat?.project?.name || 'Unknown Project';
        // 与 chat-detail 保持一致：仅使用 chat.timestamp 或 chat.date（timestamp 优先）
        const baseTimestamp = (chat?.timestamp ?? chat?.date ?? null);
        const projectPath = chat?.project?.rootPath || '';
        const pathDisplay = projectPath ? toPrettyDisplayPath(projectPath) : '';
        const dateDisplay = formatTimestamp(baseTimestamp);
        const previewMessages = (chat?.messages || []).slice(-3); // 取最近3条
        return `
        <div class="chat-card" onclick="showChatDetail('${id}')">
            <div class="chat-header">
                <div class="chat-title">💬 ${projectName} · ${dateDisplay}</div>
                <div class="chat-meta">${pathDisplay ? pathDisplay : ''}</div>
            </div>
            <div class="chat-preview">
                ${previewMessages.length > 0 ? previewMessages.map(msg => `
                    <div class="message-preview ${msg.role === 'user' ? 'user-message' : 'assistant-message'}">
                        <strong>${msg.role === 'user' ? '👤 用户' : '🤖 助手'}:</strong>
                        ${escapeHtml(String(msg.content || '').slice(0, 120))}
                    </div>
                `).join('') : `<div class="message-preview assistant-message">暂无会话</div>`}
            </div>
            <div class="chat-actions" onclick="event.stopPropagation()">
                <button class="btn btn-sm btn-primary" onclick="showChatDetail('${id}')">👁️ 查看详情</button>
            </div>
        </div>`;
    }

    // 提取会话最佳时间戳（尽量保证卡片显示日期）
    function getChatTimestamp(chat){
        if (!chat) return null;
        let ts = chat.timestamp ?? chat.date ?? chat.lastUpdatedAt ?? chat.updatedAt
            ?? (chat.session ? (chat.session.lastUpdatedAt ?? chat.session.createdAt) : null);
        if (!ts && Array.isArray(chat.messages) && chat.messages.length){
            let maxTs = 0; for (const m of chat.messages){ const mt = Number(m.timestamp || 0); if (mt > maxTs) maxTs = mt; }
            ts = maxTs || null;
        }
        return ts || null;
    }

    function toCursorViewPath(p){ if (!p) return ''; const s=String(p).replace(/\\/g,'/'); const replaced=s.replace(/^([A-Za-z]):/, (m,d)=>`${d}%3A`); return replaced.startsWith('/')?replaced:'/'+replaced; }
    // 将 Windows 风格/光标视图风格路径转为可读形式，例如：/d%3A/Repos/X -> D:\\Repos\\X
    function toPrettyDisplayPath(p){
        if (!p) return '';
        let s = String(p);
        // 处理 /d%3A/xxx -> D:\\xxx
        if (/^\/[A-Za-z]%3A\//.test(s)){
            s = s.replace(/^\/([A-Za-z])%3A\//, (_, d) => `${String(d).toUpperCase()}:\\`);
            s = s.replace(/\//g, '\\');
            return s;
        }
        // 处理 D:/xxx -> D\\xxx
        if (/^[A-Za-z]:\//.test(s)){
            s = s.replace(/^([A-Za-z]):\//, (_, d) => `${String(d).toUpperCase()}:\\`);
            s = s.replace(/\//g, '\\');
            return s;
        }
        // 处理 d:\\xxx -> D:\\xxx
        if (/^[A-Za-z]:\\/.test(s)){
            s = s.replace(/^([A-Za-z]):\\/, (_, d) => `${String(d).toUpperCase()}:\\`);
            return s;
        }
        return s;
    }
    function showChatDetail(id){
        let url = `/chat-detail.html?sessionId=${encodeURIComponent(id)}&mode=cv`;
        try{ const u=new URL(window.location.href); const inst=u.searchParams.get('instance'); if(inst){ url += `&instance=${encodeURIComponent(inst)}`; } }catch{}
        window.open(url, '_blank');
    }

    // 保障每条记录具备 primary 时间戳字段（timestamp 或 date），方便统一展示
    function ensurePrimaryTimestamp(item){
        const copy = { ...(item||{}) };
        if (copy.timestamp == null && copy.date != null) {
            copy.timestamp = copy.date;
        }
        return copy;
    }

    async function loadStats(){ if (currentViewMode==='active') return; try{ const [sRes,pRes]=await Promise.all([fetch('/api/history/stats'), fetch('/api/history/projects')]); const s=await sRes.json(); const p=await pRes.json(); const messageCount=currentHistory.reduce((sum,it)=>sum+(it.messages?.length||0),0); const total=(s&&s.success)?(s.data.total||currentHistory.length):currentHistory.length; const chats=(s&&s.success)?(s.data.byType?.chat||currentHistory.length):currentHistory.length; const proj=(p&&p.success)?(p.data?.length||0):new Set(currentHistory.map(it=>it.project?.rootPath||it.project?.name)).size; document.getElementById('totalRecords').textContent=total; document.getElementById('chatRecords').textContent=chats; document.getElementById('projectCount').textContent=proj; document.getElementById('messageCount').textContent=messageCount; }catch(e){}}

    function showLoading(){ document.getElementById('historyContent').innerHTML = `<div class="loading"><div class="spinner"></div><div>正在加载聊天记录...</div></div>`; }
    function showError(msg){ document.getElementById('historyContent').innerHTML = `<div class="no-data"><div class="no-data-icon">⚠️</div><h3>加载失败</h3><p>${msg}</p></div>`; }
    function clearSearch(){ document.getElementById('searchInput').value=''; loadHistory(); }
    // 与 chat-detail.html 完全一致：简单直取并展示
    function formatTimestamp(timestamp){
        if (!timestamp) return 'N/A';
        const date = new Date(timestamp);
        return date.toLocaleString('zh-CN');
    }
    function escapeHtml(t){ const div=document.createElement('div'); div.textContent=t; return div.innerHTML; }
    </script>
</body>
</html>

