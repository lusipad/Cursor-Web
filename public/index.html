<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cursor Web - Cursor èŠå¤©åŒæ­¥</title>
    <link rel="stylesheet" href="style.css">
    <!-- å·²ç§»é™¤ Prismï¼šä»…ç”¨ marked æ¸²æŸ“ Markdown -->
    <script src="js/instance-utils.js"></script>
    <script>
      try{ InstanceUtils && InstanceUtils.ensureOrRedirect('/instances.html?first=1&return=/'); }catch{}
    </script>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Cursor Web</h1>
            <div style="display:flex;align-items:center;gap:12px;">
                 <a href="/test.html" class="btn btn-secondary" target="_blank" title="é…ç½®ä¸æ³¨å…¥æµ‹è¯•">âš™ è®¾ç½®</a>
                 <button id="toggle-broadcast" class="btn btn-info" style="padding:6px 10px">ğŸ“¡ å®æ—¶å¹¿æ’­: å…³é—­</button>
            </div>
        </header>

        <!-- Tab å¯¼èˆª -->
        <nav class="tab-nav">
            <button class="tab-btn active" data-tab="chat-tab">èŠå¤©</button>
            <button class="tab-btn" data-tab="realtime-tab">å®æ—¶å›æ˜¾</button>
            <button class="tab-btn" data-tab="history-tab">å†å²è®°å½•</button>
            <button class="tab-btn" data-tab="instances-tab">å®ä¾‹</button>
            <button class="tab-btn" data-tab="git-tab">Git ç®¡ç†</button>
            <button class="tab-btn" data-tab="diagnostic-tab">ç³»ç»Ÿè¯Šæ–­</button>
        </nav>

        <main class="main">
            <!-- èŠå¤© Tab å†…å®¹ï¼ˆå¯¹è¯ï¼‰ -->
            <section id="chat-tab" class="tab-content active">
                <div id="messages-container" class="messages-container">
                    <div class="welcome-message">
                        <h2>æ¬¢è¿ä½¿ç”¨ Cursor Web</h2>
                        <p>å±•ç¤ºæœºåˆ¶ï¼š</p>
                        <p>ğŸ” <strong>åŸºäºå†å²æ‹‰å–æ˜¾ç¤º</strong>ï¼šå‘é€æ¶ˆæ¯åï¼Œå®¢æˆ·ç«¯ä¼šçŸ­æœŸå¿«é€Ÿè½®è¯¢ï¼Œå¹¶åœ¨åå°ä»¥å›ºå®šé¢‘ç‡æ‹‰å– <code>/api/chats</code>/<code>/api/chats/latest</code> æ˜¾ç¤ºæœ€æ–°å›å¤ã€‚</p>
                        <p>âš™ï¸ å¯é€‰ï¼šå¦‚éœ€å®æ—¶ HTML å›æ˜¾ï¼Œå¯åœ¨è¯Šæ–­é¡µä¸´æ—¶å¼€å¯ WebSocket <code>html_content</code> å¹¿æ’­ï¼ˆé»˜è®¤å…³é—­ï¼Œä»…è°ƒè¯•ä½¿ç”¨ï¼‰ã€‚</p>
                        <br>
                        <p class="instruction">ä½¿ç”¨æ–¹æ³•ï¼šåœ¨ Cursor è¿è¡Œæ³¨å…¥è„šæœ¬ï¼ˆç”¨äºæ¶ˆæ¯å‘é€ä¸æ§åˆ¶ï¼‰ï¼Œç•Œé¢æ˜¾ç¤ºç”±å†å²æ‹‰å–å®Œæˆã€‚</p>
                        <a href="/script.html" class="btn btn-primary" style="display:inline-block;margin:10px 0;">å‰å¾€ä¸€é”®å¤åˆ¶æ³¨å…¥è„šæœ¬ &gt;&gt;</a>
                        <p class="instruction">æ³¨å…¥è„šæœ¬è´Ÿè´£æŠ•é€’æ¶ˆæ¯ä¸è¾…åŠ©æ§åˆ¶ï¼›ä¸å†å¼ºåˆ¶ä¾èµ– HTML å›æ˜¾ã€‚</p>
                    </div>
                </div>
                <footer class="footer">
                    <form id="send-form" autocomplete="off" onsubmit="return false">
                        <textarea id="send-input" placeholder="è¾“å…¥æ¶ˆæ¯... (æ”¯æŒ Markdown åŠä»£ç å—)" rows="1" autocomplete="off" style="resize:vertical"></textarea>
                        <button id="send-btn" type="button">å‘é€</button>
                        <button id="clear-btn" type="button">æ¸…é™¤</button>
                    </form>
                </footer>
            </section>

            <!-- å®æ—¶å›æ˜¾ Tab å†…å®¹ -->
            <section id="realtime-tab" class="tab-content">
                <div class="history-panel" style="padding:0;">
                    <div style="padding:10px 12px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #333;background:#1b1d22;gap:12px;flex-wrap:wrap;">
                        <div style="opacity:.9;display:flex;align-items:center;gap:10px;">
                          <span>å®æ—¶ HTML å›æ˜¾</span>
                          <span id="rt-broadcast-pill" class="badge badge-warn">çŠ¶æ€ï¼šæœªçŸ¥</span>
                          <button id="toggle-broadcast-rt" class="btn btn-info btn-small">è¯»å–çŠ¶æ€</button>
                          <span style="font-size:12px;color:#888;">ï¼ˆå¼€å¯åå°†ç«‹å³å¹¿æ’­æœ€è¿‘ä¸€æ¬¡å†…å®¹ï¼‰</span>
                        </div>
                        <div id="currentInstanceLabelRealtime" style="font-size:12px;color:#aaa;"></div>
                    </div>
                    <div id="realtime-container" class="messages-container"></div>
                </div>
            </section>

            <!-- å†å²è®°å½• Tab å†…å®¹ -->
            <section id="history-tab" class="tab-content">
             <div class="history-panel" style="padding:0;">
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;">
                      <div id="currentInstanceLabel" style="font-size:12px;color:#aaa;"></div>
                      <a href="/instances.html" class="btn btn-secondary" target="_blank">é€‰æ‹©/åˆ‡æ¢å®ä¾‹</a>
                    </div>
                    <iframe id="historyFrame" src="/history-new.html" style="width:100%;height:100vh;border:0;border-radius:8px;background:#111;"></iframe>
                </div>
            </section>

            <!-- å®ä¾‹ Tab å†…å®¹ -->
            <section id="instances-tab" class="tab-content">
                <div class="history-panel" style="padding:12px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:10px;">
                      <div id="instancesCurrentLabel" style="font-size:12px;color:#aaa;"></div>
                      <div style="display:flex;gap:8px;">
                        <button id="instances-refresh" class="btn btn-secondary">åˆ·æ–°</button>
                        <button id="instances-scan-inject" class="btn btn-info">æ‰«ææ³¨å…¥</button>
                        <button id="instances-kill-all" class="btn btn-danger">æ€æ­»å…¨éƒ¨</button>
                      </div>
                    </div>
                    <div id="instances-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(360px,1fr));gap:12px;margin-bottom:16px;"></div>
                    <div style="display:grid;grid-template-columns:1fr;gap:12px;">
                      <div class="card">
                        <h3 style="margin:0 0 8px 0;">è¿›ç¨‹åˆ—è¡¨</h3>
                        <div id="instances-processes" class="meta">åŠ è½½ä¸­...</div>
                      </div>
                      <div class="card">
                        <h3 style="margin:0 0 8px 0;">å·²è¿æ¥å®¢æˆ·ç«¯</h3>
                        <div id="instances-clients" class="meta">åŠ è½½ä¸­...</div>
                      </div>
                    </div>
                </div>
            </section>

            <!-- Git ç®¡ç† Tab å†…å®¹ -->
            <section id="git-tab" class="tab-content">
                <div class="git-panel">
                    <h2>Git åˆ†æ”¯ç®¡ç†</h2>
                    <div class="git-controls">
                        <div class="status-row">
                            <span>å®ä¾‹ï¼š</span>
                            <span id="git-instance-label" class="git-path">é»˜è®¤(å½“å‰ç›®å½•)</span>
                        </div>
                        <div class="git-status">
                            <div class="status-row">
                                <span>å½“å‰åˆ†æ”¯ï¼š</span>
                                <span id="current-branch" class="current-branch">åŠ è½½ä¸­...</span>
                            </div>
                            <div class="status-row">
                                <span>Git è·¯å¾„ï¼š</span>
                                <span id="git-path" class="git-path" title="">åŠ è½½ä¸­...</span>
                            </div>
                        </div>
                        <div class="git-actions">
                            <button id="refresh-branches" class="btn btn-secondary">åˆ·æ–°è¿œç¨‹åˆ†æ”¯</button>
                            <button id="pull-code" class="btn btn-primary">æ›´æ–°ä»£ç </button>
                            <button id="git-status" class="btn btn-info">æŸ¥çœ‹çŠ¶æ€</button>
                        </div>
                    </div>
                    <div class="branch-section">
                        <h3>åˆ†æ”¯åˆ‡æ¢</h3>
                        <div class="branch-selector">
                            <select id="branch-select" class="branch-select">
                                <option value="">é€‰æ‹©åˆ†æ”¯...</option>
                            </select>
                            <button id="checkout-branch" class="btn btn-success">åˆ‡æ¢åˆ†æ”¯</button>
                        </div>
                    </div>
                    <div class="commit-section">
                        <h3>ä»£ç æäº¤</h3>
                        <div class="commit-controls">
                            <div class="commit-input">
                                <input type="text" id="commit-message" placeholder="è¾“å…¥æäº¤ä¿¡æ¯..." class="commit-input-field">
                                <button id="add-files" class="btn btn-secondary">æ·»åŠ æ–‡ä»¶</button>
                                <button id="commit-code" class="btn btn-primary">æäº¤ä»£ç </button>
                                <button id="push-code" class="btn btn-success">æ¨é€ä»£ç </button>
                            </div>
                        </div>
                    </div>
                    <div id="git-output" class="git-output">
                        <div class="output-header">
                            <span>Git æ“ä½œè¾“å‡º</span>
                            <button id="clear-output" class="btn btn-small">æ¸…é™¤</button>
                        </div>
                        <div id="git-log" class="git-log"></div>
                    </div>
                </div>
            </section>

            <!-- ç³»ç»Ÿè¯Šæ–­ Tab å†…å®¹ -->
            <section id="diagnostic-tab" class="tab-content">
                <div class="diagnostic-panel">
                    <h2>ç³»ç»Ÿè¯Šæ–­</h2>
                    <p>æ£€æŸ¥ç³»ç»Ÿå„ä¸ªåŠŸèƒ½æ¨¡å—çš„çŠ¶æ€å’Œè¿æ¥æƒ…å†µ</p>
                    <div class="diagnostic-actions">
                        <a href="/diagnostic.html" class="btn btn-primary" target="_blank">
                            ğŸ” æ‰“å¼€å®Œæ•´è¯Šæ–­é¡µé¢
                        </a>
                        <p class="instruction">åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€å®Œæ•´çš„ç³»ç»Ÿè¯Šæ–­ç•Œé¢ï¼ŒåŒ…å«æ‰€æœ‰æµ‹è¯•åŠŸèƒ½</p>
                    </div>
                    <div class="quick-status">
                        <h3>å¿«é€ŸçŠ¶æ€æ£€æŸ¥</h3>
                        <div id="quick-status-grid" class="quick-status-grid">
                            <div class="status-item">
                                <span class="status-label">WebSocketè¿æ¥</span>
                                <span id="ws-status" class="status-value">æ£€æŸ¥ä¸­...</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">CursorçŠ¶æ€</span>
                                <span id="cursor-status" class="status-value">æ£€æŸ¥ä¸­...</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">æ¨¡å—åŠ è½½</span>
                                <span id="module-status" class="status-value">æ£€æŸ¥ä¸­...</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">å®¢æˆ·ç«¯çŠ¶æ€</span>
                                <span id="client-status" class="status-value">æ£€æŸ¥ä¸­...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- ç§»é™¤ Prism ç›¸å…³è„šæœ¬ -->
    <!-- Marked: ä¸¥æ ¼çš„ Markdown è§£æï¼Œé¿å…ä»£ç å—æˆªæ–­é—®é¢˜ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
     <script src="js/modules/module-loader.js"></script>
     <script>
       // è½»é‡åˆå§‹åŒ– SimpleWebClientï¼šç”¨äºå»ºç«‹ WS è¿æ¥å¹¶ä¸ŠæŠ¥ web å®¢æˆ·ç«¯åœ¨çº¿çŠ¶æ€
       (function(){
         function boot(){ try{ if (window.SimpleWebClient && !window.simpleClient){ window.simpleClient = new window.SimpleWebClient(); } }catch{} }
         // è‹¥æ¨¡å—åŠ è½½å™¨å¼‚æ­¥åŠ è½½äº† SimpleWebClientï¼Œè¿™é‡Œå…œåº•ç­‰å¾… 1s å†å°è¯•
         setTimeout(boot, 1000);
       })();
     </script>
     <script src="js/instance-banner.js"></script>
     <script src="js/modules/InjectBar.js"></script>
     <script src="js/modules/DiagnosticQuickStatus.js"></script>
    <script>
      // ç¡®ä¿å…¬å…±æ¸²æŸ“å·¥å…·åŠ è½½
      if (window.ModuleLoader){
        // MarkdownRenderer åªæœ‰ ErrorHandler ä¾èµ–ï¼Œè‹¥æœªè‡ªåŠ¨åŠ è½½åˆ™æ‰‹åŠ¨åŠ è½½ä¸€æ¬¡
        if (!window.MarkdownRenderer){
          const s = document.createElement('script');
          s.src = 'js/modules/MarkdownRenderer.js';
          document.head.appendChild(s);
        }
      }
    </script>
     <script src="git-manager.js"></script>
     <script src="js/instances-tab.js"></script>
     <script src="js/broadcast-toggle.js"></script>
    <script>
    // å®æ—¶å¹¿æ’­å¼€å…³ï¼ˆè¯Šæ–­/è°ƒè¯•ç”¨ï¼‰
    (function setupBroadcastToggle(){
        const btn = document.getElementById('toggle-broadcast');
        if (!btn) return;
        async function refresh(){
            try{
                const r = await fetch('/api/debug/html-broadcast');
                const j = await r.json();
                const on = !!(j && (j.enabled===true || j.enabled==='true'));
                btn.textContent = 'ğŸ“¡ å®æ—¶å¹¿æ’­: ' + (on ? 'å¼€å¯' : 'å…³é—­');
                btn.dataset.on = on ? '1' : '0';
            }catch{ btn.textContent='ğŸ“¡ å®æ—¶å¹¿æ’­: æœªçŸ¥'; }
        }
        btn.addEventListener('click', async ()=>{
            const on = btn.dataset.on === '1';
            try{
                const r = await fetch('/api/debug/html-broadcast?enable='+(on?'0':'1'));
                await refresh();
            }catch{}
        });
        refresh();
    })();

    // å®æ—¶å›æ˜¾é¡µï¼šçŠ¶æ€èƒ¶å›Šä¸å¼€å…³æŒ‰é’®ï¼ˆä»…è¯¥ Tab å¯è§ï¼‰
    (function setupRealtimeBroadcastUI(){
      const pill = document.getElementById('rt-broadcast-pill');
      const btn = document.getElementById('toggle-broadcast-rt');
      if (!pill || !btn) return;
      function setPill(on){
        pill.textContent = 'çŠ¶æ€ï¼š' + (on?'å¼€å¯':'å…³é—­');
        pill.className = 'badge ' + (on ? 'badge-ok' : 'badge-warn');
        btn.textContent = on ? 'å…³é—­å¹¿æ’­' : 'å¼€å¯å¹¿æ’­';
      }
      async function refresh(){
        try{
          const r = await fetch('/api/debug/html-broadcast');
          const j = await r.json();
          const on = !!(j && (j.enabled===true || j.enabled==='true'));
          setPill(on);
        }catch{ setPill(false); }
      }
      btn.addEventListener('click', async ()=>{
        try{
          const on = pill.classList.contains('badge-ok');
          await fetch('/api/debug/html-broadcast?enable='+(on?'0':'1'));
          await refresh();
        }catch{}
      });
      // åˆå§‹åˆ·æ–°
      refresh();
    })();

    // Tab åˆ‡æ¢é€»è¾‘
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            this.classList.add('active');
            document.getElementById(this.dataset.tab).classList.add('active');

            // å¦‚æœåˆ‡æ¢åˆ°è¯Šæ–­tabï¼Œæ›´æ–°å¿«é€ŸçŠ¶æ€
            if (this.dataset.tab === 'diagnostic-tab') {
                updateQuickStatus();
            }
            // åˆ‡æ¢æ¸²æŸ“ç›®æ ‡ï¼ˆèŠå¤©: #messages-containerï¼›å®æ—¶å›æ˜¾: #realtime-containerï¼‰
            if (this.dataset.tab === 'realtime-tab') {
                window.__renderTargetId = 'realtime-container';
                window.__enableRealtimeRender = true;
                try{ InstanceUtils && InstanceUtils.renderBadge(document.getElementById('currentInstanceLabelRealtime')); }catch{}
            } else if (this.dataset.tab === 'chat-tab') {
                window.__renderTargetId = 'messages-container';
                window.__enableRealtimeRender = false;
                try{ InstanceUtils && InstanceUtils.renderBadge(document.getElementById('currentInstanceLabel')); }catch{}
            }
            
            // å†å²è®°å½•tab ç›´æ¥å†…åµŒï¼Œæ— éœ€é¢å¤–åŠ è½½
        });
    });

    // æ›´æ–°å¿«é€ŸçŠ¶æ€æ£€æŸ¥ï¼ˆæå–ä¸ºæ¨¡å—ï¼‰
    function updateQuickStatus(){ try{ window.DiagnosticQuickStatus && window.DiagnosticQuickStatus.update(); }catch{} }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.addEventListener('load', function() {
        // å¦‚æœ URL å¸¦æœ‰ ?instance=ï¼ŒåŒæ­¥ç»™å†å² iframe
        try{
            const u = new URL(window.location.href);
            const inst = u.searchParams.get('instance');
            if (inst) {
                const iframe = document.getElementById('historyFrame');
                if (iframe) {
                    const base = '/history-new.html';
                    iframe.src = `${base}?instance=${encodeURIComponent(inst)}`;
                }
                // å­˜å‚¨å®ä¾‹å¹¶åˆ·æ–°é¡¶éƒ¨æ ‡è¯†
                try{ InstanceUtils && InstanceUtils.set(inst); }catch{}
            }
        }catch{}
        // æ¸²æŸ“å½“å‰å®ä¾‹æ ‡è¯†
        try{ InstanceUtils && InstanceUtils.renderBadge(document.getElementById('currentInstanceLabel')); }catch{}
        try{ InstanceUtils && InstanceUtils.renderBadge(document.getElementById('currentInstanceLabelRealtime')); }catch{}

        // é»˜è®¤æ¸²æŸ“ç›®æ ‡ä¸ºèŠå¤©
        window.__renderTargetId = 'messages-container';
        window.__enableRealtimeRender = false;
        // å¦‚æœå½“å‰åœ¨è¯Šæ–­tabï¼Œæ›´æ–°çŠ¶æ€
        if (document.querySelector('.tab-btn[data-tab="diagnostic-tab"]').classList.contains('active')) {
            updateQuickStatus();
        }
        
        // å†å²è®°å½•tab ç›´æ¥å†…åµŒï¼Œæ— éœ€é¢„åŠ è½½

        // å®šæœŸæ›´æ–°çŠ¶æ€ï¼ˆæ¯5ç§’ï¼‰
        try{ window.DiagnosticQuickStatus && window.DiagnosticQuickStatus.startAuto && window.DiagnosticQuickStatus.startAuto(); }catch{}
    });
    
    // ç§»é™¤å¿«é€Ÿå†å²ç›¸å…³é€»è¾‘ï¼ˆæ”¹ä¸ºå†…åµŒ history-newï¼‰
    
    // æ ¼å¼åŒ–æ—¶é—´æˆ³
    function formatTimestamp(timestamp) {
        return new Date(timestamp).toLocaleString();
    }
    
    // è·å–ç±»å‹æ ‡ç­¾
    function getTypeLabel(type) {
        const labels = {
            'chat': 'èŠå¤©',
            'system': 'ç³»ç»Ÿ',
            'error': 'é”™è¯¯',
            'git': 'Git'
        };
        return labels[type] || type;
    }

    // è®©å†å²è®°å½• iframe è‡ªé€‚åº”å†…å®¹é«˜åº¦ï¼Œä¿è¯é¡µé¢å¯æŒç»­å‘ä¸‹æ»šåŠ¨
    (function setupHistoryIframeAutoHeight(){
        const iframe = document.getElementById('historyFrame');
        if (!iframe) return;
        const resize = () => {
            try {
                const doc = iframe.contentDocument || iframe.contentWindow.document;
                if (!doc) return;
                const h = Math.max(
                    doc.body.scrollHeight,
                    doc.documentElement.scrollHeight,
                    doc.body.offsetHeight,
                    doc.documentElement.offsetHeight
                );
                if (h && Math.abs(iframe.clientHeight - h) > 8) {
                    iframe.style.height = h + 'px';
                }
            } catch {}
        };
        iframe.addEventListener('load', () => {
            resize();
            try {
                const doc = iframe.contentDocument || iframe.contentWindow.document;
                if (!doc) return;
                const mo = new MutationObserver(() => resize());
                mo.observe(doc.documentElement, { childList: true, subtree: true, attributes: true, characterData: true });
                iframe.contentWindow.addEventListener('resize', resize);
                // å…œåº•å®šæ—¶å™¨ï¼Œå¤„ç†å¼‚æ­¥æ¸²æŸ“
                setInterval(resize, 800);
            } catch {}
        });
        window.addEventListener('resize', resize);
    })();
    </script>
</body>
</html>
