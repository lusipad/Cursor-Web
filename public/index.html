<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cursor Web - Cursor 聊天同步</title>
    <link rel="stylesheet" href="style.css">
    <!-- Prism.js 语法高亮样式（轻量主题） -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Cursor Web</h1>
            <div style="display:flex;align-items:center;gap:12px;">
                <a href="/test.html" class="btn btn-secondary" target="_blank" title="配置与注入测试">⚙ 设置</a>
                <div id="status" class="status disconnected">等待连接...</div>
            </div>
        </header>

        <!-- Tab 导航 -->
        <nav class="tab-nav">
            <button class="tab-btn active" data-tab="chat-tab">聊天</button>
            <button class="tab-btn" data-tab="history-tab">历史记录</button>
            <button class="tab-btn" data-tab="git-tab">Git 管理</button>
            <button class="tab-btn" data-tab="diagnostic-tab">系统诊断</button>
        </nav>

        <main class="main">
            <!-- 聊天 Tab 内容 -->
            <section id="chat-tab" class="tab-content active">
                <div id="messages-container" class="messages-container">
                    <div class="welcome-message">
                        <h2>欢迎使用 Cursor Web</h2>
                        <p>展示机制：</p>
                        <p>🔁 <strong>基于历史拉取显示</strong>：发送消息后，客户端会短期快速轮询，并在后台以固定频率拉取 <code>/api/chats</code>/<code>/api/chats/latest</code> 显示最新回复。</p>
                        <p>⚙️ 可选：如需实时 HTML 回显，可在诊断页临时开启 WebSocket <code>html_content</code> 广播（默认关闭，仅调试使用）。</p>
                        <br>
                        <p class="instruction">使用方法：在 Cursor 运行注入脚本（用于消息发送与控制），界面显示由历史拉取完成。</p>
                        <a href="/script.html" class="btn btn-primary" style="display:inline-block;margin:10px 0;">前往一键复制注入脚本 &gt;&gt;</a>
                        <p class="instruction">注入脚本负责投递消息与辅助控制；不再强制依赖 HTML 回显。</p>
                    </div>
                </div>
                <footer class="footer">
                    <form id="send-form" autocomplete="off" onsubmit="return false">
                        <textarea id="send-input" placeholder="输入消息... (支持 Markdown 及代码块)" rows="1" autocomplete="off" style="resize:vertical"></textarea>
                        <button id="send-btn" type="button">发送</button>
                        <button id="clear-btn" type="button">清除</button>
                    </form>
                </footer>
            </section>

            <!-- 历史记录 Tab 内容 -->
            <section id="history-tab" class="tab-content">
                <div class="history-panel" style="padding:0;">
                    <iframe id="historyFrame" src="/history-new.html" style="width:100%;height:100vh;border:0;border-radius:8px;background:#111;"></iframe>
                </div>
            </section>

            <!-- Git 管理 Tab 内容 -->
            <section id="git-tab" class="tab-content">
                <div class="git-panel">
                    <h2>Git 分支管理</h2>
                    <div class="git-controls">
                        <div class="status-row">
                            <span>实例：</span>
                            <span id="git-instance-label" class="git-path">默认(当前目录)</span>
                        </div>
                        <div class="git-status">
                            <div class="status-row">
                                <span>当前分支：</span>
                                <span id="current-branch" class="current-branch">加载中...</span>
                            </div>
                            <div class="status-row">
                                <span>Git 路径：</span>
                                <span id="git-path" class="git-path" title="">加载中...</span>
                            </div>
                        </div>
                        <div class="git-actions">
                            <button id="refresh-branches" class="btn btn-secondary">刷新远程分支</button>
                            <button id="pull-code" class="btn btn-primary">更新代码</button>
                            <button id="git-status" class="btn btn-info">查看状态</button>
                        </div>
                    </div>
                    <div class="branch-section">
                        <h3>分支切换</h3>
                        <div class="branch-selector">
                            <select id="branch-select" class="branch-select">
                                <option value="">选择分支...</option>
                            </select>
                            <button id="checkout-branch" class="btn btn-success">切换分支</button>
                        </div>
                    </div>
                    <div class="commit-section">
                        <h3>代码提交</h3>
                        <div class="commit-controls">
                            <div class="commit-input">
                                <input type="text" id="commit-message" placeholder="输入提交信息..." class="commit-input-field">
                                <button id="add-files" class="btn btn-secondary">添加文件</button>
                                <button id="commit-code" class="btn btn-primary">提交代码</button>
                                <button id="push-code" class="btn btn-success">推送代码</button>
                            </div>
                        </div>
                    </div>
                    <div id="git-output" class="git-output">
                        <div class="output-header">
                            <span>Git 操作输出</span>
                            <button id="clear-output" class="btn btn-small">清除</button>
                        </div>
                        <div id="git-log" class="git-log"></div>
                    </div>
                </div>
            </section>

            <!-- 系统诊断 Tab 内容 -->
            <section id="diagnostic-tab" class="tab-content">
                <div class="diagnostic-panel">
                    <h2>系统诊断</h2>
                    <p>检查系统各个功能模块的状态和连接情况</p>
                    <div class="diagnostic-actions">
                        <a href="/diagnostic.html" class="btn btn-primary" target="_blank">
                            🔍 打开完整诊断页面
                        </a>
                        <p class="instruction">在新标签页中打开完整的系统诊断界面，包含所有测试功能</p>
                    </div>
                    <div class="quick-status">
                        <h3>快速状态检查</h3>
                        <div id="quick-status-grid" class="quick-status-grid">
                            <div class="status-item">
                                <span class="status-label">WebSocket连接</span>
                                <span id="ws-status" class="status-value">检查中...</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Cursor状态</span>
                                <span id="cursor-status" class="status-value">检查中...</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">模块加载</span>
                                <span id="module-status" class="status-value">检查中...</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">客户端状态</span>
                                <span id="client-status" class="status-value">检查中...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Prism.js 语法高亮核心与常用语言组件（按需可增减） -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-clike.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-typescript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-java.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-c.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-cpp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/keep-markup/prism-keep-markup.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markdown.min.js"></script>
    <!-- Marked: 严格的 Markdown 解析，避免代码块截断问题 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="js/modules/module-loader.js"></script>
    <script>
      // 确保公共渲染工具加载
      if (window.ModuleLoader){
        // MarkdownRenderer 只有 ErrorHandler 依赖，若未自动加载则手动加载一次
        if (!window.MarkdownRenderer){
          const s = document.createElement('script');
          s.src = 'js/modules/MarkdownRenderer.js';
          document.head.appendChild(s);
        }
      }
    </script>
    <script src="git-manager.js"></script>
    <script>
    // Tab 切换逻辑
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            this.classList.add('active');
            document.getElementById(this.dataset.tab).classList.add('active');

            // 如果切换到诊断tab，更新快速状态
            if (this.dataset.tab === 'diagnostic-tab') {
                updateQuickStatus();
            }
            
            // 历史记录tab 直接内嵌，无需额外加载
        });
    });

        // 更新快速状态检查
    function updateQuickStatus() {
        // WebSocket状态 - 使用更准确的检测方法
        const wsStatus = document.getElementById('ws-status');
        let wsConnected = false;

        // 方法1: 检查simpleClient的WebSocket状态（与诊断页面保持一致）
        if (window.simpleClient && typeof window.simpleClient.isConnected === 'function') {
            wsConnected = window.simpleClient.isConnected();
        }
        // 方法2: 检查simpleClient的wsManager状态
        else if (window.simpleClient && window.simpleClient.wsManager && typeof window.simpleClient.wsManager.isConnected === 'function') {
            wsConnected = window.simpleClient.wsManager.isConnected();
        }
        // 方法3: 检查页面状态元素
        else if (document.querySelector('.status.connected')) {
            wsConnected = true;
        }
        // 方法4: 检查WebSocketManager模块
        else if (window.WebSocketManager && typeof window.WebSocketManager.isConnected === 'function') {
            wsConnected = window.WebSocketManager.isConnected();
        }

        if (wsConnected) {
            wsStatus.textContent = '已连接';
            wsStatus.className = 'status-value connected';
        } else {
            wsStatus.textContent = '未连接';
            wsStatus.className = 'status-value disconnected';
        }

        // 调试信息（可选）
        if (window.simpleClient) {
            console.log('首页WebSocket状态检测:', {
                simpleClientExists: !!window.simpleClient,
                isConnectedMethod: typeof window.simpleClient.isConnected,
                wsManagerExists: !!window.simpleClient.wsManager,
                wsManagerIsConnectedMethod: window.simpleClient.wsManager ? typeof window.simpleClient.wsManager.isConnected : 'N/A',
                finalResult: wsConnected
            });
        }

        // 模块加载状态
        const moduleStatus = document.getElementById('module-status');
        if (window.ModuleLoader) {
            moduleStatus.textContent = '已加载';
            moduleStatus.className = 'status-value success';
        } else {
            moduleStatus.textContent = '未加载';
            moduleStatus.className = 'status-value error';
        }

        // Cursor状态
        const cursorStatus = document.getElementById('cursor-status');
        if (window.simpleClient && window.simpleClient.cursorStatusManager) {
            try {
                const status = window.simpleClient.cursorStatusManager.getCursorStatus();
                switch (status.status) {
                    case 'active':
                        cursorStatus.textContent = '活跃';
                        cursorStatus.className = 'status-value success';
                        break;
                    case 'waiting':
                        cursorStatus.textContent = '等待';
                        cursorStatus.className = 'status-value warning';
                        break;
                    case 'inactive':
                        cursorStatus.textContent = '不活跃';
                        cursorStatus.className = 'status-value warning';
                        break;
                    case 'closed':
                        cursorStatus.textContent = '已关闭';
                        cursorStatus.className = 'status-value error';
                        break;
                    default:
                        cursorStatus.textContent = '未知';
                        cursorStatus.className = 'status-value error';
                }
            } catch (error) {
                cursorStatus.textContent = '检查失败';
                cursorStatus.className = 'status-value error';
            }
        } else {
            cursorStatus.textContent = '未初始化';
            cursorStatus.className = 'status-value error';
        }

        // 客户端状态
        const clientStatus = document.getElementById('client-status');
        if (window.simpleClient) {
            clientStatus.textContent = '已初始化';
            clientStatus.className = 'status-value success';
        } else {
            clientStatus.textContent = '未初始化';
            clientStatus.className = 'status-value error';
        }
    }

    // 页面加载完成后初始化
    window.addEventListener('load', function() {
        // 如果 URL 带有 ?instance=，同步给历史 iframe
        try{
            const u = new URL(window.location.href);
            const inst = u.searchParams.get('instance');
            if (inst) {
                const iframe = document.getElementById('historyFrame');
                if (iframe) {
                    const base = '/history-new.html';
                    iframe.src = `${base}?instance=${encodeURIComponent(inst)}`;
                }
            }
        }catch{}
        // 如果当前在诊断tab，更新状态
        if (document.querySelector('.tab-btn[data-tab="diagnostic-tab"]').classList.contains('active')) {
            updateQuickStatus();
        }
        
        // 历史记录tab 直接内嵌，无需预加载

        // 定期更新状态（每5秒）
        setInterval(function() {
            if (document.querySelector('.tab-btn[data-tab="diagnostic-tab"]').classList.contains('active')) {
                updateQuickStatus();
            }
        }, 5000);
    });
    
    // 移除快速历史相关逻辑（改为内嵌 history-new）
    
    // 格式化时间戳
    function formatTimestamp(timestamp) {
        return new Date(timestamp).toLocaleString();
    }
    
    // 获取类型标签
    function getTypeLabel(type) {
        const labels = {
            'chat': '聊天',
            'system': '系统',
            'error': '错误',
            'git': 'Git'
        };
        return labels[type] || type;
    }

    // 让历史记录 iframe 自适应内容高度，保证页面可持续向下滚动
    (function setupHistoryIframeAutoHeight(){
        const iframe = document.getElementById('historyFrame');
        if (!iframe) return;
        const resize = () => {
            try {
                const doc = iframe.contentDocument || iframe.contentWindow.document;
                if (!doc) return;
                const h = Math.max(
                    doc.body.scrollHeight,
                    doc.documentElement.scrollHeight,
                    doc.body.offsetHeight,
                    doc.documentElement.offsetHeight
                );
                if (h && Math.abs(iframe.clientHeight - h) > 8) {
                    iframe.style.height = h + 'px';
                }
            } catch {}
        };
        iframe.addEventListener('load', () => {
            resize();
            try {
                const doc = iframe.contentDocument || iframe.contentWindow.document;
                if (!doc) return;
                const mo = new MutationObserver(() => resize());
                mo.observe(doc.documentElement, { childList: true, subtree: true, attributes: true, characterData: true });
                iframe.contentWindow.addEventListener('resize', resize);
                // 兜底定时器，处理异步渲染
                setInterval(resize, 800);
            } catch {}
        });
        window.addEventListener('resize', resize);
    })();
    </script>
</body>
</html>
