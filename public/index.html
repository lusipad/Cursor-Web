<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Web - Cursor 聊天同步</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Claude Web</h1>
            <div id="status" class="status disconnected">等待连接...</div>
        </header>

        <!-- Tab 导航 -->
        <nav class="tab-nav">
            <button class="tab-btn" data-tab="chat-tab">聊天</button>
                <button class="tab-btn active" data-tab="history-tab">历史记录</button>
            <button class="tab-btn" data-tab="git-tab">Git 管理</button>
            <button class="tab-btn" data-tab="diagnostic-tab">系统诊断</button>
        </nav>

        <main class="main">
            <!-- 聊天 Tab 内容 -->
            <section id="chat-tab" class="tab-content">
                <div id="messages-container" class="messages-container">
                    <div class="welcome-message">
                        <h2>欢迎使用 Claude Web</h2>
                        <p>状态说明：</p>
                        <p>🟡 <strong>已连接 - 等待 Cursor 内容</strong>：需要在 Cursor 中运行注入脚本</p>
                        <p>🟢 <strong>已连接 - 同步正常</strong>：内容同步工作正常</p>
                        <br>
                        <p class="instruction">使用方法：在 Cursor 开发者工具中运行同步脚本</p>
                        <a href="/script.html" class="btn btn-primary" style="display:inline-block;margin:10px 0;">前往一键复制同步脚本 &gt;&gt;</a>
                        <p class="instruction">脚本会同步整个 Cursor 页面内容到此页面</p>
                    </div>
                </div>
                <footer class="footer">
                    <form id="send-form" autocomplete="off">
                        <input id="send-input" type="text" placeholder="输入消息..." autocomplete="off" />
                        <button id="send-btn" type="submit">发送</button>
                        <button id="clear-btn" type="button">清除</button>
                    </form>
                </footer>
            </section>

            <!-- 历史记录 Tab 内容 -->
            <section id="history-tab" class="tab-content active">
                <div class="history-panel">
                    <div style="padding: 20px; border-bottom: 1px solid #404040;">
                        <h2 style="margin: 0 0 15px 0; color: #ffffff;">Cursor 聊天历史记录</h2>
                        
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <input type="text" id="history-search" placeholder="搜索聊天内容..." 
                                   style="padding: 8px 12px; border: 1px solid #404040; border-radius: 4px; font-size: 14px; min-width: 200px; background: #2d2d2d; color: #ffffff;">
                            <input type="text" id="folder-search" placeholder="筛选文件夹..." 
                                   style="padding: 8px 12px; border: 1px solid #404040; border-radius: 4px; font-size: 14px; min-width: 150px; background: #2d2d2d; color: #ffffff;">
                            <button onclick="searchChats()" class="btn btn-primary">搜索</button>
                            <button onclick="refreshChats()" class="btn btn-secondary">刷新</button>
                            <button onclick="clearCache()" class="btn btn-info">清除缓存</button>
                            <button id="toggle-all-projects" class="btn btn-info" onclick="toggleAllProjects()" title="切换显示所有项目">
                                📁 全部项目
                            </button>
                        </div>
                    </div>
                    
                    <div id="history-stats" style="padding: 10px 20px; background: #2d2d2d; border-bottom: 1px solid #404040; font-size: 14px; color: #cccccc;">
                        准备就绪...
                    </div>
                    
                    <div style="display: flex; height: 500px;">
                        <!-- 项目文件夹导航 -->
                        <div style="width: 250px; border-right: 1px solid #404040; overflow-y: auto; padding: 0; background: #2d2d2d;">
                            <div style="padding: 10px; border-bottom: 1px solid #404040; font-weight: 600; background: #404040; color: #ffffff;">
                                项目文件夹
                            </div>
                            <div id="project-folders" style="padding: 0;">
                                <div class="loading" style="padding: 20px; text-align: center; color: #cccccc;">正在加载项目...</div>
                            </div>
                        </div>
                        
                        <!-- 聊天列表 -->
                        <div style="flex: 1; border-right: 1px solid #404040; overflow-y: auto; padding: 20px; background: #1a1a1a;">
                            <div id="chat-list-container">
                                <div class="loading" style="color: #cccccc;">正在加载聊天记录...</div>
                            </div>
                        </div>
                        
                        <!-- 聊天详情 -->
                        <div style="flex: 2; overflow-y: auto; padding: 20px; background: #1a1a1a;">
                            <div id="chat-detail-container">
                                <div class="loading" style="color: #cccccc;">选择一个聊天查看详情...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Git 管理 Tab 内容 -->
            <section id="git-tab" class="tab-content">
                <div class="git-panel">
                    <h2>Git 分支管理</h2>
                    <div class="git-controls">
                        <div class="git-status">
                            <div class="status-row">
                                <span>当前分支：</span>
                                <span id="current-branch" class="current-branch">加载中...</span>
                            </div>
                            <div class="status-row">
                                <span>Git 路径：</span>
                                <span id="git-path" class="git-path" title="">加载中...</span>
                            </div>
                        </div>
                        <div class="git-actions">
                            <button id="refresh-branches" class="btn btn-secondary">刷新远程分支</button>
                            <button id="pull-code" class="btn btn-primary">更新代码</button>
                            <button id="git-status" class="btn btn-info">查看状态</button>
                        </div>
                    </div>
                    <div class="branch-section">
                        <h3>分支切换</h3>
                        <div class="branch-selector">
                            <select id="branch-select" class="branch-select">
                                <option value="">选择分支...</option>
                            </select>
                            <button id="checkout-branch" class="btn btn-success">切换分支</button>
                        </div>
                    </div>
                    <div class="commit-section">
                        <h3>代码提交</h3>
                        <div class="commit-controls">
                            <div class="commit-input">
                                <input type="text" id="commit-message" placeholder="输入提交信息..." class="commit-input-field">
                                <button id="add-files" class="btn btn-secondary">添加文件</button>
                                <button id="commit-code" class="btn btn-primary">提交代码</button>
                                <button id="push-code" class="btn btn-success">推送代码</button>
                            </div>
                        </div>
                    </div>
                    <div id="git-output" class="git-output">
                        <div class="output-header">
                            <span>Git 操作输出</span>
                            <button id="clear-output" class="btn btn-small">清除</button>
                        </div>
                        <div id="git-log" class="git-log"></div>
                    </div>
                </div>
            </section>

            <!-- 系统诊断 Tab 内容 -->
            <section id="diagnostic-tab" class="tab-content">
                <div class="diagnostic-panel">
                    <h2>系统诊断</h2>
                    <p>检查系统各个功能模块的状态和连接情况</p>
                    <div class="diagnostic-actions">
                        <a href="/diagnostic.html" class="btn btn-primary" target="_blank">
                            🔍 打开完整诊断页面
                        </a>
                        <p class="instruction">在新标签页中打开完整的系统诊断界面，包含所有测试功能</p>
                    </div>
                    <div class="quick-status">
                        <h3>快速状态检查</h3>
                        <div id="quick-status-grid" class="quick-status-grid">
                            <div class="status-item">
                                <span class="status-label">WebSocket连接</span>
                                <span id="ws-status" class="status-value">检查中...</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Cursor状态</span>
                                <span id="cursor-status" class="status-value">检查中...</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">模块加载</span>
                                <span id="module-status" class="status-value">检查中...</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">客户端状态</span>
                                <span id="client-status" class="status-value">检查中...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script src="js/modules/git-manager.js"></script>
    <script>
        // 历史记录功能 - 独立实现
        class HistoryApiClient {
            constructor() {
                this.baseUrl = '/api/history';
            }

            async getAllChats(options = {}) {
                const params = new URLSearchParams();
                if (options.limit) params.append('limit', options.limit);
                if (options.offset) params.append('offset', options.offset);
                
                const url = `${this.baseUrl}/chats${params.toString() ? '?' + params.toString() : ''}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                return await response.json();
            }

            async getChatDetail(sessionId) {
                const response = await fetch(`${this.baseUrl}/chat/${encodeURIComponent(sessionId)}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                return await response.json();
            }

            async searchChats(query) {
                const response = await fetch(`${this.baseUrl}/search?q=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                return await response.json();
            }

            async clearCache() {
                const response = await fetch(`${this.baseUrl}/cache`, { method: 'DELETE' });
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                return await response.json();
            }
        }

        class HistoryService {
            constructor() {
                this.apiClient = new HistoryApiClient();
                this.cache = new Map();
                this.cacheTimeout = 5 * 60 * 1000;
            }

            async getChatList(options = {}) {
                const cacheKey = `all_chats_${JSON.stringify(options)}`;
                const cached = this.cache.get(cacheKey);
                
                if (cached && Date.now() - cached.timestamp < this.cacheTimeout) {
                    return cached.data;
                }

                try {
                    const response = await this.apiClient.getAllChats(options);
                    
                    let chats;
                    if (response && response.success && Array.isArray(response.data)) {
                        chats = response.data;
                    } else {
                        console.warn('意外的API响应格式:', response);
                        chats = [];
                    }

                    const processedChats = this.processChats(chats);
                    this.cache.set(cacheKey, { data: processedChats, timestamp: Date.now() });
                    return processedChats;
                } catch (error) {
                    console.error('获取聊天列表失败:', error);
                    throw error;
                }
            }

            async getChatDetail(sessionId) {
                try {
                    const response = await this.apiClient.getChatDetail(sessionId);
                    const chatDetail = response.data;
                    return this.processChatDetail(chatDetail);
                } catch (error) {
                    console.error('获取聊天详情失败:', error);
                    throw error;
                }
            }

            async searchChats(query) {
                if (!query || query.trim() === '') {
                    return this.getChatList();
                }

                try {
                    const response = await this.apiClient.searchChats(query);
                    return this.processChats(response.data || []);
                } catch (error) {
                    console.error('搜索聊天记录失败:', error);
                    throw error;
                }
            }

            async clearCache() {
                this.cache.clear();
                return await this.apiClient.clearCache();
            }

            processChats(chats) {
                if (!Array.isArray(chats)) {
                    console.warn('processChats: 期望数组但收到:', typeof chats, chats);
                    return [];
                }
                
                return chats.map(chat => ({
                    ...chat,
                    title: this.generateChatTitle(chat),
                    preview: this.generateChatPreview(chat),
                    formattedTime: this.formatTime(chat.timestamp || chat.lastModified),
                    messageCount: chat.messages ? chat.messages.length : 0
                }));
            }

            processChatDetail(chatDetail) {
                return {
                    ...chatDetail,
                    title: this.generateChatTitle(chatDetail),
                    formattedTime: this.formatTime(chatDetail.timestamp || chatDetail.lastModified),
                    messages: chatDetail.messages ? chatDetail.messages.map(msg => ({
                        ...msg,
                        formattedTime: this.formatTime(msg.timestamp)
                    })) : []
                };
            }

            generateChatTitle(chat) {
                if (chat.title) return chat.title;
                
                if (chat.messages && chat.messages.length > 0) {
                    const firstUserMessage = chat.messages.find(msg => msg.role === 'user');
                    if (firstUserMessage) {
                        return firstUserMessage.content.substring(0, 50) + 
                               (firstUserMessage.content.length > 50 ? '...' : '');
                    }
                }
                
                return `聊天记录 ${this.formatTime(chat.timestamp || Date.now())}`;
            }

            generateChatPreview(chat) {
                if (chat.messages && chat.messages.length > 0) {
                    const lastMessage = chat.messages[chat.messages.length - 1];
                    return lastMessage.content.substring(0, 100) + 
                           (lastMessage.content.length > 100 ? '...' : '');
                }
                return '暂无消息';
            }

            formatTime(timestamp) {
                if (!timestamp) return '未知时间';
                
                const date = new Date(timestamp);
                const now = new Date();
                const diff = now - date;
                
                if (diff < 60000) return '刚刚';
                if (diff < 3600000) return `${Math.floor(diff / 60000)}分钟前`;
                if (diff < 86400000) return `${Math.floor(diff / 3600000)}小时前`;
                if (diff < 604800000) return `${Math.floor(diff / 86400000)}天前`;
                return date.toLocaleDateString('zh-CN');
            }
        }

        // 历史记录管理器
        let historyService = new HistoryService();
        let currentChats = [];
        let allProjects = {};
        let currentGitPath = null;
        let showAllProjects = false;

        // 功能函数
        async function loadHistoryChats() {
            await loadProjectFolders();
            await loadCurrentGitPath();
            await loadChatsForCurrentProject();
        }

        async function loadProjectFolders() {
            const projectContainer = document.getElementById('project-folders');
            projectContainer.innerHTML = '<div class="loading" style="padding: 20px; text-align: center;">正在加载项目...</div>';
            
            try {
                const chats = await historyService.getChatList();
                
                // 按项目分组
                const projects = groupChatsByProject(chats);
                allProjects = projects;
                
                // 应用文件夹筛选
                const folderFilter = document.getElementById('folder-search').value;
                const filteredProjects = filterProjects(projects, folderFilter);
                
                displayProjectFolders(filteredProjects);
            } catch (error) {
                console.error('加载项目失败:', error);
                projectContainer.innerHTML = '<div class="error" style="padding: 20px; text-align: center; color: red;">加载失败</div>';
            }
        }

        async function loadCurrentGitPath() {
            try {
                const response = await fetch('/api/git/current-path');
                const data = await response.json();
                currentGitPath = data.currentPath;
                
                // 添加当前Git目录指示器
                if (currentGitPath) {
                    updateHistoryStats(`当前显示: ${currentGitPath} 的聊天记录`);
                }
            } catch (error) {
                console.warn('无法获取当前Git路径:', error);
                currentGitPath = null;
            }
        }

        async function loadChatsForCurrentProject() {
            updateHistoryStats('正在加载聊天记录...');
            
            try {
                let chats = await historyService.getChatList();
                
                // 根据当前模式过滤聊天记录
                if (!showAllProjects && currentGitPath) {
                    chats = chats.filter(chat => 
                        chat.project && chat.project.path && 
                        chat.project.path.includes(currentGitPath)
                    );
                }
                
                currentChats = chats;
                allCurrentChats = chats; // 存储所有聊天记录用于虚拟滚动
                displayHistoryChats(chats);
                
                const totalCount = Object.values(allProjects).reduce((sum, project) => sum + project.chats.length, 0);
                updateHistoryStats(`显示 ${chats.length} / ${totalCount} 条聊天记录`);
            } catch (error) {
                console.error('加载聊天记录失败:', error);
                updateHistoryStats(`加载失败: ${error.message}`);
                document.getElementById('chat-list-container').innerHTML = 
                    `<div class="error">加载失败: ${error.message}</div>`;
            }
        }

        function displayHistoryChats(chats) {
            const container = document.getElementById('chat-list-container');
            if (!chats || chats.length === 0) {
                container.innerHTML = '<div class="error" style="color: #cccccc;">没有找到聊天记录</div>';
                return;
            }

            // 性能优化：虚拟滚动
            const performanceStart = performance.now();
            
            // 限制一次渲染的最大数量
            const MAX_CHATS_TO_RENDER = 100;
            const chatsToRender = chats.slice(0, MAX_CHATS_TO_RENDER);
            
            let html = '';
            chatsToRender.forEach(chat => {
                html += `
                    <div class="chat-card" onclick="loadHistoryChatDetail('${chat.sessionId}')" 
                         style="border: 1px solid #404040; margin: 8px 0; padding: 12px; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; background: #2d2d2d;"
                         onmouseover="this.style.background='#3d3d3d'" 
                         onmouseout="this.style.background='#2d2d2d'">
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 5px; color: #ffffff;">${chat.title}</div>
                        <div style="color: #cccccc; font-size: 14px; margin-bottom: 5px;">${chat.preview}</div>
                        <div style="font-size: 12px; color: #888888; display: flex; gap: 15px;">
                            <span>项目: ${chat.project?.name || '未知'}</span>
                            <span>消息: ${chat.messageCount}</span>
                            <span>${chat.formattedTime}</span>
                        </div>
                    </div>
                `;
            });
            
            // 如果聊天数量超过限制，显示加载更多按钮
            if (chats.length > MAX_CHATS_TO_RENDER) {
                html += `
                    <div style="text-align: center; padding: 20px;">
                        <button onclick="loadMoreChats()" class="btn btn-secondary" style="background: #404040; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                            加载更多聊天记录 (${chats.length - MAX_CHATS_TO_RENDER} 条未显示)
                        </button>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            const performanceEnd = performance.now();
            console.log(`🚀 渲染 ${chatsToRender.length} 个聊天卡片耗时: ${(performanceEnd - performanceStart).toFixed(2)}ms`);
        }

        // 全局变量用于存储所有聊天记录
        let allCurrentChats = [];

        function loadMoreChats() {
            const container = document.getElementById('chat-list-container');
            const currentCount = container.querySelectorAll('.chat-card').length;
            const remainingChats = allCurrentChats.slice(currentCount);
            
            if (remainingChats.length === 0) {
                updateHistoryStats('没有更多聊天记录了');
                return;
            }
            
            // 追加更多聊天记录
            const MAX_BATCH_SIZE = 50;
            const chatsToAppend = remainingChats.slice(0, MAX_BATCH_SIZE);
            
            let html = '';
            chatsToAppend.forEach(chat => {
                html += `
                    <div class="chat-card" onclick="loadHistoryChatDetail('${chat.sessionId}')" 
                         style="border: 1px solid #404040; margin: 8px 0; padding: 12px; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; background: #2d2d2d;"
                         onmouseover="this.style.background='#3d3d3d'" 
                         onmouseout="this.style.background='#2d2d2d'">
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 5px; color: #ffffff;">${chat.title}</div>
                        <div style="color: #cccccc; font-size: 14px; margin-bottom: 5px;">${chat.preview}</div>
                        <div style="font-size: 12px; color: #888888; display: flex; gap: 15px;">
                            <span>项目: ${chat.project?.name || '未知'}</span>
                            <span>消息: ${chat.messageCount}</span>
                            <span>${chat.formattedTime}</span>
                        </div>
                    </div>
                `;
            });
            
            // 移除现有的加载更多按钮
            const loadMoreBtn = container.querySelector('button');
            if (loadMoreBtn) {
                loadMoreBtn.remove();
            }
            
            // 追加新的聊天记录
            container.insertAdjacentHTML('beforeend', html);
            
            // 如果还有更多聊天记录，重新添加加载更多按钮
            const newCurrentCount = container.querySelectorAll('.chat-card').length;
            if (newCurrentCount < allCurrentChats.length) {
                const remaining = allCurrentChats.length - newCurrentCount;
                container.insertAdjacentHTML('beforeend', `
                    <div style="text-align: center; padding: 20px;">
                        <button onclick="loadMoreChats()" class="btn btn-secondary" style="background: #404040; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                            加载更多聊天记录 (${remaining} 条未显示)
                        </button>
                    </div>
                `);
            }
            
            updateHistoryStats(`已显示 ${newCurrentCount} / ${allCurrentChats.length} 条聊天记录`);
        }

        async function loadHistoryChatDetail(sessionId) {
            updateHistoryStats('正在加载聊天详情...');
            document.getElementById('chat-detail-container').innerHTML = 
                '<div class="loading">正在加载聊天详情...</div>';
            
            try {
                const chat = await historyService.getChatDetail(sessionId);
                displayHistoryChatDetail(chat);
                updateHistoryStats(`显示聊天详情: ${chat.title}`);
            } catch (error) {
                console.error('加载详情失败:', error);
                updateHistoryStats(`加载详情失败: ${error.message}`);
                document.getElementById('chat-detail-container').innerHTML = 
                    `<div class="error">加载详情失败: ${error.message}</div>`;
            }
        }

        function displayHistoryChatDetail(chat) {
            const container = document.getElementById('chat-detail-container');
            
            let html = `
                <h3 style="margin: 0 0 15px 0; color: #ffffff;">${chat.title}</h3>
                <div style="margin: 15px 0; font-size: 14px; color: #cccccc; background: #2d2d2d; padding: 15px; border-radius: 4px; border: 1px solid #404040;">
                    <p style="margin: 5px 0;"><strong>会话ID:</strong> <code style="color: #ffffff;">${chat.sessionId}</code></p>
                    <p style="margin: 5px 0;"><strong>项目:</strong> ${chat.project?.name || '未知'}</p>
                    <p style="margin: 5px 0;"><strong>消息数量:</strong> ${chat.messages?.length || 0}</p>
                    <p style="margin: 5px 0;"><strong>时间:</strong> ${chat.formattedTime}</p>
                </div>
                <hr style="margin: 20px 0; border: none; border-top: 1px solid #404040;">
            `;

            if (chat.messages && chat.messages.length > 0) {
                chat.messages.forEach((msg, index) => {
                    html += `
                        <div style="margin: 15px 0; padding: 15px; border-radius: 6px; border-left: 3px solid ${msg.role === 'user' ? '#22c55e' : '#3b82f6'}; background: ${msg.role === 'user' ? '#1a3a1a' : '#1a2a3a'};">
                            <div style="font-size: 12px; color: #cccccc; margin-bottom: 8px;">
                                ${msg.role === 'user' ? '👤 用户' : '🤖 AI'} - ${msg.formattedTime}
                            </div>
                            <div style="font-size: 14px; line-height: 1.6; white-space: pre-wrap; color: #ffffff;">${msg.content}</div>
                        </div>
                    `;
                });
            } else {
                html += '<p style="color: #cccccc; text-align: center; padding: 20px;">暂无消息</p>';
            }

            container.innerHTML = html;
        }

        async function searchChats() {
            const query = document.getElementById('history-search').value.trim();
            if (!query) {
                loadChatsForCurrentProject();
                return;
            }
            
            updateHistoryStats(`正在搜索: ${query}...`);
            try {
                const results = await historyService.searchChats(query);
                
                // 根据当前模式过滤搜索结果
                let filteredResults = results;
                if (!showAllProjects && currentGitPath) {
                    filteredResults = results.filter(chat => 
                        chat.project && chat.project.path && 
                        chat.project.path.includes(currentGitPath)
                    );
                }
                
                currentChats = filteredResults;
                allCurrentChats = filteredResults; // 存储搜索结果用于虚拟滚动
                displayHistoryChats(filteredResults);
                updateHistoryStats(`搜索完成: ${filteredResults.length} 条结果`);
            } catch (error) {
                updateHistoryStats(`搜索失败: ${error.message}`);
            }
        }

        async function refreshChats() {
            await historyService.clearCache();
            await loadHistoryChats();
        }

        async function clearCache() {
            await historyService.clearCache();
            updateHistoryStats('缓存已清除');
            await loadHistoryChats();
        }

        function updateHistoryStats(message) {
            document.getElementById('history-stats').textContent = message;
        }

        function groupChatsByProject(chats) {
            const groups = {};
            
            chats.forEach(chat => {
                // 使用cursor-view-main的实际项目检测逻辑
                const projectPath = chat.project?.path || chat.project?.rootPath || '';
                let projectName = 'Unknown Project';
                
                if (projectPath) {
                    // 基于cursor-view-main的项目名称提取逻辑
                    projectName = extractProjectNameFromPath(projectPath);
                } else if (chat.workspaceId) {
                    // 使用workspace ID作为项目标识
                    projectName = `Workspace ${chat.workspaceId.substring(0, 8)}`;
                } else if (chat.project?.name) {
                    // 使用项目名称
                    projectName = chat.project.name;
                }
                
                const normalizedPath = normalizeProjectPath(projectPath);
                const key = `${projectName}|${normalizedPath}`;
                
                if (!groups[key]) {
                    groups[key] = {
                        name: projectName,
                        path: normalizedPath,
                        chats: [],
                        workspaceId: chat.workspaceId
                    };
                }
                groups[key].chats.push(chat);
            });
            
            return groups;
        }

        function extractProjectNameFromPath(path) {
            if (!path) return 'Unknown Project';
            
            // 基于cursor-view-main的实际实现
            const knownProjects = ['genaisf', 'cursor-view', 'cursor', 'cursor-apps', 'Cursor-Web', 'claude-api'];
            
            // 处理file:///协议
            let cleanPath = path;
            if (path.startsWith('file:///')) {
                cleanPath = path.substring(7); // 移除file://
            }
            
            // 标准化路径分隔符
            cleanPath = cleanPath.replace(/\\/g, '/');
            const parts = cleanPath.split('/').filter(p => p && p.length > 0);
            
            if (parts.length === 0) return 'Root Directory';
            
            // 查找已知项目名称
            for (const known of knownProjects) {
                if (parts.some(part => part.toLowerCase() === known.toLowerCase())) {
                    return known;
                }
            }
            
            // 处理特殊目录结构
            if (parts.includes('Documents') && parts.includes('codebase')) {
                const idx = parts.indexOf('codebase');
                if (idx + 1 < parts.length) {
                    return parts[idx + 1];
                }
            }
            
            if (parts.includes('Repos')) {
                const idx = parts.indexOf('Repos');
                if (idx + 1 < parts.length) {
                    return parts[idx + 1];
                }
            }
            
            // 跳过容器目录
            const skipDirs = ['Users', 'Documents', 'Code', 'Projects', 'workspace', 'Desktop', 'home', 'opt', 'var', 'usr', 'root'];
            let meaningfulParts = parts.filter(part => !skipDirs.includes(part));
            
            if (meaningfulParts.length > 0) {
                return meaningfulParts[meaningfulParts.length - 1];
            }
            
            // 使用最后一个有意义的部分
            for (let i = parts.length - 1; i >= 0; i--) {
                if (parts[i] && !parts[i].startsWith('.')) {
                    return parts[i];
                }
            }
            
            return parts[parts.length - 1] || 'Unknown Project';
        }

        function normalizeProjectPath(path) {
            if (!path) return '';
            
            // 标准化路径并处理file:///协议
            let normalized = path;
            if (path.startsWith('file:///')) {
                normalized = path.substring(7);
            }
            
            // 标准化路径分隔符
            normalized = normalized.replace(/\\/g, '/');
            
            // 移除末尾的斜杠
            normalized = normalized.replace(/\/$/, '');
            
            // 如果路径包含文件名，移除文件名
            const lastSlash = normalized.lastIndexOf('/');
            if (lastSlash > 0) {
                const lastPart = normalized.substring(lastSlash + 1);
                // 如果最后一部分包含点号，可能是文件名
                if (lastPart.includes('.') && !lastPart.startsWith('.')) {
                    normalized = normalized.substring(0, lastSlash);
                }
            }
            
            return normalized;
        }

        function displayProjectFolders(projects) {
            const container = document.getElementById('project-folders');
            
            if (Object.keys(projects).length === 0) {
                container.innerHTML = '<div class="error" style="padding: 20px; text-align: center; color: #cccccc;">没有找到项目</div>';
                return;
            }

            // 创建文件夹树结构
            const folderTree = buildFolderTree(projects);
            
            let html = '';
            
            // 添加当前Git目录指示器
            if (currentGitPath && !showAllProjects) {
                html += `
                    <div class="current-git-indicator" style="padding: 8px 12px; background: #1a3a1a; border-left: 3px solid #22c55e; font-size: 12px; color: #22c55e; margin-bottom: 10px;">
                        📁 当前目录：${currentGitPath}
                    </div>
                `;
            }

            // 渲染文件夹树
            html += renderFolderTree(folderTree, projects);

            container.innerHTML = html;
        }

        function filterProjects(projects, filterText) {
            if (!filterText || filterText.trim() === '') {
                return projects;
            }

            const filtered = {};
            const filterLower = filterText.toLowerCase();

            Object.entries(projects).forEach(([key, project]) => {
                const projectName = project.name.toLowerCase();
                const projectPath = (project.path || '').toLowerCase();
                
                // 检查项目名称或路径是否包含筛选文本
                if (projectName.includes(filterLower) || projectPath.includes(filterLower)) {
                    filtered[key] = project;
                }
            });

            return filtered;
        }

        function buildFolderTree(projects) {
            const tree = {};
            const performanceStart = performance.now();
            
            Object.entries(projects).forEach(([projectName, project]) => {
                const path = project.path || '';
                const pathParts = path.split('/').filter(part => part && part.length > 0);
                
                let currentLevel = tree;
                pathParts.forEach(part => {
                    if (!currentLevel[part]) {
                        currentLevel[part] = {
                            type: 'folder',
                            children: {},
                            chatCount: 0 // 预计算聊天数量
                        };
                    }
                    currentLevel = currentLevel[part].children;
                });
                
                // 添加项目到最终位置
                currentLevel[projectName] = {
                    type: 'project',
                    project: project,
                    projectName: projectName
                };
            });
            
            // 预计算文件夹的聊天数量
            calculateFolderChatCounts(tree);
            
            const performanceEnd = performance.now();
            console.log(`🚀 构建文件夹树耗时: ${(performanceEnd - performanceStart).toFixed(2)}ms`);
            
            return tree;
        }

        function calculateFolderChatCounts(tree) {
            Object.values(tree).forEach(node => {
                if (node.type === 'folder') {
                    // 递归计算子文件夹的聊天数量
                    if (node.children) {
                        calculateFolderChatCounts(node.children);
                        node.chatCount = Object.values(node.children).reduce((sum, child) => {
                            return sum + (child.type === 'project' ? child.project.chats.length : (child.chatCount || 0));
                        }, 0);
                    }
                }
            });
        }

        function renderFolderTree(tree, projects, level = 0, parentPath = '') {
            let html = '';
            const sortedKeys = Object.keys(tree).sort();
            
            sortedKeys.forEach(key => {
                const node = tree[key];
                const fullPath = parentPath ? `${parentPath}/${key}` : key;
                
                if (node.type === 'folder') {
                    const isActive = !showAllProjects && currentGitPath && fullPath.includes(currentGitPath);
                    const isExpanded = isActive || level < 2; // 默认展开前两级
                    
                    html += `
                        <div class="folder-node" style="margin-left: ${level * 15}px;">
                            <div class="folder-header" style="padding: 8px 12px; border-bottom: 1px solid #404040; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: space-between; ${isActive ? 'background: #1a2a3a; border-left: 3px solid #3b82f6;' : ''}" 
                                 onclick="toggleFolder('${fullPath.replace(/'/g, "\\'")}')">
                                <div style="display: flex; align-items: center; flex: 1;">
                                    <span style="margin-right: 8px; color: #ffa000;">${isExpanded ? '📂' : '📁'}</span>
                                    <span style="font-weight: 500; color: #ffffff; font-size: 14px;">${key}</span>
                                </div>
                                <span style="color: #888888; font-size: 12px;">${countItemsInFolder(node)}</span>
                            </div>
                            <div class="folder-children" id="folder-${fullPath.replace(/\//g, '-')}" style="${isExpanded ? '' : 'display: none;'}">
                                ${renderFolderTree(node.children, projects, level + 1, fullPath)}
                            </div>
                        </div>
                    `;
                } else if (node.type === 'project') {
                    const isActive = !showAllProjects && currentGitPath && node.project.path.includes(currentGitPath);
                    
                    html += `
                        <div class="project-folder" style="margin-left: ${level * 15}px; padding: 8px 12px; border-bottom: 1px solid #404040; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: space-between; ${isActive ? 'background: #1a2a3a; border-left: 3px solid #3b82f6;' : ''}" 
                             onclick="selectProject('${node.projectName.replace(/'/g, "\\'")}')" 
                             data-project="${node.projectName}">
                            <div style="display: flex; align-items: center; flex: 1;">
                                <span style="margin-right: 8px; color: #00bbff;">💬</span>
                                <span style="font-weight: 500; color: #ffffff; font-size: 14px;">${node.projectName}</span>
                            </div>
                            <span style="background: #3b82f6; color: white; padding: 2px 6px; border-radius: 10px; font-size: 12px; min-width: 20px; text-align: center;">${node.project.chats.length}</span>
                        </div>
                    `;
                }
            });
            
            return html;
        }

        function countItemsInFolder(folderNode) {
            // 使用预计算的聊天数量
            return folderNode.chatCount || 0;
        }

        function toggleFolder(folderPath) {
            const folderId = `folder-${folderPath.replace(/\//g, '-')}`;
            const folderElement = document.getElementById(folderId);
            const folderHeader = folderElement.previousElementSibling;
            const icon = folderHeader.querySelector('span');
            
            if (folderElement.style.display === 'none') {
                folderElement.style.display = 'block';
                icon.textContent = '📂';
            } else {
                folderElement.style.display = 'none';
                icon.textContent = '📁';
            }
        }

        function selectProject(projectName) {
            // 获取选中的项目聊天记录
            const project = allProjects[projectName];
            if (project) {
                currentChats = project.chats;
                displayHistoryChats(currentChats);
                updateHistoryStats(`${projectName} - ${project.chats.length} 条聊天记录`);
            }
        }

        function toggleAllProjects() {
            showAllProjects = !showAllProjects;
            const button = document.getElementById('toggle-all-projects');
            
            if (showAllProjects) {
                button.innerHTML = '📂 当前目录';
                button.title = '只显示当前Git目录的聊天记录';
            } else {
                button.innerHTML = '📁 全部项目';
                button.title = '显示所有项目的聊天记录';
            }
            
            loadChatsForCurrentProject();
            filterFolders(); // 重新应用文件夹筛选
        }

        // 初始化历史记录（当切换到历史记录标签时）
        document.addEventListener('DOMContentLoaded', () => {
            // 监听标签切换事件
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // 如果切换到历史记录标签，加载数据
                    if (this.dataset.tab === 'history-tab') {
                        // 延迟加载，确保标签已切换
                        setTimeout(() => {
                            loadHistoryChats();
                        }, 100);
                    }
                });
            });

            // 绑定搜索事件
            document.getElementById('history-search').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchChats();
                }
            });

            // 绑定文件夹筛选事件
            document.getElementById('folder-search').addEventListener('input', (e) => {
                filterFolders();
            });
        });

        function filterFolders() {
            const folderFilter = document.getElementById('folder-search').value;
            const filteredProjects = filterProjects(allProjects, folderFilter);
            displayProjectFolders(filteredProjects);
            
            const totalCount = Object.values(allProjects).reduce((sum, project) => sum + project.chats.length, 0);
            const filteredCount = Object.values(filteredProjects).reduce((sum, project) => sum + project.chats.length, 0);
            
            if (folderFilter) {
                updateHistoryStats(`显示 ${filteredCount} / ${totalCount} 条聊天记录 (筛选: ${folderFilter})`);
            } else {
                updateHistoryStats(`显示 ${filteredCount} / ${totalCount} 条聊天记录`);
            }
        }

        // 页面加载完成后立即加载历史记录
        setTimeout(() => {
            if (document.querySelector('.tab-btn[data-tab="history-tab"]').classList.contains('active')) {
                loadHistoryChats();
            }
        }, 500);
    </script>
    <script src="js/modules/git-manager.js"></script>
    <script>
    // 页面加载完成后初始化
     window.addEventListener('load', function() {
         console.log('🚀 页面加载完成，初始化历史记录管理器');
         
         // 立即显示一个测试消息
         const chatList = document.getElementById('chat-list');
         if (chatList) {
             chatList.innerHTML = '<div style="color: yellow; padding: 10px;">🔄 JavaScript正在执行，准备加载聊天记录...</div>';
         }
         
         setTimeout(function() {
             // 使用模块系统加载历史记录管理器
             if (window.ModuleLoader) {
                 ModuleLoader.loadModule('HistoryManager').then(async () => {
                     if (window.HistoryManager) {
                          try {
                              const historyContainer = document.querySelector('#history-tab');
                              window.historyManager = new window.HistoryManager(historyContainer);
                              await window.historyManager.init();
                             console.log('✅ 历史记录管理器初始化成功');
                             
                             // 等待2秒后检查结果
                             setTimeout(() => {
                                 const chatListAfter = document.getElementById('chat-list');
                                 if (chatListAfter) {
                                     console.log('📋 2秒后聊天列表内容长度:', chatListAfter.innerHTML.length);
                                     if (chatListAfter.innerHTML.length < 200) {
                                         chatListAfter.innerHTML = '<div style="color: red; padding: 10px;">❌ 聊天记录加载失败，请检查控制台日志</div>';
                                     }
                                 }
                             }, 2000);
                         } catch (error) {
                             console.error('❌ 历史记录管理器初始化失败:', error);
                             if (chatList) {
                                 chatList.innerHTML = `<div style="color: red; padding: 10px;">❌ 初始化失败: ${error.message}</div>`;
                             }
                         }
                     } else {
                         console.error('❌ HistoryManager模块加载失败');
                         if (chatList) {
                             chatList.innerHTML = '<div style="color: red; padding: 10px;">❌ HistoryManager模块加载失败</div>';
                         }
                     }
                 }).catch(error => {
                     console.error('❌ 模块加载失败:', error);
                     if (chatList) {
                         chatList.innerHTML = `<div style="color: red; padding: 10px;">❌ 模块加载失败: ${error.message}</div>`;
                     }
                 });
             } else {
                 console.error('❌ ModuleLoader未找到');
                 if (chatList) {
                     chatList.innerHTML = '<div style="color: red; padding: 10px;">❌ ModuleLoader未找到</div>';
                 }
             }
         }, 500);
     });
    
    // Tab 切换逻辑
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            this.classList.add('active');
            document.getElementById(this.dataset.tab).classList.add('active');

            // 如果切换到诊断tab，更新快速状态
            if (this.dataset.tab === 'diagnostic-tab') {
                updateQuickStatus();
            }
            
            // 如果切换到历史记录tab，初始化历史记录管理器
            if (this.dataset.tab === 'history-tab') {
                if (window.ModuleLoader && !window.historyManager) {
                    ModuleLoader.loadModule('HistoryManager').then(async () => {
                        if (window.HistoryManager && !window.historyManager) {
                             const historyContainer = document.querySelector('#history-tab');
                             window.historyManager = new window.HistoryManager(historyContainer);
                             await window.historyManager.init();
                        }
                    }).catch(error => {
                        console.error('❌ 历史记录管理器加载失败:', error);
                    });
                }
            }
        });
    });

        // 更新快速状态检查
    function updateQuickStatus() {
        // WebSocket状态 - 使用更准确的检测方法
        const wsStatus = document.getElementById('ws-status');
        let wsConnected = false;

        // 方法1: 检查simpleClient的WebSocket状态（与诊断页面保持一致）
        if (window.simpleClient && typeof window.simpleClient.isConnected === 'function') {
            wsConnected = window.simpleClient.isConnected();
        }
        // 方法2: 检查simpleClient的wsManager状态
        else if (window.simpleClient && window.simpleClient.wsManager && typeof window.simpleClient.wsManager.isConnected === 'function') {
            wsConnected = window.simpleClient.wsManager.isConnected();
        }
        // 方法3: 检查页面状态元素
        else if (document.querySelector('.status.connected')) {
            wsConnected = true;
        }
        // 方法4: 检查WebSocketManager模块
        else if (window.WebSocketManager && typeof window.WebSocketManager.isConnected === 'function') {
            wsConnected = window.WebSocketManager.isConnected();
        }

        if (wsConnected) {
            wsStatus.textContent = '已连接';
            wsStatus.className = 'status-value connected';
        } else {
            wsStatus.textContent = '未连接';
            wsStatus.className = 'status-value disconnected';
        }

        // 调试信息（可选）
        if (window.simpleClient) {
            console.log('首页WebSocket状态检测:', {
                simpleClientExists: !!window.simpleClient,
                isConnectedMethod: typeof window.simpleClient.isConnected,
                wsManagerExists: !!window.simpleClient.wsManager,
                wsManagerIsConnectedMethod: window.simpleClient.wsManager ? typeof window.simpleClient.wsManager.isConnected : 'N/A',
                finalResult: wsConnected
            });
        }

        // 模块加载状态
        const moduleStatus = document.getElementById('module-status');
        if (window.ModuleLoader) {
            moduleStatus.textContent = '已加载';
            moduleStatus.className = 'status-value success';
        } else {
            moduleStatus.textContent = '未加载';
            moduleStatus.className = 'status-value error';
        }

        // Cursor状态
        const cursorStatus = document.getElementById('cursor-status');
        if (window.simpleClient && window.simpleClient.cursorStatusManager) {
            try {
                const status = window.simpleClient.cursorStatusManager.getCursorStatus();
                switch (status.status) {
                    case 'active':
                        cursorStatus.textContent = '活跃';
                        cursorStatus.className = 'status-value success';
                        break;
                    case 'waiting':
                        cursorStatus.textContent = '等待';
                        cursorStatus.className = 'status-value warning';
                        break;
                    case 'inactive':
                        cursorStatus.textContent = '不活跃';
                        cursorStatus.className = 'status-value warning';
                        break;
                    case 'closed':
                        cursorStatus.textContent = '已关闭';
                        cursorStatus.className = 'status-value error';
                        break;
                    default:
                        cursorStatus.textContent = '未知';
                        cursorStatus.className = 'status-value error';
                }
            } catch (error) {
                cursorStatus.textContent = '检查失败';
                cursorStatus.className = 'status-value error';
            }
        } else {
            cursorStatus.textContent = '未初始化';
            cursorStatus.className = 'status-value error';
        }

        // 客户端状态
        const clientStatus = document.getElementById('client-status');
        if (window.simpleClient) {
            clientStatus.textContent = '已初始化';
            clientStatus.className = 'status-value success';
        } else {
            clientStatus.textContent = '未初始化';
            clientStatus.className = 'status-value error';
        }
    }

    // 强制初始化和加载函数
    window.forceInitAndLoad = function() {
        console.log('🔧 强制初始化和加载...');
        const chatList = document.getElementById('chat-list');
        
        try {
            // 重置状态
            window.historyManager = null;
            
            // 显示加载状态
            if (chatList) {
                chatList.innerHTML = '<div style="color: yellow; padding: 10px;">🔄 强制重新初始化中...</div>';
            }
            
            // 使用模块系统初始化
            if (window.ModuleLoader) {
                ModuleLoader.loadModule('HistoryManager').then(async () => {
                    if (window.HistoryManager) {
                        const historyContainer = document.querySelector('#history-tab');
                         window.historyManager = new window.HistoryManager(historyContainer);
                        await window.historyManager.init();
                        console.log('✅ 强制初始化完成');
                        
                        // 等待一秒后检查结果
                        setTimeout(() => {
                            if (window.historyManager && window.historyManager.chats) {
                                console.log('📊 加载的聊天数量:', window.historyManager.chats.length);
                                if (chatList) {
                                    console.log('📋 当前chat-list内容长度:', chatList.innerHTML.length);
                                }
                            } else {
                                console.error('❌ historyManager或chats为空');
                                if (chatList) {
                                    chatList.innerHTML = '<div style="color: red; padding: 10px;">❌ 初始化失败，historyManager为空</div>';
                                }
                            }
                        }, 1000);
                    } else {
                        console.error('❌ HistoryManager模块加载失败');
                        if (chatList) {
                            chatList.innerHTML = '<div style="color: red; padding: 10px;">❌ HistoryManager模块加载失败</div>';
                        }
                    }
                }).catch(error => {
                    console.error('❌ 模块加载失败:', error);
                    if (chatList) {
                        chatList.innerHTML = `<div style="color: red; padding: 10px;">❌ 模块加载失败: ${error.message}</div>`;
                    }
                });
            } else {
                console.error('❌ ModuleLoader未找到');
                if (chatList) {
                    chatList.innerHTML = '<div style="color: red; padding: 10px;">❌ ModuleLoader未找到</div>';
                }
            }
        } catch (error) {
            console.error('❌ 强制初始化失败:', error);
            if (chatList) {
                chatList.innerHTML = `<div style="color: red; padding: 10px;">❌ 强制初始化失败: ${error.message}</div>`;
            }
        }
    };
    
    // 调试状态函数
    window.debugHistoryManager = function() {
        console.log('=== 调试信息 ===');
        console.log('HistoryManager类型:', typeof window.HistoryManager);
        console.log('ModuleLoader:', typeof window.ModuleLoader);
        console.log('historyManager实例:', window.historyManager);
        console.log('chat-list元素:', document.getElementById('chat-list'));
        
        if (window.historyManager) {
            console.log('聊天数据:', window.historyManager.chats);
            console.log('聊天数量:', window.historyManager.chats ? window.historyManager.chats.length : 'undefined');
            console.log('加载状态:', window.historyManager.isLoading);
        } else {
            console.log('❌ historyManager实例不存在');
        }
        
        const chatList = document.getElementById('chat-list');
        if (chatList) {
            console.log('chat-list内容长度:', chatList.innerHTML.length);
            console.log('chat-list内容预览:', chatList.innerHTML.substring(0, 100));
        }
        
        // 测试API
        fetch('/api/history/chats')
            .then(response => {
                console.log('API响应状态:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('API返回数据类型:', typeof data);
                console.log('API返回数据长度:', Array.isArray(data) ? data.length : 'not array');
                if (Array.isArray(data) && data.length > 0) {
                    console.log('第一条记录:', data[0]);
                }
            })
            .catch(error => {
                console.error('API测试失败:', error);
            });
    };
    
    // 强制初始化函数（保持向后兼容）
    async function forceInit() {
        console.log('🔧 强制初始化历史记录管理器');
        try {
            if (typeof HistoryManager !== 'undefined') {
                const historyContainer = document.querySelector('#history-tab');
                window.historyManager = new HistoryManager(historyContainer);
                await window.historyManager.init();
                console.log('✅ 强制初始化成功');
            } else {
                console.error('❌ HistoryManager类未找到');
            }
        } catch (error) {
            console.error('❌ 强制初始化失败:', error);
        }
    }
    
    // 如果当前在诊断tab，更新状态
        if (document.querySelector('.tab-btn[data-tab="diagnostic-tab"]').classList.contains('active')) {
            updateQuickStatus();
        }

        // 定期更新状态（每5秒）
        setInterval(function() {
            if (document.querySelector('.tab-btn[data-tab="diagnostic-tab"]').classList.contains('active')) {
                updateQuickStatus();
            }
        }, 5000);
    

    </script>
</body>
</html>
