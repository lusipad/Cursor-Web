<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Web - Cursor 聊天同步</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Claude Web</h1>
            <div id="status" class="status disconnected">等待连接...</div>
        </header>

        <!-- Tab 导航 -->
        <nav class="tab-nav">
            <button class="tab-btn" data-tab="chat-tab">聊天</button>
                <button class="tab-btn active" data-tab="history-tab">历史记录</button>
            <button class="tab-btn" data-tab="git-tab">Git 管理</button>
            <button class="tab-btn" data-tab="diagnostic-tab">系统诊断</button>
        </nav>

        <main class="main">
            <!-- 聊天 Tab 内容 -->
            <section id="chat-tab" class="tab-content">
                <div id="messages-container" class="messages-container">
                    <div class="welcome-message">
                        <h2>欢迎使用 Claude Web</h2>
                        <p>状态说明：</p>
                        <p>🟡 <strong>已连接 - 等待 Cursor 内容</strong>：需要在 Cursor 中运行注入脚本</p>
                        <p>🟢 <strong>已连接 - 同步正常</strong>：内容同步工作正常</p>
                        <br>
                        <p class="instruction">使用方法：在 Cursor 开发者工具中运行同步脚本</p>
                        <a href="/script.html" class="btn btn-primary" style="display:inline-block;margin:10px 0;">前往一键复制同步脚本 &gt;&gt;</a>
                        <p class="instruction">脚本会同步整个 Cursor 页面内容到此页面</p>
                    </div>
                </div>
                <footer class="footer">
                    <form id="send-form" autocomplete="off">
                        <input id="send-input" type="text" placeholder="输入消息..." autocomplete="off" />
                        <button id="send-btn" type="submit">发送</button>
                        <button id="clear-btn" type="button">清除</button>
                    </form>
                </footer>
            </section>

            <!-- 历史记录 Tab 内容 -->
            <section id="history-tab" class="tab-content active">
                <div class="history-panel">
                    <h2>Cursor 聊天历史记录</h2>
                    <div class="history-controls">
                        <div class="search-section">
                            <div class="search-input">
                                <input type="text" id="history-search" placeholder="搜索聊天内容..." class="search-field">
                                <button id="search-btn" class="btn btn-primary">搜索</button>
                                <button id="refresh-history" class="btn btn-secondary">刷新</button>
                                <button id="force-init-btn" class="btn btn-primary" onclick="forceInitAndLoad()">强制初始化</button>
                                <button id="debug-btn" class="btn btn-info" onclick="debugHistoryManager()">调试状态</button>
                            </div>
                        </div>
                    </div>
                    <div class="history-stats">
                        <div class="stats-row">
                            <span>总聊天数：</span>
                            <span id="total-chats" class="stat-value">加载中...</span>
                        </div>
                        <div class="stats-row">
                            <span>状态：</span>
                            <span id="history-status" class="stat-value">准备就绪</span>
                        </div>
                    </div>
                    <div class="history-list">
                        <div id="chat-list" class="chat-list">
                            <div class="loading-message">正在加载聊天历史...</div>
                        </div>
                    </div>
                    <div class="chat-detail" id="chat-detail" style="display: none;">
                        <div class="detail-header">
                            <h3 id="detail-title">聊天详情</h3>
                            <div class="detail-actions">
                                <button id="export-html" class="btn btn-secondary">导出HTML</button>
                                <button id="export-json" class="btn btn-secondary">导出JSON</button>
                                <button id="close-detail" class="btn btn-info">关闭</button>
                            </div>
                        </div>
                        <div class="detail-info">
                            <div class="info-row">
                                <span>会话ID：</span>
                                <span id="detail-session-id"></span>
                            </div>
                            <div class="info-row">
                                <span>工作区：</span>
                                <span id="detail-workspace"></span>
                            </div>
                            <div class="info-row">
                                <span>创建时间：</span>
                                <span id="detail-created-at"></span>
                            </div>
                            <div class="info-row">
                                <span>消息数量：</span>
                                <span id="detail-message-count"></span>
                            </div>
                        </div>
                        <div class="detail-messages" id="detail-messages">
                            <!-- 聊天消息将在这里显示 -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Git 管理 Tab 内容 -->
            <section id="git-tab" class="tab-content">
                <div class="git-panel">
                    <h2>Git 分支管理</h2>
                    <div class="git-controls">
                        <div class="git-status">
                            <div class="status-row">
                                <span>当前分支：</span>
                                <span id="current-branch" class="current-branch">加载中...</span>
                            </div>
                            <div class="status-row">
                                <span>Git 路径：</span>
                                <span id="git-path" class="git-path" title="">加载中...</span>
                            </div>
                        </div>
                        <div class="git-actions">
                            <button id="refresh-branches" class="btn btn-secondary">刷新远程分支</button>
                            <button id="pull-code" class="btn btn-primary">更新代码</button>
                            <button id="git-status" class="btn btn-info">查看状态</button>
                        </div>
                    </div>
                    <div class="branch-section">
                        <h3>分支切换</h3>
                        <div class="branch-selector">
                            <select id="branch-select" class="branch-select">
                                <option value="">选择分支...</option>
                            </select>
                            <button id="checkout-branch" class="btn btn-success">切换分支</button>
                        </div>
                    </div>
                    <div class="commit-section">
                        <h3>代码提交</h3>
                        <div class="commit-controls">
                            <div class="commit-input">
                                <input type="text" id="commit-message" placeholder="输入提交信息..." class="commit-input-field">
                                <button id="add-files" class="btn btn-secondary">添加文件</button>
                                <button id="commit-code" class="btn btn-primary">提交代码</button>
                                <button id="push-code" class="btn btn-success">推送代码</button>
                            </div>
                        </div>
                    </div>
                    <div id="git-output" class="git-output">
                        <div class="output-header">
                            <span>Git 操作输出</span>
                            <button id="clear-output" class="btn btn-small">清除</button>
                        </div>
                        <div id="git-log" class="git-log"></div>
                    </div>
                </div>
            </section>

            <!-- 系统诊断 Tab 内容 -->
            <section id="diagnostic-tab" class="tab-content">
                <div class="diagnostic-panel">
                    <h2>系统诊断</h2>
                    <p>检查系统各个功能模块的状态和连接情况</p>
                    <div class="diagnostic-actions">
                        <a href="/diagnostic.html" class="btn btn-primary" target="_blank">
                            🔍 打开完整诊断页面
                        </a>
                        <p class="instruction">在新标签页中打开完整的系统诊断界面，包含所有测试功能</p>
                    </div>
                    <div class="quick-status">
                        <h3>快速状态检查</h3>
                        <div id="quick-status-grid" class="quick-status-grid">
                            <div class="status-item">
                                <span class="status-label">WebSocket连接</span>
                                <span id="ws-status" class="status-value">检查中...</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Cursor状态</span>
                                <span id="cursor-status" class="status-value">检查中...</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">模块加载</span>
                                <span id="module-status" class="status-value">检查中...</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">客户端状态</span>
                                <span id="client-status" class="status-value">检查中...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script src="js/modules/module-loader.js"></script>
    <script src="js/history.js"></script>
    <script src="git-manager.js"></script>
    <script>
    // 页面加载完成后初始化
     window.addEventListener('load', function() {
         console.log('🚀 页面加载完成，初始化历史记录管理器');
         
         // 立即显示一个测试消息
         const chatList = document.getElementById('chat-list');
         if (chatList) {
             chatList.innerHTML = '<div style="color: yellow; padding: 10px;">🔄 JavaScript正在执行，准备加载聊天记录...</div>';
         }
         
         setTimeout(function() {
             if (typeof initHistoryManager === 'function') {
                 try {
                     initHistoryManager();
                     console.log('✅ 历史记录管理器初始化成功');
                     
                     // 等待2秒后检查结果
                     setTimeout(() => {
                         const chatListAfter = document.getElementById('chat-list');
                         if (chatListAfter) {
                             console.log('📋 2秒后聊天列表内容长度:', chatListAfter.innerHTML.length);
                             if (chatListAfter.innerHTML.length < 200) {
                                 chatListAfter.innerHTML = '<div style="color: red; padding: 10px;">❌ 聊天记录加载失败，请检查控制台日志</div>';
                             }
                         }
                     }, 2000);
                     
                 } catch (error) {
                     console.error('❌ 历史记录管理器初始化失败:', error);
                     if (chatList) {
                         chatList.innerHTML = `<div style="color: red; padding: 10px;">❌ 初始化失败: ${error.message}</div>`;
                     }
                 }
             } else if (typeof HistoryManager !== 'undefined') {
                 try {
                     window.historyManager = new HistoryManager();
                     window.historyManager.init();
                     console.log('✅ 手动初始化成功');
                 } catch (error) {
                     console.error('❌ 手动初始化失败:', error);
                     if (chatList) {
                         chatList.innerHTML = `<div style="color: red; padding: 10px;">❌ 手动初始化失败: ${error.message}</div>`;
                     }
                 }
             } else {
                 console.error('❌ HistoryManager和initHistoryManager都未找到');
                 if (chatList) {
                     chatList.innerHTML = '<div style="color: red; padding: 10px;">❌ HistoryManager类未找到</div>';
                 }
             }
         }, 500);
     });
    
    // Tab 切换逻辑
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            this.classList.add('active');
            document.getElementById(this.dataset.tab).classList.add('active');

            // 如果切换到诊断tab，更新快速状态
            if (this.dataset.tab === 'diagnostic-tab') {
                updateQuickStatus();
            }
            
            // 如果切换到历史记录tab，初始化历史记录管理器
            if (this.dataset.tab === 'history-tab') {
                if (typeof initHistoryManager === 'function') {
                    initHistoryManager();
                }
            }
        });
    });

        // 更新快速状态检查
    function updateQuickStatus() {
        // WebSocket状态 - 使用更准确的检测方法
        const wsStatus = document.getElementById('ws-status');
        let wsConnected = false;

        // 方法1: 检查simpleClient的WebSocket状态（与诊断页面保持一致）
        if (window.simpleClient && typeof window.simpleClient.isConnected === 'function') {
            wsConnected = window.simpleClient.isConnected();
        }
        // 方法2: 检查simpleClient的wsManager状态
        else if (window.simpleClient && window.simpleClient.wsManager && typeof window.simpleClient.wsManager.isConnected === 'function') {
            wsConnected = window.simpleClient.wsManager.isConnected();
        }
        // 方法3: 检查页面状态元素
        else if (document.querySelector('.status.connected')) {
            wsConnected = true;
        }
        // 方法4: 检查WebSocketManager模块
        else if (window.WebSocketManager && typeof window.WebSocketManager.isConnected === 'function') {
            wsConnected = window.WebSocketManager.isConnected();
        }

        if (wsConnected) {
            wsStatus.textContent = '已连接';
            wsStatus.className = 'status-value connected';
        } else {
            wsStatus.textContent = '未连接';
            wsStatus.className = 'status-value disconnected';
        }

        // 调试信息（可选）
        if (window.simpleClient) {
            console.log('首页WebSocket状态检测:', {
                simpleClientExists: !!window.simpleClient,
                isConnectedMethod: typeof window.simpleClient.isConnected,
                wsManagerExists: !!window.simpleClient.wsManager,
                wsManagerIsConnectedMethod: window.simpleClient.wsManager ? typeof window.simpleClient.wsManager.isConnected : 'N/A',
                finalResult: wsConnected
            });
        }

        // 模块加载状态
        const moduleStatus = document.getElementById('module-status');
        if (window.ModuleLoader) {
            moduleStatus.textContent = '已加载';
            moduleStatus.className = 'status-value success';
        } else {
            moduleStatus.textContent = '未加载';
            moduleStatus.className = 'status-value error';
        }

        // Cursor状态
        const cursorStatus = document.getElementById('cursor-status');
        if (window.simpleClient && window.simpleClient.cursorStatusManager) {
            try {
                const status = window.simpleClient.cursorStatusManager.getCursorStatus();
                switch (status.status) {
                    case 'active':
                        cursorStatus.textContent = '活跃';
                        cursorStatus.className = 'status-value success';
                        break;
                    case 'waiting':
                        cursorStatus.textContent = '等待';
                        cursorStatus.className = 'status-value warning';
                        break;
                    case 'inactive':
                        cursorStatus.textContent = '不活跃';
                        cursorStatus.className = 'status-value warning';
                        break;
                    case 'closed':
                        cursorStatus.textContent = '已关闭';
                        cursorStatus.className = 'status-value error';
                        break;
                    default:
                        cursorStatus.textContent = '未知';
                        cursorStatus.className = 'status-value error';
                }
            } catch (error) {
                cursorStatus.textContent = '检查失败';
                cursorStatus.className = 'status-value error';
            }
        } else {
            cursorStatus.textContent = '未初始化';
            cursorStatus.className = 'status-value error';
        }

        // 客户端状态
        const clientStatus = document.getElementById('client-status');
        if (window.simpleClient) {
            clientStatus.textContent = '已初始化';
            clientStatus.className = 'status-value success';
        } else {
            clientStatus.textContent = '未初始化';
            clientStatus.className = 'status-value error';
        }
    }

    // 强制初始化和加载函数
    window.forceInitAndLoad = function() {
        console.log('🔧 强制初始化和加载...');
        const chatList = document.getElementById('chat-list');
        
        try {
            // 重置状态
            window.historyManager = null;
            
            // 显示加载状态
            if (chatList) {
                chatList.innerHTML = '<div style="color: yellow; padding: 10px;">🔄 强制重新初始化中...</div>';
            }
            
            // 初始化
            if (typeof initHistoryManager === 'function') {
                initHistoryManager();
                console.log('✅ 强制初始化完成');
                
                // 等待一秒后检查结果
                setTimeout(() => {
                    if (window.historyManager && window.historyManager.chats) {
                        console.log('📊 加载的聊天数量:', window.historyManager.chats.length);
                        if (chatList) {
                            console.log('📋 当前chat-list内容长度:', chatList.innerHTML.length);
                        }
                    } else {
                        console.error('❌ historyManager或chats为空');
                        if (chatList) {
                            chatList.innerHTML = '<div style="color: red; padding: 10px;">❌ 初始化失败，historyManager为空</div>';
                        }
                    }
                }, 1000);
            } else {
                console.error('❌ initHistoryManager函数未找到');
                if (chatList) {
                    chatList.innerHTML = '<div style="color: red; padding: 10px;">❌ initHistoryManager函数未找到</div>';
                }
            }
        } catch (error) {
            console.error('❌ 强制初始化失败:', error);
            if (chatList) {
                chatList.innerHTML = `<div style="color: red; padding: 10px;">❌ 强制初始化失败: ${error.message}</div>`;
            }
        }
    };
    
    // 调试状态函数
    window.debugHistoryManager = function() {
        console.log('=== 调试信息 ===');
        console.log('HistoryManager类型:', typeof HistoryManager);
        console.log('initHistoryManager函数:', typeof initHistoryManager);
        console.log('historyManager实例:', window.historyManager);
        console.log('chat-list元素:', document.getElementById('chat-list'));
        
        if (window.historyManager) {
            console.log('聊天数据:', window.historyManager.chats);
            console.log('聊天数量:', window.historyManager.chats ? window.historyManager.chats.length : 'undefined');
            console.log('加载状态:', window.historyManager.isLoading);
        } else {
            console.log('❌ historyManager实例不存在');
        }
        
        const chatList = document.getElementById('chat-list');
        if (chatList) {
            console.log('chat-list内容长度:', chatList.innerHTML.length);
            console.log('chat-list内容预览:', chatList.innerHTML.substring(0, 100));
        }
        
        // 测试API
        fetch('/api/history/chats')
            .then(response => {
                console.log('API响应状态:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('API返回数据类型:', typeof data);
                console.log('API返回数据长度:', Array.isArray(data) ? data.length : 'not array');
                if (Array.isArray(data) && data.length > 0) {
                    console.log('第一条记录:', data[0]);
                }
            })
            .catch(error => {
                console.error('API测试失败:', error);
            });
    };
    
    // 强制初始化函数（保持向后兼容）
    function forceInit() {
        console.log('🔧 强制初始化历史记录管理器');
        try {
            if (typeof HistoryManager !== 'undefined') {
                window.historyManager = new HistoryManager();
                window.historyManager.init();
                console.log('✅ 强制初始化成功');
            } else {
                console.error('❌ HistoryManager类未找到');
            }
        } catch (error) {
            console.error('❌ 强制初始化失败:', error);
        }
    }
    
    // 如果当前在诊断tab，更新状态
        if (document.querySelector('.tab-btn[data-tab="diagnostic-tab"]').classList.contains('active')) {
            updateQuickStatus();
        }

        // 定期更新状态（每5秒）
        setInterval(function() {
            if (document.querySelector('.tab-btn[data-tab="diagnostic-tab"]').classList.contains('active')) {
                updateQuickStatus();
            }
        }, 5000);
    

    </script>
</body>
</html>
