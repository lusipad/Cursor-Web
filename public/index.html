<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Web - Cursor èŠå¤©åŒæ­¥</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Claude Web</h1>
            <div id="status" class="status disconnected">ç­‰å¾…è¿æ¥...</div>
        </header>

        <!-- Tab å¯¼èˆª -->
        <nav class="tab-nav">
            <button class="tab-btn active" data-tab="chat-tab">èŠå¤©</button>
            <button class="tab-btn" data-tab="history-tab">å†å²è®°å½•</button>
            <button class="tab-btn" data-tab="git-tab">Git ç®¡ç†</button>
            <button class="tab-btn" data-tab="diagnostic-tab">ç³»ç»Ÿè¯Šæ–­</button>
        </nav>

        <main class="main">
            <!-- èŠå¤© Tab å†…å®¹ -->
            <section id="chat-tab" class="tab-content active">
                <div id="messages-container" class="messages-container">
                    <div class="welcome-message">
                        <h2>æ¬¢è¿ä½¿ç”¨ Claude Web</h2>
                        <p>çŠ¶æ€è¯´æ˜ï¼š</p>
                        <p>ğŸŸ¡ <strong>å·²è¿æ¥ - ç­‰å¾… Cursor å†…å®¹</strong>ï¼šéœ€è¦åœ¨ Cursor ä¸­è¿è¡Œæ³¨å…¥è„šæœ¬</p>
                        <p>ğŸŸ¢ <strong>å·²è¿æ¥ - åŒæ­¥æ­£å¸¸</strong>ï¼šå†…å®¹åŒæ­¥å·¥ä½œæ­£å¸¸</p>
                        <br>
                        <p class="instruction">ä½¿ç”¨æ–¹æ³•ï¼šåœ¨ Cursor å¼€å‘è€…å·¥å…·ä¸­è¿è¡ŒåŒæ­¥è„šæœ¬</p>
                        <a href="/script.html" class="btn btn-primary" style="display:inline-block;margin:10px 0;">å‰å¾€ä¸€é”®å¤åˆ¶åŒæ­¥è„šæœ¬ &gt;&gt;</a>
                        <p class="instruction">è„šæœ¬ä¼šåŒæ­¥æ•´ä¸ª Cursor é¡µé¢å†…å®¹åˆ°æ­¤é¡µé¢</p>
                    </div>
                </div>
                <footer class="footer">
                    <form id="send-form" autocomplete="off">
                        <input id="send-input" type="text" placeholder="è¾“å…¥æ¶ˆæ¯..." autocomplete="off" />
                        <button id="send-btn" type="submit">å‘é€</button>
                        <button id="clear-btn" type="button">æ¸…é™¤</button>
                    </form>
                </footer>
            </section>

            <!-- å†å²è®°å½• Tab å†…å®¹ -->
            <section id="history-tab" class="tab-content">
                <div class="history-panel">
                    <div class="history-header">
                        <h2>å†å²è®°å½•</h2>
                        <div class="history-controls">
                            <button class="btn btn-primary" onclick="window.open('/history.html', '_blank')">æ‰“å¼€å®Œæ•´å†å²è®°å½•é¡µé¢</button>
                            <button class="btn btn-secondary" onclick="refreshQuickHistory()">åˆ·æ–°</button>
                        </div>
                    </div>
                    
                    <div class="history-stats" id="quickHistoryStats">
                        <div class="stat-card">
                            <h3>æ€»è®°å½•æ•°</h3>
                            <div class="value" id="quickTotalRecords">-</div>
                        </div>
                        <div class="stat-card">
                            <h3>èŠå¤©è®°å½•</h3>
                            <div class="value" id="quickChatRecords">-</div>
                        </div>
                        <div class="stat-card">
                            <h3>ç³»ç»Ÿè®°å½•</h3>
                            <div class="value" id="quickSystemRecords">-</div>
                        </div>
                        <div class="stat-card">
                            <h3>é”™è¯¯è®°å½•</h3>
                            <div class="value" id="quickErrorRecords">-</div>
                        </div>
                    </div>

                    <div class="history-list" id="quickHistoryList">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                </div>
            </section>

            <!-- Git ç®¡ç† Tab å†…å®¹ -->
            <section id="git-tab" class="tab-content">
                <div class="git-panel">
                    <h2>Git åˆ†æ”¯ç®¡ç†</h2>
                    <div class="git-controls">
                        <div class="git-status">
                            <div class="status-row">
                                <span>å½“å‰åˆ†æ”¯ï¼š</span>
                                <span id="current-branch" class="current-branch">åŠ è½½ä¸­...</span>
                            </div>
                            <div class="status-row">
                                <span>Git è·¯å¾„ï¼š</span>
                                <span id="git-path" class="git-path" title="">åŠ è½½ä¸­...</span>
                            </div>
                        </div>
                        <div class="git-actions">
                            <button id="refresh-branches" class="btn btn-secondary">åˆ·æ–°è¿œç¨‹åˆ†æ”¯</button>
                            <button id="pull-code" class="btn btn-primary">æ›´æ–°ä»£ç </button>
                            <button id="git-status" class="btn btn-info">æŸ¥çœ‹çŠ¶æ€</button>
                        </div>
                    </div>
                    <div class="branch-section">
                        <h3>åˆ†æ”¯åˆ‡æ¢</h3>
                        <div class="branch-selector">
                            <select id="branch-select" class="branch-select">
                                <option value="">é€‰æ‹©åˆ†æ”¯...</option>
                            </select>
                            <button id="checkout-branch" class="btn btn-success">åˆ‡æ¢åˆ†æ”¯</button>
                        </div>
                    </div>
                    <div class="commit-section">
                        <h3>ä»£ç æäº¤</h3>
                        <div class="commit-controls">
                            <div class="commit-input">
                                <input type="text" id="commit-message" placeholder="è¾“å…¥æäº¤ä¿¡æ¯..." class="commit-input-field">
                                <button id="add-files" class="btn btn-secondary">æ·»åŠ æ–‡ä»¶</button>
                                <button id="commit-code" class="btn btn-primary">æäº¤ä»£ç </button>
                                <button id="push-code" class="btn btn-success">æ¨é€ä»£ç </button>
                            </div>
                        </div>
                    </div>
                    <div id="git-output" class="git-output">
                        <div class="output-header">
                            <span>Git æ“ä½œè¾“å‡º</span>
                            <button id="clear-output" class="btn btn-small">æ¸…é™¤</button>
                        </div>
                        <div id="git-log" class="git-log"></div>
                    </div>
                </div>
            </section>

            <!-- ç³»ç»Ÿè¯Šæ–­ Tab å†…å®¹ -->
            <section id="diagnostic-tab" class="tab-content">
                <div class="diagnostic-panel">
                    <h2>ç³»ç»Ÿè¯Šæ–­</h2>
                    <p>æ£€æŸ¥ç³»ç»Ÿå„ä¸ªåŠŸèƒ½æ¨¡å—çš„çŠ¶æ€å’Œè¿æ¥æƒ…å†µ</p>
                    <div class="diagnostic-actions">
                        <a href="/diagnostic.html" class="btn btn-primary" target="_blank">
                            ğŸ” æ‰“å¼€å®Œæ•´è¯Šæ–­é¡µé¢
                        </a>
                        <p class="instruction">åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€å®Œæ•´çš„ç³»ç»Ÿè¯Šæ–­ç•Œé¢ï¼ŒåŒ…å«æ‰€æœ‰æµ‹è¯•åŠŸèƒ½</p>
                    </div>
                    <div class="quick-status">
                        <h3>å¿«é€ŸçŠ¶æ€æ£€æŸ¥</h3>
                        <div id="quick-status-grid" class="quick-status-grid">
                            <div class="status-item">
                                <span class="status-label">WebSocketè¿æ¥</span>
                                <span id="ws-status" class="status-value">æ£€æŸ¥ä¸­...</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">CursorçŠ¶æ€</span>
                                <span id="cursor-status" class="status-value">æ£€æŸ¥ä¸­...</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">æ¨¡å—åŠ è½½</span>
                                <span id="module-status" class="status-value">æ£€æŸ¥ä¸­...</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">å®¢æˆ·ç«¯çŠ¶æ€</span>
                                <span id="client-status" class="status-value">æ£€æŸ¥ä¸­...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script src="js/modules/module-loader.js"></script>
    <script src="git-manager.js"></script>
    <script>
    // Tab åˆ‡æ¢é€»è¾‘
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            this.classList.add('active');
            document.getElementById(this.dataset.tab).classList.add('active');

            // å¦‚æœåˆ‡æ¢åˆ°è¯Šæ–­tabï¼Œæ›´æ–°å¿«é€ŸçŠ¶æ€
            if (this.dataset.tab === 'diagnostic-tab') {
                updateQuickStatus();
            }
            
            // å¦‚æœåˆ‡æ¢åˆ°å†å²è®°å½•tabï¼ŒåŠ è½½å†å²è®°å½•
            if (this.dataset.tab === 'history-tab') {
                loadQuickHistory();
            }
        });
    });

        // æ›´æ–°å¿«é€ŸçŠ¶æ€æ£€æŸ¥
    function updateQuickStatus() {
        // WebSocketçŠ¶æ€ - ä½¿ç”¨æ›´å‡†ç¡®çš„æ£€æµ‹æ–¹æ³•
        const wsStatus = document.getElementById('ws-status');
        let wsConnected = false;

        // æ–¹æ³•1: æ£€æŸ¥simpleClientçš„WebSocketçŠ¶æ€ï¼ˆä¸è¯Šæ–­é¡µé¢ä¿æŒä¸€è‡´ï¼‰
        if (window.simpleClient && typeof window.simpleClient.isConnected === 'function') {
            wsConnected = window.simpleClient.isConnected();
        }
        // æ–¹æ³•2: æ£€æŸ¥simpleClientçš„wsManagerçŠ¶æ€
        else if (window.simpleClient && window.simpleClient.wsManager && typeof window.simpleClient.wsManager.isConnected === 'function') {
            wsConnected = window.simpleClient.wsManager.isConnected();
        }
        // æ–¹æ³•3: æ£€æŸ¥é¡µé¢çŠ¶æ€å…ƒç´ 
        else if (document.querySelector('.status.connected')) {
            wsConnected = true;
        }
        // æ–¹æ³•4: æ£€æŸ¥WebSocketManageræ¨¡å—
        else if (window.WebSocketManager && typeof window.WebSocketManager.isConnected === 'function') {
            wsConnected = window.WebSocketManager.isConnected();
        }

        if (wsConnected) {
            wsStatus.textContent = 'å·²è¿æ¥';
            wsStatus.className = 'status-value connected';
        } else {
            wsStatus.textContent = 'æœªè¿æ¥';
            wsStatus.className = 'status-value disconnected';
        }

        // è°ƒè¯•ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
        if (window.simpleClient) {
            console.log('é¦–é¡µWebSocketçŠ¶æ€æ£€æµ‹:', {
                simpleClientExists: !!window.simpleClient,
                isConnectedMethod: typeof window.simpleClient.isConnected,
                wsManagerExists: !!window.simpleClient.wsManager,
                wsManagerIsConnectedMethod: window.simpleClient.wsManager ? typeof window.simpleClient.wsManager.isConnected : 'N/A',
                finalResult: wsConnected
            });
        }

        // æ¨¡å—åŠ è½½çŠ¶æ€
        const moduleStatus = document.getElementById('module-status');
        if (window.ModuleLoader) {
            moduleStatus.textContent = 'å·²åŠ è½½';
            moduleStatus.className = 'status-value success';
        } else {
            moduleStatus.textContent = 'æœªåŠ è½½';
            moduleStatus.className = 'status-value error';
        }

        // CursorçŠ¶æ€
        const cursorStatus = document.getElementById('cursor-status');
        if (window.simpleClient && window.simpleClient.cursorStatusManager) {
            try {
                const status = window.simpleClient.cursorStatusManager.getCursorStatus();
                switch (status.status) {
                    case 'active':
                        cursorStatus.textContent = 'æ´»è·ƒ';
                        cursorStatus.className = 'status-value success';
                        break;
                    case 'waiting':
                        cursorStatus.textContent = 'ç­‰å¾…';
                        cursorStatus.className = 'status-value warning';
                        break;
                    case 'inactive':
                        cursorStatus.textContent = 'ä¸æ´»è·ƒ';
                        cursorStatus.className = 'status-value warning';
                        break;
                    case 'closed':
                        cursorStatus.textContent = 'å·²å…³é—­';
                        cursorStatus.className = 'status-value error';
                        break;
                    default:
                        cursorStatus.textContent = 'æœªçŸ¥';
                        cursorStatus.className = 'status-value error';
                }
            } catch (error) {
                cursorStatus.textContent = 'æ£€æŸ¥å¤±è´¥';
                cursorStatus.className = 'status-value error';
            }
        } else {
            cursorStatus.textContent = 'æœªåˆå§‹åŒ–';
            cursorStatus.className = 'status-value error';
        }

        // å®¢æˆ·ç«¯çŠ¶æ€
        const clientStatus = document.getElementById('client-status');
        if (window.simpleClient) {
            clientStatus.textContent = 'å·²åˆå§‹åŒ–';
            clientStatus.className = 'status-value success';
        } else {
            clientStatus.textContent = 'æœªåˆå§‹åŒ–';
            clientStatus.className = 'status-value error';
        }
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.addEventListener('load', function() {
        // å¦‚æœå½“å‰åœ¨è¯Šæ–­tabï¼Œæ›´æ–°çŠ¶æ€
        if (document.querySelector('.tab-btn[data-tab="diagnostic-tab"]').classList.contains('active')) {
            updateQuickStatus();
        }
        
        // å¦‚æœå½“å‰åœ¨å†å²è®°å½•tabï¼ŒåŠ è½½å†å²è®°å½•
        if (document.querySelector('.tab-btn[data-tab="history-tab"]').classList.contains('active')) {
            loadQuickHistory();
        }

        // å®šæœŸæ›´æ–°çŠ¶æ€ï¼ˆæ¯5ç§’ï¼‰
        setInterval(function() {
            if (document.querySelector('.tab-btn[data-tab="diagnostic-tab"]').classList.contains('active')) {
                updateQuickStatus();
            }
        }, 5000);
    });
    
    // åŠ è½½å¿«é€Ÿå†å²è®°å½•
    function loadQuickHistory() {
        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        fetch('/api/history/stats')
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    const stats = result.data;
                    document.getElementById('quickTotalRecords').textContent = stats.total;
                    document.getElementById('quickChatRecords').textContent = stats.byType.chat || 0;
                    document.getElementById('quickSystemRecords').textContent = stats.byType.system || 0;
                    document.getElementById('quickErrorRecords').textContent = stats.byType.error || 0;
                }
            })
            .catch(error => {
                console.error('åŠ è½½å†å²è®°å½•ç»Ÿè®¡å¤±è´¥:', error);
            });
        
        // åŠ è½½æœ€è¿‘çš„å†å²è®°å½•
        fetch('/api/history?limit=10&sortOrder=desc')
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    const container = document.getElementById('quickHistoryList');
                    const items = result.data.items;
                    
                    if (items.length === 0) {
                        container.innerHTML = '<div class="no-data">æš‚æ— å†å²è®°å½•</div>';
                        return;
                    }
                    
                    container.innerHTML = items.map(item => `
                        <div class="history-item type-${item.type}">
                            <div class="history-item-header">
                                <div class="history-item-meta">
                                    <span class="type-badge type-${item.type}">${getTypeLabel(item.type)}</span>
                                    <span class="timestamp">${formatTimestamp(item.timestamp)}</span>
                                </div>
                                <div class="history-item-actions">
                                    <button class="btn btn-sm btn-primary" onclick="window.open('/history.html', '_blank')">æŸ¥çœ‹æ›´å¤š</button>
                                </div>
                            </div>
                            <div class="history-item-summary">${item.summary}</div>
                        </div>
                    `).join('');
                }
            })
            .catch(error => {
                console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
                document.getElementById('quickHistoryList').innerHTML = '<div class="no-data">åŠ è½½å¤±è´¥</div>';
            });
    }
    
    // åˆ·æ–°å¿«é€Ÿå†å²è®°å½•
    function refreshQuickHistory() {
        loadQuickHistory();
    }
    
    // æ ¼å¼åŒ–æ—¶é—´æˆ³
    function formatTimestamp(timestamp) {
        return new Date(timestamp).toLocaleString();
    }
    
    // è·å–ç±»å‹æ ‡ç­¾
    function getTypeLabel(type) {
        const labels = {
            'chat': 'èŠå¤©',
            'system': 'ç³»ç»Ÿ',
            'error': 'é”™è¯¯',
            'git': 'Git'
        };
        return labels[type] || type;
    }
    </script>
</body>
</html>
