<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Web - Cursor èŠå¤©åŒæ­¥</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Claude Web</h1>
            <div id="status" class="status disconnected">ç­‰å¾…è¿æ¥...</div>
        </header>

        <!-- Tab å¯¼èˆª -->
        <nav class="tab-nav">
            <button class="tab-btn" data-tab="chat-tab">èŠå¤©</button>
                <button class="tab-btn active" data-tab="history-tab">å†å²è®°å½•</button>
            <button class="tab-btn" data-tab="git-tab">Git ç®¡ç†</button>
            <button class="tab-btn" data-tab="diagnostic-tab">ç³»ç»Ÿè¯Šæ–­</button>
        </nav>

        <main class="main">
            <!-- èŠå¤© Tab å†…å®¹ -->
            <section id="chat-tab" class="tab-content">
                <div id="messages-container" class="messages-container">
                    <div class="welcome-message">
                        <h2>æ¬¢è¿ä½¿ç”¨ Claude Web</h2>
                        <p>çŠ¶æ€è¯´æ˜ï¼š</p>
                        <p>ğŸŸ¡ <strong>å·²è¿æ¥ - ç­‰å¾… Cursor å†…å®¹</strong>ï¼šéœ€è¦åœ¨ Cursor ä¸­è¿è¡Œæ³¨å…¥è„šæœ¬</p>
                        <p>ğŸŸ¢ <strong>å·²è¿æ¥ - åŒæ­¥æ­£å¸¸</strong>ï¼šå†…å®¹åŒæ­¥å·¥ä½œæ­£å¸¸</p>
                        <br>
                        <p class="instruction">ä½¿ç”¨æ–¹æ³•ï¼šåœ¨ Cursor å¼€å‘è€…å·¥å…·ä¸­è¿è¡ŒåŒæ­¥è„šæœ¬</p>
                        <a href="/script.html" class="btn btn-primary" style="display:inline-block;margin:10px 0;">å‰å¾€ä¸€é”®å¤åˆ¶åŒæ­¥è„šæœ¬ &gt;&gt;</a>
                        <p class="instruction">è„šæœ¬ä¼šåŒæ­¥æ•´ä¸ª Cursor é¡µé¢å†…å®¹åˆ°æ­¤é¡µé¢</p>
                    </div>
                </div>
                <footer class="footer">
                    <form id="send-form" autocomplete="off">
                        <input id="send-input" type="text" placeholder="è¾“å…¥æ¶ˆæ¯..." autocomplete="off" />
                        <button id="send-btn" type="submit">å‘é€</button>
                        <button id="clear-btn" type="button">æ¸…é™¤</button>
                    </form>
                </footer>
            </section>

            <!-- å†å²è®°å½• Tab å†…å®¹ -->
            <section id="history-tab" class="tab-content active">
                <div class="workspace-history-panel">
                    <div class="workspace-header">
                        <h2>Cursor Chat History</h2>
                        <div class="workspace-controls">
                            <input type="text" id="workspace-search" placeholder="æœç´¢..." class="workspace-search-input">
                            <button onclick="refreshWorkspaces()" class="btn-refresh" title="åˆ·æ–°">ğŸ”„</button>
                        </div>
                    </div>
                    
                    <div class="workspace-grid" id="workspace-grid">
                        <div class="loading-workspace">æ­£åœ¨åŠ è½½å·¥ä½œåŒº...</div>
                    </div>
                    
                    <!-- å·¥ä½œåŒºè¯¦æƒ…å¼¹çª— -->
                    <div id="workspace-detail-modal" class="workspace-modal" style="display: none;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 id="modal-workspace-name">å·¥ä½œåŒºåç§°</h3>
                                <button class="modal-close" onclick="closeWorkspaceModal()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="time-groups" id="workspace-time-groups">
                                    <!-- æŒ‰æ—¶é—´åˆ†ç»„çš„èŠå¤©è®°å½• -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Git ç®¡ç† Tab å†…å®¹ -->
            <section id="git-tab" class="tab-content">
                <div class="git-panel">
                    <h2>Git åˆ†æ”¯ç®¡ç†</h2>
                    <div class="git-controls">
                        <div class="git-status">
                            <div class="status-row">
                                <span>å½“å‰åˆ†æ”¯ï¼š</span>
                                <span id="current-branch" class="current-branch">åŠ è½½ä¸­...</span>
                            </div>
                            <div class="status-row">
                                <span>Git è·¯å¾„ï¼š</span>
                                <span id="git-path" class="git-path" title="">åŠ è½½ä¸­...</span>
                            </div>
                        </div>
                        <div class="git-actions">
                            <button id="refresh-branches" class="btn btn-secondary">åˆ·æ–°è¿œç¨‹åˆ†æ”¯</button>
                            <button id="pull-code" class="btn btn-primary">æ›´æ–°ä»£ç </button>
                            <button id="git-status" class="btn btn-info">æŸ¥çœ‹çŠ¶æ€</button>
                        </div>
                    </div>
                    <div class="branch-section">
                        <h3>åˆ†æ”¯åˆ‡æ¢</h3>
                        <div class="branch-selector">
                            <select id="branch-select" class="branch-select">
                                <option value="">é€‰æ‹©åˆ†æ”¯...</option>
                            </select>
                            <button id="checkout-branch" class="btn btn-success">åˆ‡æ¢åˆ†æ”¯</button>
                        </div>
                    </div>
                    <div class="commit-section">
                        <h3>ä»£ç æäº¤</h3>
                        <div class="commit-controls">
                            <div class="commit-input">
                                <input type="text" id="commit-message" placeholder="è¾“å…¥æäº¤ä¿¡æ¯..." class="commit-input-field">
                                <button id="add-files" class="btn btn-secondary">æ·»åŠ æ–‡ä»¶</button>
                                <button id="commit-code" class="btn btn-primary">æäº¤ä»£ç </button>
                                <button id="push-code" class="btn btn-success">æ¨é€ä»£ç </button>
                            </div>
                        </div>
                    </div>
                    <div id="git-output" class="git-output">
                        <div class="output-header">
                            <span>Git æ“ä½œè¾“å‡º</span>
                            <button id="clear-output" class="btn btn-small">æ¸…é™¤</button>
                        </div>
                        <div id="git-log" class="git-log"></div>
                    </div>
                </div>
            </section>

            <!-- ç³»ç»Ÿè¯Šæ–­ Tab å†…å®¹ -->
            <section id="diagnostic-tab" class="tab-content">
                <div class="diagnostic-panel">
                    <h2>ç³»ç»Ÿè¯Šæ–­</h2>
                    <p>æ£€æŸ¥ç³»ç»Ÿå„ä¸ªåŠŸèƒ½æ¨¡å—çš„çŠ¶æ€å’Œè¿æ¥æƒ…å†µ</p>
                    <div class="diagnostic-actions">
                        <a href="/diagnostic.html" class="btn btn-primary" target="_blank">
                            ğŸ” æ‰“å¼€å®Œæ•´è¯Šæ–­é¡µé¢
                        </a>
                        <p class="instruction">åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€å®Œæ•´çš„ç³»ç»Ÿè¯Šæ–­ç•Œé¢ï¼ŒåŒ…å«æ‰€æœ‰æµ‹è¯•åŠŸèƒ½</p>
                    </div>
                    <div class="quick-status">
                        <h3>å¿«é€ŸçŠ¶æ€æ£€æŸ¥</h3>
                        <div id="quick-status-grid" class="quick-status-grid">
                            <div class="status-item">
                                <span class="status-label">WebSocketè¿æ¥</span>
                                <span id="ws-status" class="status-value">æ£€æŸ¥ä¸­...</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">CursorçŠ¶æ€</span>
                                <span id="cursor-status" class="status-value">æ£€æŸ¥ä¸­...</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">æ¨¡å—åŠ è½½</span>
                                <span id="module-status" class="status-value">æ£€æŸ¥ä¸­...</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">å®¢æˆ·ç«¯çŠ¶æ€</span>
                                <span id="client-status" class="status-value">æ£€æŸ¥ä¸­...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script src="js/modules/git-manager.js"></script>
    <script>
        // å†å²è®°å½•åŠŸèƒ½ - ç‹¬ç«‹å®ç°
        class HistoryApiClient {
            constructor() {
                this.baseUrl = '/api/history';
            }

            async getAllChats(options = {}) {
                const params = new URLSearchParams();
                if (options.limit) params.append('limit', options.limit);
                if (options.offset) params.append('offset', options.offset);
                
                const url = `${this.baseUrl}/chats${params.toString() ? '?' + params.toString() : ''}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                return await response.json();
            }

            async getChatDetail(sessionId) {
                const response = await fetch(`${this.baseUrl}/chat/${encodeURIComponent(sessionId)}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                return await response.json();
            }

            async searchChats(query) {
                const response = await fetch(`${this.baseUrl}/search?q=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                return await response.json();
            }

            async clearCache() {
                const response = await fetch(`${this.baseUrl}/cache`, { method: 'DELETE' });
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                return await response.json();
            }
        }

        class HistoryService {
            constructor() {
                this.apiClient = new HistoryApiClient();
                this.cache = new Map();
                this.cacheTimeout = 5 * 60 * 1000;
            }

            async getChatList(options = {}) {
                const cacheKey = `all_chats_${JSON.stringify(options)}`;
                const cached = this.cache.get(cacheKey);
                
                if (cached && Date.now() - cached.timestamp < this.cacheTimeout) {
                    return cached.data;
                }

                try {
                    const response = await this.apiClient.getAllChats(options);
                    console.log('APIå“åº”:', response);
                    
                    let chats;
                    if (response && response.success && Array.isArray(response.data)) {
                        chats = response.data;
                    } else if (Array.isArray(response)) {
                        chats = response;
                    } else {
                        console.warn('æ„å¤–çš„APIå“åº”æ ¼å¼:', response);
                        chats = [];
                    }

                    const processedChats = this.processChats(chats);
                    this.cache.set(cacheKey, { data: processedChats, timestamp: Date.now() });
                    return processedChats;
                } catch (error) {
                    console.error('è·å–èŠå¤©åˆ—è¡¨å¤±è´¥:', error);
                    throw error;
                }
            }

            async getChatDetail(sessionId) {
                try {
                    const response = await this.apiClient.getChatDetail(sessionId);
                    const chatDetail = response.data;
                    return this.processChatDetail(chatDetail);
                } catch (error) {
                    console.error('è·å–èŠå¤©è¯¦æƒ…å¤±è´¥:', error);
                    throw error;
                }
            }

            async searchChats(query) {
                if (!query || query.trim() === '') {
                    return this.getChatList();
                }

                try {
                    const response = await this.apiClient.searchChats(query);
                    return this.processChats(response.data || []);
                } catch (error) {
                    console.error('æœç´¢èŠå¤©è®°å½•å¤±è´¥:', error);
                    throw error;
                }
            }

            async clearCache() {
                this.cache.clear();
                return await this.apiClient.clearCache();
            }

            processChats(chats) {
                if (!Array.isArray(chats)) {
                    console.warn('processChats: æœŸæœ›æ•°ç»„ä½†æ”¶åˆ°:', typeof chats, chats);
                    return [];
                }
                
                return chats.map(chat => ({
                    ...chat,
                    title: this.generateChatTitle(chat),
                    preview: this.generateChatPreview(chat),
                    formattedTime: this.formatTime(chat.timestamp || chat.lastModified),
                    messageCount: chat.messages ? chat.messages.length : 0
                }));
            }

            processChatDetail(chatDetail) {
                return {
                    ...chatDetail,
                    title: this.generateChatTitle(chatDetail),
                    formattedTime: this.formatTime(chatDetail.timestamp || chatDetail.lastModified),
                    messages: chatDetail.messages ? chatDetail.messages.map(msg => ({
                        ...msg,
                        formattedTime: this.formatTime(msg.timestamp)
                    })) : []
                };
            }

            generateChatTitle(chat) {
                if (chat.title) return chat.title;
                
                if (chat.messages && chat.messages.length > 0) {
                    const firstUserMessage = chat.messages.find(msg => msg.role === 'user');
                    if (firstUserMessage) {
                        return firstUserMessage.content.substring(0, 50) + 
                               (firstUserMessage.content.length > 50 ? '...' : '');
                    }
                }
                
                return `èŠå¤©è®°å½• ${this.formatTime(chat.timestamp || Date.now())}`;
            }

            generateChatPreview(chat) {
                if (chat.messages && chat.messages.length > 0) {
                    const lastMessage = chat.messages[chat.messages.length - 1];
                    return lastMessage.content.substring(0, 100) + 
                           (lastMessage.content.length > 100 ? '...' : '');
                }
                return 'æš‚æ— æ¶ˆæ¯';
            }

            formatTime(timestamp) {
                if (!timestamp) return 'æœªçŸ¥æ—¶é—´';
                
                const date = new Date(timestamp);
                const now = new Date();
                const diff = now - date;
                
                if (diff < 60000) return 'åˆšåˆš';
                if (diff < 3600000) return `${Math.floor(diff / 60000)}åˆ†é’Ÿå‰`;
                if (diff < 86400000) return `${Math.floor(diff / 3600000)}å°æ—¶å‰`;
                if (diff < 604800000) return `${Math.floor(diff / 86400000)}å¤©å‰`;
                return date.toLocaleDateString('zh-CN');
            }
        }

        // å†å²è®°å½•ç®¡ç†å™¨
        let historyService = new HistoryService();
        let currentChats = [];
        let allProjects = {};
        let currentGitPath = null;
        let showAllProjects = true;

        // å·¥ä½œåŒºå†å²è®°å½•ç®¡ç†å™¨
        let historyManager = null;

        // åˆå§‹åŒ–å·¥ä½œåŒºå†å²è®°å½•
        async function initWorkspaceHistory() {
            try {
                const historyContainer = document.querySelector('#history-tab');
                if (historyContainer && typeof HistoryManager !== 'undefined') {
                    historyManager = new HistoryManager(historyContainer);
                    await historyManager.init();
                    console.log('âœ… å·¥ä½œåŒºå†å²è®°å½•ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ');
                } else {
                    console.error('âŒ å†å²è®°å½•å®¹å™¨æˆ–HistoryManagerç±»æœªæ‰¾åˆ°');
                }
            } catch (error) {
                console.error('âŒ å·¥ä½œåŒºå†å²è®°å½•åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }

        // å…¼å®¹æ€§å‡½æ•°ï¼ˆä¿ç•™æ—§çš„å‡½æ•°åï¼‰
        async function loadHistoryChats() {
            await initWorkspaceHistory();
        }

        // å…¼å®¹æ€§å‡½æ•°ï¼ˆä¿ç•™ä½†ä¸æ‰§è¡Œå®é™…é€»è¾‘ï¼‰
        async function loadProjectFolders() {
            // æ­¤å‡½æ•°å·²è¢«æ–°çš„å·¥ä½œåŒºç®¡ç†å™¨æ›¿ä»£
            console.log('loadProjectFolders å·²è¢«å·¥ä½œåŒºç®¡ç†å™¨æ›¿ä»£');
            
            try {
                // åŒæ—¶è·å–é¡¹ç›®ä¿¡æ¯å’ŒèŠå¤©è®°å½•
                const [projectResponse, chatsResponse] = await Promise.all([
                    fetch('/api/history/file-paths'),
                    fetch('/api/history/chats')
                ]);
                
                const projectData = await projectResponse.json();
                const chatsData = await chatsResponse.json();
                
                console.log('ğŸ” é¡¹ç›®æ•°æ®:', projectData);
                console.log('ğŸ” èŠå¤©æ•°æ®:', chatsData);
                console.log('ğŸ” èŠå¤©è®°å½•ç¤ºä¾‹:', chatsData.data ? chatsData.data.slice(0, 3) : 'No data');
                if (chatsData.data && chatsData.data.length > 0) {
                    console.log('ğŸ” ç¬¬ä¸€æ¡èŠå¤©è®°å½•çš„projectå­—æ®µ:', chatsData.data[0].project);
                    console.log('ğŸ” ç¬¬ä¸€æ¡èŠå¤©è®°å½•çš„workspaceIdå­—æ®µ:', chatsData.data[0].workspaceId);
                }
                
                if (projectData.data && projectData.data.projectInfo && projectData.data.projectInfo.length > 0) {
                    // è½¬æ¢ä¸ºé¡¹ç›®å¯¹è±¡æ ¼å¼
                    const projects = {};
                    
                    // é¦–å…ˆåˆ›å»ºé¡¹ç›®ç»“æ„
                    projectData.data.projectInfo.forEach(project => {
                        const key = `${project.workspaceId}|${project.name}`;
                        projects[key] = {
                            name: project.name,
                            path: project.rootPath,
                            chats: [],
                            workspaceId: project.workspaceId,
                            lastModified: project.lastModified
                        };
                    });
                    
                    // ç„¶åå…³è”èŠå¤©è®°å½•
                    if (Array.isArray(chatsData.data)) {
                        chatsData.data.forEach(chat => {
                            // å¤„ç†ä¸åŒçš„æ•°æ®ç»“æ„
                            let workspaceId, projectName;
                            
                            if (chat.project && chat.project.workspace_id && chat.project.name) {
                                // æ–°çš„æ•°æ®ç»“æ„
                                workspaceId = chat.project.workspace_id;
                                projectName = chat.project.name;
                            } else if (chat.workspaceId && chat.project && chat.project.name) {
                                // å¤‡ç”¨æ•°æ®ç»“æ„
                                workspaceId = chat.workspaceId;
                                projectName = chat.project.name;
                            }
                            
                            if (workspaceId && projectName) {
                                const key = `${workspaceId}|${projectName}`;
                                if (projects[key]) {
                                    projects[key].chats.push(chat);
                                }
                            }
                        });
                    }
                    
                    allProjects = projects;
                    
                    // åº”ç”¨æ–‡ä»¶å¤¹ç­›é€‰
                    const folderFilter = document.getElementById('folder-search').value;
                    const filteredProjects = filterProjects(projects, folderFilter);
                    
                    displayProjectFolders(filteredProjects);
                    
                    // è®¡ç®—æ€»èŠå¤©æ•°é‡
                    const totalChats = Object.values(projects).reduce((sum, project) => sum + project.chats.length, 0);
                    
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    updateHistoryStats(`å‘ç° ${projectData.data.projectInfo.length} ä¸ªé¡¹ç›®ï¼Œ${totalChats} æ¡èŠå¤©è®°å½•`);
                } else {
                    projectContainer.innerHTML = '<div class="error" style="padding: 20px; text-align: center; color: #cccccc;">æ²¡æœ‰æ‰¾åˆ°é¡¹ç›®</div>';
                    updateHistoryStats('æ²¡æœ‰æ‰¾åˆ°é¡¹ç›®');
                }
            } catch (error) {
                console.error('åŠ è½½é¡¹ç›®å¤±è´¥:', error);
                projectContainer.innerHTML = '<div class="error" style="padding: 20px; text-align: center; color: red;">åŠ è½½å¤±è´¥</div>';
                updateHistoryStats(`åŠ è½½å¤±è´¥: ${error.message}`);
            }
        }

        async function loadCurrentGitPath() {
            try {
                const response = await fetch('/api/git/current-path');
                const data = await response.json();
                currentGitPath = data.currentPath;
                
                // æ·»åŠ å½“å‰Gitç›®å½•æŒ‡ç¤ºå™¨
                if (currentGitPath) {
                    updateHistoryStats(`å½“å‰æ˜¾ç¤º: ${currentGitPath} çš„èŠå¤©è®°å½•`);
                }
            } catch (error) {
                console.warn('æ— æ³•è·å–å½“å‰Gitè·¯å¾„:', error);
                currentGitPath = null;
            }
        }

        async function loadChatsForCurrentProject() {
            console.log('ğŸš€ loadChatsForCurrentProject å‡½æ•°è¢«è°ƒç”¨');
            updateHistoryStats('æ­£åœ¨åŠ è½½èŠå¤©è®°å½•...');
            
            try {
                console.log('ğŸ”„ å¼€å§‹è°ƒç”¨historyService.getChatList()');
                let chats = await historyService.getChatList();
                console.log('ğŸ“Š APIè¿”å›çš„èŠå¤©è®°å½•æ•°é‡:', chats ? chats.length : 'null/undefined');
                console.log('ğŸ“‹ APIè¿”å›çš„æ•°æ®ç±»å‹:', typeof chats);
                if (chats && chats.length > 0) {
                    console.log('ğŸ“ ç¬¬ä¸€æ¡èŠå¤©è®°å½•:', chats[0]);
                } else {
                    console.warn('âš ï¸ APIè¿”å›çš„èŠå¤©è®°å½•ä¸ºç©ºæˆ–æ— æ•ˆ');
                }
                
                // æ ¹æ®å½“å‰æ¨¡å¼è¿‡æ»¤èŠå¤©è®°å½•
                if (!showAllProjects && currentGitPath) {
                    const originalLength = chats.length;
                    chats = chats.filter(chat => 
                        chat.project && chat.project.path && 
                        chat.project.path.includes(currentGitPath)
                    );
                    console.log(`ğŸ” è¿‡æ»¤åèŠå¤©è®°å½•æ•°é‡: ${chats.length} / ${originalLength}`);
                }
                
                currentChats = chats;
                allCurrentChats = chats; // å­˜å‚¨æ‰€æœ‰èŠå¤©è®°å½•ç”¨äºè™šæ‹Ÿæ»šåŠ¨
                displayHistoryChats(chats);
                
                const totalCount = Object.values(allProjects).reduce((sum, project) => sum + project.chats.length, 0);
                updateHistoryStats(`æ˜¾ç¤º ${chats.length} / ${totalCount} æ¡èŠå¤©è®°å½•`);
            } catch (error) {
                console.error('âŒ åŠ è½½èŠå¤©è®°å½•å¤±è´¥:', error);
                updateHistoryStats(`åŠ è½½å¤±è´¥: ${error.message}`);
                document.getElementById('chat-list-container').innerHTML = 
                    `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        function displayHistoryChats(chats) {
            const container = document.getElementById('chat-list-container');
            if (!chats || chats.length === 0) {
                container.innerHTML = `
                    <div style="background: #2d2d2d; border: 1px solid #404040; border-radius: 6px; padding: 20px; margin: 20px 0; color: #cccccc; text-align: center;">
                        <div style="font-size: 18px; margin-bottom: 15px; color: #ffffff;">ğŸ“­ æ²¡æœ‰æ‰¾åˆ°èŠå¤©è®°å½•</div>
                        <div style="font-size: 14px; line-height: 1.6; margin-bottom: 15px;">
                            å¯èƒ½çš„åŸå› ï¼š<br>
                            â€¢ Cursor ç¼–è¾‘å™¨å°šæœªå®‰è£…æˆ–é¦–æ¬¡ä½¿ç”¨<br>
                            â€¢ è¿˜æ²¡æœ‰ä¸ AI è¿›è¡Œè¿‡å¯¹è¯<br>
                            â€¢ ç¨‹åºæ— æƒé™è®¿é—® Cursor æ•°æ®æ–‡ä»¶<br>
                            â€¢ Cursor èŠå¤©è®°å½•æ•°æ®åº“ä¸ºç©ºæˆ–æŸå
                        </div>
                        <div style="font-size: 13px; color: #888888;">
                            è¯·åœ¨ Cursor ç¼–è¾‘å™¨ä¸­ä¸ AI è¿›è¡Œå¯¹è¯ååˆ·æ–°é¡µé¢
                        </div>
                    </div>
                `;
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯æ¼”ç¤ºæ•°æ®
            const isDemoData = chats.some(chat => chat.sessionId && chat.sessionId.startsWith('demo-'));
            let demoWarning = '';
            if (isDemoData) {
                demoWarning = `
                    <div style="background: #2d1b1b; border: 1px solid #8b4513; border-radius: 6px; padding: 15px; margin-bottom: 20px; color: #ffcc99;">
                        <div style="font-weight: bold; margin-bottom: 8px;">âš ï¸ å½“å‰æ˜¾ç¤ºæ¼”ç¤ºæ•°æ®</div>
                        <div style="font-size: 14px; line-height: 1.5;">æœªæ‰¾åˆ°çœŸå®çš„ Cursor èŠå¤©è®°å½•ã€‚è¯·ç¡®ä¿ï¼š<br>
                        â€¢ Cursor ç¼–è¾‘å™¨å·²æ­£ç¡®å®‰è£…<br>
                        â€¢ åœ¨ Cursor ä¸­æœ‰è¿‡ AI å¯¹è¯å†å²<br>
                        â€¢ ç¨‹åºæœ‰æƒé™è®¿é—® Cursor æ•°æ®æ–‡ä»¶</div>
                    </div>
                `;
            }

            // æ€§èƒ½ä¼˜åŒ–ï¼šè™šæ‹Ÿæ»šåŠ¨
            const performanceStart = performance.now();
            
            // é™åˆ¶ä¸€æ¬¡æ¸²æŸ“çš„æœ€å¤§æ•°é‡
            const MAX_CHATS_TO_RENDER = 100;
            const chatsToRender = chats.slice(0, MAX_CHATS_TO_RENDER);
            
            let html = '';
            chatsToRender.forEach(chat => {
                html += `
                    <div class="chat-card" onclick="loadHistoryChatDetail('${chat.sessionId}')" 
                         style="border: 1px solid #404040; margin: 8px 0; padding: 12px; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; background: #2d2d2d;"
                         onmouseover="this.style.background='#3d3d3d'" 
                         onmouseout="this.style.background='#2d2d2d'">
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 5px; color: #ffffff;">${chat.title || 'æœªçŸ¥æ ‡é¢˜'}</div>
                        <div style="color: #cccccc; font-size: 14px; margin-bottom: 5px;">${chat.preview}</div>
                        <div style="font-size: 12px; color: #888888; display: flex; flex-direction: column; gap: 5px;">
                            <div style="display: flex; gap: 15px;">
                                <span>é¡¹ç›®: ${chat.project?.name || 'æœªçŸ¥'}</span>
                                <span>æ¶ˆæ¯: ${chat.messageCount}</span>
                                <span>${chat.formattedTime}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;" title="${chat.project?.path || chat.project?.rootPath || ''}">
                                <span>ğŸ“</span>
                                <span style="font-size: 11px; color: #666666;">${chat.project?.path || chat.project?.rootPath || 'Unknown Path'}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // å¦‚æœèŠå¤©æ•°é‡è¶…è¿‡é™åˆ¶ï¼Œæ˜¾ç¤ºåŠ è½½æ›´å¤šæŒ‰é’®
            if (chats.length > MAX_CHATS_TO_RENDER) {
                html += `
                    <div style="text-align: center; padding: 20px;">
                        <button onclick="loadMoreChats()" class="btn btn-secondary" style="background: #404040; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                            åŠ è½½æ›´å¤šèŠå¤©è®°å½• (${chats.length - MAX_CHATS_TO_RENDER} æ¡æœªæ˜¾ç¤º)
                        </button>
                    </div>
                `;
            }
            
            container.innerHTML = demoWarning + html;
            
            const performanceEnd = performance.now();
            console.log(`ğŸš€ æ¸²æŸ“ ${chatsToRender.length} ä¸ªèŠå¤©å¡ç‰‡è€—æ—¶: ${(performanceEnd - performanceStart).toFixed(2)}ms`);
        }

        // å…¨å±€å˜é‡ç”¨äºå­˜å‚¨æ‰€æœ‰èŠå¤©è®°å½•
        let allCurrentChats = [];

        function loadMoreChats() {
            const container = document.getElementById('chat-list-container');
            const currentCount = container.querySelectorAll('.chat-card').length;
            const remainingChats = allCurrentChats.slice(currentCount);
            
            if (remainingChats.length === 0) {
                updateHistoryStats('æ²¡æœ‰æ›´å¤šèŠå¤©è®°å½•äº†');
                return;
            }
            
            // è¿½åŠ æ›´å¤šèŠå¤©è®°å½•
            const MAX_BATCH_SIZE = 50;
            const chatsToAppend = remainingChats.slice(0, MAX_BATCH_SIZE);
            
            let html = '';
            chatsToAppend.forEach(chat => {
                html += `
                    <div class="chat-card" onclick="loadHistoryChatDetail('${chat.sessionId}')" 
                         style="border: 1px solid #404040; margin: 8px 0; padding: 12px; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; background: #2d2d2d;"
                         onmouseover="this.style.background='#3d3d3d'" 
                         onmouseout="this.style.background='#2d2d2d'">
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 5px; color: #ffffff;">${chat.title || 'æœªçŸ¥æ ‡é¢˜'}</div>
                        <div style="color: #cccccc; font-size: 14px; margin-bottom: 5px;">${chat.preview}</div>
                        <div style="font-size: 12px; color: #888888; display: flex; flex-direction: column; gap: 5px;">
                            <div style="display: flex; gap: 15px;">
                                <span>é¡¹ç›®: ${chat.project?.name || 'æœªçŸ¥'}</span>
                                <span>æ¶ˆæ¯: ${chat.messageCount}</span>
                                <span>${chat.formattedTime}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;" title="${chat.project?.path || chat.project?.rootPath || ''}">
                                <span>ğŸ“</span>
                                <span style="font-size: 11px; color: #666666;">${chat.project?.path || chat.project?.rootPath || 'Unknown Path'}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // ç§»é™¤ç°æœ‰çš„åŠ è½½æ›´å¤šæŒ‰é’®
            const loadMoreBtn = container.querySelector('button');
            if (loadMoreBtn) {
                loadMoreBtn.remove();
            }
            
            // è¿½åŠ æ–°çš„èŠå¤©è®°å½•
            container.insertAdjacentHTML('beforeend', html);
            
            // å¦‚æœè¿˜æœ‰æ›´å¤šèŠå¤©è®°å½•ï¼Œé‡æ–°æ·»åŠ åŠ è½½æ›´å¤šæŒ‰é’®
            const newCurrentCount = container.querySelectorAll('.chat-card').length;
            if (newCurrentCount < allCurrentChats.length) {
                const remaining = allCurrentChats.length - newCurrentCount;
                container.insertAdjacentHTML('beforeend', `
                    <div style="text-align: center; padding: 20px;">
                        <button onclick="loadMoreChats()" class="btn btn-secondary" style="background: #404040; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                            åŠ è½½æ›´å¤šèŠå¤©è®°å½• (${remaining} æ¡æœªæ˜¾ç¤º)
                        </button>
                    </div>
                `);
            }
            
            updateHistoryStats(`å·²æ˜¾ç¤º ${newCurrentCount} / ${allCurrentChats.length} æ¡èŠå¤©è®°å½•`);
        }

        async function loadHistoryChatDetail(sessionId) {
            updateHistoryStats('æ­£åœ¨åŠ è½½èŠå¤©è¯¦æƒ…...');
            document.getElementById('chat-detail-container').innerHTML = 
                '<div class="loading">æ­£åœ¨åŠ è½½èŠå¤©è¯¦æƒ…...</div>';
            
            try {
                const chat = await historyService.getChatDetail(sessionId);
                if (chat) {
                    displayHistoryChatDetail(chat);
                    updateHistoryStats(`æ˜¾ç¤ºèŠå¤©è¯¦æƒ…: ${chat.title || 'æœªçŸ¥æ ‡é¢˜'}`);
                } else {
                    throw new Error('èŠå¤©è¯¦æƒ…ä¸ºç©º');
                }
            } catch (error) {
                console.error('åŠ è½½è¯¦æƒ…å¤±è´¥:', error);
                updateHistoryStats(`åŠ è½½è¯¦æƒ…å¤±è´¥: ${error.message}`);
                document.getElementById('chat-detail-container').innerHTML = 
                    `<div class="error">åŠ è½½è¯¦æƒ…å¤±è´¥: ${error.message}</div>`;
            }
        }

        function displayHistoryChatDetail(chat) {
            const container = document.getElementById('chat-detail-container');
            
            // æ£€æŸ¥chatå¯¹è±¡æ˜¯å¦æœ‰æ•ˆ
            if (!chat) {
                container.innerHTML = '<div class="error">èŠå¤©è¯¦æƒ…æ•°æ®æ— æ•ˆ</div>';
                return;
            }
            
            let html = `
                <h3 style="margin: 0 0 15px 0; color: #ffffff;">${chat.title || 'æœªçŸ¥æ ‡é¢˜'}</h3>
                <div style="margin: 15px 0; font-size: 14px; color: #cccccc; background: #2d2d2d; padding: 15px; border-radius: 4px; border: 1px solid #404040;">
                    <p style="margin: 5px 0;"><strong>ä¼šè¯ID:</strong> <code style="color: #ffffff;">${chat.sessionId}</code></p>
                    <p style="margin: 5px 0;"><strong>é¡¹ç›®:</strong> ${chat.project?.name || 'æœªçŸ¥'}</p>
                    <p style="margin: 5px 0;"><strong>æ¶ˆæ¯æ•°é‡:</strong> ${chat.messages?.length || 0}</p>
                    <p style="margin: 5px 0;"><strong>æ—¶é—´:</strong> ${chat.formattedTime}</p>
                </div>
                <hr style="margin: 20px 0; border: none; border-top: 1px solid #404040;">
            `;

            if (chat.messages && chat.messages.length > 0) {
                chat.messages.forEach((msg, index) => {
                    html += `
                        <div style="margin: 15px 0; padding: 15px; border-radius: 6px; border-left: 3px solid ${msg.role === 'user' ? '#22c55e' : '#3b82f6'}; background: ${msg.role === 'user' ? '#1a3a1a' : '#1a2a3a'};">
                            <div style="font-size: 12px; color: #cccccc; margin-bottom: 8px;">
                                ${msg.role === 'user' ? 'ğŸ‘¤ ç”¨æˆ·' : 'ğŸ¤– AI'} - ${msg.formattedTime}
                            </div>
                            <div style="font-size: 14px; line-height: 1.6; white-space: pre-wrap; color: #ffffff;">${msg.content}</div>
                        </div>
                    `;
                });
            } else {
                html += '<p style="color: #cccccc; text-align: center; padding: 20px;">æš‚æ— æ¶ˆæ¯</p>';
            }

            container.innerHTML = html;
        }

        async function searchChats() {
            const query = document.getElementById('history-search').value.trim();
            if (!query) {
                loadChatsForCurrentProject();
                return;
            }
            
            updateHistoryStats(`æ­£åœ¨æœç´¢: ${query}...`);
            
            try {
                // å°è¯•ä½¿ç”¨åç«¯æœç´¢
                const results = await historyService.searchChats(query);
                
                // æ ¹æ®å½“å‰æ¨¡å¼è¿‡æ»¤æœç´¢ç»“æœ
                let filteredResults = results;
                if (!showAllProjects && currentGitPath) {
                    filteredResults = results.filter(chat => 
                        chat.project && chat.project.path && 
                        chat.project.path.includes(currentGitPath)
                    );
                }
                
                currentChats = filteredResults;
                allCurrentChats = filteredResults; // å­˜å‚¨æœç´¢ç»“æœç”¨äºè™šæ‹Ÿæ»šåŠ¨
                displayHistoryChats(filteredResults);
                updateHistoryStats(`æœç´¢å®Œæˆ: ${filteredResults.length} æ¡ç»“æœ`);
            } catch (error) {
                console.warn('åç«¯æœç´¢å¤±è´¥ï¼Œä½¿ç”¨å‰ç«¯æœç´¢:', error);
                
                // åç«¯æœç´¢å¤±è´¥æ—¶ï¼Œä½¿ç”¨å‰ç«¯æœç´¢
                frontendSearch(query);
            }
        }
        
        function frontendSearch(query) {
            if (!allCurrentChats || allCurrentChats.length === 0) {
                updateHistoryStats('æ²¡æœ‰å¯æœç´¢çš„èŠå¤©è®°å½•');
                return;
            }
            
            const searchTerm = query.toLowerCase();
            const results = allCurrentChats.filter(chat => {
                // æœç´¢æ ‡é¢˜
                if (chat.title && chat.title.toLowerCase().includes(searchTerm)) {
                    return true;
                }
                
                // æœç´¢é¢„è§ˆ
                if (chat.preview && chat.preview.toLowerCase().includes(searchTerm)) {
                    return true;
                }
                
                // æœç´¢é¡¹ç›®åç§°
                if (chat.project && chat.project.name && 
                    chat.project.name.toLowerCase().includes(searchTerm)) {
                    return true;
                }
                
                return false;
            });
            
            currentChats = results;
            displayHistoryChats(results);
            updateHistoryStats(`å‰ç«¯æœç´¢å®Œæˆ: ${results.length} æ¡ç»“æœ`);
        }

        async function refreshChats() {
            await historyService.clearCache();
            await loadHistoryChats();
        }

        async function clearCache() {
            await historyService.clearCache();
            updateHistoryStats('ç¼“å­˜å·²æ¸…é™¤');
            await loadHistoryChats();
        }

        function updateHistoryStats(message) {
            document.getElementById('history-stats').textContent = message;
        }

        function groupChatsByWorkspace(chats) {
            const groups = {};
            
            console.log('ğŸ” groupChatsByWorkspace: å¼€å§‹å¤„ç†èŠå¤©è®°å½•', chats.length, 'æ¡');
            
            chats.forEach((chat, index) => {
                // ç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„å·¥ä½œåŒºåŒ¹é…ç»“æœ
                const project = chat.project || {};
                const projectName = project.name || 'Unknown Project';
                const projectPath = project.path || project.rootPath || '';
                const workspaceId = project.workspace_id || chat.workspaceId || 'global';
                
                // è°ƒè¯•ä¿¡æ¯
                if (index < 3) {
                    console.log(`ğŸ“‹ èŠå¤©è®°å½• ${index + 1}:`, {
                        project: chat.project,
                        projectName,
                        projectPath,
                        workspaceId,
                        chatWorkspaceId: chat.workspaceId
                    });
                }
                
                // ä½¿ç”¨å·¥ä½œåŒºIDä½œä¸ºå”¯ä¸€é”®ï¼Œç¡®ä¿æ­£ç¡®åˆ†ç»„
                const key = `${workspaceId}|${projectName}`;
                
                if (!groups[key]) {
                    groups[key] = {
                        name: projectName,
                        path: projectPath,
                        chats: [],
                        workspaceId: workspaceId
                    };
                }
                groups[key].chats.push(chat);
            });
            
            console.log('ğŸ“Š åˆ†ç»„ç»“æœ:', Object.keys(groups).map(key => ({
                key,
                name: groups[key].name,
                chatCount: groups[key].chats.length
            })));
            
            return groups;
        }

        function groupChatsByProject(chats) {
            const groups = {};
            
            chats.forEach(chat => {
                // ä½¿ç”¨cursor-view-mainçš„å®é™…é¡¹ç›®æ£€æµ‹é€»è¾‘
                const projectPath = chat.project?.path || chat.project?.rootPath || '';
                let projectName = 'Unknown Project';
                
                if (projectPath) {
                    // åŸºäºcursor-view-mainçš„é¡¹ç›®åç§°æå–é€»è¾‘
                    projectName = extractProjectNameFromPath(projectPath);
                } else if (chat.workspaceId) {
                    // ä½¿ç”¨workspace IDä½œä¸ºé¡¹ç›®æ ‡è¯†
                    projectName = `Workspace ${chat.workspaceId.substring(0, 8)}`;
                } else if (chat.project?.name) {
                    // ä½¿ç”¨é¡¹ç›®åç§°
                    projectName = chat.project.name;
                }
                
                const normalizedPath = normalizeProjectPath(projectPath);
                const key = `${projectName}|${normalizedPath}`;
                
                if (!groups[key]) {
                    groups[key] = {
                        name: projectName,
                        path: normalizedPath,
                        chats: [],
                        workspaceId: chat.workspaceId
                    };
                }
                groups[key].chats.push(chat);
            });
            
            return groups;
        }

        function extractProjectNameFromPath(path) {
            if (!path) return 'Unknown Project';
            
            // åŸºäºcursor-view-mainçš„å®é™…å®ç°
            const knownProjects = ['genaisf', 'cursor-view', 'cursor', 'cursor-apps', 'Cursor-Web', 'claude-api'];
            
            // å¤„ç†file:///åè®®
            let cleanPath = path;
            if (path.startsWith('file:///')) {
                cleanPath = path.substring(7); // ç§»é™¤file://
            }
            
            // æ ‡å‡†åŒ–è·¯å¾„åˆ†éš”ç¬¦
            cleanPath = cleanPath.replace(/\\/g, '/');
            const parts = cleanPath.split('/').filter(p => p && p.length > 0);
            
            if (parts.length === 0) return 'Root Directory';
            
            // æŸ¥æ‰¾å·²çŸ¥é¡¹ç›®åç§°
            for (const known of knownProjects) {
                if (parts.some(part => part.toLowerCase() === known.toLowerCase())) {
                    return known;
                }
            }
            
            // å¤„ç†ç‰¹æ®Šç›®å½•ç»“æ„
            if (parts.includes('Documents') && parts.includes('codebase')) {
                const idx = parts.indexOf('codebase');
                if (idx + 1 < parts.length) {
                    return parts[idx + 1];
                }
            }
            
            if (parts.includes('Repos')) {
                const idx = parts.indexOf('Repos');
                if (idx + 1 < parts.length) {
                    return parts[idx + 1];
                }
            }
            
            // è·³è¿‡å®¹å™¨ç›®å½•
            const skipDirs = ['Users', 'Documents', 'Code', 'Projects', 'workspace', 'Desktop', 'home', 'opt', 'var', 'usr', 'root'];
            let meaningfulParts = parts.filter(part => !skipDirs.includes(part));
            
            if (meaningfulParts.length > 0) {
                return meaningfulParts[meaningfulParts.length - 1];
            }
            
            // ä½¿ç”¨æœ€åä¸€ä¸ªæœ‰æ„ä¹‰çš„éƒ¨åˆ†
            for (let i = parts.length - 1; i >= 0; i--) {
                if (parts[i] && !parts[i].startsWith('.')) {
                    return parts[i];
                }
            }
            
            return parts[parts.length - 1] || 'Unknown Project';
        }

        function normalizeProjectPath(path) {
            if (!path) return '';
            
            // æ ‡å‡†åŒ–è·¯å¾„å¹¶å¤„ç†file:///åè®®
            let normalized = path;
            if (path.startsWith('file:///')) {
                normalized = path.substring(7);
            }
            
            // æ ‡å‡†åŒ–è·¯å¾„åˆ†éš”ç¬¦
            normalized = normalized.replace(/\\/g, '/');
            
            // ç§»é™¤æœ«å°¾çš„æ–œæ 
            normalized = normalized.replace(/\/$/, '');
            
            // å¦‚æœè·¯å¾„åŒ…å«æ–‡ä»¶åï¼Œç§»é™¤æ–‡ä»¶å
            const lastSlash = normalized.lastIndexOf('/');
            if (lastSlash > 0) {
                const lastPart = normalized.substring(lastSlash + 1);
                // å¦‚æœæœ€åä¸€éƒ¨åˆ†åŒ…å«ç‚¹å·ï¼Œå¯èƒ½æ˜¯æ–‡ä»¶å
                if (lastPart.includes('.') && !lastPart.startsWith('.')) {
                    normalized = normalized.substring(0, lastSlash);
                }
            }
            
            return normalized;
        }

        function displayProjectFolders(projects) {
            const container = document.getElementById('project-folders');
            
            if (Object.keys(projects).length === 0) {
                container.innerHTML = '<div class="error" style="padding: 20px; text-align: center; color: #cccccc;">æ²¡æœ‰æ‰¾åˆ°é¡¹ç›®</div>';
                return;
            }

            // åˆ›å»ºæ–‡ä»¶å¤¹æ ‘ç»“æ„
            const folderTree = buildFolderTree(projects);
            
            let html = '';
            
            // æ·»åŠ å½“å‰Gitç›®å½•æŒ‡ç¤ºå™¨
            if (currentGitPath && !showAllProjects) {
                html += `
                    <div class="current-git-indicator" style="padding: 8px 12px; background: #1a3a1a; border-left: 3px solid #22c55e; font-size: 12px; color: #22c55e; margin-bottom: 10px;">
                        ğŸ“ å½“å‰ç›®å½•ï¼š${currentGitPath}
                    </div>
                `;
            }

            // æ¸²æŸ“æ–‡ä»¶å¤¹æ ‘
            html += renderFolderTree(folderTree, projects);

            container.innerHTML = html;
            
            console.log('ğŸ“ é¡¹ç›®æ–‡ä»¶å¤¹æ˜¾ç¤ºå®Œæˆ:', Object.keys(projects).length, 'ä¸ªé¡¹ç›®');
        }

        function filterProjects(projects, filterText) {
            if (!filterText || filterText.trim() === '') {
                return projects;
            }

            const filtered = {};
            const filterLower = filterText.toLowerCase();

            Object.entries(projects).forEach(([key, project]) => {
                const projectName = (project.name || '').toLowerCase();
                const projectPath = (project.path || '').toLowerCase();
                
                // æ£€æŸ¥é¡¹ç›®åç§°æˆ–è·¯å¾„æ˜¯å¦åŒ…å«ç­›é€‰æ–‡æœ¬
                if (projectName.includes(filterLower) || projectPath.includes(filterLower)) {
                    filtered[key] = project;
                }
            });

            console.log(`ğŸ” ç­›é€‰ç»“æœ: ${Object.keys(filtered).length}/${Object.keys(projects).length} ä¸ªé¡¹ç›®åŒ¹é… "${filterText}"`);
            return filtered;
        }

        function buildFolderTree(projects) {
            const tree = {};
            const performanceStart = performance.now();
            
            Object.entries(projects).forEach(([projectKey, project]) => {
                const path = project.path || '';
                const pathParts = path.split('/').filter(part => part && part.length > 0);
                
                let currentLevel = tree;
                pathParts.forEach(part => {
                    if (!currentLevel[part]) {
                        currentLevel[part] = {
                            type: 'folder',
                            children: {},
                            chatCount: 0 // é¢„è®¡ç®—èŠå¤©æ•°é‡
                        };
                    }
                    currentLevel = currentLevel[part].children;
                });
                
                // æ·»åŠ é¡¹ç›®åˆ°æœ€ç»ˆä½ç½®ï¼Œä½¿ç”¨é¡¹ç›®åç§°ä½œä¸ºæ˜¾ç¤ºå
                const displayName = project.name || 'Unknown Project';
                currentLevel[displayName] = {
                    type: 'project',
                    project: project,
                    projectName: displayName,
                    projectKey: projectKey,
                    path: path
                };
            });
            
            // é¢„è®¡ç®—æ–‡ä»¶å¤¹çš„èŠå¤©æ•°é‡
            calculateFolderChatCounts(tree);
            
            const performanceEnd = performance.now();
            console.log(`ğŸš€ æ„å»ºæ–‡ä»¶å¤¹æ ‘è€—æ—¶: ${(performanceEnd - performanceStart).toFixed(2)}ms, å¤„ç†äº† ${Object.keys(projects).length} ä¸ªé¡¹ç›®`);
            
            return tree;
        }

        function calculateFolderChatCounts(tree) {
            Object.values(tree).forEach(node => {
                if (node.type === 'folder') {
                    // é€’å½’è®¡ç®—å­æ–‡ä»¶å¤¹çš„èŠå¤©æ•°é‡
                    if (node.children) {
                        calculateFolderChatCounts(node.children);
                        node.chatCount = Object.values(node.children).reduce((sum, child) => {
                            return sum + (child.type === 'project' ? child.project.chats.length : (child.chatCount || 0));
                        }, 0);
                    }
                }
            });
        }

        function renderFolderTree(tree, projects, level = 0, parentPath = '') {
            let html = '';
            const sortedKeys = Object.keys(tree).sort();
            
            sortedKeys.forEach(key => {
                const node = tree[key];
                const fullPath = parentPath ? `${parentPath}/${key}` : key;
                
                if (node.type === 'folder') {
                    const isActive = !showAllProjects && currentGitPath && fullPath.includes(currentGitPath);
                    const isExpanded = isActive || level < 2; // é»˜è®¤å±•å¼€å‰ä¸¤çº§
                    
                    html += `
                        <div class="folder-node" style="margin-left: ${level * 15}px;">
                            <div class="folder-header" style="padding: 8px 12px; border-bottom: 1px solid #404040; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: space-between; ${isActive ? 'background: #1a2a3a; border-left: 3px solid #3b82f6;' : ''}" 
                                 onclick="toggleFolder('${fullPath.replace(/'/g, "\\'")}')">
                                <div style="display: flex; align-items: center; flex: 1;">
                                    <span style="margin-right: 8px; color: #ffa000;">${isExpanded ? 'ğŸ“‚' : 'ğŸ“'}</span>
                                    <span style="font-weight: 500; color: #ffffff; font-size: 14px;">${key}</span>
                                </div>
                                <span style="color: #888888; font-size: 12px;">${countItemsInFolder(node)}</span>
                            </div>
                            <div class="folder-children" id="folder-${fullPath.replace(/\//g, '-')}" style="${isExpanded ? '' : 'display: none;'}">
                                ${renderFolderTree(node.children, projects, level + 1, fullPath)}
                            </div>
                        </div>
                    `;
                } else if (node.type === 'project') {
                    const isActive = !showAllProjects && currentGitPath && node.project.path.includes(currentGitPath);
                    
                    html += `
                        <div class="project-folder" style="margin-left: ${level * 15}px; padding: 8px 12px; border-bottom: 1px solid #404040; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: space-between; ${isActive ? 'background: #1a2a3a; border-left: 3px solid #3b82f6;' : ''}" 
                             onclick="selectProject('${node.projectName.replace(/'/g, "\\'")}')" 
                             data-project="${node.projectName}">
                            <div style="display: flex; flex-direction: column; flex: 1;">
                                <div style="display: flex; align-items: center;">
                                    <span style="margin-right: 8px; color: #00bbff;">ğŸ’¬</span>
                                    <span style="font-weight: 500; color: #ffffff; font-size: 14px;">${node.projectName}</span>
                                </div>
                                <div style="margin-left: 24px; font-size: 12px; color: #888888; margin-top: 2px;" title="${node.project.path || ''}">
                                    ğŸ“ ${node.project.path || 'Unknown Path'}
                                </div>
                            </div>
                            <span style="background: #3b82f6; color: white; padding: 2px 6px; border-radius: 10px; font-size: 12px; min-width: 20px; text-align: center;">${node.project.chats.length}</span>
                        </div>
                    `;
                }
            });
            
            return html;
        }

        function countItemsInFolder(folderNode) {
            // ä½¿ç”¨é¢„è®¡ç®—çš„èŠå¤©æ•°é‡
            return folderNode.chatCount || 0;
        }

        function toggleFolder(folderPath) {
            const folderId = `folder-${folderPath.replace(/\//g, '-')}`;
            const folderElement = document.getElementById(folderId);
            const folderHeader = folderElement.previousElementSibling;
            const icon = folderHeader.querySelector('span');
            
            if (folderElement.style.display === 'none') {
                folderElement.style.display = 'block';
                icon.textContent = 'ğŸ“‚';
            } else {
                folderElement.style.display = 'none';
                icon.textContent = 'ğŸ“';
            }
        }

        function selectProject(projectName) {
            // è·å–é€‰ä¸­çš„é¡¹ç›®èŠå¤©è®°å½•
            const project = allProjects[projectName];
            if (project) {
                currentChats = project.chats;
                displayHistoryChats(currentChats);
                updateHistoryStats(`${projectName} - ${project.chats.length} æ¡èŠå¤©è®°å½•`);
            }
        }

        function toggleAllProjects() {
            showAllProjects = !showAllProjects;
            const button = document.getElementById('toggle-all-projects');
            
            if (showAllProjects) {
                button.innerHTML = 'ğŸ“‚ å½“å‰ç›®å½•';
                button.title = 'åªæ˜¾ç¤ºå½“å‰Gitç›®å½•çš„èŠå¤©è®°å½•';
            } else {
                button.innerHTML = 'ğŸ“ å…¨éƒ¨é¡¹ç›®';
                button.title = 'æ˜¾ç¤ºæ‰€æœ‰é¡¹ç›®çš„èŠå¤©è®°å½•';
            }
            
            loadChatsForCurrentProject();
            filterFolders(); // é‡æ–°åº”ç”¨æ–‡ä»¶å¤¹ç­›é€‰
        }

        // åˆå§‹åŒ–å†å²è®°å½•ï¼ˆå½“åˆ‡æ¢åˆ°å†å²è®°å½•æ ‡ç­¾æ—¶æˆ–é¡µé¢åŠ è½½æ—¶ï¼‰
        document.addEventListener('DOMContentLoaded', () => {
            // ç›‘å¬æ ‡ç­¾åˆ‡æ¢äº‹ä»¶
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // å¦‚æœåˆ‡æ¢åˆ°å†å²è®°å½•æ ‡ç­¾ï¼ŒåŠ è½½æ•°æ®
                    if (this.dataset.tab === 'history-tab') {
                        // å»¶è¿ŸåŠ è½½ï¼Œç¡®ä¿æ ‡ç­¾å·²åˆ‡æ¢
                        setTimeout(() => {
                            loadHistoryChats();
                        }, 100);
                    }
                });
            });
            
            // æ£€æŸ¥é¡µé¢åŠ è½½æ—¶æ˜¯å¦å·²ç»åœ¨å†å²è®°å½•æ ‡ç­¾
            const activeTab = document.querySelector('.tab-btn.active');
            if (activeTab && activeTab.dataset.tab === 'history-tab') {
                console.log('å†å²è®°å½•æ ‡ç­¾å·²æ¿€æ´»ï¼Œæ­£åœ¨åŠ è½½å†å²è®°å½•...');
                setTimeout(() => {
                    loadHistoryChats();
                }, 100);
            }

            // å†å²è®°å½•ç›¸å…³äº‹ä»¶ç»‘å®šå·²ç§»è‡³HistoryManagerä¸­
            // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆå§‹åŒ–å·¥ä½œåŒºå†å²è®°å½•
            if (activeTab && activeTab.dataset.tab === 'history-tab') {
                console.log('å†å²è®°å½•æ ‡ç­¾å·²æ¿€æ´»ï¼Œæ­£åœ¨åˆå§‹åŒ–å·¥ä½œåŒºå†å²è®°å½•...');
                setTimeout(() => {
                    initWorkspaceHistory();
                }, 100);
            }
        });

        function filterFolders() {
            const folderFilter = document.getElementById('folder-search').value;
            const filteredProjects = filterProjects(allProjects, folderFilter);
            displayProjectFolders(filteredProjects);
            
            const totalCount = Object.values(allProjects).reduce((sum, project) => sum + project.chats.length, 0);
            const filteredCount = Object.values(filteredProjects).reduce((sum, project) => sum + project.chats.length, 0);
            
            if (folderFilter) {
                updateHistoryStats(`æ˜¾ç¤º ${filteredCount} / ${totalCount} æ¡èŠå¤©è®°å½• (ç­›é€‰: ${folderFilter})`);
            } else {
                updateHistoryStats(`æ˜¾ç¤º ${filteredCount} / ${totalCount} æ¡èŠå¤©è®°å½•`);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåç«‹å³åŠ è½½å†å²è®°å½•
        setTimeout(() => {
            if (document.querySelector('.tab-btn[data-tab="history-tab"]').classList.contains('active')) {
                console.log('ğŸš€ å†å²è®°å½•æ ‡ç­¾å·²æ¿€æ´»ï¼Œå¼€å§‹åŠ è½½å†å²è®°å½•');
                loadHistoryChats();
            }
        }, 500);
    </script>
    <script>
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
     window.addEventListener('load', function() {
         console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆ');
     });
    
    // Tab åˆ‡æ¢é€»è¾‘
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            this.classList.add('active');
            document.getElementById(this.dataset.tab).classList.add('active');

            // å¦‚æœåˆ‡æ¢åˆ°è¯Šæ–­tabï¼Œæ›´æ–°å¿«é€ŸçŠ¶æ€
            if (this.dataset.tab === 'diagnostic-tab') {
                updateQuickStatus();
            }
            
            // å¦‚æœåˆ‡æ¢åˆ°å†å²è®°å½•tabï¼ŒåŠ è½½å†å²è®°å½•
            if (this.dataset.tab === 'history-tab') {
                console.log('ğŸ”„ åˆ‡æ¢åˆ°å†å²è®°å½•æ ‡ç­¾ï¼Œå¼€å§‹åŠ è½½å†å²è®°å½•');
                setTimeout(() => {
                    loadHistoryChats();
                }, 100);
            }
        });
    });

        // æ›´æ–°å¿«é€ŸçŠ¶æ€æ£€æŸ¥
    function updateQuickStatus() {
        // WebSocketçŠ¶æ€ - ä½¿ç”¨æ›´å‡†ç¡®çš„æ£€æµ‹æ–¹æ³•
        const wsStatus = document.getElementById('ws-status');
        let wsConnected = false;

        // æ–¹æ³•1: æ£€æŸ¥simpleClientçš„WebSocketçŠ¶æ€ï¼ˆä¸è¯Šæ–­é¡µé¢ä¿æŒä¸€è‡´ï¼‰
        if (window.simpleClient && typeof window.simpleClient.isConnected === 'function') {
            wsConnected = window.simpleClient.isConnected();
        }
        // æ–¹æ³•2: æ£€æŸ¥simpleClientçš„wsManagerçŠ¶æ€
        else if (window.simpleClient && window.simpleClient.wsManager && typeof window.simpleClient.wsManager.isConnected === 'function') {
            wsConnected = window.simpleClient.wsManager.isConnected();
        }
        // æ–¹æ³•3: æ£€æŸ¥é¡µé¢çŠ¶æ€å…ƒç´ 
        else if (document.querySelector('.status.connected')) {
            wsConnected = true;
        }
        // æ–¹æ³•4: æ£€æŸ¥WebSocketManageræ¨¡å—
        else if (window.WebSocketManager && typeof window.WebSocketManager.isConnected === 'function') {
            wsConnected = window.WebSocketManager.isConnected();
        }

        if (wsConnected) {
            wsStatus.textContent = 'å·²è¿æ¥';
            wsStatus.className = 'status-value connected';
        } else {
            wsStatus.textContent = 'æœªè¿æ¥';
            wsStatus.className = 'status-value disconnected';
        }

        // è°ƒè¯•ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
        if (window.simpleClient) {
            console.log('é¦–é¡µWebSocketçŠ¶æ€æ£€æµ‹:', {
                simpleClientExists: !!window.simpleClient,
                isConnectedMethod: typeof window.simpleClient.isConnected,
                wsManagerExists: !!window.simpleClient.wsManager,
                wsManagerIsConnectedMethod: window.simpleClient.wsManager ? typeof window.simpleClient.wsManager.isConnected : 'N/A',
                finalResult: wsConnected
            });
        }

        // æ¨¡å—åŠ è½½çŠ¶æ€
        const moduleStatus = document.getElementById('module-status');
        if (window.ModuleLoader) {
            moduleStatus.textContent = 'å·²åŠ è½½';
            moduleStatus.className = 'status-value success';
        } else {
            moduleStatus.textContent = 'æœªåŠ è½½';
            moduleStatus.className = 'status-value error';
        }

        // CursorçŠ¶æ€
        const cursorStatus = document.getElementById('cursor-status');
        if (window.simpleClient && window.simpleClient.cursorStatusManager) {
            try {
                const status = window.simpleClient.cursorStatusManager.getCursorStatus();
                switch (status.status) {
                    case 'active':
                        cursorStatus.textContent = 'æ´»è·ƒ';
                        cursorStatus.className = 'status-value success';
                        break;
                    case 'waiting':
                        cursorStatus.textContent = 'ç­‰å¾…';
                        cursorStatus.className = 'status-value warning';
                        break;
                    case 'inactive':
                        cursorStatus.textContent = 'ä¸æ´»è·ƒ';
                        cursorStatus.className = 'status-value warning';
                        break;
                    case 'closed':
                        cursorStatus.textContent = 'å·²å…³é—­';
                        cursorStatus.className = 'status-value error';
                        break;
                    default:
                        cursorStatus.textContent = 'æœªçŸ¥';
                        cursorStatus.className = 'status-value error';
                }
            } catch (error) {
                cursorStatus.textContent = 'æ£€æŸ¥å¤±è´¥';
                cursorStatus.className = 'status-value error';
            }
        } else {
            cursorStatus.textContent = 'æœªåˆå§‹åŒ–';
            cursorStatus.className = 'status-value error';
        }

        // å®¢æˆ·ç«¯çŠ¶æ€
        const clientStatus = document.getElementById('client-status');
        if (window.simpleClient) {
            clientStatus.textContent = 'å·²åˆå§‹åŒ–';
            clientStatus.className = 'status-value success';
        } else {
            clientStatus.textContent = 'æœªåˆå§‹åŒ–';
            clientStatus.className = 'status-value error';
        }
    }

    // å¼ºåˆ¶åˆå§‹åŒ–å’ŒåŠ è½½å‡½æ•°
    window.forceInitAndLoad = function() {
        console.log('ğŸ”§ å¼ºåˆ¶åˆå§‹åŒ–å’ŒåŠ è½½...');
        const chatList = document.getElementById('chat-list-container');
        
        try {
            // é‡ç½®çŠ¶æ€
            window.historyManager = null;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            if (chatList) {
                chatList.innerHTML = '<div style="color: yellow; padding: 10px;">ğŸ”„ å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–ä¸­...</div>';
            }
            
            // ä½¿ç”¨æ¨¡å—ç³»ç»Ÿåˆå§‹åŒ–
            if (window.ModuleLoader) {
                ModuleLoader.loadModule('HistoryManager').then(async () => {
                    if (window.HistoryManager) {
                        const historyContainer = document.querySelector('#history-tab');
                         window.historyManager = new window.HistoryManager(historyContainer);
                        await window.historyManager.init();
                        console.log('âœ… å¼ºåˆ¶åˆå§‹åŒ–å®Œæˆ');
                        
                        // ç­‰å¾…ä¸€ç§’åæ£€æŸ¥ç»“æœ
                        setTimeout(() => {
                            if (window.historyManager && window.historyManager.chats) {
                                console.log('ğŸ“Š åŠ è½½çš„èŠå¤©æ•°é‡:', window.historyManager.chats.length);
                                if (chatList) {
                                    console.log('ğŸ“‹ å½“å‰chat-listå†…å®¹é•¿åº¦:', chatList.innerHTML.length);
                                }
                            } else {
                                console.error('âŒ historyManageræˆ–chatsä¸ºç©º');
                                if (chatList) {
                                    chatList.innerHTML = '<div style="color: red; padding: 10px;">âŒ åˆå§‹åŒ–å¤±è´¥ï¼ŒhistoryManagerä¸ºç©º</div>';
                                }
                            }
                        }, 1000);
                    } else {
                        console.error('âŒ HistoryManageræ¨¡å—åŠ è½½å¤±è´¥');
                        if (chatList) {
                            chatList.innerHTML = '<div style="color: red; padding: 10px;">âŒ HistoryManageræ¨¡å—åŠ è½½å¤±è´¥</div>';
                        }
                    }
                }).catch(error => {
                    console.error('âŒ æ¨¡å—åŠ è½½å¤±è´¥:', error);
                    if (chatList) {
                        chatList.innerHTML = `<div style="color: red; padding: 10px;">âŒ æ¨¡å—åŠ è½½å¤±è´¥: ${error.message}</div>`;
                    }
                });
            } else {
                console.error('âŒ ModuleLoaderæœªæ‰¾åˆ°');
                if (chatList) {
                    chatList.innerHTML = '<div style="color: red; padding: 10px;">âŒ ModuleLoaderæœªæ‰¾åˆ°</div>';
                }
            }
        } catch (error) {
            console.error('âŒ å¼ºåˆ¶åˆå§‹åŒ–å¤±è´¥:', error);
            if (chatList) {
                chatList.innerHTML = `<div style="color: red; padding: 10px;">âŒ å¼ºåˆ¶åˆå§‹åŒ–å¤±è´¥: ${error.message}</div>`;
            }
        }
    };
    

    
    // å¼ºåˆ¶åˆå§‹åŒ–å‡½æ•°ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
    async function forceInit() {
        console.log('ğŸ”§ å¼ºåˆ¶åˆå§‹åŒ–å·¥ä½œåŒºå†å²è®°å½•ç®¡ç†å™¨');
        try {
            await initWorkspaceHistory();
            console.log('âœ… å¼ºåˆ¶åˆå§‹åŒ–æˆåŠŸ');
        } catch (error) {
            console.error('âŒ å¼ºåˆ¶åˆå§‹åŒ–å¤±è´¥:', error);
        }
    }
    
    // å¦‚æœå½“å‰åœ¨è¯Šæ–­tabï¼Œæ›´æ–°çŠ¶æ€
        if (document.querySelector('.tab-btn[data-tab="diagnostic-tab"]').classList.contains('active')) {
            updateQuickStatus();
        }

        // å®šæœŸæ›´æ–°çŠ¶æ€ï¼ˆæ¯5ç§’ï¼‰
        setInterval(function() {
            if (document.querySelector('.tab-btn[data-tab="diagnostic-tab"]').classList.contains('active')) {
                updateQuickStatus();
            }
        }, 5000);
    

    </script>
    <script src="js/modules/HistoryManager.js"></script>
</body>
</html>
