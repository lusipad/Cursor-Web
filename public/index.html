<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Web - Cursor èŠå¤©åŒæ­¥</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Claude Web</h1>
            <div id="status" class="status disconnected">ç­‰å¾…è¿æ¥...</div>
        </header>

        <!-- Tab å¯¼èˆª -->
        <nav class="tab-nav">
            <button class="tab-btn" data-tab="chat-tab">èŠå¤©</button>
                <button class="tab-btn active" data-tab="history-tab">å†å²è®°å½•</button>
            <button class="tab-btn" data-tab="git-tab">Git ç®¡ç†</button>
            <button class="tab-btn" data-tab="diagnostic-tab">ç³»ç»Ÿè¯Šæ–­</button>
        </nav>

        <main class="main">
            <!-- èŠå¤© Tab å†…å®¹ -->
            <section id="chat-tab" class="tab-content">
                <div id="messages-container" class="messages-container">
                    <div class="welcome-message">
                        <h2>æ¬¢è¿ä½¿ç”¨ Claude Web</h2>
                        <p>çŠ¶æ€è¯´æ˜ï¼š</p>
                        <p>ğŸŸ¡ <strong>å·²è¿æ¥ - ç­‰å¾… Cursor å†…å®¹</strong>ï¼šéœ€è¦åœ¨ Cursor ä¸­è¿è¡Œæ³¨å…¥è„šæœ¬</p>
                        <p>ğŸŸ¢ <strong>å·²è¿æ¥ - åŒæ­¥æ­£å¸¸</strong>ï¼šå†…å®¹åŒæ­¥å·¥ä½œæ­£å¸¸</p>
                        <br>
                        <p class="instruction">ä½¿ç”¨æ–¹æ³•ï¼šåœ¨ Cursor å¼€å‘è€…å·¥å…·ä¸­è¿è¡ŒåŒæ­¥è„šæœ¬</p>
                        <a href="/script.html" class="btn btn-primary" style="display:inline-block;margin:10px 0;">å‰å¾€ä¸€é”®å¤åˆ¶åŒæ­¥è„šæœ¬ &gt;&gt;</a>
                        <p class="instruction">è„šæœ¬ä¼šåŒæ­¥æ•´ä¸ª Cursor é¡µé¢å†…å®¹åˆ°æ­¤é¡µé¢</p>
                    </div>
                </div>
                <footer class="footer">
                    <form id="send-form" autocomplete="off">
                        <input id="send-input" type="text" placeholder="è¾“å…¥æ¶ˆæ¯..." autocomplete="off" />
                        <button id="send-btn" type="submit">å‘é€</button>
                        <button id="clear-btn" type="button">æ¸…é™¤</button>
                    </form>
                </footer>
            </section>

            <!-- å†å²è®°å½• Tab å†…å®¹ -->
            <section id="history-tab" class="tab-content active">
                <div class="history-panel">
                    <h2>Cursor èŠå¤©å†å²è®°å½•</h2>
                    <div class="history-controls">
                        <div class="search-section">
                            <div class="search-input">
                                <input type="text" id="history-search" placeholder="æœç´¢èŠå¤©å†…å®¹..." class="search-field">
                                <button id="search-btn" class="btn btn-primary">æœç´¢</button>
                                <button id="refresh-history" class="btn btn-secondary">åˆ·æ–°</button>
                                <button id="force-init-btn" class="btn btn-primary" onclick="forceInitAndLoad()">å¼ºåˆ¶åˆå§‹åŒ–</button>
                                <button id="debug-btn" class="btn btn-info" onclick="debugHistoryManager()">è°ƒè¯•çŠ¶æ€</button>
                            </div>
                        </div>
                    </div>
                    <div class="history-stats">
                        <div class="stats-row">
                            <span>æ€»èŠå¤©æ•°ï¼š</span>
                            <span id="total-chats" class="stat-value">åŠ è½½ä¸­...</span>
                        </div>
                        <div class="stats-row">
                            <span>çŠ¶æ€ï¼š</span>
                            <span id="history-status" class="stat-value">å‡†å¤‡å°±ç»ª</span>
                        </div>
                    </div>
                    <div class="history-list">
                        <div id="chat-list" class="chat-list">
                            <div class="loading-message">æ­£åœ¨åŠ è½½èŠå¤©å†å²...</div>
                        </div>
                    </div>
                    <div class="chat-detail" id="chat-detail" style="display: none;">
                        <div class="detail-header">
                            <h3 id="detail-title">èŠå¤©è¯¦æƒ…</h3>
                            <div class="detail-actions">
                                <button id="export-html" class="btn btn-secondary">å¯¼å‡ºHTML</button>
                                <button id="export-json" class="btn btn-secondary">å¯¼å‡ºJSON</button>
                                <button id="close-detail" class="btn btn-info">å…³é—­</button>
                            </div>
                        </div>
                        <div class="detail-info">
                            <div class="info-row">
                                <span>ä¼šè¯IDï¼š</span>
                                <span id="detail-session-id"></span>
                            </div>
                            <div class="info-row">
                                <span>å·¥ä½œåŒºï¼š</span>
                                <span id="detail-workspace"></span>
                            </div>
                            <div class="info-row">
                                <span>åˆ›å»ºæ—¶é—´ï¼š</span>
                                <span id="detail-created-at"></span>
                            </div>
                            <div class="info-row">
                                <span>æ¶ˆæ¯æ•°é‡ï¼š</span>
                                <span id="detail-message-count"></span>
                            </div>
                        </div>
                        <div class="detail-messages" id="detail-messages">
                            <!-- èŠå¤©æ¶ˆæ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Git ç®¡ç† Tab å†…å®¹ -->
            <section id="git-tab" class="tab-content">
                <div class="git-panel">
                    <h2>Git åˆ†æ”¯ç®¡ç†</h2>
                    <div class="git-controls">
                        <div class="git-status">
                            <div class="status-row">
                                <span>å½“å‰åˆ†æ”¯ï¼š</span>
                                <span id="current-branch" class="current-branch">åŠ è½½ä¸­...</span>
                            </div>
                            <div class="status-row">
                                <span>Git è·¯å¾„ï¼š</span>
                                <span id="git-path" class="git-path" title="">åŠ è½½ä¸­...</span>
                            </div>
                        </div>
                        <div class="git-actions">
                            <button id="refresh-branches" class="btn btn-secondary">åˆ·æ–°è¿œç¨‹åˆ†æ”¯</button>
                            <button id="pull-code" class="btn btn-primary">æ›´æ–°ä»£ç </button>
                            <button id="git-status" class="btn btn-info">æŸ¥çœ‹çŠ¶æ€</button>
                        </div>
                    </div>
                    <div class="branch-section">
                        <h3>åˆ†æ”¯åˆ‡æ¢</h3>
                        <div class="branch-selector">
                            <select id="branch-select" class="branch-select">
                                <option value="">é€‰æ‹©åˆ†æ”¯...</option>
                            </select>
                            <button id="checkout-branch" class="btn btn-success">åˆ‡æ¢åˆ†æ”¯</button>
                        </div>
                    </div>
                    <div class="commit-section">
                        <h3>ä»£ç æäº¤</h3>
                        <div class="commit-controls">
                            <div class="commit-input">
                                <input type="text" id="commit-message" placeholder="è¾“å…¥æäº¤ä¿¡æ¯..." class="commit-input-field">
                                <button id="add-files" class="btn btn-secondary">æ·»åŠ æ–‡ä»¶</button>
                                <button id="commit-code" class="btn btn-primary">æäº¤ä»£ç </button>
                                <button id="push-code" class="btn btn-success">æ¨é€ä»£ç </button>
                            </div>
                        </div>
                    </div>
                    <div id="git-output" class="git-output">
                        <div class="output-header">
                            <span>Git æ“ä½œè¾“å‡º</span>
                            <button id="clear-output" class="btn btn-small">æ¸…é™¤</button>
                        </div>
                        <div id="git-log" class="git-log"></div>
                    </div>
                </div>
            </section>

            <!-- ç³»ç»Ÿè¯Šæ–­ Tab å†…å®¹ -->
            <section id="diagnostic-tab" class="tab-content">
                <div class="diagnostic-panel">
                    <h2>ç³»ç»Ÿè¯Šæ–­</h2>
                    <p>æ£€æŸ¥ç³»ç»Ÿå„ä¸ªåŠŸèƒ½æ¨¡å—çš„çŠ¶æ€å’Œè¿æ¥æƒ…å†µ</p>
                    <div class="diagnostic-actions">
                        <a href="/diagnostic.html" class="btn btn-primary" target="_blank">
                            ğŸ” æ‰“å¼€å®Œæ•´è¯Šæ–­é¡µé¢
                        </a>
                        <p class="instruction">åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€å®Œæ•´çš„ç³»ç»Ÿè¯Šæ–­ç•Œé¢ï¼ŒåŒ…å«æ‰€æœ‰æµ‹è¯•åŠŸèƒ½</p>
                    </div>
                    <div class="quick-status">
                        <h3>å¿«é€ŸçŠ¶æ€æ£€æŸ¥</h3>
                        <div id="quick-status-grid" class="quick-status-grid">
                            <div class="status-item">
                                <span class="status-label">WebSocketè¿æ¥</span>
                                <span id="ws-status" class="status-value">æ£€æŸ¥ä¸­...</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">CursorçŠ¶æ€</span>
                                <span id="cursor-status" class="status-value">æ£€æŸ¥ä¸­...</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">æ¨¡å—åŠ è½½</span>
                                <span id="module-status" class="status-value">æ£€æŸ¥ä¸­...</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">å®¢æˆ·ç«¯çŠ¶æ€</span>
                                <span id="client-status" class="status-value">æ£€æŸ¥ä¸­...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script src="js/modules/module-loader.js"></script>
    <script src="js/history.js"></script>
    <script src="git-manager.js"></script>
    <script>
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
     window.addEventListener('load', function() {
         console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–å†å²è®°å½•ç®¡ç†å™¨');
         
         // ç«‹å³æ˜¾ç¤ºä¸€ä¸ªæµ‹è¯•æ¶ˆæ¯
         const chatList = document.getElementById('chat-list');
         if (chatList) {
             chatList.innerHTML = '<div style="color: yellow; padding: 10px;">ğŸ”„ JavaScriptæ­£åœ¨æ‰§è¡Œï¼Œå‡†å¤‡åŠ è½½èŠå¤©è®°å½•...</div>';
         }
         
         setTimeout(function() {
             if (typeof initHistoryManager === 'function') {
                 try {
                     initHistoryManager();
                     console.log('âœ… å†å²è®°å½•ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ');
                     
                     // ç­‰å¾…2ç§’åæ£€æŸ¥ç»“æœ
                     setTimeout(() => {
                         const chatListAfter = document.getElementById('chat-list');
                         if (chatListAfter) {
                             console.log('ğŸ“‹ 2ç§’åèŠå¤©åˆ—è¡¨å†…å®¹é•¿åº¦:', chatListAfter.innerHTML.length);
                             if (chatListAfter.innerHTML.length < 200) {
                                 chatListAfter.innerHTML = '<div style="color: red; padding: 10px;">âŒ èŠå¤©è®°å½•åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—</div>';
                             }
                         }
                     }, 2000);
                     
                 } catch (error) {
                     console.error('âŒ å†å²è®°å½•ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:', error);
                     if (chatList) {
                         chatList.innerHTML = `<div style="color: red; padding: 10px;">âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}</div>`;
                     }
                 }
             } else if (typeof HistoryManager !== 'undefined') {
                 try {
                     window.historyManager = new HistoryManager();
                     window.historyManager.init();
                     console.log('âœ… æ‰‹åŠ¨åˆå§‹åŒ–æˆåŠŸ');
                 } catch (error) {
                     console.error('âŒ æ‰‹åŠ¨åˆå§‹åŒ–å¤±è´¥:', error);
                     if (chatList) {
                         chatList.innerHTML = `<div style="color: red; padding: 10px;">âŒ æ‰‹åŠ¨åˆå§‹åŒ–å¤±è´¥: ${error.message}</div>`;
                     }
                 }
             } else {
                 console.error('âŒ HistoryManagerå’ŒinitHistoryManageréƒ½æœªæ‰¾åˆ°');
                 if (chatList) {
                     chatList.innerHTML = '<div style="color: red; padding: 10px;">âŒ HistoryManagerç±»æœªæ‰¾åˆ°</div>';
                 }
             }
         }, 500);
     });
    
    // Tab åˆ‡æ¢é€»è¾‘
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            this.classList.add('active');
            document.getElementById(this.dataset.tab).classList.add('active');

            // å¦‚æœåˆ‡æ¢åˆ°è¯Šæ–­tabï¼Œæ›´æ–°å¿«é€ŸçŠ¶æ€
            if (this.dataset.tab === 'diagnostic-tab') {
                updateQuickStatus();
            }
            
            // å¦‚æœåˆ‡æ¢åˆ°å†å²è®°å½•tabï¼Œåˆå§‹åŒ–å†å²è®°å½•ç®¡ç†å™¨
            if (this.dataset.tab === 'history-tab') {
                if (typeof initHistoryManager === 'function') {
                    initHistoryManager();
                }
            }
        });
    });

        // æ›´æ–°å¿«é€ŸçŠ¶æ€æ£€æŸ¥
    function updateQuickStatus() {
        // WebSocketçŠ¶æ€ - ä½¿ç”¨æ›´å‡†ç¡®çš„æ£€æµ‹æ–¹æ³•
        const wsStatus = document.getElementById('ws-status');
        let wsConnected = false;

        // æ–¹æ³•1: æ£€æŸ¥simpleClientçš„WebSocketçŠ¶æ€ï¼ˆä¸è¯Šæ–­é¡µé¢ä¿æŒä¸€è‡´ï¼‰
        if (window.simpleClient && typeof window.simpleClient.isConnected === 'function') {
            wsConnected = window.simpleClient.isConnected();
        }
        // æ–¹æ³•2: æ£€æŸ¥simpleClientçš„wsManagerçŠ¶æ€
        else if (window.simpleClient && window.simpleClient.wsManager && typeof window.simpleClient.wsManager.isConnected === 'function') {
            wsConnected = window.simpleClient.wsManager.isConnected();
        }
        // æ–¹æ³•3: æ£€æŸ¥é¡µé¢çŠ¶æ€å…ƒç´ 
        else if (document.querySelector('.status.connected')) {
            wsConnected = true;
        }
        // æ–¹æ³•4: æ£€æŸ¥WebSocketManageræ¨¡å—
        else if (window.WebSocketManager && typeof window.WebSocketManager.isConnected === 'function') {
            wsConnected = window.WebSocketManager.isConnected();
        }

        if (wsConnected) {
            wsStatus.textContent = 'å·²è¿æ¥';
            wsStatus.className = 'status-value connected';
        } else {
            wsStatus.textContent = 'æœªè¿æ¥';
            wsStatus.className = 'status-value disconnected';
        }

        // è°ƒè¯•ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
        if (window.simpleClient) {
            console.log('é¦–é¡µWebSocketçŠ¶æ€æ£€æµ‹:', {
                simpleClientExists: !!window.simpleClient,
                isConnectedMethod: typeof window.simpleClient.isConnected,
                wsManagerExists: !!window.simpleClient.wsManager,
                wsManagerIsConnectedMethod: window.simpleClient.wsManager ? typeof window.simpleClient.wsManager.isConnected : 'N/A',
                finalResult: wsConnected
            });
        }

        // æ¨¡å—åŠ è½½çŠ¶æ€
        const moduleStatus = document.getElementById('module-status');
        if (window.ModuleLoader) {
            moduleStatus.textContent = 'å·²åŠ è½½';
            moduleStatus.className = 'status-value success';
        } else {
            moduleStatus.textContent = 'æœªåŠ è½½';
            moduleStatus.className = 'status-value error';
        }

        // CursorçŠ¶æ€
        const cursorStatus = document.getElementById('cursor-status');
        if (window.simpleClient && window.simpleClient.cursorStatusManager) {
            try {
                const status = window.simpleClient.cursorStatusManager.getCursorStatus();
                switch (status.status) {
                    case 'active':
                        cursorStatus.textContent = 'æ´»è·ƒ';
                        cursorStatus.className = 'status-value success';
                        break;
                    case 'waiting':
                        cursorStatus.textContent = 'ç­‰å¾…';
                        cursorStatus.className = 'status-value warning';
                        break;
                    case 'inactive':
                        cursorStatus.textContent = 'ä¸æ´»è·ƒ';
                        cursorStatus.className = 'status-value warning';
                        break;
                    case 'closed':
                        cursorStatus.textContent = 'å·²å…³é—­';
                        cursorStatus.className = 'status-value error';
                        break;
                    default:
                        cursorStatus.textContent = 'æœªçŸ¥';
                        cursorStatus.className = 'status-value error';
                }
            } catch (error) {
                cursorStatus.textContent = 'æ£€æŸ¥å¤±è´¥';
                cursorStatus.className = 'status-value error';
            }
        } else {
            cursorStatus.textContent = 'æœªåˆå§‹åŒ–';
            cursorStatus.className = 'status-value error';
        }

        // å®¢æˆ·ç«¯çŠ¶æ€
        const clientStatus = document.getElementById('client-status');
        if (window.simpleClient) {
            clientStatus.textContent = 'å·²åˆå§‹åŒ–';
            clientStatus.className = 'status-value success';
        } else {
            clientStatus.textContent = 'æœªåˆå§‹åŒ–';
            clientStatus.className = 'status-value error';
        }
    }

    // å¼ºåˆ¶åˆå§‹åŒ–å’ŒåŠ è½½å‡½æ•°
    window.forceInitAndLoad = function() {
        console.log('ğŸ”§ å¼ºåˆ¶åˆå§‹åŒ–å’ŒåŠ è½½...');
        const chatList = document.getElementById('chat-list');
        
        try {
            // é‡ç½®çŠ¶æ€
            window.historyManager = null;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            if (chatList) {
                chatList.innerHTML = '<div style="color: yellow; padding: 10px;">ğŸ”„ å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–ä¸­...</div>';
            }
            
            // åˆå§‹åŒ–
            if (typeof initHistoryManager === 'function') {
                initHistoryManager();
                console.log('âœ… å¼ºåˆ¶åˆå§‹åŒ–å®Œæˆ');
                
                // ç­‰å¾…ä¸€ç§’åæ£€æŸ¥ç»“æœ
                setTimeout(() => {
                    if (window.historyManager && window.historyManager.chats) {
                        console.log('ğŸ“Š åŠ è½½çš„èŠå¤©æ•°é‡:', window.historyManager.chats.length);
                        if (chatList) {
                            console.log('ğŸ“‹ å½“å‰chat-listå†…å®¹é•¿åº¦:', chatList.innerHTML.length);
                        }
                    } else {
                        console.error('âŒ historyManageræˆ–chatsä¸ºç©º');
                        if (chatList) {
                            chatList.innerHTML = '<div style="color: red; padding: 10px;">âŒ åˆå§‹åŒ–å¤±è´¥ï¼ŒhistoryManagerä¸ºç©º</div>';
                        }
                    }
                }, 1000);
            } else {
                console.error('âŒ initHistoryManagerå‡½æ•°æœªæ‰¾åˆ°');
                if (chatList) {
                    chatList.innerHTML = '<div style="color: red; padding: 10px;">âŒ initHistoryManagerå‡½æ•°æœªæ‰¾åˆ°</div>';
                }
            }
        } catch (error) {
            console.error('âŒ å¼ºåˆ¶åˆå§‹åŒ–å¤±è´¥:', error);
            if (chatList) {
                chatList.innerHTML = `<div style="color: red; padding: 10px;">âŒ å¼ºåˆ¶åˆå§‹åŒ–å¤±è´¥: ${error.message}</div>`;
            }
        }
    };
    
    // è°ƒè¯•çŠ¶æ€å‡½æ•°
    window.debugHistoryManager = function() {
        console.log('=== è°ƒè¯•ä¿¡æ¯ ===');
        console.log('HistoryManagerç±»å‹:', typeof HistoryManager);
        console.log('initHistoryManagerå‡½æ•°:', typeof initHistoryManager);
        console.log('historyManagerå®ä¾‹:', window.historyManager);
        console.log('chat-listå…ƒç´ :', document.getElementById('chat-list'));
        
        if (window.historyManager) {
            console.log('èŠå¤©æ•°æ®:', window.historyManager.chats);
            console.log('èŠå¤©æ•°é‡:', window.historyManager.chats ? window.historyManager.chats.length : 'undefined');
            console.log('åŠ è½½çŠ¶æ€:', window.historyManager.isLoading);
        } else {
            console.log('âŒ historyManagerå®ä¾‹ä¸å­˜åœ¨');
        }
        
        const chatList = document.getElementById('chat-list');
        if (chatList) {
            console.log('chat-listå†…å®¹é•¿åº¦:', chatList.innerHTML.length);
            console.log('chat-listå†…å®¹é¢„è§ˆ:', chatList.innerHTML.substring(0, 100));
        }
        
        // æµ‹è¯•API
        fetch('/api/history/chats')
            .then(response => {
                console.log('APIå“åº”çŠ¶æ€:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('APIè¿”å›æ•°æ®ç±»å‹:', typeof data);
                console.log('APIè¿”å›æ•°æ®é•¿åº¦:', Array.isArray(data) ? data.length : 'not array');
                if (Array.isArray(data) && data.length > 0) {
                    console.log('ç¬¬ä¸€æ¡è®°å½•:', data[0]);
                }
            })
            .catch(error => {
                console.error('APIæµ‹è¯•å¤±è´¥:', error);
            });
    };
    
    // å¼ºåˆ¶åˆå§‹åŒ–å‡½æ•°ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
    function forceInit() {
        console.log('ğŸ”§ å¼ºåˆ¶åˆå§‹åŒ–å†å²è®°å½•ç®¡ç†å™¨');
        try {
            if (typeof HistoryManager !== 'undefined') {
                window.historyManager = new HistoryManager();
                window.historyManager.init();
                console.log('âœ… å¼ºåˆ¶åˆå§‹åŒ–æˆåŠŸ');
            } else {
                console.error('âŒ HistoryManagerç±»æœªæ‰¾åˆ°');
            }
        } catch (error) {
            console.error('âŒ å¼ºåˆ¶åˆå§‹åŒ–å¤±è´¥:', error);
        }
    }
    
    // å¦‚æœå½“å‰åœ¨è¯Šæ–­tabï¼Œæ›´æ–°çŠ¶æ€
        if (document.querySelector('.tab-btn[data-tab="diagnostic-tab"]').classList.contains('active')) {
            updateQuickStatus();
        }

        // å®šæœŸæ›´æ–°çŠ¶æ€ï¼ˆæ¯5ç§’ï¼‰
        setInterval(function() {
            if (document.querySelector('.tab-btn[data-tab="diagnostic-tab"]').classList.contains('active')) {
                updateQuickStatus();
            }
        }, 5000);
    

    </script>
</body>
</html>
