<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤© - Cursor Web</title>
    <link rel="stylesheet" href="style.css">
    <script src="js/instance-utils.js"></script>
    <script>
      try{ InstanceUtils && InstanceUtils.ensureOrRedirect('/instances.html?first=1&return=/chat.html'); }catch{}
    </script>
</head>
<body>
    <div class="container">
        <!-- ç»Ÿä¸€é¡µçœ‰ -->
        <header class="page-header">
            <div class="header-left">
                <a href="/" class="btn btn-back">
                    <span class="back-icon">â†</span>
                    è¿”å›ä¸»é¡µ
                </a>
            </div>
            <div class="header-center">
                <h1>èŠå¤©</h1>
            </div>
            <div class="header-right">
                <div class="instance-status">
                    <span class="instance-label">å®ä¾‹ï¼š</span>
                    <span class="instance-name" id="currentInstanceName">default</span>
                </div>
                <div class="status-indicators">
                    <div class="status-item">
                        <span class="status-dot" id="connectionStatusDot"></span>
                        <span class="status-text" id="connectionStatus">æ£€æŸ¥ä¸­...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-dot" id="injectStatusDot"></span>
                        <span class="status-text" id="injectStatus">æ£€æŸ¥ä¸­...</span>
                    </div>
                </div>
            </div>
        </header>

        <main class="main">
            <div id="messages-container" class="messages-container">
                <div class="welcome-message">
                    <h2>æ¬¢è¿ä½¿ç”¨ Cursor Web èŠå¤©</h2>
                    <p>å±•ç¤ºæœºåˆ¶ï¼š</p>
                    <p>ğŸ” <strong>åŸºäºå†å²æ‹‰å–æ˜¾ç¤º</strong>ï¼šå‘é€æ¶ˆæ¯åï¼Œå®¢æˆ·ç«¯ä¼šçŸ­æœŸå¿«é€Ÿè½®è¯¢ï¼Œå¹¶åœ¨åå°ä»¥å›ºå®šé¢‘ç‡æ‹‰å– <code>/api/chats</code>/<code>/api/chats/latest</code> æ˜¾ç¤ºæœ€æ–°å›å¤ã€‚</p>
                    <p>âš™ï¸ å¯é€‰ï¼šå¦‚éœ€å®æ—¶ HTML å›æ˜¾ï¼Œå¯åœ¨è¯Šæ–­é¡µä¸´æ—¶å¼€å¯ WebSocket <code>html_content</code> å¹¿æ’­ï¼ˆé»˜è®¤å…³é—­ï¼Œä»…è°ƒè¯•ä½¿ç”¨ï¼‰ã€‚</p>
                    <br>
                    <p class="instruction">ä½¿ç”¨æ–¹æ³•ï¼šåœ¨ Cursor è¿è¡Œæ³¨å…¥è„šæœ¬ï¼ˆç”¨äºæ¶ˆæ¯å‘é€ä¸æ§åˆ¶ï¼‰ï¼Œç•Œé¢æ˜¾ç¤ºç”±å†å²æ‹‰å–å®Œæˆã€‚</p>
                    <a href="/script.html" class="btn btn-primary" style="display:inline-block;margin:10px 0;">å‰å¾€ä¸€é”®å¤åˆ¶æ³¨å…¥è„šæœ¬ &gt;&gt;</a>
                    <p class="instruction">æ³¨å…¥è„šæœ¬è´Ÿè´£æŠ•é€’æ¶ˆæ¯ä¸è¾…åŠ©æ§åˆ¶ï¼›ä¸å†å¼ºåˆ¶ä¾èµ– HTML å›æ˜¾ã€‚</p>
                </div>
            </div>
            <footer class="footer">
                <form id="send-form" autocomplete="off" onsubmit="return false">
                    <textarea id="send-input" placeholder="è¾“å…¥æ¶ˆæ¯... (æ”¯æŒ Markdown åŠä»£ç å—)" rows="1" autocomplete="off" style="resize:vertical"></textarea>
                    <button id="send-btn" type="button">å‘é€</button>
                    <button id="clear-btn" type="button">æ¸…é™¤</button>
                </form>
            </footer>
        </main>
    </div>

    <!-- èŠå¤©é¡µé¢ä¸“ç”¨è„šæœ¬ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="js/modules/module-loader.js"></script>
    <script>
        // é˜»æ­¢è‡ªåŠ¨åŠ è½½ InjectBar æ¨¡å—ï¼Œé¿å…åˆ›å»ºæ‚¬æµ®çª—
        if (window.ModuleLoader) {
            // ä»ä¾èµ–ä¸­ç§»é™¤ InjectBar
            if (window.ModuleLoader.moduleDependencies) {
                delete window.ModuleLoader.moduleDependencies['InjectBar'];
            }
            // ä»å¿…è¦æ¨¡å—æ£€æŸ¥ä¸­ç§»é™¤ InjectBar
            if (window.ModuleLoader.checkModulesAvailability) {
                const originalCheck = window.ModuleLoader.checkModulesAvailability;
                window.ModuleLoader.checkModulesAvailability = function() {
                    const need=['WebSocketManager','ChatTimeline','ContentManager','StatusManager','CursorStatusManager','UIManager','EventManager','HomePageStatusManager','DebugManager','SimpleWebClient'];
                    const miss=need.filter(n=>!window[n]);
                    if(miss.length){ console.error('âŒ ç¼ºå°‘å¿…è¦æ¨¡å—:', miss); return false; }
                    return true;
                };
            }
        }
        
        // åˆå§‹åŒ– SimpleWebClientï¼šç¨³å¦¥è½®è¯¢æ–¹å¼ï¼Œæœ€å¤šé‡è¯• ~4s
        (function(){
          let tries = 0; const max = 20;
          function boot(){
            try{
              if (window.simpleClient) return true;
              if (window.SimpleWebClient){
                try{ window.Audit && Audit.log('boot','instantiate_simple_client'); }catch{}
                window.simpleClient = new window.SimpleWebClient();
                return true;
              }
            }catch{}
            return false;
          }
          if (!boot()){
            const t = setInterval(()=>{ tries++; if (boot() || tries>=max) clearInterval(t); }, 200);
          }
        })();
    </script>
    <script src="js/modules/AuditLogger.js"></script>
    <script src="js/status-checker.js"></script>
    <script>
        // ç¡®ä¿å…¬å…±æ¸²æŸ“å·¥å…·åŠ è½½
        if (window.ModuleLoader){
          // MarkdownRenderer åªæœ‰ ErrorHandler ä¾èµ–ï¼Œè‹¥æœªè‡ªåŠ¨åŠ è½½åˆ™æ‰‹åŠ¨åŠ è½½ä¸€æ¬¡
          if (!window.MarkdownRenderer){
            const s = document.createElement('script');
            s.src = 'js/modules/MarkdownRenderer.js';
            document.head.appendChild(s);
          }
        }
    </script>

    <script>
        // èŠå¤©é¡µé¢ä¸“ç”¨é€»è¾‘
        window.__renderTargetId = 'messages-container';
        window.__enableRealtimeRender = false;
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', function() {
            // å¦‚æœ URL å¸¦æœ‰ ?instance=ï¼ŒåŒæ­¥ç»™å†å² iframe
            try{
                const u = new URL(window.location.href);
                const inst = u.searchParams.get('instance');
                if (inst) {
                    // å­˜å‚¨å®ä¾‹å¹¶åˆ·æ–°é¡¶éƒ¨æ ‡è¯†
                    try{ InstanceUtils && InstanceUtils.set(inst); }catch{}
                }
            }catch{}
            
            // æ›´æ–°å®ä¾‹çŠ¶æ€
            updateInstanceStatus();
            
            // å¯åŠ¨çŠ¶æ€æ£€æŸ¥
            if (window.statusChecker) {
                window.statusChecker.startAutoCheck();
            }
        });

        // æ›´æ–°å®ä¾‹çŠ¶æ€
        function updateInstanceStatus() {
            try {
                if (window.InstanceUtils) {
                    const instanceName = InstanceUtils.get() || 'default';
                    document.getElementById('currentInstanceName').textContent = instanceName;
                }
            } catch (e) {
                console.log('æ›´æ–°å®ä¾‹çŠ¶æ€å¤±è´¥:', e);
            }
        }
    </script>
</body>
</html>
