<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤© - Cursor Web</title>
    <link rel="stylesheet" href="style.css">
    <script src="js/instance-utils.js"></script>
    <script>
      try{ InstanceUtils && InstanceUtils.ensureOrRedirect('/instances.html?first=1&return=/chat.html'); }catch{}
    </script>
</head>
<body>
    <div class="container">
        <!-- ç»Ÿä¸€é¡µçœ‰ -->
        <header class="page-header">
            <div class="header-left">
                <a href="/" class="btn btn-back">
                    <span class="back-icon">â†</span>
                    è¿”å›ä¸»é¡µ
                </a>
            </div>
            <div class="header-center">
                <h1>èŠå¤©</h1>
            </div>
            <div class="header-right">
                <div class="instance-status">
                    <span class="instance-label">å®ä¾‹ï¼š</span>
                    <span class="instance-name" id="currentInstanceName">default</span>
                </div>
                <div class="status-indicators">
                    <div class="status-item" title="WebSocketè¿æ¥çŠ¶æ€">
                        <span class="status-dot" id="connectionStatusDot"></span>
                        <span class="status-text" id="connectionStatus">æ£€æŸ¥ä¸­...</span>
                    </div>
                    <div class="status-item" title="Cursorå®ä¾‹çŠ¶æ€ï¼šå·²æ³¨å…¥=å¯èŠå¤©ï¼Œè¿è¡Œä¸­=éœ€æ³¨å…¥ï¼Œæœªè¿è¡Œ=æœªå¯åŠ¨">
                        <span class="status-dot" id="injectStatusDot"></span>
                        <span class="status-text" id="injectStatus">æ£€æŸ¥ä¸­...</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- æ¶ˆæ¯è¿‡æ»¤æ§åˆ¶é¢æ¿ - å›ºå®šåœ¨é¡µçœ‰ä¸‹æ–¹ -->
        <div class="filter-panel-container" style="display: none;">
            <div class="filter-panel">
                <div class="filter-header">
                    <span>ğŸ” æ¶ˆæ¯è¿‡æ»¤</span>
                    <button class="btn-toggle-filters" onclick="toggleFilterPanel()">æ˜¾ç¤º/éšè—</button>
                </div>
                <div class="filter-content" id="filterContent" style="display: none;">
                    <div class="filter-options">
                        <label class="filter-option">
                            <input type="checkbox" id="showUserMessages" checked onchange="updateFilters()">
                            <span>ğŸ‘¤ ç”¨æˆ·æ¶ˆæ¯</span>
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" id="showAssistantMessages" checked onchange="updateFilters()">
                            <span>ğŸ¤– åŠ©æ‰‹å›å¤</span>
                        </label>
                    </div>
                    <div class="filter-settings">
                        <label class="filter-setting">
                            <span>æœ€å¤§æ˜¾ç¤ºæ¶ˆæ¯æ•°ï¼š</span>
                            <input type="number" id="maxMessages" value="100" min="10" max="500" onchange="updateFilters()">
                        </label>
                        <label class="filter-setting">
                            <span>æœ€å°æ¶ˆæ¯é•¿åº¦ï¼š</span>
                            <input type="number" id="minMessageLength" value="1" min="1" max="20" onchange="updateFilters()">
                        </label>
                        <label class="filter-setting">
                            <span>æ˜¾ç¤ºæ›´å¤šæ¶ˆæ¯ï¼š</span>
                            <button class="btn btn-info" onclick="loadMoreMessages()" style="padding: 4px 8px; font-size: 12px;">åŠ è½½æ›´å¤š</button>
                        </label>
                    </div>
                    <!-- ç§»é™¤æ“ä½œæŒ‰é’®ï¼Œè¿‡æ»¤è®¾ç½®æ”¹å˜åè‡ªåŠ¨ç”Ÿæ•ˆ -->
                </div>
            </div>
        </div>

        <main class="main">
            <div id="messages-container" class="messages-container">
                <div class="welcome-message">
                    <h2>æ¬¢è¿ä½¿ç”¨ Cursor Web èŠå¤©</h2>
                    <p>å±•ç¤ºæœºåˆ¶ï¼š</p>
                    <p>ğŸ” <strong>åŸºäºå†å²æ‹‰å–æ˜¾ç¤º</strong>ï¼šå‘é€æ¶ˆæ¯åï¼Œå®¢æˆ·ç«¯ä¼šçŸ­æœŸå¿«é€Ÿè½®è¯¢ï¼Œå¹¶åœ¨åå°ä»¥å›ºå®šé¢‘ç‡æ‹‰å– <code>/api/chats</code>/<code>/api/chats/latest</code> æ˜¾ç¤ºæœ€æ–°å›å¤ã€‚</p>
                    <p>âš™ï¸ å¯é€‰ï¼šå¦‚éœ€å®æ—¶ HTML å›æ˜¾ï¼Œå¯åœ¨è¯Šæ–­é¡µä¸´æ—¶å¼€å¯ WebSocket <code>html_content</code> å¹¿æ’­ï¼ˆé»˜è®¤å…³é—­ï¼Œä»…è°ƒè¯•ä½¿ç”¨ï¼‰ã€‚</p>
                    <br>
                    <p class="instruction">ä½¿ç”¨æ–¹æ³•ï¼šåœ¨ Cursor è¿è¡Œæ³¨å…¥è„šæœ¬ï¼ˆç”¨äºæ¶ˆæ¯å‘é€ä¸æ§åˆ¶ï¼‰ï¼Œç•Œé¢æ˜¾ç¤ºç”±å†å²æ‹‰å–å®Œæˆã€‚</p>
                    <a href="/script.html" class="btn btn-primary" style="display:inline-block;margin:10px 0;">å‰å¾€ä¸€é”®å¤åˆ¶æ³¨å…¥è„šæœ¬ &gt;&gt;</a>
                    <p class="instruction">æ³¨å…¥è„šæœ¬è´Ÿè´£æŠ•é€’æ¶ˆæ¯ä¸è¾…åŠ©æ§åˆ¶ï¼›ä¸å†å¼ºåˆ¶ä¾èµ– HTML å›æ˜¾ã€‚</p>
                </div>
            </div>
            <footer class="footer">
                <form id="send-form" autocomplete="off" onsubmit="return false">
                    <textarea id="send-input" placeholder="è¾“å…¥æ¶ˆæ¯... (æ”¯æŒ Markdown åŠä»£ç å—)" rows="1" autocomplete="off" style="resize:vertical"></textarea>
                    <button id="send-btn" type="button">å‘é€</button>
                    <button id="clear-btn" type="button">æ¸…é™¤</button>
                </form>
            </footer>
        </main>
    </div>

    <!-- èŠå¤©é¡µé¢ä¸“ç”¨è„šæœ¬ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="js/modules/module-loader.js"></script>
    <script>
        // é˜»æ­¢è‡ªåŠ¨åŠ è½½ InjectBar æ¨¡å—ï¼Œé¿å…åˆ›å»ºæ‚¬æµ®çª—
        if (window.ModuleLoader) {
            // ä»ä¾èµ–ä¸­ç§»é™¤ InjectBar
            if (window.ModuleLoader.moduleDependencies) {
                delete window.ModuleLoader.moduleDependencies['InjectBar'];
            }
            // ä»å¿…è¦æ¨¡å—æ£€æŸ¥ä¸­ç§»é™¤ InjectBar
            if (window.ModuleLoader.checkModulesAvailability) {
                const originalCheck = window.ModuleLoader.checkModulesAvailability;
                window.ModuleLoader.checkModulesAvailability = function() {
                    const need=['WebSocketManager','ChatTimeline','ContentManager','StatusManager','CursorStatusManager','UIManager','EventManager','HomePageStatusManager','DebugManager','SimpleWebClient'];
                    const miss=need.filter(n=>!window[n]);
                    if(miss.length){ console.error('âŒ ç¼ºå°‘å¿…è¦æ¨¡å—:', miss); return false; }
                    return true;
                };
            }
        }
        
        // åˆå§‹åŒ– SimpleWebClientï¼šç¨³å¦¥è½®è¯¢æ–¹å¼ï¼Œæœ€å¤šé‡è¯• ~4s
        (function(){
          let tries = 0; const max = 20;
          function boot(){
            try{
              if (window.simpleClient) return true;
              if (window.SimpleWebClient){
                try{ window.Audit && Audit.log('boot','instantiate_simple_client'); }catch{}
                window.simpleClient = new window.SimpleWebClient();
                return true;
              }
            }catch{}
            return false;
          }
          if (!boot()){
            const t = setInterval(()=>{ tries++; if (boot() || tries>=max) clearInterval(t); }, 200);
          }
        })();
    </script>
    <script src="js/modules/AuditLogger.js"></script>
    <script src="js/status-checker.js"></script>
    <script>
        // ç¡®ä¿å…¬å…±æ¸²æŸ“å·¥å…·åŠ è½½
        if (window.ModuleLoader){
          // MarkdownRenderer åªæœ‰ ErrorHandler ä¾èµ–ï¼Œè‹¥æœªè‡ªåŠ¨åŠ è½½åˆ™æ‰‹åŠ¨åŠ è½½ä¸€æ¬¡
          if (!window.MarkdownRenderer){
            const s = document.createElement('script');
            s.src = 'js/modules/MarkdownRenderer.js';
            document.head.appendChild(s);
          }
        }
    </script>

    <script>
        // èŠå¤©é¡µé¢ä¸“ç”¨é€»è¾‘
        window.__renderTargetId = 'messages-container';
        window.__enableRealtimeRender = false;
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', function() {
            // å¦‚æœ URL å¸¦æœ‰ ?instance=ï¼ŒåŒæ­¥ç»™å†å² iframe
            try{
                const u = new URL(window.location.href);
                const inst = u.searchParams.get('instance');
                if (inst) {
                    // å­˜å‚¨å®ä¾‹å¹¶åˆ·æ–°é¡¶éƒ¨æ ‡è¯†
                    try{ InstanceUtils && InstanceUtils.set(inst); }catch{}
                }
            }catch{}
            
            // æ›´æ–°å®ä¾‹çŠ¶æ€
            updateInstanceStatus();
            
            // å¯åŠ¨çŠ¶æ€æ£€æŸ¥
            if (window.statusChecker) {
                window.statusChecker.startAutoCheck();
            }
            
            // ç­‰å¾…æ¨¡å—åŠ è½½å®Œæˆååˆå§‹åŒ–EventManager
            const initEventManager = () => {
                if (window.EventManager && window.simpleClient) {
                    try {
                        window.eventManager = new window.EventManager(window.simpleClient);
                        window.eventManager.init();
                        console.log('âœ… EventManager åˆå§‹åŒ–æˆåŠŸ');
                        return true;
                    } catch (e) {
                        console.error('âŒ EventManager åˆå§‹åŒ–å¤±è´¥:', e);
                        return false;
                    }
                } else {
                    console.log('â³ ç­‰å¾… EventManager å’Œ simpleClient åŠ è½½...');
                    return false;
                }
            };
            
            // ç«‹å³å°è¯•åˆå§‹åŒ–ï¼Œå¦‚æœå¤±è´¥åˆ™å®šæ—¶é‡è¯•
            if (!initEventManager()) {
                let retryCount = 0;
                const maxRetries = 20; // æœ€å¤šé‡è¯•20æ¬¡ï¼ˆ4ç§’ï¼‰
                const retryInterval = setInterval(() => {
                    retryCount++;
                    if (initEventManager() || retryCount >= maxRetries) {
                        clearInterval(retryInterval);
                        if (retryCount >= maxRetries) {
                            console.error('âŒ EventManager åˆå§‹åŒ–è¶…æ—¶å¤±è´¥');
                        }
                    }
                }, 200);
            }
            
            // åˆå§‹åŒ–è¿‡æ»¤æ§åˆ¶é¢æ¿
            initializeFilterPanel();
        });

        // æ›´æ–°å®ä¾‹çŠ¶æ€
        function updateInstanceStatus() {
            try {
                if (window.InstanceUtils) {
                    const instanceName = InstanceUtils.get() || 'default';
                    document.getElementById('currentInstanceName').textContent = instanceName;
                }
            } catch (e) {
                console.log('æ›´æ–°å®ä¾‹çŠ¶æ€å¤±è´¥:', e);
            }
        }
        
        // è¿‡æ»¤æ§åˆ¶é¢æ¿ç›¸å…³å‡½æ•°
        function toggleFilterPanel() {
            const container = document.querySelector('.filter-panel-container');
            const content = document.getElementById('filterContent');
            
            if (container && container.style.display === 'none') {
                // æ˜¾ç¤ºæ•´ä¸ªè¿‡æ»¤é¢æ¿
                container.style.display = 'block';
                if (content) content.style.display = 'block';
                showNotification('è¿‡æ»¤é¢æ¿å·²æ˜¾ç¤º', 'info');
            } else if (container) {
                // éšè—æ•´ä¸ªè¿‡æ»¤é¢æ¿
                container.style.display = 'none';
                if (content) content.style.display = 'none';
                showNotification('è¿‡æ»¤é¢æ¿å·²éšè—', 'info');
            }
        }
        
        // æ·»åŠ å¿«æ·é”®æ”¯æŒ (Ctrl+F æ˜¾ç¤º/éšè—è¿‡æ»¤é¢æ¿)
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                toggleFilterPanel();
            }
        });
        
        function initializeFilterPanel() {
            // ä»localStorageæ¢å¤è¿‡æ»¤è®¾ç½®
            try {
                const savedFilters = localStorage.getItem('cw_chat_filters');
                if (savedFilters) {
                    const filters = JSON.parse(savedFilters);
                    document.getElementById('showUserMessages').checked = filters.showUserMessages !== false;
                    document.getElementById('showAssistantMessages').checked = filters.showAssistantMessages !== false;
                    document.getElementById('maxMessages').value = filters.maxMessages || 100;
                    document.getElementById('minMessageLength').value = filters.minMessageLength || 1;
                }
            } catch (e) {
                console.log('æ¢å¤è¿‡æ»¤è®¾ç½®å¤±è´¥:', e);
            }
        }
        
        function updateFilters() {
            try {
                const filters = {
                    showUserMessages: document.getElementById('showUserMessages').checked,
                    showAssistantMessages: document.getElementById('showAssistantMessages').checked,
                    maxMessages: parseInt(document.getElementById('maxMessages').value) || 100,
                    minMessageLength: parseInt(document.getElementById('minMessageLength').value) || 1
                };
                
                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('cw_chat_filters', JSON.stringify(filters));
                
                // æ›´æ–°ChatTimelineçš„è¿‡æ»¤è®¾ç½®
                if (window.timeline && window.timeline.setMessageFilters) {
                    window.timeline.setMessageFilters(filters);
                }
            } catch (e) {
                console.error('æ›´æ–°è¿‡æ»¤è®¾ç½®å¤±è´¥:', e);
            }
        }
        
        // åŠ è½½æ›´å¤šæ¶ˆæ¯
        function loadMoreMessages() {
            try {
                if (window.timeline && window.timeline.loadMoreMessages) {
                    window.timeline.loadMoreMessages();
                } else {
                    // å¦‚æœæ²¡æœ‰loadMoreMessagesæ–¹æ³•ï¼Œå°±å¢åŠ maxMessagesçš„å€¼
                    const maxMessagesInput = document.getElementById('maxMessages');
                    const currentValue = parseInt(maxMessagesInput.value) || 100;
                    maxMessagesInput.value = Math.min(currentValue + 50, 500);
                    updateFilters();
                }
            } catch (e) {
                console.error('åŠ è½½æ›´å¤šæ¶ˆæ¯å¤±è´¥:', e);
            }
        }
        
        // æµ‹è¯•è¿‡æ»¤åŠŸèƒ½
        function testFilter() {
            try {
                showNotification('æ­£åœ¨æµ‹è¯•è¿‡æ»¤åŠŸèƒ½...', 'info');
                
                // æµ‹è¯•è¿‡æ»¤æ§åˆ¶é¢æ¿æ˜¯å¦å¯è§
                const filterPanel = document.querySelector('.filter-panel');
                if (filterPanel) {
                    showNotification('âœ… è¿‡æ»¤æ§åˆ¶é¢æ¿å·²æ‰¾åˆ°', 'info');
                } else {
                    showNotification('âŒ è¿‡æ»¤æ§åˆ¶é¢æ¿æœªæ‰¾åˆ°', 'error');
                }
                
                // æµ‹è¯•ChatTimelineæ˜¯å¦å¯ç”¨
                if (window.timeline) {
                    showNotification('âœ… ChatTimeline å·²åŠ è½½', 'info');
                    
                    // æµ‹è¯•è¿‡æ»¤è®¾ç½®
                    const filters = window.timeline.getMessageFilters();
                    showNotification(`å½“å‰è¿‡æ»¤è®¾ç½®: ç”¨æˆ·=${filters.showUserMessages}, åŠ©æ‰‹=${filters.showAssistantMessages}`, 'info');
                } else {
                    showNotification('âŒ ChatTimeline æœªåŠ è½½', 'error');
                }
                
                // å¼ºåˆ¶æ˜¾ç¤ºè¿‡æ»¤é¢æ¿
                const filterContent = document.getElementById('filterContent');
                if (filterContent) {
                    filterContent.style.display = 'block';
                    showNotification('è¿‡æ»¤é¢æ¿å·²å¼ºåˆ¶æ˜¾ç¤º', 'info');
                }
                
            } catch (e) {
                console.error('æµ‹è¯•è¿‡æ»¤åŠŸèƒ½å¤±è´¥:', e);
                showNotification('æµ‹è¯•å¤±è´¥: ' + e.message, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–è¿‡æ»¤é¢æ¿
        window.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–è¿‡æ»¤æ§åˆ¶é¢æ¿...');
            
            // ç¡®ä¿è¿‡æ»¤é¢æ¿é»˜è®¤éšè—
            const filterPanelContainer = document.querySelector('.filter-panel-container');
            const filterContent = document.getElementById('filterContent');
            
            if (filterPanelContainer) {
                filterPanelContainer.style.display = 'none';
                console.log('âœ… è¿‡æ»¤é¢æ¿å®¹å™¨å·²éšè—');
            }
            
            if (filterContent) {
                filterContent.style.display = 'none';
                console.log('âœ… è¿‡æ»¤é¢æ¿å†…å®¹å·²éšè—');
            }
        });
    </script>
</body>
</html>
