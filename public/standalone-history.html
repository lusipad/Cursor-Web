<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cursor 聊天历史记录</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            margin: 0; 
            padding: 20px; 
            background: #f5f5f5;
            line-height: 1.6;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header { 
            background: #007acc; 
            color: white; 
            padding: 15px 20px; 
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        .controls { 
            padding: 20px; 
            border-bottom: 1px solid #eee; 
            display: flex; 
            gap: 10px; 
            align-items: center;
            flex-wrap: wrap;
        }
        .controls input, .controls button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .controls button {
            background: #007acc;
            color: white;
            cursor: pointer;
            border: none;
        }
        .controls button:hover {
            background: #005a9e;
        }
        .stats { 
            padding: 10px 20px; 
            background: #f9f9f9; 
            border-bottom: 1px solid #eee; 
            font-size: 14px;
        }
        .chat-list { 
            padding: 20px; 
            height: calc(100vh - 200px);
            overflow-y: auto;
            border-right: 1px solid #eee;
        }
        .chat-detail { 
            padding: 20px;
        }
        .chat-card {
            border: 1px solid #e1e4e8;
            margin: 10px 0;
            padding: 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .chat-card:hover {
            background: #f6f8fa;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chat-title { font-size: 16px; font-weight: 600; margin-bottom: 5px; }
        .chat-preview { color: #586069; font-size: 14px; margin-bottom: 5px; }
        .chat-meta { font-size: 12px; color: #959da5; display: flex; gap: 15px; }
        .message {
            margin: 10px 0;
            border-radius: 6px;
            border: 1px solid #e1e4e8;
            overflow: hidden;
        }
        .message.user { border-left: 3px solid #28a745; }
        .message.assistant { border-left: 3px solid #6f42c1; }
        .message-header {
            padding: 12px;
            background: #f6f8fa;
            border-bottom: 1px solid #e1e4e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            font-weight: 600;
        }
        .message-header .role {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .message-content {
            padding: 12px;
            font-size: 14px;
            line-height: 1.5;
            background: #fff;
        }
        .message.user .message-content { background: #f6ffed; }
        .message.assistant .message-content { background: #f3f0ff; }
        
        /* Markdown 高亮样式 */
        .message-content pre {
            background: #f6f8fa;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            padding: 16px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .message-content code {
            background: #f6f8fa;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 85%;
        }
        .message-content pre code {
            background: transparent;
            padding: 0;
            border-radius: 0;
        }
        .message-content blockquote {
            border-left: 4px solid #dfe2e5;
            padding-left: 16px;
            margin: 10px 0;
            color: #6a737d;
        }
        .message-content h1, .message-content h2, .message-content h3, 
        .message-content h4, .message-content h5, .message-content h6 {
            margin-top: 20px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .message-content ul, .message-content ol {
            padding-left: 20px;
            margin: 10px 0;
        }
        .message-content li {
            margin: 5px 0;
        }
        .loading { text-align: center; padding: 40px; color: #586069; }
        .error { color: #d73a49; background: #ffeef0; padding: 10px; border-radius: 4px; }
        .split-container { 
            display: flex;
        }
        .split-container .chat-list { flex: 1; border-right: 1px solid #eee; }
        .split-container .chat-detail { flex: 2; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Cursor 聊天历史记录</h1>
        </div>
        
        <div class="controls">
            <input type="text" id="search-input" placeholder="搜索聊天内容..." />
            <button onclick="searchChats()">搜索</button>
            <button onclick="refreshChats()">刷新</button>
            <button onclick="clearCache()">清除缓存</button>
        </div>
        
        <div class="stats" id="stats">准备就绪...</div>
        
        <div class="split-container">
            <div class="chat-list">
                <div id="chats-container">
                    <div class="loading">正在加载聊天记录...</div>
                </div>
            </div>
            
            <div class="chat-detail">
                <div id="detail-container">
                    <div class="loading">选择一个聊天查看详情...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API客户端
        class HistoryApiClient {
            constructor() {
                this.baseUrl = '/api/history';
            }

            async getAllChats(options = {}) {
                const params = new URLSearchParams();
                if (options.limit) params.append('limit', options.limit);
                if (options.offset) params.append('offset', options.offset);
                if (options.workspaceId) params.append('workspaceId', options.workspaceId);
                
                const url = `${this.baseUrl}/chats${params.toString() ? '?' + params.toString() : ''}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                return await response.json();
            }

            async getChatDetail(sessionId) {
                const response = await fetch(`${this.baseUrl}/chat/${encodeURIComponent(sessionId)}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                return await response.json();
            }

            async searchChats(query) {
                const response = await fetch(`${this.baseUrl}/search?q=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                return await response.json();
            }

            async clearCache() {
                const response = await fetch(`${this.baseUrl}/cache`, { method: 'DELETE' });
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                return await response.json();
            }
        }

        // 服务层
        class HistoryService {
            constructor() {
                this.apiClient = new HistoryApiClient();
                this.cache = new Map();
                this.cacheTimeout = 5 * 60 * 1000; // 5分钟
            }

            async getChatList(options = {}) {
                const cacheKey = `all_chats_${JSON.stringify(options)}`;
                const cached = this.cache.get(cacheKey);
                
                if (cached && Date.now() - cached.timestamp < this.cacheTimeout) {
                    return cached.data;
                }

                try {
                    const response = await this.apiClient.getAllChats(options);
                    
                    let chats;
                    if (response && response.success && Array.isArray(response.data)) {
                        chats = response.data;
                    } else if (Array.isArray(response)) {
                        chats = response;
                    } else {
                        console.warn('意外的API响应格式:', response);
                        chats = [];
                    }

                    const processedChats = this.processChats(chats);
                    this.cache.set(cacheKey, { data: processedChats, timestamp: Date.now() });
                    return processedChats;
                } catch (error) {
                    console.error('获取聊天列表失败:', error);
                    throw error;
                }
            }

            async getChatDetail(sessionId) {
                const cacheKey = `chat_detail_${sessionId}`;
                const cached = this.cache.get(cacheKey);
                
                if (cached && Date.now() - cached.timestamp < this.cacheTimeout) {
                    return cached.data;
                }

                try {
                    const response = await this.apiClient.getChatDetail(sessionId);
                    const chatDetail = response.data;
                    const processedDetail = this.processChatDetail(chatDetail);
                    this.cache.set(cacheKey, { data: processedDetail, timestamp: Date.now() });
                    return processedDetail;
                } catch (error) {
                    console.error('获取聊天详情失败:', error);
                    throw error;
                }
            }

            async searchChats(query) {
                if (!query || query.trim() === '') {
                    return this.getChatList();
                }

                try {
                    const response = await this.apiClient.searchChats(query);
                    return this.processChats(response.data || []);
                } catch (error) {
                    console.error('搜索聊天记录失败:', error);
                    throw error;
                }
            }

            async clearCache() {
                this.cache.clear();
                return await this.apiClient.clearCache();
            }

            processChats(chats) {
                if (!Array.isArray(chats)) {
                    console.warn('processChats: 期望数组但收到:', typeof chats, chats);
                    return [];
                }
                
                return chats.map(chat => ({
                    ...chat,
                    title: this.generateChatTitle(chat),
                    preview: this.generateChatPreview(chat),
                    formattedTime: this.formatTime(chat.timestamp || chat.lastModified),
                    messageCount: chat.messages ? chat.messages.length : 0
                }));
            }

            processChatDetail(chatDetail) {
                return {
                    ...chatDetail,
                    title: this.generateChatTitle(chatDetail),
                    formattedTime: this.formatTime(chatDetail.timestamp || chatDetail.lastModified),
                    messages: chatDetail.messages ? chatDetail.messages.map(msg => ({
                        ...msg,
                        formattedTime: this.formatTime(msg.timestamp)
                    })) : []
                };
            }

            generateChatTitle(chat) {
                if (chat.title) return chat.title;
                
                if (chat.messages && chat.messages.length > 0) {
                    const firstUserMessage = chat.messages.find(msg => msg.role === 'user');
                    if (firstUserMessage) {
                        return firstUserMessage.content.substring(0, 50) + 
                               (firstUserMessage.content.length > 50 ? '...' : '');
                    }
                }
                
                return `聊天记录 ${this.formatTime(chat.timestamp || Date.now())}`;
            }

            generateChatPreview(chat) {
                if (chat.messages && chat.messages.length > 0) {
                    const lastMessage = chat.messages[chat.messages.length - 1];
                    return lastMessage.content.substring(0, 100) + 
                           (lastMessage.content.length > 100 ? '...' : '');
                }
                return '暂无消息';
            }

            formatTime(timestamp) {
                if (!timestamp) return '未知时间';
                
                const date = new Date(timestamp);
                const now = new Date();
                const diff = now - date;
                
                if (diff < 60000) return '刚刚';
                if (diff < 3600000) return `${Math.floor(diff / 60000)}分钟前`;
                if (diff < 86400000) return `${Math.floor(diff / 3600000)}小时前`;
                if (diff < 604800000) return `${Math.floor(diff / 86400000)}天前`;
                return date.toLocaleDateString('zh-CN');
            }
        }

        // 全局变量
        let service = new HistoryService();
        let currentChats = [];

        // 功能函数
        async function loadChats() {
            updateStats('正在加载...');
            document.getElementById('chats-container').innerHTML = '<div class="loading">正在加载聊天记录...</div>';
            
            try {
                currentChats = await service.getChatList();
                displayChats(currentChats);
                updateStats(`找到 ${currentChats.length} 条聊天记录`);
            } catch (error) {
                console.error('加载失败:', error);
                updateStats(`加载失败: ${error.message}`);
                document.getElementById('chats-container').innerHTML = `<div class="error">加载失败: ${error.message}</div>`;
            }
        }

        function displayChats(chats) {
            const container = document.getElementById('chats-container');
            if (!chats || chats.length === 0) {
                container.innerHTML = '<div class="error">没有找到聊天记录</div>';
                return;
            }

            let html = '';
            chats.forEach(chat => {
                html += `
                    <div class="chat-card" onclick="loadChatDetail('${chat.sessionId}')">
                        <div class="chat-title">${chat.title}</div>
                        <div class="chat-preview">${chat.preview}</div>
                        <div class="chat-meta">
                            <span>项目: ${chat.project?.name || '未知'}</span>
                            <span>消息: ${chat.messageCount}</span>
                            <span>${chat.formattedTime}</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        async function loadChatDetail(sessionId) {
            updateStats('正在加载聊天详情...');
            document.getElementById('detail-container').innerHTML = '<div class="loading">正在加载聊天详情...</div>';
            
            try {
                const chat = await service.getChatDetail(sessionId);
                displayChatDetail(chat);
                updateStats(`显示聊天详情: ${chat.title}`);
            } catch (error) {
                console.error('加载详情失败:', error);
                updateStats(`加载详情失败: ${error.message}`);
                document.getElementById('detail-container').innerHTML = `<div class="error">加载详情失败: ${error.message}</div>`;
            }
        }

        function displayChatDetail(chat) {
            const container = document.getElementById('detail-container');
            
            let html = `
                <h3>${chat.title}</h3>
                <div style="margin: 10px 0; font-size: 14px; color: #666;">
                    <p><strong>会话ID:</strong> ${chat.sessionId}</p>
                    <p><strong>项目:</strong> ${chat.project?.name || '未知'}</p>
                    <p><strong>消息数量:</strong> ${chat.messages?.length || 0}</p>
                    <p><strong>时间:</strong> ${chat.formattedTime}</p>
                </div>
                <div style="margin: 10px 0;">
                    <button onclick="exportToHTML('${chat.sessionId}')" style="margin-right: 10px; padding: 8px 16px; border: 1px solid #007acc; background: #007acc; color: white; border-radius: 4px; cursor: pointer;">导出HTML</button>
                    <button onclick="exportToMarkdown('${chat.sessionId}')" style="padding: 8px 16px; border: 1px solid #28a745; background: #28a745; color: white; border-radius: 4px; cursor: pointer;">导出Markdown</button>
                </div>
                <hr>
            `;

            if (chat.messages && chat.messages.length > 0) {
                const mergedMessages = mergeConsecutiveMessages(chat.messages);
                mergedMessages.forEach((msg, index) => {
                    const processedContent = parseMarkdown(msg.content);
                    html += `
                        <div class="message ${msg.role}">
                            <div class="message-header">
                                <div class="role">
                                    ${msg.role === 'user' ? '👤 用户' : '🤖 AI'}
                                </div>
                                <div>
                                    <span style="font-size: 12px; color: #666;">${msg.timeRange}</span>
                                </div>
                            </div>
                            <div class="message-content">${processedContent}</div>
                        </div>
                    `;
                });
            } else {
                html += '<p>暂无消息</p>';
            }

            container.innerHTML = html;
        }
        
        // 合并连续的同角色消息
        function mergeConsecutiveMessages(messages) {
            if (!messages || messages.length === 0) return [];
            
            const merged = [];
            let currentGroup = {
                role: messages[0].role,
                content: messages[0].content,
                startTime: messages[0].formattedTime,
                endTime: messages[0].formattedTime,
                timeRange: messages[0].formattedTime
            };
            
            for (let i = 1; i < messages.length; i++) {
                const msg = messages[i];
                
                if (msg.role === currentGroup.role) {
                    // 同角色消息，合并内容
                    currentGroup.content += '\n\n' + msg.content;
                    currentGroup.endTime = msg.formattedTime;
                    currentGroup.timeRange = currentGroup.startTime === currentGroup.endTime 
                        ? currentGroup.startTime 
                        : `${currentGroup.startTime} - ${currentGroup.endTime}`;
                } else {
                    // 不同角色，保存当前组并开始新组
                    merged.push(currentGroup);
                    currentGroup = {
                        role: msg.role,
                        content: msg.content,
                        startTime: msg.formattedTime,
                        endTime: msg.formattedTime,
                        timeRange: msg.formattedTime
                    };
                }
            }
            
            // 添加最后一组
            merged.push(currentGroup);
            return merged;
        }
        
        // 简单的Markdown解析函数
         function parseMarkdown(text) {
             if (!text) return '';
             
             // HTML转义
             let html = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
             
             // 代码块 (```)
             html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
             
             // 行内代码 (`)
             html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
             
             // 标题
             html = html.replace(/^### (.*$)/gm, '<h3>$1</h3>');
             html = html.replace(/^## (.*$)/gm, '<h2>$1</h2>');
             html = html.replace(/^# (.*$)/gm, '<h1>$1</h1>');
             
             // 粗体
             html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             
             // 斜体
             html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
             
             // 引用
             html = html.replace(/^> (.*$)/gm, '<blockquote>$1</blockquote>');
             
             // 无序列表
             html = html.replace(/^[\*\-\+] (.*$)/gm, '<li>$1</li>');
             html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
             
             // 有序列表
             html = html.replace(/^\d+\. (.*$)/gm, '<li>$1</li>');
             
             // 换行
             html = html.replace(/\n/g, '<br>');
             
             return html;
         }
         
         // 导出HTML功能
         async function exportToHTML(sessionId) {
             try {
                 const chat = await service.getChatDetail(sessionId);
                 if (!chat) {
                     alert('未找到对应的聊天记录');
                     return;
                 }
             
             let htmlContent = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${chat.title} - 聊天记录</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        .message { margin: 15px 0; padding: 15px; border-radius: 8px; border-left: 4px solid; }
        .user { background: #e3f2fd; border-left-color: #2196f3; }
        .assistant { background: #f3e5f5; border-left-color: #9c27b0; }
        .role { font-weight: bold; margin-bottom: 8px; }
        .time { font-size: 12px; color: #666; margin-bottom: 8px; }
        pre { background: #f4f4f4; padding: 10px; border-radius: 4px; overflow-x: auto; }
        code { background: #f4f4f4; padding: 2px 4px; border-radius: 3px; }
        blockquote { border-left: 4px solid #ddd; margin: 0; padding-left: 15px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>${chat.title}</h1>
            <p><strong>会话ID:</strong> ${chat.sessionId}</p>
            <p><strong>项目:</strong> ${chat.project?.name || '未知'}</p>
            <p><strong>消息数量:</strong> ${chat.messages?.length || 0}</p>
            <p><strong>导出时间:</strong> ${new Date().toLocaleString('zh-CN')}</p>
        </div>
`;
             
             if (chat.messages && chat.messages.length > 0) {
                  const mergedMessages = mergeConsecutiveMessages(chat.messages);
                  mergedMessages.forEach(msg => {
                      const processedContent = parseMarkdown(msg.content);
                      htmlContent += `
        <div class="message ${msg.role}">
            <div class="role">${msg.role === 'user' ? '👤 用户' : '🤖 AI助手'}</div>
            <div class="time">${msg.timeRange}</div>
            <div class="content">${processedContent}</div>
        </div>`;
                  });
              }
             
             htmlContent += `
    </div>
</body>
</html>`;
             
                 downloadFile(htmlContent, `${chat.title}_${sessionId}.html`, 'text/html');
             } catch (error) {
                 console.error('导出HTML失败:', error);
                 alert('导出失败: ' + error.message);
             }
         }
         
         // 导出Markdown功能
         async function exportToMarkdown(sessionId) {
             try {
                 const chat = await service.getChatDetail(sessionId);
                 if (!chat) {
                     alert('未找到对应的聊天记录');
                     return;
                 }
             
             let markdownContent = `# ${chat.title}\n\n`;
             markdownContent += `**会话ID:** ${chat.sessionId}\n`;
             markdownContent += `**项目:** ${chat.project?.name || '未知'}\n`;
             markdownContent += `**消息数量:** ${chat.messages?.length || 0}\n`;
             markdownContent += `**导出时间:** ${new Date().toLocaleString('zh-CN')}\n\n`;
             markdownContent += `---\n\n`;
             
             if (chat.messages && chat.messages.length > 0) {
                  const mergedMessages = mergeConsecutiveMessages(chat.messages);
                  mergedMessages.forEach((msg, index) => {
                      markdownContent += `## ${msg.role === 'user' ? '👤 用户' : '🤖 AI助手'} (${msg.timeRange})\n\n`;
                      markdownContent += `${msg.content}\n\n`;
                      if (index < mergedMessages.length - 1) {
                          markdownContent += `---\n\n`;
                      }
                  });
              }
             
                 downloadFile(markdownContent, `${chat.title}_${sessionId}.md`, 'text/markdown');
             } catch (error) {
                 console.error('导出Markdown失败:', error);
                 alert('导出失败: ' + error.message);
             }
         }
         
         // 下载文件的通用函数
         function downloadFile(content, filename, mimeType) {
             const blob = new Blob([content], { type: mimeType + ';charset=utf-8' });
             const url = URL.createObjectURL(blob);
             const link = document.createElement('a');
             link.href = url;
             link.download = filename;
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
             URL.revokeObjectURL(url);
         }

        async function searchChats() {
            const query = document.getElementById('search-input').value.trim();
            if (!query) {
                displayChats(currentChats);
                return;
            }
            
            updateStats(`正在搜索: ${query}...`);
            try {
                const results = await service.searchChats(query);
                displayChats(results);
                updateStats(`搜索完成: ${results.length} 条结果`);
            } catch (error) {
                updateStats(`搜索失败: ${error.message}`);
            }
        }

        async function refreshChats() {
            await service.clearCache();
            await loadChats();
        }

        function clearCache() {
            service.clearCache();
            updateStats('缓存已清除');
        }

        function updateStats(message) {
            document.getElementById('stats').textContent = message;
        }



        // 初始化
        document.addEventListener('DOMContentLoaded', loadChats);
    </script>
</body>
</html>