<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cursor èŠå¤©å†å²è®°å½•</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            margin: 0; 
            padding: 20px; 
            background: #f5f5f5;
            line-height: 1.6;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header { 
            background: #007acc; 
            color: white; 
            padding: 20px; 
            text-align: center;
        }
        .controls { 
            padding: 20px; 
            border-bottom: 1px solid #eee; 
            display: flex; 
            gap: 10px; 
            align-items: center;
            flex-wrap: wrap;
        }
        .controls input, .controls button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .controls button {
            background: #007acc;
            color: white;
            cursor: pointer;
            border: none;
        }
        .controls button:hover {
            background: #005a9e;
        }
        .stats { 
            padding: 10px 20px; 
            background: #f9f9f9; 
            border-bottom: 1px solid #eee; 
            font-size: 14px;
        }
        .chat-list { 
            padding: 20px; 
            height: 400px; 
            overflow-y: auto; 
            border-right: 1px solid #eee;
        }
        .chat-detail { 
            padding: 20px; 
            height: 400px; 
            overflow-y: auto;
        }
        .chat-card {
            border: 1px solid #e1e4e8;
            margin: 10px 0;
            padding: 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .chat-card:hover {
            background: #f6f8fa;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chat-title { font-size: 16px; font-weight: 600; margin-bottom: 5px; }
        .chat-preview { color: #586069; font-size: 14px; margin-bottom: 5px; }
        .chat-meta { font-size: 12px; color: #959da5; display: flex; gap: 15px; }
        .message {
            margin: 10px 0;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #e1e4e8;
        }
        .message.user { border-left-color: #28a745; background: #f6ffed; }
        .message.assistant { border-left-color: #6f42c1; background: #f3f0ff; }
        .message-header {
            font-size: 12px;
            color: #586069;
            margin-bottom: 8px;
        }
        .message-content {
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
        }
        .loading { text-align: center; padding: 40px; color: #586069; }
        .error { color: #d73a49; background: #ffeef0; padding: 10px; border-radius: 4px; }
        .split-container { display: flex; height: 500px; }
        .split-container .chat-list { flex: 1; border-right: 1px solid #eee; }
        .split-container .chat-detail { flex: 2; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Cursor èŠå¤©å†å²è®°å½•</h1>
            <p>ç‹¬ç«‹ç‰ˆæœ¬ - æ— éœ€å¤æ‚æ¨¡å—ç³»ç»Ÿ</p>
        </div>
        
        <div class="controls">
            <input type="text" id="search-input" placeholder="æœç´¢èŠå¤©å†…å®¹..." />
            <button onclick="searchChats()">æœç´¢</button>
            <button onclick="refreshChats()">åˆ·æ–°</button>
            <button onclick="clearCache()">æ¸…é™¤ç¼“å­˜</button>
        </div>
        
        <div class="stats" id="stats">å‡†å¤‡å°±ç»ª...</div>
        
        <div class="split-container">
            <div class="chat-list">
                <div id="chats-container">
                    <div class="loading">æ­£åœ¨åŠ è½½èŠå¤©è®°å½•...</div>
                </div>
            </div>
            
            <div class="chat-detail">
                <div id="detail-container">
                    <div class="loading">é€‰æ‹©ä¸€ä¸ªèŠå¤©æŸ¥çœ‹è¯¦æƒ…...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // APIå®¢æˆ·ç«¯
        class HistoryApiClient {
            constructor() {
                this.baseUrl = '/api/history';
            }

            async getAllChats(options = {}) {
                const params = new URLSearchParams();
                if (options.limit) params.append('limit', options.limit);
                if (options.offset) params.append('offset', options.offset);
                if (options.workspaceId) params.append('workspaceId', options.workspaceId);
                
                const url = `${this.baseUrl}/chats${params.toString() ? '?' + params.toString() : ''}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                return await response.json();
            }

            async getChatDetail(sessionId) {
                const response = await fetch(`${this.baseUrl}/chat/${encodeURIComponent(sessionId)}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                return await response.json();
            }

            async searchChats(query) {
                const response = await fetch(`${this.baseUrl}/search?q=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                return await response.json();
            }

            async clearCache() {
                const response = await fetch(`${this.baseUrl}/cache`, { method: 'DELETE' });
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                return await response.json();
            }
        }

        // æœåŠ¡å±‚
        class HistoryService {
            constructor() {
                this.apiClient = new HistoryApiClient();
                this.cache = new Map();
                this.cacheTimeout = 5 * 60 * 1000; // 5åˆ†é’Ÿ
            }

            async getChatList(options = {}) {
                const cacheKey = `all_chats_${JSON.stringify(options)}`;
                const cached = this.cache.get(cacheKey);
                
                if (cached && Date.now() - cached.timestamp < this.cacheTimeout) {
                    return cached.data;
                }

                try {
                    const response = await this.apiClient.getAllChats(options);
                    
                    let chats;
                    if (response && response.success && Array.isArray(response.data)) {
                        chats = response.data;
                    } else if (Array.isArray(response)) {
                        chats = response;
                    } else {
                        console.warn('æ„å¤–çš„APIå“åº”æ ¼å¼:', response);
                        chats = [];
                    }

                    const processedChats = this.processChats(chats);
                    this.cache.set(cacheKey, { data: processedChats, timestamp: Date.now() });
                    return processedChats;
                } catch (error) {
                    console.error('è·å–èŠå¤©åˆ—è¡¨å¤±è´¥:', error);
                    throw error;
                }
            }

            async getChatDetail(sessionId) {
                const cacheKey = `chat_detail_${sessionId}`;
                const cached = this.cache.get(cacheKey);
                
                if (cached && Date.now() - cached.timestamp < this.cacheTimeout) {
                    return cached.data;
                }

                try {
                    const response = await this.apiClient.getChatDetail(sessionId);
                    const chatDetail = response.data;
                    const processedDetail = this.processChatDetail(chatDetail);
                    this.cache.set(cacheKey, { data: processedDetail, timestamp: Date.now() });
                    return processedDetail;
                } catch (error) {
                    console.error('è·å–èŠå¤©è¯¦æƒ…å¤±è´¥:', error);
                    throw error;
                }
            }

            async searchChats(query) {
                if (!query || query.trim() === '') {
                    return this.getChatList();
                }

                try {
                    const response = await this.apiClient.searchChats(query);
                    return this.processChats(response.data || []);
                } catch (error) {
                    console.error('æœç´¢èŠå¤©è®°å½•å¤±è´¥:', error);
                    throw error;
                }
            }

            async clearCache() {
                this.cache.clear();
                return await this.apiClient.clearCache();
            }

            processChats(chats) {
                if (!Array.isArray(chats)) {
                    console.warn('processChats: æœŸæœ›æ•°ç»„ä½†æ”¶åˆ°:', typeof chats, chats);
                    return [];
                }
                
                return chats.map(chat => ({
                    ...chat,
                    title: this.generateChatTitle(chat),
                    preview: this.generateChatPreview(chat),
                    formattedTime: this.formatTime(chat.timestamp || chat.lastModified),
                    messageCount: chat.messages ? chat.messages.length : 0
                }));
            }

            processChatDetail(chatDetail) {
                return {
                    ...chatDetail,
                    title: this.generateChatTitle(chatDetail),
                    formattedTime: this.formatTime(chatDetail.timestamp || chatDetail.lastModified),
                    messages: chatDetail.messages ? chatDetail.messages.map(msg => ({
                        ...msg,
                        formattedTime: this.formatTime(msg.timestamp)
                    })) : []
                };
            }

            generateChatTitle(chat) {
                if (chat.title) return chat.title;
                
                if (chat.messages && chat.messages.length > 0) {
                    const firstUserMessage = chat.messages.find(msg => msg.role === 'user');
                    if (firstUserMessage) {
                        return firstUserMessage.content.substring(0, 50) + 
                               (firstUserMessage.content.length > 50 ? '...' : '');
                    }
                }
                
                return `èŠå¤©è®°å½• ${this.formatTime(chat.timestamp || Date.now())}`;
            }

            generateChatPreview(chat) {
                if (chat.messages && chat.messages.length > 0) {
                    const lastMessage = chat.messages[chat.messages.length - 1];
                    return lastMessage.content.substring(0, 100) + 
                           (lastMessage.content.length > 100 ? '...' : '');
                }
                return 'æš‚æ— æ¶ˆæ¯';
            }

            formatTime(timestamp) {
                if (!timestamp) return 'æœªçŸ¥æ—¶é—´';
                
                const date = new Date(timestamp);
                const now = new Date();
                const diff = now - date;
                
                if (diff < 60000) return 'åˆšåˆš';
                if (diff < 3600000) return `${Math.floor(diff / 60000)}åˆ†é’Ÿå‰`;
                if (diff < 86400000) return `${Math.floor(diff / 3600000)}å°æ—¶å‰`;
                if (diff < 604800000) return `${Math.floor(diff / 86400000)}å¤©å‰`;
                return date.toLocaleDateString('zh-CN');
            }
        }

        // å…¨å±€å˜é‡
        let service = new HistoryService();
        let currentChats = [];

        // åŠŸèƒ½å‡½æ•°
        async function loadChats() {
            updateStats('æ­£åœ¨åŠ è½½...');
            document.getElementById('chats-container').innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½èŠå¤©è®°å½•...</div>';
            
            try {
                currentChats = await service.getChatList();
                displayChats(currentChats);
                updateStats(`æ‰¾åˆ° ${currentChats.length} æ¡èŠå¤©è®°å½•`);
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                updateStats(`åŠ è½½å¤±è´¥: ${error.message}`);
                document.getElementById('chats-container').innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        function displayChats(chats) {
            const container = document.getElementById('chats-container');
            if (!chats || chats.length === 0) {
                container.innerHTML = '<div class="error">æ²¡æœ‰æ‰¾åˆ°èŠå¤©è®°å½•</div>';
                return;
            }

            let html = '';
            chats.forEach(chat => {
                html += `
                    <div class="chat-card" onclick="loadChatDetail('${chat.sessionId}')">
                        <div class="chat-title">${chat.title}</div>
                        <div class="chat-preview">${chat.preview}</div>
                        <div class="chat-meta">
                            <span>é¡¹ç›®: ${chat.project?.name || 'æœªçŸ¥'}</span>
                            <span>æ¶ˆæ¯: ${chat.messageCount}</span>
                            <span>${chat.formattedTime}</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        async function loadChatDetail(sessionId) {
            updateStats('æ­£åœ¨åŠ è½½èŠå¤©è¯¦æƒ…...');
            document.getElementById('detail-container').innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½èŠå¤©è¯¦æƒ…...</div>';
            
            try {
                const chat = await service.getChatDetail(sessionId);
                displayChatDetail(chat);
                updateStats(`æ˜¾ç¤ºèŠå¤©è¯¦æƒ…: ${chat.title}`);
            } catch (error) {
                console.error('åŠ è½½è¯¦æƒ…å¤±è´¥:', error);
                updateStats(`åŠ è½½è¯¦æƒ…å¤±è´¥: ${error.message}`);
                document.getElementById('detail-container').innerHTML = `<div class="error">åŠ è½½è¯¦æƒ…å¤±è´¥: ${error.message}</div>`;
            }
        }

        function displayChatDetail(chat) {
            const container = document.getElementById('detail-container');
            
            let html = `
                <h3>${chat.title}</h3>
                <div style="margin: 10px 0; font-size: 14px; color: #666;">
                    <p><strong>ä¼šè¯ID:</strong> ${chat.sessionId}</p>
                    <p><strong>é¡¹ç›®:</strong> ${chat.project?.name || 'æœªçŸ¥'}</p>
                    <p><strong>æ¶ˆæ¯æ•°é‡:</strong> ${chat.messages?.length || 0}</p>
                    <p><strong>æ—¶é—´:</strong> ${chat.formattedTime}</p>
                </div>
                <hr>
            `;

            if (chat.messages && chat.messages.length > 0) {
                chat.messages.forEach((msg, index) => {
                    html += `
                        <div class="message ${msg.role}">
                            <div class="message-header">
                                ${msg.role === 'user' ? 'ğŸ‘¤ ç”¨æˆ·' : 'ğŸ¤– AI'} - ${msg.formattedTime}
                            </div>
                            <div class="message-content">${msg.content}</div>
                        </div>
                    `;
                });
            } else {
                html += '<p>æš‚æ— æ¶ˆæ¯</p>';
            }

            container.innerHTML = html;
        }

        async function searchChats() {
            const query = document.getElementById('search-input').value.trim();
            if (!query) {
                displayChats(currentChats);
                return;
            }
            
            updateStats(`æ­£åœ¨æœç´¢: ${query}...`);
            try {
                const results = await service.searchChats(query);
                displayChats(results);
                updateStats(`æœç´¢å®Œæˆ: ${results.length} æ¡ç»“æœ`);
            } catch (error) {
                updateStats(`æœç´¢å¤±è´¥: ${error.message}`);
            }
        }

        async function refreshChats() {
            await service.clearCache();
            await loadChats();
        }

        function clearCache() {
            service.clearCache();
            updateStats('ç¼“å­˜å·²æ¸…é™¤');
        }

        function updateStats(message) {
            document.getElementById('stats').textContent = message;
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', loadChats);
    </script>
</body>
</html>